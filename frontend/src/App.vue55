<template>
  <div class="app-root">
    <!-- 蟾?萓?蟇?闊?譬?-->
    <Sidebar 
      :is-logged-in="isLoggedIn"
      :current-user="currentUser"
      :active-page="activePage"
      @navigate="handleNavigate"
      @login="showLoginDialog = true"
      @logout="handleLogout"
    />
    
    <!-- 荳?蜀???蛹?蝓?-->
    <div class="main-container">
      <!-- 蜈?蜈?鬥夜?? -->
      <CommunityHome 
        v-if="activePage === 'home'"
        :is-logged-in="isLoggedIn"
        @use-template="handleUseTemplate"
        @need-login="showLoginDialog = true"
      />
      
      <!-- 蟾?菴懷床?亥次譛臥函謌千阜髱???-->
      <div v-else-if="activePage === 'workspace'" class="main-layout">
      <!-- 蟾?萓?髱?譚??啜AB蛻?困 + 逕?謌?雍?謌?邉?扈 -->
      <div class="left-panel">
        <!-- TAB蛻?困蛹?蝓 -->
        <div class="tab-section">
          <div class="tab-header">
            <el-tabs v-model="activeTab" class="left-tabs">
              <el-tab-pane label="提示词" name="prompts">
                <div class="tab-content">
                  <!-- 謠千??隸咲??逅?潔髓?-->
                  <div class="prompts-manage-header">
                    <el-button 
                      type="primary" 
                      size="small" 
                      @click="showPromptManager = true"
                      class="prompts-manage-btn"
                    >
                      <el-icon><Setting /></el-icon>
                      管理提示词
                    </el-button>
                  </div>

                  <div class="prompts-waterfall-container">
                    <div v-if="userPromptsLoading" class="loading-prompts">
                      <LoadingCard 
                        title="正在加载提示词..." 
                        subtitle="请稍候，正在获取您的提示词列表"
                        size="small"
                      />
                    </div>
                    
                    <div v-else-if="userPrompts.length === 0" class="empty-prompts">
                      <el-icon size="48"><Document /></el-icon>
                      <p>暂无提示词</p>
                      <el-button 
                        type="primary" 
                        size="small" 
                        @click="showPromptManager = true"
                      >
                        添加提示词
                      </el-button>
                    </div>
                    
                    <div
                      v-else
                      v-for="userPrompt in userPrompts"
                      :key="userPrompt.id"
                      class="prompt-card-waterfall"
                      @click="selectUserPrompt(userPrompt)"
                    >
                      <div class="card-image-waterfall">
                        <img 
                          v-if="userPrompt.referenceImage" 
                          :src="userPrompt.referenceImage" 
                          :alt="userPrompt.title"
                          @error="handleImageError"
                        />
                        <div v-else class="no-image-waterfall">
                          <el-icon size="24"><Picture /></el-icon>
                        </div>
                      </div>
                      <div class="card-content-waterfall">
                        <h4 class="card-title-waterfall">{{ userPrompt.title }}</h4>
                      </div>
                    </div>
                  </div>
                </div>
              </el-tab-pane>
              
              <el-tab-pane label="历史记录" name="history">
                <div class="tab-content">
                  <HistoryPanel ref="historyPanelRef" @select-history="loadFromHistory" />
                </div>
              </el-tab-pane>
            </el-tabs>
          </div>
        </div>
        
        <!-- 逕?謌?雍?謌?邉?扈滂?亥?暮Κ蟆丞今迚???-->
        <div class="user-account-card">
          <div class="user-info">
            <div class="user-avatar">
              <el-avatar :size="32" :src="currentUser.avatar">
                {{ currentUser.username?.charAt(0)?.toUpperCase() }}
              </el-avatar>
            </div>
            <div class="user-details">
              <div class="username">{{ currentUser.username }}</div>
              <div class="user-status">蝨?郤?</div>
            </div>
          </div>
          <div class="user-actions">
            <el-dropdown trigger="click" placement="top-start">
              <el-button type="text" size="small" class="more-btn">
                <el-icon><MoreFilled /></el-icon>
              </el-button>
              <template #dropdown>
                <el-dropdown-menu>
                  <el-dropdown-item v-if="currentUser?.is_admin" @click="showAdminDashboard = true">
                    <el-icon><Setting /></el-icon>
                    邂?逅?遭謗?蛻?蜿?
                  </el-dropdown-item>
                  <el-dropdown-item @click="handleLogout">
                    <el-icon><SwitchButton /></el-icon>
                    騾蜃?逋?蠖?                  </el-dropdown-item>
                </el-dropdown-menu>
              </template>
            </el-dropdown>
          </div>
        </div>
      </div>
      
      <!-- 荳?髣?謗?蛻?髱?譚? -->
      <div class="control-panel">
        <!-- 蜈?螻Tab蛻?困 -->
        <el-tabs v-model="generationMode" class="global-mode-tabs">
          <el-tab-pane label="文生图" name="text-to-image"></el-tab-pane>
          <el-tab-pane label="图生图" name="image-to-image"></el-tab-pane>
          <el-tab-pane label="AI视频" name="image-to-video"></el-tab-pane>
        </el-tabs>

        <!-- 謠千??隸崎?灘?-->
        <div class="prompt-section">
          <div class="prompt-header">
            <!-- 讓?蝙矩画叫蜥碁?鄂?謖蛾?- 譁?函蝗?蜥悟崟逕溷?-->
            <div v-if="generationMode !== 'image-to-video'" style="display: flex; gap: 8px; align-items: center;">
              <el-select
                v-model="selectedModelId"
                placeholder="騾画叫AI讓?蝙"
                size="small"
                @change="onModelChange"
                style="width: 200px"
              >
                <el-option
                  v-for="model in filteredAvailableModels"
                  :key="model.id"
                  :label="model.name"
                  :value="model.id"
                >
                  <div class="model-option">
                    <img 
                      v-if="model.icon_url" 
                      :src="model.icon_url" 
                      class="model-icon"
                      @error="handleModelIconError"
                    />
                    <el-icon v-else class="model-icon" color="#909399"><Picture /></el-icon>
                    <span class="model-name">{{ model.name }}</span>
                    <span v-if="model.is_default" class="default-tag">鮟倩??</span>
                  </div>
                </el-option>
              </el-select>
              <el-button @click="resetForm" size="small">驥咲??</el-button>
            </div>
            <!-- 讓?蝙矩画叫蜥碁?鄂?謖蛾?- 隗??第??蠑 -->
            <div v-else style="display: flex; gap: 8px; align-items: center;">
              <el-select
                v-model="videoSelectedModelId"
                placeholder="騾画叫隗??第??蝙"
                size="small"
                :loading="videoModelsLoading"
                style="width: 200px"
              >
                <el-option
                  v-for="model in videoModels"
                  :key="model.id"
                  :label="model.name"
                  :value="model.id"
                >
                  <div class="model-option">
                    <img 
                      v-if="model.icon_url" 
                      :src="model.icon_url" 
                      class="model-icon"
                      @error="handleModelIconError"
                    />
                    <el-icon v-else class="model-icon" color="#909399"><VideoPlay /></el-icon>
                    <div class="model-name">{{ model.name }}</div>
                  </div>
                </el-option>
              </el-select>
              <el-button @click="resetVideoForm" size="small">驥咲??</el-button>
            </div>
          </div>
          
          <!-- 譁?函蝗?蜥悟崟逕溷崟逧?署遉?隸崎?灘?-->
          <template v-if="generationMode === 'text-to-image' || generationMode === 'image-to-image'">
            <!-- 菴?逕?閾?螳壻?牙?夊?梧???霎灘?扈???-->
            <MultilineTagInput
              ref="multilineTagInputRef"
              v-model="promptTags"
              placeholder="謠剰??菴諠?隕∫函謌千噪蝗?蜒,萓句?:荳蜿?蜿?辷?逧?賢蜥?,譟碑??逧??帛?螟?逵?逹?髦?蜈我?句??隨?.."
              class="prompt-input-tag"
              :max-tags="20"
              :min-rows="3"
              :max-rows="6"
              :show-hint="true"
              separator=","
              :auto-convert-to-tags="false"
              :tag-mapping="tagMapping"
              @change="handlePromptChange"
            />
            <!-- 蟶?逕?謠千??隸?-->
            <div class="common-prompts">
              <div class="common-prompts-header">
                <div class="common-prompts-label">蟶?逕?謠千??隸搾?</div>
                <el-button 
                  size="small" 
                  type="primary" 
                  plain
                  @click="showCommonPromptsManager = true"
                  class="manage-prompts-btn"
                >
                  邂?逅
                </el-button>
              </div>
              <div class="common-prompts-buttons">
                <el-button
                  v-for="commonPrompt in commonPrompts"
                  :key="commonPrompt.id"
                  size="small"
                  :type="selectedCommonPromptIds.has(commonPrompt.id) ? 'primary' : 'info'"
                  :plain="!selectedCommonPromptIds.has(commonPrompt.id)"
                  @click="addCommonPrompt(commonPrompt, commonPrompt.id)"
                  :class="{ 'selected-prompt': selectedCommonPromptIds.has(commonPrompt.id) }"
                >
                  {{ commonPrompt.name }}
                </el-button>
              </div>
            </div>
          </template>
          
          <!-- AI隗??醍噪謠千??隸崎?灘? -->
          <template v-else-if="generationMode === 'image-to-video'">
            <!-- 菴?逕?閾?螳壻?牙?夊?梧???霎灘?扈???-->
            <MultilineTagInput
              ref="videoMultilineTagInputRef"
              v-model="videoPromptTags"
              placeholder="謠剰??菴諠?隕∫函謌千噪隗??大?螳?,萓句?:荳蜿?蜿?辷?逧?賢蜥?蝨?闕牙慍荳雁?碑?,髦?蜈画?蟐,蠕?鬟手??諡..."
              class="prompt-input-tag"
              :max-tags="20"
              :min-rows="3"
              :max-rows="6"
              :show-hint="true"
              separator=","
              :auto-convert-to-tags="false"
              :tag-mapping="videoTagMapping"
              @change="handleVideoPromptChange"
            />
            <!-- 视频常用提示词 -->
            <div class="common-prompts">
              <div class="common-prompts-header">
                <div class="common-prompts-label">视频常用提示词</div>
                <el-button 
                  size="small" 
                  type="primary" 
                  plain
                  @click="showVideoPromptsManager = true"
                  class="manage-prompts-btn"
                >
                  管理
                </el-button>
              </div>
              <div class="common-prompts-buttons">
                <el-button
                  v-for="videoPrompt in videoCommonPrompts"
                  :key="videoPrompt.id"
                  size="small"
                  :type="selectedVideoPromptIds.has(videoPrompt.id) ? 'primary' : 'info'"
                  :plain="!selectedVideoPromptIds.has(videoPrompt.id)"
                  @click="addVideoCommonPrompt(videoPrompt, videoPrompt.id)"
                  :class="{ 'selected-prompt': selectedVideoPromptIds.has(videoPrompt.id) }"
                >
                  {{ videoPrompt.name }}
                </el-button>
              </div>
            </div>
          </template>
        </div>

        <!-- 蝗?逕溷崟讓?蠑丈?狗噪蝗?迚??贋??- 邏?蜃第潔髓?蠑?-->
        <div v-if="generationMode === 'image-to-image'" class="settings-section vertical-layout compact-section">
          <div class="setting-item">
            <div class="image-upload-header-inline">
              <h3>参考图管理</h3>
              <el-button 
                type="primary" 
                size="small" 
                :icon="Picture" 
                @click="showReferenceManager = true"
              >
                管理参考图
              </el-button>
            </div>
            
            <div class="reference-upload-compact">
              <!-- 荳贋?謖蛾聴 -->
              <el-upload
                ref="uploadRef"
                :auto-upload="false"
                :on-change="handleImageChange"
                :show-file-list="false"
                accept="image/*"
                multiple
                class="compact-uploader"
              >
                <el-button size="small" :icon="Plus">添加参考图</el-button>
              </el-upload>
            </div>
            
            <!-- 蟾?荳贋?蝗?迚???逡?蝗? -->
            <div v-if="uploadedImages.length > 0" class="uploaded-thumbnails-compact">
              <div 
                v-for="(image, index) in uploadedImages" 
                :key="image.id" 
                class="thumbnail-item-compact"
                :class="{ 
                  'dragging': draggedImageIndex === index,
                  'drag-over': dropTargetIndex === index
                }"
                draggable="true"
                @dragstart="handleDragStart(index, $event)"
                @dragover.prevent="handleDragOver(index, $event)"
                @dragleave="handleDragLeave"
                @drop="handleDrop(index, $event)"
                @dragend="handleDragEnd"
              >
                <img 
                  :src="image.url" 
                  :alt="image.name"
                  @click="handleThumbnailClick(image.id)"
                  style="cursor: pointer;"
                  title="轤?蜃?譖?謐?蝗?迚"
                />
                <el-button 
                  type="danger" 
                  size="small" 
                  circle 
                  class="remove-thumb-btn"
                  @click.stop="removeImage(image.id)"
                >
                  <el-icon><Close /></el-icon>
                </el-button>
              </div>
            </div>
            
            <!-- 蟶?逕?蜿り?崟蟆丞崟譬?-->
            <div v-if="isLoadingReferenceImages || commonReferenceImages.length > 0" class="common-reference-icons-inline">
              <div class="icons-header-inline">
                <span>蟶?逕?蜿り?崟</span>
                <div class="header-actions-inline">
                  <!-- 蛻???蛻?困譬??? -->
                  <div v-if="referenceCategories.length > 1" class="category-tabs-inline">
                    <div 
                      v-for="category in referenceCategories" 
                      :key="category.id"
                      class="category-tab-inline"
                      :class="{ active: activeReferenceCategoryId === category.id }"
                      @click="setActiveReferenceCategory(category.id)"
                    >
                      <span class="category-name">{{ category.name }}</span>
                      <span class="category-count">({{ getReferenceCategoryImageCount(category.id) }})</span>
                    </div>
                  </div>
                  <el-button 
                    v-if="commonReferenceImages.length > 16" 
                    size="small" 
                    type="text" 
                    @click="toggleReferenceIconsCollapse"
                    class="collapse-btn"
                  >
                    {{ isReferenceIconsCollapsed ? '螻募?' : '謚伜匠' }}
                  </el-button>
                </div>
              </div>
              
              <!-- 蜉霓?蜉?逕? -->
              <div v-if="isLoadingReferenceImages" class="reference-loading">
                <el-icon class="is-loading" :size="24">
                  <Loading />
                </el-icon>
                <span>蜉霓?蟶?逕?蜿り?崟荳?..</span>
              </div>
              
              <!-- 蜿り?崟鄂第? -->
              <div v-else class="icons-grid-inline" :class="{ collapsed: isReferenceIconsCollapsed }">
                <div 
                  v-for="image in displayedReferenceImages" 
                  :key="image.id" 
                  class="reference-icon-inline"
                  draggable="true"
                  @click="insertCommonReferenceImage(image)"
                  @dragstart="handleCommonImageDragStart(image, $event)"
                  :title="`${image.originalName || image.filename}\n諡匁郷蛻?荳頑婿郛?逡?蝗?蜿?譖?謐?`"
                >
                  <img :src="image.url" :alt="image.originalName || image.filename" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI隗??第??蠑丈?狗噪霎灘?謗?莉? -->
        <div v-if="generationMode === 'image-to-video'" class="video-input-section">

          <!-- 蝗?迚??贋?蛹?蝓 (莉?惠讓?蝙区髪謖∵慮譏?遉? - 雜???蜃第??蠑?-->
          <div v-if="supportsFirstFrame || supportsLastFrame" class="settings-section vertical-layout compact-section">
            <div class="setting-item">
              <h3>荳贋?蝗?迚</h3>
              <div class="video-upload-ultra-compact">
                <!-- 鬥門??蝗?迚 -->
                <div v-if="supportsFirstFrame" class="video-upload-item">
                  <label class="ultra-compact-label">鬥門?? <span v-if="firstFrameRequired" style="color: #f56c6c;">*</span></label>
                  <div v-if="firstFramePreview" class="ultra-compact-preview">
                    <img :src="firstFramePreview" alt="鬥門??" class="ultra-thumb" />
                    <el-button size="small" text @click="firstFrameFile = null; firstFramePreview = ''">
                      <el-icon><Close /></el-icon>
                    </el-button>
                  </div>
                  <el-upload
                    v-else
                    class="ultra-compact-uploader"
                    :show-file-list="false"
                    :before-upload="handleFirstFrameUpload"
                    :accept="'image/*'"
                  >
                    <el-button size="small" :icon="Plus">上传图片</el-button>
                  </el-upload>
                </div>

                <!-- 蟆?蟶?蝗?迚 -->
                <div v-if="supportsLastFrame" class="video-upload-item">
                  <label class="ultra-compact-label">蟆?蟶?</label>
                  <div v-if="lastFramePreview" class="ultra-compact-preview">
                    <img :src="lastFramePreview" alt="蟆?蟶?" class="ultra-thumb" />
                    <el-button size="small" text @click="lastFrameFile = null; lastFramePreview = ''">
                      <el-icon><Close /></el-icon>
                    </el-button>
                  </div>
                  <el-upload
                    v-else
                    class="ultra-compact-uploader"
                    :show-file-list="false"
                    :before-upload="handleLastFrameUpload"
                    :accept="'image/*'"
                  >
                    <el-button size="small" :icon="Plus">上传图片</el-button>
                  </el-upload>
                </div>
              </div>
            </div>
          </div>

          <!-- 视频参数设置 -->
          <div class="settings-section vertical-layout compact-section">
            <div class="setting-item">
              <h3>视频参数</h3>
              
              <!-- Sora 系列参数 -->
              <div v-if="isSoraModel" class="params-compact-row">
                <div class="param-compact-col">
                  <label>时长</label>
                  <el-select v-model="videoDuration" placeholder="选择时长" size="small">
                    <el-option label="10秒" value="10" />
                    <el-option label="15秒" value="15" :disabled="!isSoraPro" />
                    <el-option label="25秒" value="25" :disabled="!isSoraPro" />
                  </el-select>
                  <div v-if="!isSoraPro && (videoDuration === '15' || videoDuration === '25')" class="param-hint-inline">
                    需升级为 Pro 才可使用该时长
                  </div>
                </div>
                
                <div class="param-compact-col">
                  <label>画幅比例</label>
                  <el-select v-model="videoAspectRatio" placeholder="选择比例" size="small">
                    <el-option label="横屏 (16:9)" value="16:9" />
                    <el-option label="竖屏 (9:16)" value="9:16" />
                  </el-select>
                </div>

                <div class="param-compact-col">
                  <label>HD 画质</label>
                  <el-switch 
                    v-model="videoHd" 
                    size="small"
                    :disabled="!isSoraPro || videoDuration === '25'"
                  />
                  <div v-if="!isSoraPro" class="param-hint-inline">
                    需 Pro 才可使用 HD
                  </div>
                  <div v-else-if="videoDuration === '25'" class="param-hint-inline">
                    25 秒时长暂不支持 HD
                  </div>
                  <div v-else-if="videoHd" class="param-hint-inline">
                    需额外消耗 8 点
                  </div>
                </div>
                
                <div class="param-compact-col">
                  <label>水印</label>
                  <el-switch v-model="videoWatermark" size="small" />
                </div>
              </div>

              <!-- 其它模型参数 -->
              <div v-else class="params-compact-row">
                <div class="param-compact-col">
                  <label>时长</label>
                  <el-select v-model="videoDuration" placeholder="选择时长" size="small">
                    <el-option label="5秒" :value="5" />
                    <el-option label="10秒" :value="10" />
                  </el-select>
                </div>
                
                <div class="param-compact-col">
                  <label>分辨率</label>
                  <el-select v-model="videoResolution" placeholder="选择分辨率" size="small">
                    <el-option label="480p" value="480p" />
                    <el-option label="720p" value="720p" />
                    <el-option label="1080p" value="1080p" />
                  </el-select>
                </div>

                <div class="param-compact-col">
                  <label>画幅比例</label>
                  <el-select v-model="videoRatio" placeholder="选择比例" size="small">
                    <el-option label="16:9" value="16:9" />
                    <el-option label="9:16" value="9:16" />
                    <el-option label="4:3" value="4:3" />
                    <el-option label="1:1" value="1:1" />
                    <el-option label="保持原比例" value="keep_ratio" />
                  </el-select>
                </div>
              </div>
            </div>
          </div>

          <!-- Sora2 螳?譟?謠千?? -->
          <div v-if="isSoraModel" class="settings-section vertical-layout compact-section">
            <el-alert 
              type="warning" 
              :closable="false"
              show-icon
            >
              <template #title>
                <strong>笞? Sora2 驥崎?∵署遉?</strong>
              </template>
              <div style="font-size: 12px; line-height: 1.6; margin-top: 4px;">
                <p style="margin: 4px 0; color: #E6A23C; font-weight: 600;">
                  <strong>笶?荳?遖∫悄莠?辣?迚???/strong>蝗?迚???荳崎?譛臥悄莠?謌也恚襍?譚?蜒冗悄莠?逧?崟蜒
                </p>
                <p style="margin: 4px 0;">窶?謠千??隸堺?崎?蛹?性證?蜉帙?牡諠?∫沿譚?∵??逹逧?錐莠?/p>
                <p style="margin: 4px 0;">窶?逕滓?扈捺棡莨夊?幄?悟??譟??亥庄閭?蝨?0%+譌?螟?雍??</p>
                <p style="margin: 8px 0 4px 0;">
                  <strong>竢?? 鬚???逕滓?譌?髣???/strong>
                </p>
                <p style="margin: 2px 0; padding-left: 16px;">
                  窶?10遘定???托?1-3蛻?帖<br>
                  窶?15遘定???托?3-5蛻?帖<br>
                  窶?25遘定???托?5-8蛻?帖<br>
                  窶?HD鬮俶????蠑擾?夐?晏??8蛻?帖
                </p>
                <p style="margin: 8px 0 4px 0; color: #409EFF;">
                  <strong>庁 隸?閠仙???牙???檎??扈滉?夊?蜉?霓?隸?逶?蛻?螳梧?</strong>
                </p>
              </div>
            </el-alert>
          </div>

          <!-- 鬮倡??騾蛾?? - 蜿?謚伜?-->
          <div v-if="isDoubaoModel || isVeoModel || isWanModel" class="settings-section vertical-layout compact-section">
            <el-collapse v-model="videoAdvancedExpanded" class="advanced-collapse">
              <el-collapse-item name="advanced">
                <template #title>
                  <h3 class="collapse-title">鬮倡??騾蛾??</h3>
                </template>
                <div class="advanced-options-compact">
                  <!-- 髫乗惻遘榊? -->
                  <div class="option-item-compact">
                    <label>髫乗惻遘榊?撰?亥庄騾会?</label>
                    <el-input-number
                      v-model="videoSeed"
                      :min="0"
                      :max="2147483647"
                      placeholder="逡咏??髫乗惻"
                      size="small"
                      style="width: 100%"
                    />
                  </div>
                  
                  <!-- 雎?桁荳鍋畑騾蛾?? -->
                  <div v-if="isDoubaoModel" class="option-checkboxes">
                    <el-checkbox v-model="videoWatermark">豺?蜉豌?蜊?</el-checkbox>
                    <el-checkbox v-model="videoCameraFixed">蝗?螳壽槍蜒丞??/el-checkbox>
                    <el-checkbox v-model="videoReturnLastFrame">霑泌屓蟆?蟶?蝗?蜒</el-checkbox>
                  </div>
                  
                  <!-- VEO3荳鍋畑騾蛾?? -->
                  <div v-if="isVeoModel" class="option-checkboxes">
                    <el-checkbox v-model="videoEnhancePrompt">謠千??隸堺?伜?/el-checkbox>
                    <el-checkbox v-model="videoEnableUpsample">蛻???邇?署蜊?/el-checkbox>
                  </div>
                  
                  <!-- Wan荳鍋畑騾蛾?? -->
                  <template v-if="isWanModel">
                    <div class="option-checkboxes">
                      <el-checkbox v-model="videoWatermark">豺?蜉豌?蜊?</el-checkbox>
                      <el-checkbox v-model="videoPromptExtend">謠千??隸埼?蜀?/el-checkbox>
                    </div>
                    
                    <div class="option-item-compact">
                      <label>雍滄擇謠千??隸搾?亥庄騾会?</label>
                      <el-input
                        v-model="videoNegativePrompt"
                        type="textarea"
                        :rows="2"
                        placeholder="荳肴Φ蜃?邇?逧??螳?.."
                        maxlength="500"
                        show-word-limit
                        size="small"
                      />
                    </div>
                    
                    <div class="option-item-compact">
                      <label>蜈?菴灘?霎?邇?/label>
                      <el-select v-model="videoSize" placeholder="騾画叫" size="small">
                        <el-option label="1920x1080 (16:9)" value="1920x1080" />
                        <el-option label="1080x1920 (9:16)" value="1080x1920" />
                        <el-option label="1440x1440 (1:1)" value="1440x1440" />
                        <el-option label="1280x720 (16:9)" value="1280x720" />
                        <el-option label="720x1280 (9:16)" value="720x1280" />
                      </el-select>
                    </div>
                  </template>
                </div>
              </el-collapse-item>
            </el-collapse>
          </div>

          <!-- 逕滓?謖蛾聴 -->
          <div class="action-buttons">
            <el-button 
              type="primary" 
              :loading="videoGenerateCooldown"
              @click="handleVideoGeneration"
              :disabled="!videoCanGenerate || videoGenerateCooldown"
              class="generate-btn"
              size="large"
            >
              <el-icon v-if="!videoGenerateCooldown"><VideoPlay /></el-icon>
              {{ videoGenerateCooldown ? '謠蝉??荳?..' : '蠑蟋狗函謌占???? }}
            </el-button>
          </div>
        </div>


        <!-- 蝗?迚??比?句柱逕滓?謨?驥?- 莉?惠髱櫁???醍函謌先??蠑丈?区仞遉? -->
        <div v-if="generationMode !== 'image-to-video'" class="settings-section vertical-layout">
          <div class="setting-item">
            <h3>{{ currentParamConfig.paramType === 'size' ? '蝗?迚???蟇?' : '蝗?迚??比?' }}</h3>
              <div class="ratio-selector">
                <div 
                  v-for="option in dynamicImageSizeOptions" 
                  :key="option.value"
                  class="ratio-option"
                  :class="{ active: imageSize === option.value }"
                  @click="imageSize = option.value"
                >
                  <div class="ratio-box" :class="getRatioClass(option.label)"></div>
                  <span class="ratio-text">{{ option.label }}</span>
                </div>
              </div>
          </div>
          
          <div class="setting-item">
            <h3>逕滓?謨?驥</h3>
              <div class="tag-selector">
                <div 
                  v-for="option in quantityOptions" 
                  :key="option.value"
                  class="tag-option"
                  :class="{ active: generateQuantity === option.value }"
                  @click="generateQuantity = option.value"
                >
                  {{ option.label }}
                </div>
              </div>
          </div>
        </div>

        <!-- 謫堺?懈潔髓? - 莉?惠髱櫁???醍函謌先??蠑丈?区仞遉? -->
        <div v-if="generationMode !== 'image-to-video'" class="action-buttons">
          <el-button 
            type="primary" 
            :loading="imageGenerateCooldown"
            @click="generateImage"
            :disabled="imageGenerateCooldown"
            class="generate-btn"
            size="large"
          >
            {{ imageGenerateCooldown ? '謠蝉??荳?..' : '逕滓?蝗?迚' }}
          </el-button>
        </div>
      </div>

      <!-- 蜿?萓?扈捺棡螻慕?? -->
      <div class="result-panel">
        <!-- 蝗?迚?函謌先??蠑擾?壽仞遉?蝗?迚?函謌千?捺?-->
        <div>
          <div class="result-header">
          <h2>逕滓?扈捺棡</h2>
            <div class="header-actions">
              <div class="auto-download-switch">
                <el-switch
                  v-model="autoDownloadEnabled"
                  active-text="閾?蜉?荳玖??"
                  inactive-text="謇句勘荳玖??"
                  size="small"
                  style="--el-switch-on-color: #67c23a; --el-switch-off-color: #dcdfe6;"
                />
              </div>
              <el-button v-if="hasAnyResults" type="success" @click="downloadAllResults" :icon="Download" size="small">
                荳髞?荳玖??蜈?驛?              </el-button>
            </div>
          </div>
          <div class="result-content">
          <!-- 遨?迥?諤?-->
          <div v-if="generationBatches.length === 0" class="empty-result">
            <div class="empty-state">
              <div class="empty-icon-container">
                <el-icon class="empty-icon"><Picture /></el-icon>
                <div class="empty-decoration">
                  <div class="decoration-circle circle-1"></div>
                  <div class="decoration-circle circle-2"></div>
                  <div class="decoration-circle circle-3"></div>
                </div>
              </div>
              <h3 class="empty-title">遲牙??函謌</h3>
              <p class="empty-description">隸?蝨?蟾?萓?霎灘?謠千??隸榊?蟋狗函謌仙崟迚??隗??</p>
            </div>
          </div>
          
          <!-- 謇?谺?螳?蝎? - 譏?遉?謇譛画音谺?-->
          <div v-else class="batches-container">
            <div 
              v-for="batch in generationBatches" 
              :key="batch.id"
              class="batch-card"
            >
              <!-- 謇?谺?螟?驛? -->
              <div class="batch-header">
                <div class="batch-info">
                  <span class="batch-type">{{ batch.type === 'image' ? '蝗?迚?函謌' : '隗??醍函謌' }}</span>
                  <span v-if="getBatchModelName(batch)" class="batch-model-tag">{{ getBatchModelName(batch) }}</span>
                  <span class="batch-time">{{ formatTimestamp(batch.timestamp) }}</span>
                  <span class="batch-prompt" :title="batch.prompt">{{ batch.prompt.substring(0, 50) }}{{ batch.prompt.length > 50 ? '...' : '' }}</span>
                </div>
                <el-button 
                  size="small" 
                  @click="removeBatch(batch.id)"
                  :icon="Delete"
                >
                  貂?勁
                </el-button>
              </div>

              <!-- 莉?蜉?謌也?捺棡螻慕??-->
              <div v-if="batch.status !== 'completed'" class="tasks-grid">
                <!-- 螟?炊荳?譌?譏?遉?莉?蜉?蜊?迚??蟾?螳梧?逧?崟迚?-->
                <div 
                  v-for="task in batch.tasks" 
                  :key="task.id"
                  :class="{
                    'task-card': !task.imageUrl,
                    'task-pending': task.status === 'pending',
                    'task-processing': task.status === 'processing',
                    'task-completed': task.status === 'completed' && !task.imageUrl,
                    'task-failed': task.status === 'failed'
                  }"
                >
                  <!-- 螯よ棡莉?蜉?蟾?螳梧?荳疲怏蝗?迚??梧仞遉?蝗?迚 -->
                  <ImageCard
                    v-if="task.status === 'completed' && task.imageUrl"
                    :src="task.imageUrl"
                    :alt="`逕滓?逧?崟迚?${task.index}`"
                    :prompt="batch.prompt"
                    :title="`逕滓?逧?崟迚?${task.index}`"
                    :subtitle="`螳樊慮逕滓?`"
                    :meta="[batch.params?.size || imageSize, `${task.index}蜿?`]"
                    :enable-cache="true"
                    :lazy="false"
                    class="main-card"
                    @click="handleImageClick"
                    @download="handleImageDownload"
                    @add-to-prompts="handleAddToPrompts"
                    @preview="handleImagePreview"
                  />
                  
                  <!-- 蜷?蛻呎仞遉?莉?蜉?迥?諤∝今迚?-->
                  <div v-else class="task-content">
                    <!-- 莉?蜉?迥?諤∝崟譬?-->
                    <div class="task-icon">
                      <el-icon v-if="task.status === 'pending'" class="pending-icon"><Clock /></el-icon>
                      <el-icon v-else-if="task.status === 'processing'" class="processing-icon"><Loading /></el-icon>
                      <el-icon v-else-if="task.status === 'failed'" class="failed-icon"><Close /></el-icon>
                    </div>
                    
                    <!-- 莉?蜉?菫?諱? -->
                    <div class="task-info">
                      <h4>莉?蜉? {{ task.index }}</h4>
                      <p v-if="task.status === 'pending'">遲牙???蟋?/p>
                      <p v-else-if="task.status === 'processing'">逕滓?荳?..</p>
                      <p v-else-if="task.status === 'failed'" class="error-message">{{ getSimplifiedError(task.error) }}</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div v-else class="results-grid">
                <!-- 螳梧?譌?譏?遉?扈捺?-->
                <template v-for="(result, index) in batch.results" :key="index">
                  <!-- 隗??醍?捺棡 - 郛?逡?蝗?讓?蠑擾?檎せ蜃?謇灘?鬚?? -->
                  <div v-if="result.isVideo" class="video-card video-card-thumbnail" @click="openVideoPreview(result)">
                    <video 
                      :src="result.url" 
                      class="video-player"
                      :poster="result.thumbnail"
                      preload="metadata"
                    >
                      謔?逧??剰?亥勣荳肴髪謖????第眺謾?
                    </video>
                    <div class="video-info">
                      <div class="info-item"><strong>譌?髟?:</strong> {{ result.duration }}遘?/div>
                      <div class="info-item"><strong>蛻???邇?</strong> {{ result.resolution }}</div>
                      <div class="info-item"><strong>豈比?:</strong> {{ result.ratio }}</div>
                      <div class="info-item" v-if="result.seed"><strong>遘榊?:</strong> {{ result.seed }}</div>
                    </div>
                    <div class="video-actions">
                      <el-button type="primary" size="small" @click.stop="downloadVideo(result.url)">
                        <el-icon><Download /></el-icon> 荳玖??隗??
                      </el-button>
                    </div>
                  </div>
                  
                  <!-- 蝗?迚??捺棡 -->
                  <ImageCard
                    v-else
                    :src="result.url"
                    :alt="`逕滓?逧?崟迚?${index + 1}`"
                    :prompt="batch.prompt"
                    :title="`逕滓?逧?崟迚?${index + 1}`"
                    :subtitle="formatImageTime(result.timestamp)"
                    :meta="[batch.params.size || imageSize, `${result.index || index + 1}蜿?`]"
                    :badges="getImageBadges(result)"
                    :enable-cache="true"
                    :lazy="true"
                    class="main-card"
                    @click="handleImageClick"
                    @download="handleImageDownload"
                    @add-to-prompts="handleAddToPrompts"
                    @preview="handleImagePreview"
                  />
                </template>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 謠千??隸咲??逅???隸晄? -->
    <PromptManager 
      v-model="showPromptManager" 
      @select-prompt="handleSelectPrompt" 
      @prompts-updated="handleUserPromptsUpdated"
    />

    <!-- 隗??大??逕?謠千??隸咲??逅???隸晄? -->
    <CommonPromptsManager 
      v-model="showVideoPromptsManager" 
      prompt-type="video"
      @prompts-updated="handleVideoCommonPromptsUpdated"
    />


    <!-- 蟶?逕?蜿り?崟邂?逅???隸晄??-->
    <el-dialog v-model="showReferenceManager" width="98%" :close-on-click-modal="false" :show-header="false">
      
      <ReferenceImageManager 
        @select-images="handleReferenceImageSelect"
        @close="handleReferenceImageCancel"
        @images-updated="fetchCommonReferenceImages"
      />
    </el-dialog>

    <!-- 蟶?逕?謠千??隸咲??逅???隸晄? -->
    <CommonPromptsManager 
      v-model="showCommonPromptsManager" 
      @prompts-updated="handleCommonPromptsUpdated" 
    />

    </div> <!-- 蜈?髣? workspace 逧?main-layout -->
  </div>
  
  <!-- 蜈?螻蠑?遯怜玄蝓滂?亥惠main-container荵句?厄??-->
  
  <!-- 邂?逅?遭謗?蛻?蜿?蟇?隸晄??-->
  <el-dialog 
    v-model="showAdminDashboard" 
    title="邂?逅?遭謗?蛻?蜿?" 
    width="95%" 
    :close-on-click-modal="false"
    :show-close="true"
  >
    <AdminDashboard :current-user="currentUser" />
  </el-dialog>

  <!-- 閾?螳壻?牙崟迚????亥??遯?-->
  <div v-if="showImageModal" class="image-modal" @click="closeImageModal">
      <div class="image-modal-content" @click.stop>
        <!-- 蜈?髣?謖蛾聴 -->
        <button class="close-btn" @click="closeImageModal">
          <el-icon><Close /></el-icon>
        </button>
        
        <!-- 蝗?迚???蝎? -->
        <div class="image-container">
          <img 
            :src="currentPreviewImage" 
            :alt="currentPreviewTitle"
            class="preview-image"
            :style="{ transform: `scale(${imageScale}) rotate(${imageRotation}deg)` }"
            @wheel="handleImageWheel"
            @mousedown="startDrag"
            @mousemove="handleDrag"
            @mouseup="endDrag"
            @mouseleave="endDrag"
          />
        </div>
        
        <!-- 謗?蛻?譬?-->
        <div class="image-controls">
          <!-- 蟇?闊?謖蛾聴 -->
          <div class="nav-controls">
            <button 
              class="nav-btn prev-btn" 
              @click="prevImage"
              :disabled="currentImageIndex === 0"
            >
              <el-icon><ArrowLeft /></el-icon>
            </button>
            <span class="image-counter">{{ currentImageIndex + 1 }} / {{ currentBatchImages.length }}</span>
            <button 
              class="nav-btn next-btn" 
              @click="nextImage"
              :disabled="currentImageIndex === currentBatchImages.length - 1"
            >
              <el-icon><ArrowRight /></el-icon>
            </button>
          </div>
          
          <!-- 郛?謾?蜥梧雷霓?謗?蛻?-->
          <div class="zoom-controls">
            <button class="control-btn" @click="zoomOut" title="郛?蟆">
              <el-icon><ZoomOut /></el-icon>
            </button>
            <button class="control-btn" @click="resetZoom" title="驥咲??">
              <el-icon><Refresh /></el-icon>
            </button>
            <button class="control-btn" @click="zoomIn" title="謾?螟?">
              <el-icon><ZoomIn /></el-icon>
            </button>
            <button class="control-btn" @click="rotateLeft" title="蟾?譌玖??>
              <el-icon><RefreshLeft /></el-icon>
            </button>
            <button class="control-btn" @click="rotateRight" title="蜿?譌玖??>
              <el-icon><RefreshRight /></el-icon>
            </button>
          </div>
          
          <!-- 荳玖??謖蛾聴 -->
          <button class="download-btn" @click="downloadCurrentImage" title="荳玖??蠖灘燕蝗?迚">
            <el-icon><Download /></el-icon>
          </button>
          
          <!-- 菫晏?倅??謠千??隸肴潔髓? -->
          <button class="save-prompt-btn" @click="saveCurrentImageAsPrompt" title="菫晏?倅??謠千??隸">
            <el-icon><Document /></el-icon>
            <span>菫晏?俶署遉?隸?/span>
          </button>
        </div>
      </div>
  </div>

  <!-- 隗??鷹???亥??遯 -->
  <div v-if="showVideoModal" class="video-modal" @click="closeVideoModal">
    <div class="video-modal-content" @click.stop>
      <!-- 蜈?髣?謖蛾聴 -->
      <button class="close-btn" @click="closeVideoModal">
        <el-icon><Close /></el-icon>
      </button>
      
      <!-- 隗??大??蝎? -->
      <div class="video-container">
        <video 
          :src="currentPreviewVideo.url" 
          controls 
          autoplay
          class="preview-video"
        >
          謔?逧??剰?亥勣荳肴髪謖????第眺謾?
        </video>
      </div>
      
      <!-- 隗??台??諱? -->
      <div class="video-modal-info">
        <div class="info-row" v-if="currentPreviewVideo.duration">
          <strong>譌?髟?:</strong> {{ currentPreviewVideo.duration }}遘?        </div>
        <div class="info-row" v-if="currentPreviewVideo.resolution">
          <strong>蛻???邇?</strong> {{ currentPreviewVideo.resolution }}
        </div>
        <div class="info-row" v-if="currentPreviewVideo.ratio">
          <strong>豈比?:</strong> {{ currentPreviewVideo.ratio }}
        </div>
      </div>
      
      <!-- 荳玖??謖蛾聴 -->
      <button class="download-btn-video" @click="downloadVideo(currentPreviewVideo.url)" title="荳玖??隗??">
        <el-icon><Download /></el-icon>
        <span>荳玖??隗??</span>
      </button>
    </div>
  </div>
  <!-- 隗??鷹???亥??遯礼?捺據 -->
  
  <!-- 逋?蠖募??遯 -->
  <LoginDialog 
    v-model="showLoginDialog"
    @login-success="handleLoginSuccess"
  />
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, computed, watch } from 'vue'
import { ElMessage, ElMessageBox, ElSwitch } from 'element-plus'
import { Clock, Plus, Picture, Loading, Download, Collection, Close, ArrowLeft, ArrowRight, ZoomOut, ZoomIn, Refresh, RefreshLeft, RefreshRight, MoreFilled, SwitchButton, Document, Edit, VideoPlay, Delete, Check, InfoFilled } from '@element-plus/icons-vue'
import LoginForm from './components/LoginForm.vue'
import Sidebar from './components/Sidebar.vue'
import CommunityHome from './components/CommunityHome.vue'
import LoginDialog from './components/LoginDialog.vue'
import HistoryPanel from './components/HistoryPanel.vue'
import PromptManager from './components/PromptManager.vue'
import ReferenceImageManager from './components/ReferenceImageManager.vue'
import CommonPromptsManager from './components/CommonPromptsManager.vue'
import ImageCard from './components/ImageCard.vue'
import { clearAllUserCache } from './utils/cacheUtils'
import LoadingCard from './components/LoadingCard.vue'
import MultilineTagInput from './components/MultilineTagInput.vue'
import AdminDashboard from './components/AdminDashboard.vue'
import { generateImages, getGenerationResult, getAvailableModels } from './api/imageApi'
import { generateVideo, getVideoResult, getVideoGenerationStatus, getVideoModels } from './api/videoApi'
import { publishWork } from './api/worksApi'

// 隶?隸∫嶌蜈?謨?謐?
const isLoggedIn = ref(false)
const currentUser = ref(null)
const showAdminDashboard = ref(false)

// 譁?蠅橸?夐??髱?霍?逕?蜥檎匳蠖募??遯礼憾諤?const activePage = ref('home') // 'home' | 'workspace' | 'history'
const showLoginDialog = ref(false)
const workspaceInitialParams = ref(null) // 逕?莠惹?髞?蜷梧??蜉溯?
// 蜩榊?泌?乗焚謐?const generationMode = ref('text-to-image')
const prompt = ref('') // 謠千??隸搾?井?晄戟蜷大錘蜈?螳???const promptTags = ref([]) // 謠千??隸肴???謨?扈?const multilineTagInputRef = ref() // 螟夊?梧???霎灘?扈???蠑慕畑

// 隗??第署遉?隸咲嶌蜈?謨?謐?const videoPromptTags = ref([]) // 隗??第署遉?隸肴???謨?扈?const videoMultilineTagInputRef = ref() // 隗??大?夊?梧???霎灘?扈???蠑慕畑
const videoCommonPrompts = ref([]) // 隗??大??逕?謠千??隸榊?陦?const selectedVideoPromptIds = ref(new Set()) // 騾我??逧????大??逕?謠千??隸巧D髮?粋
const videoTagMapping = ref({}) // 隗??第???譏蟆
const showVideoPromptsManager = ref(false) // 隗??第署遉?隸咲??逅?勣譏?遉?迥?諤?const imageSize = ref('1024x1792')
const generateQuantity = ref(1)

// 讓?蝙矩画叫逶?蜈?
const availableModels = ref([])
const selectedModelId = ref(null)

// 隗??醍函謌千嶌蜈?謨?謐?
const videoModels = ref([])
const videoSelectedModelId = ref(null)
const videoModelsLoading = ref(false)
const videoModelsLoaded = ref(false)
const firstFrameFileList = ref([])
const lastFrameFileList = ref([])
const videoAutoDownload = ref(true)
const imageTypes = 'image/jpeg,image/jpg,image/png,image/gif,image/webp'

// 譁?蠅樒噪隗??醍嶌蜈?蜿倬?const firstFrameFile = ref(null)
const firstFramePreview = ref('')
const lastFrameFile = ref(null)
const lastFramePreview = ref('')
const videoDuration = ref(5)
const videoResolution = ref('720p')
const videoRatio = ref('16:9')
const videoWatermark = ref(false)
const videoCameraFixed = ref(false)
const videoReturnLastFrame = ref(false)
const videoSeed = ref(null)
// VEO3荳鍋畑蜿よ焚
const videoEnhancePrompt = ref(true)
// 鬮倡??騾蛾??謚伜匠謗?蛻?
const videoAdvancedExpanded = ref([])
const videoEnableUpsample = ref(false)
// Wan荳鍋畑蜿よ焚
const videoNegativePrompt = ref('')
const videoPromptExtend = ref(false)
const videoSize = ref('1920x1080') // Wan菴?逕?蜈?菴灘?霎?邇?// Sora2荳鍋畑蜿よ焚
const videoHd = ref(false) // HD 鬮俶????蠑
const videoAspectRatio = ref('16:9') // 螳?鬮俶??
// 譬???譏蟆???雎??壼?????譏?遉?譁?悽譏蟆?芦螳樣刔逧?署遉?隸榊?螳?// 霑吩??譏蟆??壻?取焚謐?蠎謎??逧???逕?謠千??隸榊勘諤∵峩譁?const tagMapping = ref({})

// Provider parameter configuration
const providerConfig = {
  doubao: {
    paramType: 'size',
    options: [
      { label: '512x512', value: '512x512' },
      { label: '1024x1024', value: '1024x1024' },
      { label: '1792x1024 (讓?蝗?)', value: '1792x1024' },
      { label: '1024x1792 (遶門崟)', value: '1024x1792' },
      { label: '1488x2079 (遶門崟)', value: '1488x2079' },
      { label: '2048x2048', value: '2048x2048' },
      { label: '2K', value: '2K' }
    ]
  },
  'nano-banana': {
    paramType: 'aspect_ratio',
    options: [
      { label: '1:1', value: '1:1' },
      { label: '4:3', value: '4:3' },
      { label: '3:4', value: '3:4' },
      { label: '16:9', value: '16:9' },
      { label: '9:16', value: '9:16' },
      { label: '2:3', value: '2:3' },
      { label: '3:2', value: '3:2' },
      { label: '4:5', value: '4:5' },
      { label: '5:4', value: '5:4' },
      { label: '21:9', value: '21:9' }
    ]
  },
  qianwen: {
    paramType: 'aspect_ratio',
    options: [
      { label: '1:1', value: '1:1' },
      { label: '21:9', value: '21:9' },
      { label: '16:9', value: '16:9' },
      { label: '4:3', value: '4:3' },
      { label: '3:2', value: '3:2' },
      { label: '2:3', value: '2:3' },
      { label: '3:4', value: '3:4' },
      { label: '9:16', value: '9:16' },
      { label: '9:21', value: '9:21' }
    ]
  },
  kuaishou: {
    paramType: 'aspect_ratio',
    options: [
      { label: '1:1', value: '1:1' },
      { label: '16:9', value: '16:9' },
      { label: '9:16', value: '9:16' },
      { label: '4:3', value: '4:3' },
      { label: '3:4', value: '3:4' },
      { label: '3:2', value: '3:2' },
      { label: '2:3', value: '2:3' }
    ]
  },
  default: {
    paramType: 'aspect_ratio',
    options: [
      { label: '1:1', value: '1:1' },
      { label: '16:9', value: '16:9' },
      { label: '9:16', value: '9:16' }
    ]
  }
}

// Detect provider from model name
const detectProvider = (modelName) => {
  if (!modelName) return 'default'
  const name = modelName.toLowerCase()
  if (name.includes('doubao') || name.includes('seedream')) return 'doubao'
  if (name.includes('nano-banana') || name.includes('gemini')) return 'nano-banana'
  if (name.includes('qwen')) return 'qianwen'
  if (name.includes('kling')) return 'kuaishou'
  return 'default'
}

// Current provider computed property
const currentProvider = computed(() => {
  const model = availableModels.value.find(m => m.id === selectedModelId.value)
  return detectProvider(model?.name)
})

// Current parameter configuration
const currentParamConfig = computed(() => {
  return providerConfig[currentProvider.value] || providerConfig.default
})

// Dynamic image size options based on provider
const dynamicImageSizeOptions = computed(() => {
  return currentParamConfig.value.options
})

// 肌 譁?蠅橸?壽?謐?逕滓?讓?蠑剰????蜿?逕?讓?蝙?const filteredAvailableModels = computed(() => {
  const mode = generationMode.value
  
  // 螯よ棡譏?隗??醍函謌先??蠑擾?瑚?泌屓遨?謨?扈??郁???第怏閾?蟾?逧???蝙句?陦???  if (mode === 'image-to-video') {
    return []
  }
  
  // 霑???讓?蝙具?壼宵譏?遉?謾?謖∝?灘燕讓?蠑冗噪讓?蝙?  return availableModels.value.filter(model => {
    const supportedModes = model.supported_modes || 'both'
    
    // 'both' 陦?遉?蜷梧慮謾?謖∵枚逕溷崟蜥悟崟逕溷?    if (supportedModes === 'both') {
      return true
    }
    
    // 'text-to-image' 蜿?蝨?譁?函蝗?讓?蠑乗仞遉?    if (supportedModes === 'text-to-image' && mode === 'text-to-image') {
      return true
    }
    
    // 'image-to-image' 蜿?蝨?蝗?逕溷崟讓?蠑乗仞遉?    if (supportedModes === 'image-to-image' && mode === 'image-to-image') {
      return true
    }
    
    return false
  })
})

  // 蝗?迚??比?矩蛾?? (菫晉蕗逕?莠主髄蜷主?螳?)
  const imageSizeOptions = ref([
    { label: '1:1', value: '1024x1024' },
    { label: '16:9 (讓?蝗?)', value: '1792x1024' },
    { label: '9:16 (遶門崟)', value: '1024x1792' }
  ])

  // 逕滓?謨?驥城蛾??
  const quantityOptions = ref([
    { label: '1', value: 1 },
    { label: '2', value: 2 },
    { label: '3', value: 3 },
    { label: '4', value: 4 },
    { label: '5', value: 5 },
    { label: '6', value: 6 },
    { label: '7', value: 7 },
    { label: '8', value: 8 }
  ])
const uploadedImages = ref([]) // 謾?荳?謨?扈?髪謖∝?壼?蝗?迚
const generatedImages = ref([]) // 菫晉蕗逕?莠主髄蜷主?螳?
const isGenerating = ref(false)

// 謇?谺?邂?逅???扈滂?域髪謖∝??蜿醍函謌撰?
const generationBatches = ref([]) // 逕滓?謇?谺?謨?扈??梧?丈??謇?谺?蛹?性螟壻??莉?蜉?// 謇?谺?蟇?雎?扈捺桷: {
//   id: string,
//   type: 'image' | 'video',
//   timestamp: Date,
//   status: 'pending' | 'processing' | 'completed' | 'failed',
//   tasks: [...],
//   results: [...],
//   prompt: string,
//   params: {...}
// }
const generationTasks = ref([]) // 菫晉蕗逕?莠主髄蜷主?螳?
const completedTasks = ref(0) // 蟾?螳梧?逧???蜉?謨?驥

// 謖蛾聴蜀?蜊?譌?髣??磯亟豁?隸?隗??
const imageGenerateCooldown = ref(false)
const videoGenerateCooldown = ref(false)
const showHistory = ref(false)
const showPromptManager = ref(false)
const showReferenceManager = ref(false)
const showCommonPromptsManager = ref(false)
const showAddPromptDialog = ref(false)
const activeTab = ref('prompts')
const uploadRef = ref()
const historyPanelRef = ref()
const uploadedFiles = ref([]) // 菫晏?倅?贋?逧?枚莉?蠑慕畑謨?扈?const commonReferenceImages = ref([]) // 蟶?逕?蜿り?崟蛻苓??
const isReferenceIconsCollapsed = ref(false) // 蟶?逕?蜿り?崟謚伜匠迥?諤?const isLoadingReferenceImages = ref(false) // 蟶?逕?蜿り?崟蜉霓?迥?諤?const recentUsedImages = ref([]) // 譛霑台??逕?逧?盾閠?崟
const referenceCategories = ref([
  { id: 'all', name: '蜈?驛?' }
]) // 蜿り?崟蛻???蛻苓??
const SYSTEM_REFERENCE_CATEGORY_NAMES = new Set(['鮟倩??蛻???', '讎帶??蠇?骰貞吏陲?'])
const activeReferenceCategoryId = ref('all') // 蠖灘燕豢?蜉?逧?盾閠?崟蛻???
const commonPrompts = ref([]) // 蟶?逕?謠千??隸榊?陦?const userPrompts = ref([]) // 逕?謌?謠千??隸榊?陦?const userPromptsLoading = ref(false) // 逕?謌?謠千??隸榊刈霓?迥?諤?const selectedCommonPromptIds = ref(new Set()) // 騾我??逧???逕?謠千??隸巧D髮?粋
const isUpdatingFromDelete = ref(false) // 譬???譏?蜷?豁?蝨?莉主唖髯?謫堺?懈峩譁?迥?諤?const autoDownloadEnabled = ref(true) // 閾?蜉?荳玖??蠑蜈?迥?諤??碁?倩??蠑蜷?
// 蜿り?崟諡匁郷蜥梧崛謐?迥?諤?const draggedImageIndex = ref(null) // 豁?蝨?諡匁郷逧?崟迚???蠑?const dropTargetIndex = ref(null) // 諡匁郷逶?譬??咲??邏?蠑
const replacingImageId = ref(null) // 豁?蝨?譖?謐?逧?崟迚⑩D
const draggedCommonImageId = ref(null) // 豁?蝨?諡匁郷逧???逕?蜿り?崟ID

// 蝗?迚????亥??遯礼憾諤?const showImageModal = ref(false)
const currentPreviewImage = ref('')
const currentPreviewTitle = ref('')
const currentImageIndex = ref(0)
const currentViewingBatchId = ref(null) // 蠖灘燕譟?逵狗噪謇?谺?ID
const currentBatchImages = ref([]) // 蠖灘燕謇?谺?逧?崟迚??陦?const imageScale = ref(1)
const imageRotation = ref(0)
const isDragging = ref(false)
const dragStart = ref({ x: 0, y: 0 })
const imagePosition = ref({ x: 0, y: 0 })

// 隗??鷹???育嶌蜈?
const showVideoModal = ref(false)
const currentPreviewVideo = ref({
  url: '',
  duration: '',
  resolution: '',
  ratio: ''
})

// 螟?炊蝗?迚??贋?
const handleImageChange = async (file) => {
  // 鬪瑚?∵枚莉?蟇?雎?
  if (!file || !file.raw) {
    console.error('譌謨育噪譁???蟇?雎?', file)
    ElMessage.error('譁???荳贋?螟?雍??壽裏謨育噪譁???')
    return
  }
  
  // 譽譟?譏?蜷?螟??取崛謐?讓?蠑?  const isReplacing = replacingImageId.value !== null
  const replaceIndex = isReplacing ? uploadedImages.value.findIndex(img => img.id === replacingImageId.value) : -1
  
  if (isReplacing) {
    console.log('[譖?謐?讓?蠑従 譖?謐?蝗?迚⑩D:', replacingImageId.value, '邏?蠑:', replaceIndex)
  }
  
  // 蜈域仞遉?譛?蝨?鬚???  const reader = new FileReader()
  reader.onload = (e) => {
    const tempImageData = {
      id: Date.now() + Math.random(),
      url: e.target.result,
      file: file.raw,
      name: file.name,
      uploading: true // 譬???荳?荳贋?荳?
    }
    
    if (isReplacing && replaceIndex !== -1) {
      // 譖?謐?讓?蠑擾?壽崛謐?謖??壻?咲??逧?崟迚
      uploadedImages.value.splice(replaceIndex, 1, tempImageData)
      uploadedFiles.value.splice(replaceIndex, 1, file.raw)
      console.log('[譖?謐?讓?蠑従 蟾?譖?謐?邏?蠑?, replaceIndex, '逧?崟迚?', file.name)
      replacingImageId.value = null // 貂?勁譖?謐?譬???
    } else {
      // 豺?蜉讓?蠑擾?壽??蜉蛻?譛?蟆?
      uploadedImages.value.push(tempImageData)
    uploadedFiles.value.push(file.raw)
      console.log('[譛?蝨?荳贋?] 豺?蜉荳?譌?鬚??:', file.name)
    }
  }
  reader.readAsDataURL(file.raw)
  
  // 蠑よ??荳贋?蛻?OSS蟷?菫晏?伜芦謨?謐?蠎?  try {
    console.log('[譛?蝨?荳贋?] 蠑蟋倶?贋?蛻?OSS:', file.name)
    const token = localStorage.getItem('token')
    
    if (!token) {
      console.warn('[譛?蝨?荳贋?] 譛?逋?蠖包?瑚??霑??贋?蛻?謨?謐?蠎')
      return
    }
    
    const formData = new FormData()
    formData.append('image', file.raw)
    formData.append('category', 'user-upload') // 逕?謌?荳贋?邀?蛻?
    
    const response = await fetch('/api/reference-images/upload', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    })
    
    if (!response.ok) {
      throw new Error(`荳贋?螟?雍?: ${response.status}`)
    }
    
    const result = await response.json()
    
    if (result.success && result.data) {
      const refImage = result.data
      console.log('[譛?蝨?荳贋?] 荳贋?謌仙粥?栗D:', refImage.id)
      
      // 譖?譁?蝗?迚???諱??梧崛謐?荳?譌?ID荳?謨?謐?蠎的D
      let tempIndex = -1
      if (isReplacing && replaceIndex !== -1) {
        // 譖?謐?讓?蠑擾?壽峩譁?陲?譖?謐?逧?崟迚?        tempIndex = replaceIndex
      } else {
        // 豺?蜉讓?蠑擾?壽衍謇?蛻壽??蜉逧???譌?蝗?迚?        tempIndex = uploadedImages.value.findIndex(img => img.name === file.name && img.uploading)
      }
      
      if (tempIndex !== -1) {
        uploadedImages.value[tempIndex] = {
          id: refImage.id,
          dbId: refImage.id, // 菫晏?俶焚謐?蠎的D
          url: refImage.oss_url || refImage.url,
          file: file.raw,
          name: file.name,
          uploading: false
        }
        console.log('[譛?蝨?荳贋?] 蟾?譖?譁?荳?謨?謐?蠎楢??蠖包?栗D:', refImage.id)
      }
    }
  } catch (error) {
    console.error('[譛?蝨?荳贋?] 荳贋?蛻?OSS螟?雍?:', error)
    // 荳贋?螟?雍?荳榊??蜩堺??逕??御?咲┯蜿?莉?逕?譛?蝨?譁???逕滓?    // 蜿?譏?譌豕穂?晏?伜芦蜴?彰隶?蠖慕噪蜿り?崟蛻苓??
  }
}

// 蛻髯?荳贋?逧?崟迚?const removeImage = (imageId) => {
  const index = uploadedImages.value.findIndex(img => img.id === imageId)
  if (index !== -1) {
    uploadedImages.value.splice(index, 1)
    uploadedFiles.value.splice(index, 1)
  }
}

// 貂???謇譛我?贋?逧?崟迚
const clearAllImages = () => {
  uploadedImages.value = []
  uploadedFiles.value = []
  uploadRef.value?.clearFiles()
}

// 轤?蜃?郛?逡?蝗?譖?謐?蝗?迚?const handleThumbnailClick = (imageId) => {
  console.log('[譖?謐?蝗?迚Ⅹ 轤?蜃?郛?逡?蝗??悟?螟?崛謐?:', imageId)
  replacingImageId.value = imageId
  // 隗?蜿第枚莉?騾画叫蝎?  uploadRef.value?.$el.querySelector('input[type="file"]')?.click()
}

// 蟶?逕?蜿り?崟諡匁郷蠑蟋?const handleCommonImageDragStart = (image, event) => {
  event.dataTransfer.effectAllowed = 'copy'
  event.dataTransfer.setData('common-reference-image-id', image.id.toString())
  draggedCommonImageId.value = image.id
  console.log('[蟶?逕?蜿り?崟諡匁郷蠑蟋犠 蝗?迚⑩D:', image.id, '蜷咲??:', image.originalName)
}

// 諡匁郷蠑蟋?const handleDragStart = (index, event) => {
  draggedImageIndex.value = index
  event.dataTransfer.effectAllowed = 'move'
  event.dataTransfer.setData('text/plain', index.toString())
  console.log('[諡匁郷蠑蟋犠 邏?蠑:', index)
}

// 諡匁郷扈剰?
const handleDragOver = (index, event) => {
  event.preventDefault()
  event.dataTransfer.dropEffect = 'move'
  if (draggedImageIndex.value !== null && draggedImageIndex.value !== index) {
    dropTargetIndex.value = index
  }
}

// 諡匁郷遖?蠑
const handleDragLeave = () => {
  dropTargetIndex.value = null
}

// 謾?鄂?
const handleDrop = (index, event) => {
  event.preventDefault()
  
  // 譽譟?譏?蜷?譏?莉主??逕?蜿り?崟諡匁郷霑?擂逧?  const commonImageId = event.dataTransfer.getData('common-reference-image-id')
  if (commonImageId) {
    console.log('[諡匁郷譖?謐?] 莉主??逕?蜿り?崟譖?謐??檎岼譬???蠑?', index, '蝗?迚⑩D:', commonImageId)
    // 譖?謐?荳?蟶?逕?蜿り?崟
    replaceWithCommonImage(index, commonImageId)
  } else if (draggedImageIndex.value !== null && draggedImageIndex.value !== index) {
    // 驥肴眠謗貞?
    console.log('[諡匁郷謗貞?従 莉守??蠑?, draggedImageIndex.value, '遘?蜉?蛻?, index)
    reorderImages(draggedImageIndex.value, index)
  }
  
  dropTargetIndex.value = null
  draggedImageIndex.value = null
}

// 諡匁郷扈捺據
const handleDragEnd = () => {
  draggedImageIndex.value = null
  dropTargetIndex.value = null
  console.log('[諡匁郷扈捺據] 貂?炊迥?諤?)
}

// 驥肴眠謗貞?丞崟迚
const reorderImages = (fromIndex, toIndex) => {
  console.log('[驥肴眠謗貞?従 莉?, fromIndex, '蛻?, toIndex)
  
  // 驥肴眠謗貞? uploadedImages 謨?扈
  const [movedImage] = uploadedImages.value.splice(fromIndex, 1)
  uploadedImages.value.splice(toIndex, 0, movedImage)
  
  // 驥肴眠謗貞? uploadedFiles 謨?扈 (蜈?髞??壻?晄戟荳拶PI蜿鷹∫噪鬘?蠎丈?閾?
  const [movedFile] = uploadedFiles.value.splice(fromIndex, 1)
  uploadedFiles.value.splice(toIndex, 0, movedFile)
  
  console.log('[驥肴眠謗貞?丞?梧?] 譁?鬘?蠎?', uploadedImages.value.map((img, i) => `${i}: ${img.name}`))
}

// 逕?蟶?逕?蜿り?崟譖?謐?謖??壻?咲??逧?崟迚?const replaceWithCommonImage = async (targetIndex, commonImageId) => {
  try {
    const commonImage = commonReferenceImages.value.find(img => img.id === parseInt(commonImageId))
    if (!commonImage) {
      console.error('[譖?謐?螟?雍?] 謇?荳榊芦蟶?逕?蜿り?崟:', commonImageId)
      return
    }
    
    console.log('[譖?謐?蝗?迚Ⅹ 逕?蟶?逕?蜿り?崟譖?謐?邏?蠑', targetIndex, ':', commonImage.originalName)
    
    // 菴?逕?莉?逅?磁蜿?闔?蜿門崟迚
    const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(commonImage.url)}`
    const response = await fetch(proxyUrl, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const blob = await response.blob()
    const file = new File([blob], commonImage.originalName || commonImage.filename, {
      type: blob.type || 'image/png'
    })
    
    // 譖?謐?謖??壻?咲??逧?崟迚?    const imageData = {
      id: commonImage.id,
      dbId: commonImage.id,
      url: commonImage.url,
      file: file,
      name: commonImage.originalName || commonImage.filename
    }
    
    uploadedImages.value.splice(targetIndex, 1, imageData)
    uploadedFiles.value.splice(targetIndex, 1, file)
    
    console.log('[譖?謐?謌仙粥] 菴咲??', targetIndex, '蟾?譖?謐?荳?:', imageData.name)
    ElMessage.success('蜿り?崟蟾?譖?謐?)
  } catch (error) {
    console.error('[譖?謐?螟?雍?]:', error)
    ElMessage.error('譖?謐?蜿り?崟螟?雍?: ' + error.message)
  }
}

// 隗??醍函謌千嶌蜈?譁?豕
const beforeVideoUpload = (file) => {
  console.log('beforeVideoUpload 陲?隹??', file)
  
  const isValidType = imageTypes.split(',').some(type => file.type === type.trim())
  if (!isValidType) {
    console.log('譁???邀?蝙区裏謨:', file.type)
    ElMessage.error('蜿?謾?謖?JPG縲￣NG縲；IF縲仝ebP 譬?蠑冗噪蝗?迚??')
    return false
  }
  const isLt10M = file.size / 1024 / 1024 < 10
  if (!isLt10M) {
    console.log('譁???霑???:', file.size)
    ElMessage.error('蝗?迚???蟆丈?崎?雜?? 10MB??)
    return false
  }
  
  console.log('譁???鬪瑚??夊???瑚?泌?false 莉?隗?蜿?on-change 莠倶??')
  // 蠖?auto-upload="false" 譌??碁怙隕??泌?false 譚?髦?豁?閾?蜉?荳贋??  // 譁???莨夐夊? on-change 莠倶??螟?炊
  return false
}

const handleVideoFileChange = (file, fileList, type) => {
  console.log('隗??第枚莉?蜿伜喧:', { file, fileList, type })
  
  if (type === 'first') {
    firstFrameFileList.value = fileList
    console.log('鬥門??譁???蛻苓??譖?譁?:', firstFrameFileList.value)
  } else if (type === 'last') {
    lastFrameFileList.value = fileList
    console.log('蟆?蟶?譁???蛻苓??譖?譁?:', lastFrameFileList.value)
  }
}

const handleVideoFileRemove = (file, fileList, type) => {
  if (type === 'first') {
    firstFrameFileList.value = fileList
  } else if (type === 'last') {
    lastFrameFileList.value = fileList
  }
}

const resetVideoForm = () => {
  firstFrameFileList.value = []
  lastFrameFileList.value = []
  videoSelectedModelId.value = null
  videoAutoDownload.value = true
  // 驥咲??譁?蠅樒噪蜿倬?  firstFrameFile.value = null
  firstFramePreview.value = ''
  lastFrameFile.value = null
  lastFramePreview.value = ''
  videoDuration.value = 5
  videoResolution.value = '720p'
  videoRatio.value = '16:9'
  videoWatermark.value = false
  videoCameraFixed.value = false
  videoReturnLastFrame.value = false
  videoSeed.value = null
  // 驥咲??VEO3荳鍋畑蜿よ焚
  videoEnhancePrompt.value = true
  videoEnableUpsample.value = false
  // 驥咲??Wan荳鍋畑蜿よ焚
  videoNegativePrompt.value = ''
  videoPromptExtend.value = false
  videoSize.value = '1920x1080'
  // 豕?諢擾?壻?肴??勁 generationBatches?檎畑謌?髴隕∵焔蜉?貂?勁蜷?音谺?
}

// 螟?炊鬥門??蝗?迚??贋?
const handleFirstFrameUpload = (file) => {
  if (!file.type.startsWith('image/')) {
    ElMessage.error('隸?荳贋?蝗?迚?枚莉?)
    return false
  }
  
  if (file.size > 10 * 1024 * 1024) {
    ElMessage.error('蝗?迚???蟆丈?崎?雜??10MB')
    return false
  }
  
  firstFrameFile.value = file
  const reader = new FileReader()
  reader.onload = (e) => {
    firstFramePreview.value = e.target.result
  }
  reader.readAsDataURL(file)
  return false
}

// 螟?炊蟆?蟶?蝗?迚??贋?
const handleLastFrameUpload = (file) => {
  if (!file.type.startsWith('image/')) {
    ElMessage.error('隸?荳贋?蝗?迚?枚莉?)
    return false
  }
  
  if (file.size > 10 * 1024 * 1024) {
    ElMessage.error('蝗?迚???蟆丈?崎?雜??10MB')
    return false
  }
  
  lastFrameFile.value = file
  const reader = new FileReader()
  reader.onload = (e) => {
    lastFramePreview.value = e.target.result
  }
  reader.readAsDataURL(file)
  return false
}

  const handleVideoGeneration = async () => {
  // 譽譟?蜀?蜊?迥?諤?  if (videoGenerateCooldown.value) {
    ElMessage.warning('隸?遞榊吝?隸包?碁∩蜈埼?醍?∫せ蜃?')
    return
  }
  
  // 闔?蜿冶???第署遉?隸榊?螳?  let promptText = ''
  if (videoMultilineTagInputRef.value) {
    promptText = videoMultilineTagInputRef.value.getFullText()
  } else if (videoPromptTags.value.length > 0) {
    // 螟?畑譁?譯茨?壽焔蜉?螟?炊隗??第???譏蟆?    const mappedTags = videoPromptTags.value.map(tag => videoTagMapping.value[tag] || tag)
    promptText = mappedTags.join(', ')
  } else {
    promptText = prompt.value
  }
  
  console.log('隗??醍函謌仙盾謨?譽譟?', {
    promptText: promptText.trim(),
    videoSelectedModelId: videoSelectedModelId.value,
    firstFrameFile: firstFrameFile.value,
    lastFrameFile: lastFrameFile.value,
    videoDuration: videoDuration.value,
    videoResolution: videoResolution.value,
    videoRatio: videoRatio.value
  })
  
  // 蝓?譛?譽譟??壽署遉?隸阪∵??蝙矩画叫蜥碁?門??蝗?迚?  if (!promptText.trim()) {
    ElMessage.warning('隸?蝪?蜀呎署遉?隸')
    return
  }
  
  if (!videoSelectedModelId.value) {
    ElMessage.warning('隸?騾画叫隗??第??蝙')
    return
  }
  
  // 螯よ棡讓?蝙句????隕??門??蝗?迚??悟?譽譟?譏?蜷?蟾?荳贋??井??mage-to-video讓?蠑丞??????  if (firstFrameRequired.value && !firstFrameFile.value) {
    ElMessage.warning('隸?荳贋?鬥門??蝗?迚?)
    return
  }

  // 蜷?蜉?蜀?蜊?隶?譌?蝎??2遘抵?
  videoGenerateCooldown.value = true
  setTimeout(() => {
    videoGenerateCooldown.value = false
  }, 2000)

  // 蛻帛??譁?謇?谺?  const batchId = `batch_video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  const videoTask = {
    id: `video_task_${Date.now()}`,
    status: 'pending',
    imageUrl: '',
    videoUrl: '',
    index: 1,
    progress: 0,
    isVideo: true
  }
  
  const newBatch = {
    id: batchId,
    type: 'video',
    timestamp: new Date(),
    status: 'pending',
    tasks: [videoTask],
    results: [],
    prompt: promptText.trim(),
    params: {
      modelDbId: videoSelectedModelId.value,
      duration: videoDuration.value,
      resolution: videoResolution.value,
      ratio: videoRatio.value
    }
  }
  
  // 蟆?眠謇?谺?豺?蜉蛻?謨?扈??螟??域怙譁?逧?惠荳企擇?
  generationBatches.value.unshift(newBatch)

  try {
    // 蛻帛??荳荳?pending莉?蜉?蜊?迚??亥?螳?譌?莉?遐???    generationTasks.value = [videoTask]
    
    // 譖?譁?謇?谺?迥?諤∽??螟?炊荳?    newBatch.status = 'processing'
    videoTask.status = 'processing'
    
    // 蜃?????豎よ焚謐?
    const requestData = {
      prompt: promptText.trim(),
      modelDbId: videoSelectedModelId.value, // 菴?逕?謨?謐?蠎的D
      duration: videoDuration.value,
      resolution: videoResolution.value,
      ratio: videoRatio.value,
      watermark: videoWatermark.value,
      camerafixed: videoCameraFixed.value,
      return_last_frame: videoReturnLastFrame.value, // 菴?逕?荳句?郤?蜻?蜷?      seed: videoSeed.value,
      auto_download: videoAutoDownload.value,
      enhance_prompt: videoEnhancePrompt.value, // VEO3荳鍋畑
      enable_upsample: videoEnableUpsample.value, // VEO3荳鍋畑
      negative_prompt: videoNegativePrompt.value, // Wan荳鍋畑?夊?滄擇謠千??隸
      prompt_extend: videoPromptExtend.value, // Wan荳鍋畑?壽署遉?隸埼?蜀
      size: videoSize.value, // Wan荳鍋畑?壼?菴灘?霎?邇
      hd: videoHd.value, // Sora2荳鍋畑?唏D 鬮俶?
      aspect_ratio: videoAspectRatio.value // Sora2荳鍋畑?壼??鬮俶?
    }

    // 譬?謐?荳贋?逧?崟迚?焚驥丞?螳夂函謌千??蝙?    if (firstFrameFile.value && lastFrameFile.value) {
      // 鬥門??蟶?逕滓?      console.log('菴?逕?鬥門??蟶?逕滓?讓?蠑?)
      requestData.firstFrame = firstFrameFile.value
      requestData.lastFrame = lastFrameFile.value
      requestData.generation_type = 'first_last_frame'
    } else if (firstFrameFile.value) {
      // 譎?騾壼盾閠?崟逕滓?
      console.log('菴?逕?鬥門??蜿り?崟逕滓?讓?蠑')
      requestData.firstFrame = firstFrameFile.value
      requestData.generation_type = 'reference'
    } else {
      // 郤?譁?悽逕滓?      console.log('菴?逕?郤?譁?悽逕滓?讓?蠑?)
      requestData.generation_type = 'text_only'
    }

    // 譖?譁?莉?蜉?迥?諤∽??螟?炊荳?    generationTasks.value[0].status = 'processing'
    
    // 隹?畑隗??醍函謌植PI?域署莠?莉?蜉??
    const response = await generateVideo(requestData)
    
    if (response.taskId) {
      // 譬?謐?讓?蝙句柱蜿よ焚譏?遉?荳榊酔逧??牙??署遉?
      let estimatedTime = '3-5蛻?帖';
      if (isSoraModel.value) {
        if (videoHd.value) {
          estimatedTime = '10-15蛻?帖';
        } else if (videoDuration.value === '25') {
          estimatedTime = '5-8蛻?帖';
        } else if (videoDuration.value === '15') {
          estimatedTime = '3-5蛻?帖';
        } else {
          estimatedTime = '1-3蛻?帖';
        }
        ElMessage.success({
          message: `Sora2莉?蜉?蟾?謠蝉????????髴隕?${estimatedTime}?瑚??閠仙???牙?...`,
          duration: 5000
        });
      } else {
        ElMessage.success('隗??醍函謌蝉??蜉?蟾?謠蝉???瑚??遲牙??..');
      }
      
      // 譬?謐?讓?蝙狗??蝙句勘諤???鄂?霓?隸?蜿よ?      let maxAttempts = 60 // 鮟倩??譛螟夊??隸?0谺??5蛻?帖??      const interval = 5000 // 豈?遘呈衍隸?荳谺?      
      // 髓亥??Sora2讓?蝙句?槫刈霓?隸?谺?謨?
      if (isSoraModel.value) {
        if (videoHd.value) {
          // HD讓?蠑擾?夐怙隕??晏??蛻?帖?梧?蜈?郤?2-15蛻?帖
          maxAttempts = 180 // 180谺?* 5遘?= 15蛻?帖
          console.log('[隗??題??隸?] Sora2 HD讓?蠑擾?梧怙螟夊??隸?80谺??育??5蛻?帖??)
        } else if (videoDuration.value === '25') {
          // 25遘呈??蠑擾?夐怙隕∫??8蛻?帖
          maxAttempts = 120 // 120谺?* 5遘?= 10蛻?帖
          console.log('[隗??題??隸?] Sora2 25遘呈??蠑擾?梧怙螟夊??隸?20谺??育??0蛻?帖??)
        } else if (videoDuration.value === '15') {
          // 15遘呈??蠑擾?夐怙隕∫??5蛻?帖
          maxAttempts = 100 // 100谺?* 5遘?= 8.3蛻?帖
          console.log('[隗??題??隸?] Sora2 15遘呈??蠑擾?梧怙螟夊??隸?00谺??育??蛻?帖??)
        } else {
          // 10遘呈??蠑擾?夐怙隕∫??3蛻?帖
          maxAttempts = 80 // 80谺?* 5遘?= 6.7蛻?帖
          console.log('[隗??題??隸?] Sora2 10遘呈??蠑擾?梧怙螟夊??隸?0谺??育??蛻?帖??)
        }
      }
      
      for (let i = 0; i < maxAttempts; i++) {
        await new Promise(resolve => setTimeout(resolve, interval))
        
        try {
          const resultResponse = await getVideoResult(response.taskId)
          console.log(`[隗??題??隸?] 隨?{i + 1}谺?譟?隸?`, {
            status: resultResponse.status,
            hasResult: !!resultResponse.result,
            fullResponse: resultResponse
          })
          
          // 譽譟?螟夂?榊庄閭?逧??蜉溽憾諤?          const isCompleted = resultResponse.status === 'completed' || 
                             resultResponse.status === 'success' ||
                             resultResponse.status === 'SUCCESS'
          
          if (isCompleted && resultResponse.result) {
            const result = resultResponse.result
            
            // 譖?譁?莉?蜉?迥?諤∽??螳梧?
            generationTasks.value[0].status = 'completed'
            generationTasks.value[0].videoUrl = result.url
            generationTasks.value[0].progress = 100
            
            const videoResult = {
              url: result.url,
              isVideo: true,
              thumbnail: result.thumbnail,
              duration: result.duration,
              resolution: result.resolution,
              ratio: result.ratio,
              fps: result.fps,
              seed: result.seed,
              timestamp: new Date().toISOString()
            }
            
            // 蟆????醍?捺棡豺?蜉蛻?逕滓?扈捺棡荳?            generatedImages.value = [videoResult]
            
            // 譖?譁?謇?谺?迥?諤∝柱扈捺棡
            if (newBatch) {
              newBatch.tasks[0].status = 'completed'
              newBatch.tasks[0].videoUrl = result.url
              newBatch.tasks[0].progress = 100
              newBatch.results = [videoResult]
              newBatch.status = 'completed'
              console.log('[謇?谺?譖?譁?] 隗??第音谺?蟾?螳梧?', {
                batchId: newBatch.id,
                status: newBatch.status,
                hasResults: newBatch.results.length > 0
              })
            } else {
              console.warn('[謇?谺?譖?譁?] 隴?蜻奇?壽伽荳榊芦謇?谺?蟇?雎?')
            }
            
            // 菫晏?伜芦蜴?彰隶?蠖?            try {
              await saveToHistoryAutomatically()
              console.log('隗??大紙蜿?隶?蠖募??菫晏??)
            } catch (historyError) {
              console.error('菫晏?倩???大紙蜿?隶?蠖募??雍?:', historyError)
              // 荳榊??蜩堺??豬∫?具?悟宵隶?蠖暮漠隸?
            }
            
            ElMessage.success('隗??醍函謌先?蜉滂??)
            
            // 譬?謐?蠑蜈?迥?諤∝?螳壽弍蜷?閾?蜉?荳玖??            if (autoDownloadEnabled.value && result.url) {
              console.log('[閾?蜉?荳玖??] 隗??醍函謌仙?梧??悟?螟??玖??)
              setTimeout(async () => {
                try {
                  await downloadVideo(result.url, `video_${Date.now()}`)
                  ElMessage.success('隗??大??閾?蜉?荳玖??)
                } catch (downloadError) {
                  console.error('[閾?蜉?荳玖??] 荳玖??螟?雍?:', downloadError)
                }
              }, 1000) // 蟒?霑1遘貞錘閾?蜉?荳玖??
            }
            
            break
          } else if (resultResponse.status === 'failed' || 
                     resultResponse.status === 'FAILED' || 
                     resultResponse.status === 'FAILURE') {
            // 遶句叉譬???莉?蜉?螟?雍?蟷?霍?蜃?蠕?邇?            const errorMessage = resultResponse.error || resultResponse.message || '隗??醍函謌仙??雍?'
            
            generationTasks.value[0].status = 'failed'
            generationTasks.value[0].error = errorMessage
            
            // 譖?譁?謇?谺?迥?諤?            if (newBatch) {
              newBatch.tasks[0].status = 'failed'
              newBatch.tasks[0].error = errorMessage
              newBatch.status = 'failed'
              console.log('[謇?谺?譖?譁?] 隗??第音谺?螟?雍?:', {
                batchId: newBatch.id,
                status: newBatch.status,
                error: errorMessage
              })
            }
            
            ElMessage.error('隗??醍函謌仙??雍??? + errorMessage)
            console.log('[隗??題??隸?] 譽豬句芦螟?雍?迥?諤??悟●豁?霓?隸?')
            return // 逶?謗?霑泌屓?悟●豁?霓?隸?          }
          // 扈?扈?遲牙?...
        } catch (pollError) {
          console.error('譟?隸?隗??醍?捺棡螟?雍?:', pollError)
          // 螯よ棡譏?failed迥?諤∝??閾?逧?漠隸??檎峩謗?謚帛??御?咲??扈?霓?隸?          if (pollError.message && pollError.message.includes('隗??醍函謌仙??雍?')) {
            throw pollError
          }
          // 蜈?莉夜漠隸??亥?ら?醍?憺漠隸??会?悟宵蝨?譛蜷惹?谺?蟆晁?墓慮謚帛?
          if (i === maxAttempts - 1) {
            throw new Error('譟?隸?隗??醍?捺棡雜?慮')
          }
        }
      }
      
      // 螯よ棡蠕?邇?扈捺據莉肴悴螳梧??梧???荳?雜?慮螟?雍?
      if (generationTasks.value.length > 0 && generationTasks.value[0].status !== 'completed') {
        const timeoutMinutes = Math.round((maxAttempts * interval) / 60000)
        console.warn(`[隗??醍函謌疹 霓?隸?雜?慮??{timeoutMinutes}蛻?帖?会?御????蜉?蜿?閭?莉榊惠蜷主床螟?炊`)
        
        let timeoutMessage = `譟?隸?雜?慮?亥??遲牙?${timeoutMinutes}蛻?帖?会?瑚??遞榊錘譟?逵句紙蜿?隶?蠖描
        if (isSoraModel.value) {
          timeoutMessage += '\n謠千???售ora2逕滓?譌?髣?霎?柄?御??蜉?蜿?閭?莉榊惠螟?炊荳?'
        }
        
        generationTasks.value[0].status = 'failed'
        generationTasks.value[0].error = timeoutMessage
        
        if (newBatch) {
          newBatch.tasks[0].status = 'failed'
          newBatch.tasks[0].error = '譟?隸?雜?慮?瑚??遞榊錘譟?逵句紙蜿?隶?蠖'
          newBatch.status = 'failed'
        }
        
        ElMessage.warning('譟?隸?雜?慮?瑚???大庄閭?莉榊惠逕滓?荳??瑚??遞榊錘譟?逵句紙蜿?隶?蠖')
      }
    } else {
      // 譬???莉?蜉?荳?螟?雍?      generationTasks.value[0].status = 'failed'
      generationTasks.value[0].error = response.message || '隗??醍函謌仙??雍?'
      
      // 譖?譁?謇?谺?迥?諤?      if (newBatch) {
        newBatch.tasks[0].status = 'failed'
        newBatch.tasks[0].error = response.message || '隗??醍函謌仙??雍?'
        newBatch.status = 'failed'
      }
      
      ElMessage.error(response.message || '隗??醍函謌仙??雍?')
    }
  } catch (error) {
    console.error('隗??醍函謌仙??雍?:', error)
    
    // 譬???莉?蜉?荳?螟?雍?    if (generationTasks.value.length > 0) {
      generationTasks.value[0].status = 'failed'
      generationTasks.value[0].error = error.message || '譛?遏?髞呵??'
    }
    
    // 譖?譁?謇?谺?迥?諤?    if (newBatch) {
      newBatch.tasks[0].status = 'failed'
      newBatch.tasks[0].error = error.message || '譛?遏?髞呵??'
      newBatch.status = 'failed'
    }
    
    ElMessage.error('隗??醍函謌仙??雍??? + (error.message || '譛?遏?髞呵??'))
  }
}

// 荳玖??隗??
const downloadVideo = async (videoUrl, filename) => {
  try {
    if (!videoUrl) {
      throw new Error('隗??繕RL荳?遨?')
    }
    
    if (!filename) {
      filename = `video_${Date.now()}`
    }
    
    console.log('[荳玖??隗??曽 蠑蟋倶?玖??', { videoUrl, filename })
    ElMessage.info('豁?蝨?蜃????玖??隗??...')
    
    // 蛻?譁?譏?蜷?髴隕?夊????逅??玖??隗??托?碁∩蜈垢ORS髣?鬚
    let fetchUrl = videoUrl
    const fetchOptions = {}
    
    if (needsProxyDownload(videoUrl)) {
      // 菴?逕?莉?逅?磁蜿?驕?蜈垢ORS
      fetchUrl = `/api/proxy-image?url=${encodeURIComponent(videoUrl)}`
      fetchOptions.headers = {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
      console.log('[荳玖??隗??曽 菴?逕?莉?逅??玖??')
    } else {
      console.log('[荳玖??隗??曽 逶?謗?荳玖??')
    }
    
    // 菴?逕?fetch荳玖??隗??第枚莉?
    const response = await fetch(fetchUrl, fetchOptions)
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`)
    }
    
    const blob = await response.blob()
    console.log('[荳玖??隗??曽 闔?蜿烹lob謌仙粥:', { size: blob.size, type: blob.type })
    
    const blobUrl = URL.createObjectURL(blob)
    
    // 蛻帛??荳荳?荳?譌?體?謗?蟷?轤?蜃?螳?    const link = document.createElement('a')
    link.href = blobUrl
    link.download = `${filename}.mp4`
    link.target = '_self'
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    
    // 貂?炊blob URL
    setTimeout(() => {
      URL.revokeObjectURL(blobUrl)
    }, 100)
    
    ElMessage.success('隗??台?玖??謌仙粥')
    return true
  } catch (error) {
    console.error('[荳玖??隗??曽 螟?雍?:', error)
    ElMessage.error('隗??台?玖??螟?雍?: ' + (error.message || '譛?遏?髞呵??'))
    throw error
  }
}

// 螟?炊蟶?逕?蜿り?崟騾画叫
const handleReferenceImageSelect = async (selectedImages) => {
  if (selectedImages && selectedImages.length > 0) {
    // 豺?蜉騾我??逧?崟迚?芦荳贋?蛻苓??
    for (const image of selectedImages) {
      try {
        // 菴?逕?莉?逅?磁蜿?闔?蜿門崟迚??碁∩蜈垢ORS髣?鬚
        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(image.url)}`
        const response = await fetch(proxyUrl, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        
        const blob = await response.blob()
        
        // 遑?菫晄怏豁?遑?逧МIME邀?蝙句柱譁???謇?螻募錐
        let mimeType = blob.type || 'image/png'
        let fileName = image.originalName || image.filename || '蜿り?崟'
        
        // 螯よ棡MIME邀?蝙倶??遨?謌匁裏謨茨?梧?謐?URL謌夜?倩??隶?鄂?荳?png
        if (!mimeType || !mimeType.startsWith('image/')) {
          mimeType = 'image/png'
        }
        
        // 遑?菫晄枚莉?蜷肴怏豁?遑?逧?黄螻募錐
        if (!fileName.includes('.')) {
          const extension = mimeType.split('/')[1] || 'png'
          fileName = `${fileName}.${extension}`
        }
        
        const file = new File([blob], fileName, {
          type: mimeType
        })
        
        const imageData = {
          id: image.id || (Date.now() + Math.random()), // 莨伜?菴?逕?謨?謐?蠎的D
          dbId: image.id, // 菫晏?俶焚謐?蠎的D逕?莠主紙蜿?隶?蠖
          url: image.url,
          file: file,
          name: image.originalName || image.filename
        }
        
        uploadedImages.value.push(imageData)
        uploadedFiles.value.push(file)
      } catch (error) {
        console.error('闔?蜿門盾閠?崟螟?雍?:', error)
        ElMessage.error(`闔?蜿門盾閠?崟 ${image.originalName || image.filename} 螟?雍?`)
      }
    }
    
    showReferenceManager.value = false
    ElMessage.success(`蟾?豺?蜉?${selectedImages.length} 蠑蜿り?崟`)
  }
}

// 蜿匁?亥盾閠?崟騾画叫
const handleReferenceImageCancel = () => {
  showReferenceManager.value = false
}

// 隶?邂怜?樊??壽仞遉?逧?盾閠?崟?域髪謖∝?邀?霑???蜥梧怙霑台??逕?逧?惠蜑搾??const displayedReferenceImages = computed(() => {
  let filteredImages = commonReferenceImages.value
  
  // 謖牙?邀?霑???  if (activeReferenceCategoryId.value !== 'all') {
    filteredImages = commonReferenceImages.value.filter(img => 
      (img.categoryId || 'default') === activeReferenceCategoryId.value
    )
  }
  
  // 蜷亥??譛霑台??逕?逧?崟迚?柱蜈?莉門崟迚??悟悉驥
  const recentIds = recentUsedImages.value.map(img => img.id)
  const otherImages = filteredImages.filter(img => !recentIds.includes(img.id))
  
  const combinedImages = [...recentUsedImages.value, ...otherImages]
  
  // 謚伜匠迥?諤∽?句宵譏?遉?蜑16蠑?  const maxDisplay = isReferenceIconsCollapsed.value ? 16 : combinedImages.length
  
  return combinedImages.slice(0, maxDisplay)
})

// 隶?邂怜?樊??夊執蜿門?灘燕騾画叫逧????第??蝙?const selectedVideoModel = computed(() => {
  if (!videoSelectedModelId.value || videoModels.value.length === 0) {
    return null
  }
  return videoModels.value.find(model => model.id === videoSelectedModelId.value)
})

// 隶?邂怜?樊??壼?灘燕讓?蝙区弍蜷?謾?謖??門??蝗?迚
const supportsFirstFrame = computed(() => {
  return selectedVideoModel.value?.mode === 'image-to-video'
})

// 隶?邂怜?樊??夐?門??蝗?迚?弍蜷?蠢????亥崟逕溯???第??蠑城?門??蠢????
const firstFrameRequired = computed(() => {
  return selectedVideoModel.value?.mode === 'image-to-video'
})

// 隶?邂怜?樊??壼?灘燕讓?蝙区弍蜷?謾?謖∝??蟶?蝗?迚
const supportsLastFrame = computed(() => {
  return selectedVideoModel.value?.features?.supportLastFrame === true
})

// 譽豬区弍蜷?騾我??莠?EO3讓?蝙
const isVeoModel = computed(() => {
  if (!videoSelectedModelId.value || !videoModels.value.length) {
    return false
  }
  const selectedModel = videoModels.value.find(m => m.id === videoSelectedModelId.value)
  return selectedModel?.provider === 'google'
})

// 譽豬区弍蜷?騾我??莠???桁讓?蝙?const isDoubaoModel = computed(() => {
  if (!videoSelectedModelId.value || !videoModels.value.length) {
    return false
  }
  const selectedModel = videoModels.value.find(m => m.id === videoSelectedModelId.value)
  return selectedModel?.provider === 'doubao'
})

// 譽豬区弍蜷?騾我??莠?仭驥係an讓?蝙
const isWanModel = computed(() => {
  if (!videoSelectedModelId.value || !videoModels.value.length) {
    return false
  }
  const selectedModel = videoModels.value.find(m => m.id === videoSelectedModelId.value)
  return selectedModel?.provider === 'ali'
})

const isSoraModel = computed(() => {
  if (!videoSelectedModelId.value || !videoModels.value.length) {
    return false
  }
  const selectedModel = videoModels.value.find(m => m.id === videoSelectedModelId.value)
  return selectedModel?.provider === 'sora'
})

const isSoraPro = computed(() => {
  if (!videoSelectedModelId.value || !videoModels.value.length) {
    return false
  }
  const selectedModel = videoModels.value.find(m => m.id === videoSelectedModelId.value)
  return selectedModel?.model_id === 'sora-2-pro'
})

// 逶大成隗??第??蝙句?謐??瑚?蜉?隶?鄂?Sora2 逧??倩??蜿よ?watch(videoSelectedModelId, (newModelId) => {
  if (!newModelId || !videoModels.value.length) return
  
  const selectedModel = videoModels.value.find(m => m.id === newModelId)
  if (selectedModel?.provider === 'sora') {
    console.log('[App.vue] 蛻?困蛻?Sora2 讓?蝙具?瑚??鄂?鮟倩??蜿よ?)
    // Sora2 鮟倩??蜿よ焚
    videoDuration.value = 10 // Sora2 譛蟆乗慮髟?譏? 10 遘?    videoAspectRatio.value = '16:9'
    videoHd.value = false
  } else {
    // 蜈?莉匁??蝙狗噪鮟倩??蜿よ?    if (videoDuration.value === 10 && selectedModel?.provider !== 'sora') {
      videoDuration.value = 5 // 諱?螟埼?倩?? 5 遘?    }
  }
})

// 譽譟?譏?蜷?譛牙崟迚?音谺?豁?蝨?螟?炊
const hasProcessingImageBatch = computed(() => {
  return generationBatches.value.some(
    batch => batch.type === 'image' && (batch.status === 'pending' || batch.status === 'processing')
  )
})

// 譽譟?譏?蜷?譛芽???第音谺?豁?蝨?螟?炊
const hasProcessingVideoBatch = computed(() => {
  const hasProcessing = generationBatches.value.some(
    batch => batch.type === 'video' && (batch.status === 'pending' || batch.status === 'processing')
  )
  
  return hasProcessing
})

// 譽譟?譏?蜷?譛我??菴募?梧?逧??捺棡?亥桁諡?驛?蛻??梧???const hasAnyResults = computed(() => {
  return generationBatches.value.some(
    batch => (batch.status === 'completed' || batch.status === 'partial') && batch.results && batch.results.length > 0
  )
})

// 逶第而隗??第音谺?迥?諤∝序蛹厄?育畑莠手???包??watch(
  () => generationBatches.value.filter(b => b.type === 'video'),
  (newVideoBatches, oldVideoBatches) => {
    if (newVideoBatches.length > 0) {
      console.log('[謇?谺?逶第而] 隗??第音谺?迥?諤?', newVideoBatches.map(b => ({
        id: b.id.substring(0, 20) + '...',
        status: b.status,
        tasksStatus: b.tasks.map(t => t.status),
        hasResults: b.results.length
      })))
      console.log('[謇?谺?逶第而] hasProcessingVideoBatch =', hasProcessingVideoBatch.value)
    }
  },
  { deep: true }
)

// Watch for model selection changes and update imageSize based on provider
watch(selectedModelId, (newModelId) => {
  if (!newModelId) return
  
  const config = currentParamConfig.value
  if (config.options.length > 0) {
    // Try to find a matching default value or use the first option
    const defaultOption = config.options.find(opt => 
      opt.value === '1:1' || opt.value === '1024x1024'
    ) || config.options[0]
    
    imageSize.value = defaultOption.value
    
    console.log('[讓?蝙句?謐?] 譖?譁?蜿よ焚驟咲??:', {
      provider: currentProvider.value,
      paramType: config.paramType,
      newSize: imageSize.value
    })
  }
})

// 肌 譁?蠅橸?夂尅蜷?逕滓?讓?蠑丞序蛹厄?瑚?蜉?蛻?困蛻?謾?謖∫噪讓?蝙
watch(generationMode, (newMode) => {
  // 螯よ棡譏?隗??第??蠑擾?御?埼怙隕∝??炊蝗?蜒乗??蝙?  if (newMode === 'image-to-video') {
    return
  }
  
  // 譽譟?蠖灘燕騾我??逧???蝙区弍蜷?謾?謖∵眠讓?蠑
  const currentModel = availableModels.value.find(m => m.id === selectedModelId.value)
  if (!currentModel) {
    return
  }
  
  const supportedModes = currentModel.supported_modes || 'both'
  const isSupported = supportedModes === 'both' || supportedModes === newMode
  
  if (!isSupported) {
    // 蠖灘燕讓?蝙倶?肴髪謖∵眠讓?蠑擾?悟?謐?蛻?隨?荳荳?謾?謖∫噪讓?蝙
    const filteredModels = filteredAvailableModels.value
    if (filteredModels.length > 0) {
      // 莨伜?騾画叫鮟倩??讓?蝙
      const defaultModel = filteredModels.find(m => m.is_default)
      selectedModelId.value = defaultModel ? defaultModel.id : filteredModels[0].id
      
      console.log('[讓?蠑丞?謐?] 閾?蜉?蛻?困讓?蝙:', {
        mode: newMode,
        oldModel: currentModel.name,
        newModel: availableModels.value.find(m => m.id === selectedModelId.value)?.name
      })
    }
  }
})

// 隗??醍函謌占??邂怜?樊?const videoCanGenerate = computed(() => {
  // 逶?謗?莉手????MultilineTagInput 扈???闔?蜿匁署遉?隸榊?螳?  let promptText = ''
  if (videoMultilineTagInputRef.value) {
    promptText = videoMultilineTagInputRef.value.getFullText()
  } else if (videoPromptTags.value.length > 0) {
    // 螟?畑譁?譯茨?壽焔蜉?螟?炊隗??第???譏蟆?    const mappedTags = videoPromptTags.value.map(tag => videoTagMapping.value[tag] || tag)
    promptText = mappedTags.join(', ')
  } else {
    promptText = prompt.value
  }
  
  const promptValid = promptText.trim()
  const modelSelected = videoSelectedModelId.value
  const hasFirstFrame = firstFrameFile.value !== null
  
  // 譽譟?蝓?譛?譚?莉??壽怏謠千??隸阪?画叫莠???蝙?  // 螯よ棡讓?蝙句????隕??門??蝗?迚??井??mage-to-video讓?蠑擾?会?悟?霑倩?∵?譟?譏?蜷?譛蛾?門??蝗?迚
  let canGenerate = promptValid && modelSelected
  if (firstFrameRequired.value && canGenerate) {
    canGenerate = canGenerate && hasFirstFrame
  }
  
  console.log('videoCanGenerate 隸?扈?憾諤?', {
    promptText,
    promptValid,
    videoSelectedModelId: videoSelectedModelId.value,
    modelSelected,
    hasFirstFrame,
    canGenerate,
    videoModels: videoModels.value.length,
    videoModelsLoaded: videoModelsLoaded.value
  })
  
  return canGenerate
})


// 蛻?困蜿り?崟謚伜匠迥?諤?const toggleReferenceIconsCollapse = () => {
  isReferenceIconsCollapsed.value = !isReferenceIconsCollapsed.value
}

// 隶?鄂?豢?蜉?逧?盾閠?崟蛻???
const setActiveReferenceCategory = (categoryId) => {
  activeReferenceCategoryId.value = categoryId
}


// 闔?蜿門盾閠?崟蛻???蝗?迚?焚驥
const getReferenceCategoryImageCount = (categoryId) => {
  if (categoryId === 'all') {
    return commonReferenceImages.value.length
  }
  return commonReferenceImages.value.filter(img => 
    (img.categoryId || 'default') === categoryId
  ).length
}

// 闔?蜿門盾閠?崟蛻???蛻苓??
const fetchReferenceCategories = async () => {
  try {
    const token = localStorage.getItem('token')
    if (!token) return

    const response = await fetch('/api/reference-image-categories', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    if (response.ok) {
      const data = await response.json()
      const userCats = Array.isArray(data) ? data : []
      const filteredCategories = userCats.filter(category => {
        const name = (category.name || '').trim()
        return name && !SYSTEM_REFERENCE_CATEGORY_NAMES.has(name)
      })
      referenceCategories.value = [
        { id: 'all', name: '蜈?驛?' },
        ...filteredCategories
      ]
      if (!referenceCategories.value.some(category => category.id === activeReferenceCategoryId.value)) {
        activeReferenceCategoryId.value = 'all'
      }
    }
  } catch (error) {
    console.error('闔?蜿門盾閠?崟蛻???螟?雍?:', error)
  }
}

// 闔?蜿門??逕?蜿り?崟蛻苓??
const fetchCommonReferenceImages = async () => {
  try {
    isLoadingReferenceImages.value = true // 蠑蟋句刈霓?    const token = localStorage.getItem('token')
    if (!token) {
      console.log('譛?逋?蠖包?梧裏豕戊執蜿門盾閠?崟')
      return
    }

    const response = await fetch('/api/reference-images', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    if (response.ok) {
      const data = await response.json()
      const images = Array.isArray(data) ? data : (data.images || [])
      
      // 謖画怙霑台??逕?譌?髣?謗貞??      commonReferenceImages.value = images.sort((a, b) => {
        const aLastUsed = localStorage.getItem(`lastUsed_${a.id}`) || 0
        const bLastUsed = localStorage.getItem(`lastUsed_${b.id}`) || 0
        return bLastUsed - aLastUsed
      })
      
      // 譖?譁?譛霑台??逕?逧?崟迚??陦?
      updateRecentUsedImages()
      
      // 蜷梧慮闔?蜿門?邀?蛻苓??
      await fetchReferenceCategories()
    }
  } catch (error) {
    console.error('闔?蜿門??逕?蜿り?崟螟?雍?:', error)
  } finally {
    isLoadingReferenceImages.value = false // 蜉霓?螳梧?
  }
}

// 譖?譁?譛霑台??逕?逧?崟迚??陦?
const updateRecentUsedImages = () => {
  const recentIds = []
  const recentImages = []
  
  // 莉四ocalStorage闔?蜿匁怙霑台??逕?逧?崟迚⑩D
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i)
    if (key && key.startsWith('lastUsed_')) {
      const imageId = key.replace('lastUsed_', '')
      recentIds.push({ id: imageId, timestamp: parseInt(localStorage.getItem(key)) })
    }
  }
  
  // 謖画慮髣?謗貞?擾?悟叙蜑8荳?  recentIds.sort((a, b) => b.timestamp - a.timestamp)
  const topRecentIds = recentIds.slice(0, 8).map(item => item.id)
  
  // 莉主??逕?蜿り?崟荳?謇?蛻?蟇?蠎皮噪蝗?迚
  topRecentIds.forEach(id => {
    const image = commonReferenceImages.value.find(img => img.id === id)
    if (image) {
      recentImages.push(image)
    }
  })
  
  recentUsedImages.value = recentImages
}

// 轤?蜃?蟶?逕?蜿り?崟蝗?譬??蜉?鄂?蜈?
const insertCommonReferenceImage = async (image) => {
  try {
    // 菴?逕?莉?逅?磁蜿?闔?蜿門崟迚??碁∩蜈垢ORS髣?鬚
    const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(image.url)}`
    const response = await fetch(proxyUrl, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const blob = await response.blob()
    
    // 遑?菫晄怏豁?遑?逧МIME邀?蝙句柱譁???謇?螻募錐
    let mimeType = blob.type || 'image/png'
    let fileName = image.originalName || image.filename || '蜿り?崟'
    
    // 螯よ棡MIME邀?蝙倶??遨?謌匁裏謨茨?梧?謐?URL謌夜?倩??隶?鄂?荳?png
    if (!mimeType || !mimeType.startsWith('image/')) {
      mimeType = 'image/png'
    }
    
    // 遑?菫晄枚莉?蜷肴怏豁?遑?逧?黄螻募錐
    if (!fileName.includes('.')) {
      const extension = mimeType.split('/')[1] || 'png'
      fileName = `${fileName}.${extension}`
    }
    
    const file = new File([blob], fileName, {
      type: mimeType
    })
    
    const imageData = {
      id: image.id || (Date.now() + Math.random()), // 莨伜?菴?逕?謨?謐?蠎的D
      dbId: image.id, // 菫晏?俶焚謐?蠎的D逕?莠主紙蜿?隶?蠖
      url: image.url,
      file: file,
      name: image.originalName || image.filename
    }
    
    uploadedImages.value.push(imageData)
    uploadedFiles.value.push(file)
    
    // 隶?蠖穂??逕?譌?髣?
    localStorage.setItem(`lastUsed_${image.id}`, Date.now().toString())
    updateRecentUsedImages()
    
    ElMessage.success('蜿り?崟蟾?豺?蜉?)
  } catch (error) {
    console.error('豺?蜉蜿り?崟螟?雍?:', error)
    ElMessage.error('豺?蜉蜿り?崟螟?雍?')
  }
}

// 闔?蜿門庄逕?讓?蝙句?陦?
const fetchAvailableModels = async () => {
  try {
    const response = await getAvailableModels()
    if (response.success) {
      availableModels.value = response.data.models
      
      // 隶?鄂?鮟倩??讓?蝙
      const defaultModel = availableModels.value.find(model => model.is_default)
      if (defaultModel) {
        selectedModelId.value = defaultModel.id
      } else if (availableModels.value.length > 0) {
        selectedModelId.value = availableModels.value[0].id
      }
    }
  } catch (error) {
    console.error('闔?蜿匁??蝙句?陦?螟?雍?:', error)
    ElMessage.error('闔?蜿匁??蝙句?陦?螟?雍?')
  }
}

// 闔?蜿冶???第??蝙句?陦?
const fetchVideoModels = async () => {
  try {
    console.log('蠑蟋玖執蜿冶???第??蝙句?陦?..')
    console.log('蠖灘燕隶?隸∫憾諤?', {
      isLoggedIn: isLoggedIn.value,
      token: localStorage.getItem('token') ? '蟄伜惠' : '荳榊?伜?
    })
    
    videoModelsLoading.value = true
    const response = await getVideoModels()
    console.log('隗??第??蝙帰PI蜩榊?:', response)
    
    if (response.success) {
      videoModels.value = response.models
      videoModelsLoaded.value = true
      console.log('隗??第??蝙句?陦?:', videoModels.value)
      
      // 隶?鄂?鮟倩??隗??第??蝙
      const defaultModel = videoModels.value.find(model => model.is_default)
      if (defaultModel) {
        videoSelectedModelId.value = defaultModel.id
        console.log('隶?鄂?鮟倩??隗??第??蝙:', defaultModel, 'ID:', defaultModel.id)
      } else if (videoModels.value.length > 0) {
        videoSelectedModelId.value = videoModels.value[0].id
        console.log('隶?鄂?隨?荳荳?隗??第??蝙?', videoModels.value[0], 'ID:', videoModels.value[0].id)
      }
      
      console.log('譛扈?videoSelectedModelId:', videoSelectedModelId.value)
    } else {
      console.error('隗??第??蝙帰PI霑泌屓螟?雍?:', response)
      ElMessage.warning('隗??第??蝙句刈霓?螟?雍??瑚??遞榊錘驥崎?')
    }
  } catch (error) {
    console.error('闔?蜿冶???第??蝙句?陦?螟?雍?:', error)
    // 荳榊?謚帛?髞呵???碁∩蜈榊??蜩埼??髱?蜉霓?    // 蜿?譏?遉?隴?蜻奇?瑚??逕?謌?扈?扈?菴?逕?蜈?莉門粥閭?    if (error.message && !error.message.includes('401')) {
      ElMessage.warning('隗??第??蝙区嘯譌?譌豕募刈霓??悟?莉門粥閭?豁?蟶?菴?逕?)
    }
    console.error('髞呵??隸?諠:', {
      message: error.message,
      response: error.response?.data,
      status: error.response?.status
    })
  } finally {
    videoModelsLoading.value = false
  }
}

// 讓?蝙矩画叫蜿伜喧螟?炊
const onModelChange = (modelId) => {
  const selectedModel = availableModels.value.find(model => model.id === modelId)
  if (selectedModel) {
    ElMessage.success(`蟾?騾画叫讓?蝙: ${selectedModel.name}`)
  }
}

// 逕滓?蝗?迚
const generateImage = async () => {
  // 譽譟?蜀?蜊?迥?諤?  if (imageGenerateCooldown.value) {
    ElMessage.warning('隸?遞榊吝?隸包?碁∩蜈埼?醍?∫せ蜃?')
    return
  }
  
  // 闔?蜿門?梧紛逧?署遉?隸榊?螳??亥桁諡?譬???譏蟆?柱霎灘?譁?悽??  let finalPrompt = ''
  
  if (multilineTagInputRef.value) {
    // 菴?逕?扈???逧?etFullText譁?豕戊執蜿門?梧紛蜀???
    finalPrompt = multilineTagInputRef.value.getFullText()
  } else if (promptTags.value.length > 0) {
    // 螟?畑譁?譯茨?壽焔蜉?螟?炊譬???譏蟆?    const mappedTags = promptTags.value.map(tag => tagMapping.value[tag] || tag)
    finalPrompt = mappedTags.join(', ')
  } else {
    finalPrompt = prompt.value
  }
  
  // 譽譟?謠千??隸肴弍蜷?荳?遨?
  if (!finalPrompt.trim()) {
    ElMessage.warning('隸?霎灘?謠千??隸')
    return
  }

  if (generationMode.value === 'image-to-image' && uploadedImages.value.length === 0) {
    ElMessage.warning('隸?荳贋?蜿り?崟迚?)
    return
  }

  // 蜷?蜉?蜀?蜊?隶?譌?蝎??2遘抵?
  imageGenerateCooldown.value = true
  setTimeout(() => {
    imageGenerateCooldown.value = false
  }, 2000)

  // 蛻帛??譁?謇?谺?  const batchId = `batch_img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  const taskCount = generateQuantity.value
  const tasks = []
  
  // 荳?豈丈??莉?蜉?蛻帛??蜊菴咲??
  for (let i = 0; i < taskCount; i++) {
    tasks.push({
      id: `task_${Date.now()}_${i}`,
      status: 'pending', // pending, processing, completed, failed
      imageUrl: '',
      index: i + 1,
      progress: 0,
      downloaded: false // 蛻晏?句喧荳玖??譬???    })
  }
  
  const newBatch = {
    id: batchId,
    type: 'image',
    timestamp: new Date(),
    status: 'pending',
    tasks: tasks,
    results: [],
    prompt: finalPrompt,
    params: {
      size: imageSize.value,
      quantity: generateQuantity.value,
      mode: generationMode.value,
      modelId: selectedModelId.value
    }
  }
  
  // 蟆?眠謇?谺?豺?蜉蛻?謨?扈??螟??域怙譁?逧?惠荳企擇?
  generationBatches.value.unshift(newBatch)
  
  // 隶?鄂?蜈?螳?蜿倬??育畑莠主紙蜿?隶?蠖穂?晏?倡?牙粥閭???  generatedImages.value = []
  completedTasks.value = 0
  generationTasks.value = tasks

  try {
    console.log('蜿鷹∫?僊I逧??梧紛謠千??隸:', finalPrompt)
    
    // 霑???謗疫ndefined蜥系ull蛟?    const validFiles = uploadedFiles.value.filter(file => file !== undefined && file !== null)
    console.log('蜴溷?丘ploadedFiles:', uploadedFiles.value)
    console.log('霑???蜷守噪validFiles:', validFiles)
    
    const result = await generateImages({
      prompt: finalPrompt,
      size: imageSize.value,
      paramType: currentParamConfig.value.paramType,
      quantity: generateQuantity.value,
      mode: generationMode.value,
      modelId: selectedModelId.value,
      images: validFiles // 莨騾定????蜷守噪蝗?迚?    })

    console.log('逕滓?莉?蜉?謠蝉??扈捺棡:', result)
    
    // 譖?譁?謇?谺?迥?諤∽??螟?炊荳?    const batch = generationBatches.value.find(b => b.id === batchId)
    if (batch) {
      batch.status = 'processing'
    }
    
    if (result.taskId) {
      // 霓?隸?譟?隸?扈捺棡?御?蜈?謇?谺?ID
      await pollGenerationResult(result.taskId, batchId)
    } else {
      throw new Error('莉?蜉?謠蝉??螟?雍?')
    }
    
  } catch (error) {
    console.error('逕滓?蝗?迚???雍?:', error)
    
    // 譬???謇譛我??蜉?荳?螟?雍?
    generationTasks.value.forEach(task => {
      task.status = 'failed'
      task.error = error.message || '譛?遏?髞呵??'
    })
    
    // 譖?譁?謇?谺?迥?諤∽??螟?雍?
    const batch = generationBatches.value.find(b => b.id === batchId)
    if (batch) {
      batch.status = 'failed'
      batch.tasks.forEach(task => {
        task.status = 'failed'
        task.error = error.message || '譛?遏?髞呵??'
      })
    }
    
    // 譏?遉?髞呵??豸域?
    ElMessage.error('逕滓?蝗?迚???雍?: ' + (error.message || '譛?遏?髞呵??'))
  }
}

// 霓?隸?譟?隸?逕滓?扈捺棡 - 菴?逕?貂占?帛?城驕?遲也払莨伜喧諤?閭?
const pollGenerationResult = async (taskId, batchId = null) => {
  const maxAttempts = 120 // 蜃丞?大?20谺??梧怙螟夂??9蛻?帖
  let lastStatus = null
  
  // 貂占?帛?城驕?遲也払?壽?謐?蟆晁?墓??謨?蜉?諤???紛霓?隸?髣?髫?  const getPollingInterval = (attemptCount) => {
    if (attemptCount <= 10) return 2000   // 蜑?0谺??亥?0遘抵?会?壽?2遘呈衍隸??悟??騾溷桃蠎?    if (attemptCount <= 30) return 3000   // 10-30谺??20遘?1.5蛻?帖?会?壽??遘?    if (attemptCount <= 60) return 5000   // 30-60谺??1.5-4蛻?帖?会?壽??遘?    return 10000                          // 60谺?蜷趣??蛻?帖+?会?壽??0遘抵?悟?霓?譛榊苅蝎?蜴句?  }
  
  // 譟?謇?蟇?蠎皮噪謇?谺?  const batch = batchId ? generationBatches.value.find(b => b.id === batchId) : null
  
  for (let i = 0; i < maxAttempts; i++) {
    try {
      const result = await getGenerationResult(taskId)
      const currentInterval = getPollingInterval(i + 1)
      console.log(`譟?隸?扈捺棡 (${i + 1}/${maxAttempts}, 髣?髫${currentInterval/1000}遘?:`, result)
      
      // 螯よ棡迥?諤∝書逕溷序蛹厄?瑚??蠖墓律蠢
      if (result.status !== lastStatus) {
        console.log(`莉?蜉?迥?諤∝序蛹? ${lastStatus} -> ${result.status}`)
        lastStatus = result.status
      }
      
      if (result.status === 'completed' || result.status === 'partial') {
        // 逕滓?螳梧?謌夜Κ蛻??梧??悟??炊扈捺棡
        const images = result.results || []
        const processedImages = []
        const successCount = result.successCount || images.length
        const totalCount = result.totalCount || images.length
        
        console.log('逕滓?螳梧??悟??炊扈捺?', images)
        console.log(`謌仙粥: ${successCount}/${totalCount}`)
        
        // 肌 菫?螟搾?夂峩謗?譖?譁?謇?谺?逧???蜉??碁∩蜈堺??逕?蜈?螻蜿倬?蟇?閾?謇?谺?豺?豺
        const targetTasks = batch ? batch.tasks : generationTasks.value
        
        // 譖?譁?莉?蜉?迥?諤?        for (let j = 0; j < images.length; j++) {
          const image = images[j]
          const taskIndex = j
          
          if (taskIndex < targetTasks.length) {
            if (image.url && !image.error) {
              // 謌仙粥逧?崟迚?              targetTasks[taskIndex].status = 'completed'
              targetTasks[taskIndex].imageUrl = image.url
              targetTasks[taskIndex].progress = 100
              
              // 豺?蜉蛻?螟?炊扈捺棡荳?
              processedImages.push({
                url: image.url,
                index: image.index,
                timestamp: image.timestamp
              })
            } else {
              // 螟?雍?逧?崟迚?              targetTasks[taskIndex].status = 'failed'
              targetTasks[taskIndex].error = image.error || '逕滓?螟?雍?'
            }
          }
        }
        
        // 譬???蜑?菴吩??蜉?荳?螟?雍??亥?よ棡譛臥噪隸晢?
        for (let k = images.length; k < targetTasks.length; k++) {
          targetTasks[k].status = 'failed'
          targetTasks[k].error = '莉?蜉?譛?謇?陦?
        }
        
        // 螯よ棡譛画音谺??梧峩譁?謇?谺?迥?諤∝柱扈捺棡
        if (batch) {
          // 譖?譁?謇?谺?扈捺棡
          batch.results = processedImages
          
          // 蜿?譛牙?楢?呎弍譛譁?逧?音谺?譌??梧燕蜷梧??蛻?蜈?螻蜿倬??亥髄蜷主?螳??
          const isLatestBatch = generationBatches.value[0]?.id === batchId
          if (isLatestBatch) {
        generatedImages.value = processedImages
        completedTasks.value = processedImages.length
            generationTasks.value = targetTasks
          }
          
          // 笨?譬?謐?螳樣刔扈捺棡隶?鄂?謇?谺?迥?諤?          if (result.status === 'partial') {
            batch.status = 'partial' // 驛?蛻??蜉
          } else if (processedImages.length === 0) {
            batch.status = 'failed' // 蜈?驛?螟?雍?
          } else {
            batch.status = 'completed' // 蜈?驛?謌仙粥
          }
          
          console.log(`[謇?谺?譖?譁?] 謇?谺?迥?諤? ${batch.status}, 謌仙粥: ${processedImages.length}/${totalCount}`)
        } else {
          // 豐?譛画音谺?譌??亥髄蜷主?螳?譌?莉?遐??
          generatedImages.value = processedImages
          completedTasks.value = processedImages.length
        }
        
        // 笨?菫?螟搾?壻?榊?閾?蜉?菫晏?伜紙蜿?隶?蠖包?悟錘遶?蟾?扈丞惠逕滓?譌?蛻帛??蟷?譖?譁?莠?紙蜿?隶?蠖
        // 蛻?譁?蜴?彰隶?蠖募?陦?莉?譏?遉?蜷守??蛻帛??逧???蠖
        if (historyPanelRef.value?.loadHistoryFromServer) {
          // 蟒?霑溷姐譁??瑚??蜷守??譛画慮髣?螳梧?蜴?彰隶?蠖慕噪菫晏?
          setTimeout(() => {
            historyPanelRef.value.loadHistoryFromServer(true) // 蠑?蛻?蛻?譁?
          }, 1000)
        }
        
        // 譬?謐?扈捺棡譏?遉?荳榊酔逧??域?        if (result.status === 'completed') {
          ElMessage.success(`謌仙粥逕滓?${processedImages.length}蠑蝗?迚??～)
        } else {
          ElMessage.warning(`驛?蛻?函謌仙?梧??壽?蜉?{processedImages.length}蠑?悟??雍?${totalCount - processedImages.length}蠑`)
        }
        
        // 笨?螳梧?譌?逧??蜉?荳玖???壼宵荳玖??蠖灘燕謇?谺?荳?霑俶悴荳玖??逧?崟迚
        // 豕?諢擾?壼惠霓?隸?霑??倶??蟾?扈城蝉??荳玖??莠??梧?逧?崟迚??瑚?咎代蜿?螟?炊驕玲?冗噪諠??        if (autoDownloadEnabled.value && processedImages.length > 0 && batch) {
          setTimeout(async () => {
            let downloadCount = 0
            for (let i = 0; i < batch.tasks.length; i++) {
              const task = batch.tasks[i]
              // 蜿?荳玖??蟾?螳梧?菴??俶悴荳玖??逧?崟迚
              if (task.status === 'completed' && task.imageUrl && !task.downloaded) {
                task.downloaded = true // 譬???荳?蟾?荳玖??
                try {
                  const result = processedImages.find(img => img.index === task.index)
                  if (result && result.url) {
                    const downloadUrl = result.url
                    // 譬?謐?URL邀?蝙矩画叫荳玖??譁?蠑擾?碁∩蜈垢ORS髣?鬚
                    const response = await fetch(
                      needsProxyDownload(downloadUrl)
                        ? `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
                        : downloadUrl,
                      needsProxyDownload(downloadUrl) ? {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                      } : {}
                    )
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`)
                    
                    const blob = await response.blob()
                    if (!blob.type.startsWith('image/')) throw new Error('荳肴弍譛画譜逧?崟迚?枚莉?)
                    
                    const blobUrl = URL.createObjectURL(blob)
                    const link = document.createElement('a')
                    link.href = blobUrl
                    link.download = `逕滓?逧?崟迚?${task.index}.png`
                    link.target = '_self'
                    document.body.appendChild(link)
                    link.click()
                    document.body.removeChild(link)
                    URL.revokeObjectURL(blobUrl)
                    downloadCount++
                  }
                } catch (error) {
                  console.error(`[閾?蜉?荳玖??] 荳玖??螟?雍?:`, error)
                }
              }
            }
            if (downloadCount > 0) {
              console.log(`[閾?蜉?荳玖??] 螳梧?譌?陦?蜈??玖??莠 ${downloadCount} 蠑蝗?迚?)
            }
          }, 1000) // 蟒?霑1遘貞錘閾?蜉?荳玖???瑚??逕?謌?逵句芦謌仙粥豸域?
        }
        
        return
      } else if (result.status === 'failed') {
        // 謇譛我??蜉?螟?雍?        console.error('逕滓?螟?雍?:', result.error)
        
        // 肌 菫?螟搾?夂峩謗?譖?譁?謇?谺?逧???蜉??碁∩蜈堺??逕?蜈?螻蜿倬?蟇?閾?謇?谺?豺?豺
        const targetTasks = batch ? batch.tasks : generationTasks.value
        
        targetTasks.forEach(task => {
          task.status = 'failed'
          task.error = result.error || '逕滓?螟?雍?'
        })
        
        // 譖?譁?謇?谺?迥?諤?        if (batch) {
          batch.status = 'failed'
          
          // 蜿?譛牙?楢?呎弍譛譁?逧?音谺?譌??梧燕蜷梧??蛻?蜈?螻蜿倬??亥髄蜷主?螳??
          const isLatestBatch = generationBatches.value[0]?.id === batchId
          if (isLatestBatch) {
            generationTasks.value = targetTasks
          }
        }
        
        throw new Error(result.error || '逕滓?螟?雍?')
      } else if (result.status === 'processing') {
        // 笨?螳樊慮譖?譁?蟾?逕滓?逧?崟迚
        const images = result.results || []
        
        console.log(`[螳樊慮譖?譁?] 蟾?逕滓?${images.length} 蠑蝗?迚?)
        
        // 肌 菫?螟搾?夂峩謗?譖?譁?謇?谺?逧???蜉??碁∩蜈堺??逕?蜈?螻蜿倬?蟇?閾?謇?谺?豺?豺
        const targetTasks = batch ? batch.tasks : generationTasks.value
        
        // 譖?譁?蟾?逕滓?逧?崟迚?芦莉?蜉?荳?
        for (let j = 0; j < images.length; j++) {
          const image = images[j]
          const taskIndex = j
          
          if (taskIndex < targetTasks.length) {
            if (image.url && !image.error) {
              // 謌仙粥逧?崟迚?- 遶句叉譏?遉?
              targetTasks[taskIndex].status = 'completed'
              targetTasks[taskIndex].imageUrl = image.url
              targetTasks[taskIndex].progress = 100
            } else if (image.error) {
              // 螟?雍?逧?崟迚?              targetTasks[taskIndex].status = 'failed'
              targetTasks[taskIndex].error = image.error || '逕滓?螟?雍?'
            }
          }
        }
        
        // 譖?譁?譛?逕滓?逧???蜉?荳?螟?炊荳?
        for (let j = images.length; j < targetTasks.length; j++) {
          if (targetTasks[j].status === 'pending') {
            targetTasks[j].status = 'processing'
          }
        }
        
        // 譖?譁?謇?谺?迥?諤∝柱蟾?逕滓?逧??捺棡
        if (batch) {
          if (batch.status === 'pending') {
            batch.status = 'processing'
          }
          
          // 蜿?譛牙?楢?呎弍譛譁?逧?音谺?譌??梧燕蜷梧??蛻?蜈?螻蜿倬??亥髄蜷主?螳??
          const isLatestBatch = generationBatches.value[0]?.id === batchId
          if (isLatestBatch) {
            generationTasks.value = targetTasks
          }
          
          // 譖?譁?謇?谺?逧??樊慮扈捺?          batch.results = images.filter(img => img.url && !img.error).map(img => ({
            url: img.url,
            originalUrl: img.originalUrl,
            ossUrl: img.ossUrl,
            index: img.index,
            timestamp: img.timestamp
          }))
          
          // 笨?譽譟?譏?蜷?譛画眠霓?蟄伜芦OSS逧?崟迚??悟?よ棡譛我?泌?蜷?莠??蜉?荳玖???悟?閾?蜉?荳玖??
          // 蜿?荳玖??蛻壼?螳梧?逧?黒蠑蝗?迚??育憾諤∽? pending/processing 蜿倅?? completed??          if (autoDownloadEnabled.value) {
            console.log(`[閾?蜉?荳玖??] 譽譟?荳?, 蝗?迚?焚驥: ${images.length}, 閾?蜉?荳玖??蠑蜈? ${autoDownloadEnabled.value}`)
            images.forEach((img, index) => {
              console.log(`[閾?蜉?荳玖??] 譽譟?蝗?迚?{index + 1}: url=${img.url}, ossUrl=${img.ossUrl}`)
              if (img.ossUrl && img.url === img.ossUrl) {
                // 霑呎弍蛻夊??蟄伜芦OSS逧?崟迚??梧?譟?譏?蜷?蟾?荳玖??霑?                const task = batch.tasks[index]
                console.log(`[閾?蜉?荳玖??] 謇?蛻?OSS蝗?迚, task.downloaded=${task?.downloaded}, task.status=${task?.status}`)
                
                // 蜿?荳玖??蛻壼?螳梧?荳疲悴荳玖??霑?噪蝗?迚?                // 遑?菫昜??蜉?迥?諤∝??扈乗弍 completed?亥惠荳企擇蟾?扈乗峩譁?霑?憾諤??
                if (task && !task.downloaded && task.status === 'completed' && task.imageUrl) {
                  console.log(`[閾?蜉?荳玖??] OSS霓?蟄伜?梧??悟?蟋倶?玖?? ${img.ossUrl}`)
                  task.downloaded = true // 遶句叉譬???荳?蟾?荳玖???碁∩蜈埼?螟?                  
                  // 蟒?霑500ms蜷惹?玖???瑚??逕?謌?逵句芦蝗?迚?                  setTimeout(async () => {
                    try {
                      // 菴?逕?扈滉?逧??玖??騾?霎托?碁∩蜈垢ORS髣?鬚
                      const downloadUrl = img.ossUrl
                      const response = await fetch(
                        needsProxyDownload(downloadUrl)
                          ? `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
                          : downloadUrl,
                        needsProxyDownload(downloadUrl) ? {
                          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        } : {}
                      )
                      
                      if (!response.ok) throw new Error(`HTTP ${response.status}`)
                      
                      const blob = await response.blob()
                      if (!blob.type.startsWith('image/')) throw new Error('荳肴弍譛画譜逧?崟迚?枚莉?)
                      
                      const blobUrl = URL.createObjectURL(blob)
                      const link = document.createElement('a')
                      link.href = blobUrl
                      link.download = `逕滓?逧?崟迚?${img.index || index + 1}.png`
                      link.target = '_self'
                      document.body.appendChild(link)
                      link.click()
                      document.body.removeChild(link)
                      URL.revokeObjectURL(blobUrl)
                      
                      console.log(`[閾?蜉?荳玖??] 螳梧?: ${img.ossUrl}`)
                    } catch (error) {
                      console.error(`[閾?蜉?荳玖??] 螟?雍?: ${error.message}`)
                    }
                  }, 500)
                }
              }
            })
          }
        }
        
        // 譖?譁?譌?逧???蜉?蜈?螳?騾?霎托?井?晉蕗蜷大錘蜈?螳??
        if (batch && batch.status === 'pending') {
          batch.status = 'processing'
          batch.tasks.forEach(task => {
            if (task.status === 'pending') {
              task.status = 'processing'
            }
          })
        }
      }
      
      // 扈?扈?遲牙???井??逕?貂占?帛?城龍髫費??      const nextInterval = getPollingInterval(i + 1)
      await new Promise(resolve => setTimeout(resolve, nextInterval))
    } catch (error) {
      console.error(`霓?隸?隨?{i + 1}谺?螟?雍?`, error)
      
      // 譽譟?譏?蜷?譏?逕滓?螟?雍?逧?漠隸?      if (error.message && error.message.includes('逕滓?螟?雍?')) {
        console.log('譽豬句芦逕滓?螟?雍??悟●豁?霓?隸?)
        // 譬???謇譛我??蜉?荳?螟?雍?
        generationTasks.value.forEach(task => {
          task.status = 'failed'
          task.error = error.message
        })
        // 驥咲??逕滓?迥?諤?        isGenerating.value = false
        // 譏?遉?髞呵??豸域?
        ElMessage.error('逕滓?螟?雍?: ' + error.message)
        return // 逶?謗?霑泌屓?御?榊?扈?扈?霓?隸?      }
      
      // 螯よ棡譏?鄂醍?憺漠隸?謌泡PI髞呵???檎??扈?驥崎??      if (error.message.includes('鄂醍?') || error.message.includes('API') || error.message.includes('譟?隸?')) {
        if (i === maxAttempts - 1) {
          // 譛蜷惹?谺?驥崎?募??雍?          generationTasks.value.forEach(task => {
            task.status = 'failed'
          })
          isGenerating.value = false
          throw new Error('鄂醍?懆?樊磁蠑ょ???瑚??譽譟?鄂醍?懷錘驥崎?')
        }
        // 扈?扈?驥崎?包?井??逕?貂占?帛?城龍髫費??        const retryInterval = getPollingInterval(i + 1)
        await new Promise(resolve => setTimeout(resolve, retryInterval))
        continue
      }
      
      // 蜈?莉夜漠隸?逶?謗?謚帛?
      if (i === maxAttempts - 1) {
        // 雜?慮?梧???謇譛我??蜉?荳?螟?雍?
        generationTasks.value.forEach(task => {
          task.status = 'failed'
        })
        isGenerating.value = false
        throw error
      }
      // 扈?扈?驥崎?包?井??逕?貂占?帛?城龍髫費??      const retryInterval2 = getPollingInterval(i + 1)
      await new Promise(resolve => setTimeout(resolve, retryInterval2))
    }
  }
  
  // 螯よ棡蠕?邇?扈捺據霑俶??譛芽?泌屓?瑚??譏手??慮
  generationTasks.value.forEach(task => {
    task.status = 'failed'
  })
  isGenerating.value = false
  throw new Error('逕滓?雜?慮?瑚??遞榊錘驥崎?')
}

// 譬?謐?豈比?区???闔?蜿門??蠎皮噪CSS邀?const getRatioClass = (label) => {
  if (label.includes('1:1')) return 'ratio-1-1'
  if (label.includes('16:9')) return 'ratio-16-9'
  if (label.includes('9:16')) return 'ratio-9-16'
  if (label.includes('4:3')) return 'ratio-4-3'
  if (label.includes('3:4')) return 'ratio-3-4'
  if (label.includes('3:2')) return 'ratio-3-2'
  if (label.includes('2:3')) return 'ratio-2-3'
  if (label.includes('21:9')) return 'ratio-21-9'
  if (label.includes('9:21')) return 'ratio-9-21'
  if (label.includes('4:5')) return 'ratio-4-5'
  if (label.includes('5:4')) return 'ratio-5-4'
  return 'ratio-1-1'
}

// 驥咲??陦?蜊
const resetForm = () => {
  prompt.value = ''
  promptTags.value = []
  videoPromptTags.value = [] // 貂???隗??第署遉?隸肴???  uploadedImages.value = [] // 菫?螟搾?壻??逕?豁?遑?逧?序驥丞?  generatedImages.value = []
  uploadedFiles.value = [] // 貂?勁譁???蠑慕畑
  imageSize.value = '1024x1792'
  generateQuantity.value = 1
  generationMode.value = 'text-to-image'
  uploadRef.value?.clearFiles()
  
  // 貂???螟夊?梧???霎灘?扈???逧??螳?  if (multilineTagInputRef.value) {
    multilineTagInputRef.value.clearTags()
    multilineTagInputRef.value.setInputText('')
  }
  
  // 貂???隗??大?夊?梧???霎灘?扈???逧??螳?  if (videoMultilineTagInputRef.value) {
    videoMultilineTagInputRef.value.clearTags()
    videoMultilineTagInputRef.value.setInputText('')
  }
  
  // 驥咲??莉?蜉?迥?諤?  generationTasks.value = []
  completedTasks.value = 0
  // 豕?諢擾?壻?肴??勁 generationBatches?檎畑謌?髴隕∵焔蜉?貂?勁蜷?音谺?
}

// ==================== 謇?谺?邂?逅???勧蜃?謨? ====================

// 譬?蠑丞喧譌?髣?謌?譏?遉?
const formatTimestamp = (date) => {
  return new Date(date).toLocaleString('zh-CN', {
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  })
}

// 闔?蜿匁音谺?迥?諤∵枚譛?// 邂蛹夜漠隸?菫?諱??碁∩蜈崎???螳?蝎?
const getSimplifiedError = (error) => {
  if (!error) return '逕滓?蜃?髞呎?霑晁???瑚??驥崎??
  
  // 扈滉?邂蛹紋??邂遏?謠千??  return '逕滓?蜃?髞呎?霑晁???瑚??驥崎??
}

const getBatchStatusText = (batch) => {
  if (!batch.tasks || batch.tasks.length === 0) {
    return '譌莉?蜉?
  }
  
  const completed = batch.tasks.filter(t => t.status === 'completed').length
  const failed = batch.tasks.filter(t => t.status === 'failed').length
  const total = batch.tasks.length
  
  if (batch.status === 'completed') {
    return `蟾?螳梧?${completed}/${total}`
  }
  if (batch.status === 'partial') {
    // 肌 邂蛹厄?壻?肴仞遉?螟?雍?荳?謨?    return `蟾?螳梧?${completed}/${total}`
  }
  if (batch.status === 'failed') {
    return `螟?雍? ${failed}/${total}`
  }
  if (batch.status === 'processing') {
    return `霑幄?御??${completed}/${total}`
  }
  return `遲牙????${completed}/${total}`
}

// 闔?蜿匁音谺?逧???蝙句錐遘?const getBatchModelName = (batch) => {
  if (!batch.params) return null
  
  // 蝗?迚?函謌先??蠑
  if (batch.type === 'image' && batch.params.modelId) {
    const model = availableModels.value.find(m => m.id === batch.params.modelId)
    return model?.name || null
  }
  
  // 隗??醍函謌先??蠑
  if (batch.type === 'video' && batch.params.modelDbId) {
    const model = videoModels.value.find(m => m.id === batch.params.modelDbId)
    return model?.name || null
  }
  
  return null
}

// 遘?髯?謖??壽音谺?
const removeBatch = (batchId) => {
  const index = generationBatches.value.findIndex(b => b.id === batchId)
  if (index !== -1) {
    generationBatches.value.splice(index, 1)
    ElMessage.success('謇?谺?蟾?遘?髯?)
  }
}

// 貂?勁謇譛画音谺?const clearAllBatches = () => {
  if (generationBatches.value.length === 0) {
    ElMessage.info('證よ裏謇?谺?')
    return
  }
  generationBatches.value = []
  ElMessage.success('蟾?貂?勁謇譛画音谺?)
}

// ==================== 荳玖??逶?蜈?蜃?謨? ====================

// 霎?勧蜃?謨??壼愛譁?URL譏?蜷?髴隕?夊????逅??玖???磯∩蜈垢ORS??const needsProxyDownload = (url) => {
  return (
    url.includes('creatimage.oss-cn-beijing.aliyuncs.com') || // 髦?驥御?前SS
    url.includes('tos-cn-beijing.volces.com') || // 蟄苓鰍霍?蜉?OSS (雎?桁)
    url.includes('ark-content-generation') || // 蟄苓鰍霍?蜉?譁?闊
    (url.startsWith('http') && !url.includes('localhost')) // 蜈?莉門?夜ΚURL
  )
}

// 荳玖??蜊募?蝗?迚
const downloadSingleImage = async (image, index) => {
  try {
    ElMessage.info('豁?蝨?蜃????玖??...')
    
    const downloadUrl = image.originalUrl || image.url
    
    // 譬?謐?URL邀?蝙矩画叫荳玖??譁?蠑
    let response
    if (needsProxyDownload(downloadUrl)) {
      // 菴?逕?莉?逅?PI荳玖???碁∩蜈垢ORS髣?鬚
      const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
      response = await fetch(proxyUrl, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
    } else {
      // 逶?謗?荳玖??譛?蝨?蝗?迚
      response = await fetch(downloadUrl)
    }
    
    if (!response.ok) {
      throw new Error('闔?蜿門崟迚???雍?')
    }
    
    const blob = await response.blob()
    const blobUrl = URL.createObjectURL(blob)
    
    // 蛻帛??荳玖??體?謗?
    const link = document.createElement('a')
    link.href = blobUrl
    link.download = `generated-image-${index + 1}-${Date.now()}.png`
    link.target = '_self' // 遑?菫晏惠蠖灘燕遯怜哨荳玖??    
    // 隗?蜿台?玖??
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    
    // 貂?炊blob URL
    URL.revokeObjectURL(blobUrl)
    
    ElMessage.success(`隨?{index + 1}蠑蝗?迚??玖??謌仙粥?～)
  } catch (error) {
    console.error('荳玖??螟?雍?:', error)
    ElMessage.error('荳玖??螟?雍?: ' + (error.message || '譛?遏?髞呵??'))
  }
}

// 扈滉?荳玖??謇譛臥?捺棡?亥崟迚?柱隗??托?
const downloadAllResults = async () => {
  // 謾?髮?園譛牙?梧?謇?谺?逧??捺棡?亥桁諡?驛?蛻??梧??
  const allResults = []
  generationBatches.value.forEach(batch => {
    if ((batch.status === 'completed' || batch.status === 'partial') && batch.results && batch.results.length > 0) {
      batch.results.forEach(result => {
        allResults.push({
          ...result,
          type: batch.type
        })
      })
    }
  })
  
  if (allResults.length === 0) {
    ElMessage.warning('豐?譛牙庄荳玖??逧??螳?')
    return
  }
  
  try {
    ElMessage.info('豁?蝨?蜃???音驥丈?玖??...')
    let imageCount = 0
    let videoCount = 0
    let failCount = 0
    
    for (let i = 0; i < allResults.length; i++) {
      const result = allResults[i]
      
      try {
        if (result.isVideo || result.type === 'video') {
          // 荳玖??隗??
          await downloadVideo(result.url, `video-${videoCount + 1}`)
          videoCount++
        } else {
          // 荳玖??蝗?迚
          const downloadUrl = result.originalUrl || result.url
          
          // 譬?謐?URL邀?蝙矩画叫荳玖??譁?蠑擾?碁∩蜈垢ORS髣?鬚
          const response = await fetch(needsProxyDownload(downloadUrl)
            ? `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
            : downloadUrl,
            needsProxyDownload(downloadUrl) ? {
              headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            } : {}
          )
          
          if (!response.ok) throw new Error(`HTTP ${response.status}`)
          
          const blob = await response.blob()
          if (!blob.type.startsWith('image/')) throw new Error('荳肴弍譛画譜逧?崟迚?枚莉?)
          
          const blobUrl = URL.createObjectURL(blob)
          const link = document.createElement('a')
          link.href = blobUrl
          link.download = `image-${imageCount + 1}-${Date.now()}.png`
          link.target = '_self'
          document.body.appendChild(link)
          link.click()
          document.body.removeChild(link)
          URL.revokeObjectURL(blobUrl)
          imageCount++
        }
      } catch (error) {
        console.error(`荳玖??隨?{i + 1}鬘?螟?雍?`, error)
        failCount++
      }
      
      // 豺?蜉蟒?霑滄∩蜈肴?剰?亥勣髦?豁?螟壻??荳玖??      if (i < allResults.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 500))
      }
    }
    
    if (imageCount > 0 || videoCount > 0) {
      let msg = '謌仙粥荳玖??'
      if (imageCount > 0) msg += `${imageCount}蠑蝗?迚?
      if (videoCount > 0) msg += `${imageCount > 0 ? '?? : ''}${videoCount}荳?隗??疏
      if (failCount > 0) msg += `??{failCount}鬘?螟?雍?`
      ElMessage.success(msg)
    } else {
      ElMessage.error('謇譛牙?螳?荳玖??螟?雍?)
    }
  } catch (error) {
    console.error('謇?驥丈?玖??螟?雍?:', error)
    ElMessage.error('謇?驥丈?玖??螟?雍?: ' + (error.message || '譛?遏?髞呵??'))
  }
}

// 荳玖??謇譛牙崟迚??亥髄蜷主?螳???const downloadAllImages = async () => {
  if (generatedImages.value.length === 0) {
    ElMessage.warning('豐?譛牙庄荳玖??逧?崟迚')
    return
  }

  try {
    ElMessage.info('豁?蝨?蜃???音驥丈?玖??...')
    const results = []
    
    for (let i = 0; i < generatedImages.value.length; i++) {
      const image = generatedImages.value[i]
      
      try {
        // 蟋狗?井??逕?蜴溷?矩得謗???AL體?謗??会?檎??菫昜?玖??蜴溷崟
        const downloadUrl = image.originalUrl || image.url
        
        console.log(`荳玖??隨?{i + 1}蠑蝗?迚? ${downloadUrl}`)
        
        // 譬?謐?URL邀?蝙矩画叫荳玖??譁?蠑擾?碁∩蜈垢ORS髣?鬚
        let response
        if (needsProxyDownload(downloadUrl)) {
          // 菴?逕?莉?逅?PI荳玖???碁∩蜈垢ORS髣?鬚
          const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
          console.log(`[謇?驥丈?玖??] 菴?逕?莉?逅: ${proxyUrl}`)
          response = await fetch(proxyUrl, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          })
        } else {
          // 逶?謗?荳玖??譛?蝨?蝗?迚
          console.log(`[謇?驥丈?玖??] 逶?謗?荳玖??: ${downloadUrl}`)
          response = await fetch(downloadUrl)
        }
        
      if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
      }
      
      const blob = await response.blob()
        
        // 鬪瑚?｜lob邀?蝙
        if (!blob.type.startsWith('image/')) {
          throw new Error('荳肴弍譛画譜逧?崟迚?枚莉?)
        }
        
      const blobUrl = URL.createObjectURL(blob)
      
      // 蛻帛??荳玖??體?謗?
      const link = document.createElement('a')
      link.href = blobUrl
      link.download = `generated-image-${i + 1}-${Date.now()}.png`
        link.target = '_self'
      
      // 隗?蜿台?玖??
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      
      // 貂?炊blob URL
      URL.revokeObjectURL(blobUrl)
        
        results.push({ index: i + 1, success: true })
        console.log(`隨?{i + 1}蠑蝗?迚??玖??謌仙粥`)
        
      } catch (error) {
        console.error(`荳玖??隨?{i + 1}蠑蝗?迚???雍?`, error)
        results.push({ 
          index: i + 1, 
          success: false, 
          error: error.message 
        })
      }
      
      // 豺?蜉蟒?霑滄∩蜈肴?剰?亥勣髦?豁?螟壻??荳玖??      if (i < generatedImages.value.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 500))
      }
    }
    
    const successCount = results.filter(r => r.success).length
    const failCount = results.filter(r => !r.success).length
    
    if (successCount > 0) {
      ElMessage.success(`謌仙粥荳玖??${successCount}蠑蝗?迚?{failCount > 0 ? `??{failCount}蠑螟?雍?` : ''}`)
    } else {
      ElMessage.error('謇譛牙崟迚??玖??螟?雍?)
    }
    
  } catch (error) {
    console.error('謇?驥丈?玖??螟?雍?:', error)
    ElMessage.error('謇?驥丈?玖??螟?雍?: ' + (error.message || '譛?遏?髞呵??'))
  }
}

// 菫晏?伜崟迚?芦譛?蝨?const saveImageToLocal = async (imageUrl) => {
  try {
    // 闔?蜿門崟迚?焚謐?
    const response = await fetch(imageUrl)
    if (!response.ok) {
      throw new Error('闔?蜿門崟迚???雍?')
    }
    
    const blob = await response.blob()
    
    // 蛻帛??譛?蝨?blob URL
    const localUrl = URL.createObjectURL(blob)
    
    // 菫晏?話lob蛻?譛?蝨?蟄伜お?亥庄騾会?檎畑莠取戟荵?喧?
    const timestamp = Date.now()
    const fileName = `generated-image-${timestamp}.png`
    
    // 蟆?lob URL蜥梧枚莉?蜷榊?伜お蛻?譛?蝨??御??萓?蜷守??菴?逕?
    const imageData = {
      url: localUrl,
      fileName: fileName,
      blob: blob,
      timestamp: timestamp
    }
    
    // 蟄伜お蛻?sessionStorage?磯??髱?蛻?譁?蜷主??謨茨?御??∩蜈榊?蟄俶???擾??    sessionStorage.setItem(`image_${timestamp}`, JSON.stringify({
      url: localUrl,
      fileName: fileName,
      timestamp: timestamp
    }))
    
    return localUrl
  } catch (error) {
    console.error('菫晏?伜崟迚?芦譛?蝨?螟?雍?', error)
    throw new Error('菫晏?伜崟迚?芦譛?蝨?螟?雍? ' + error.message)
  }
}

// 閾?蜉?菫晏?伜芦蜴?彰隶?蠖?const saveToHistoryAutomatically = async () => {
  // 笨?謾?荳?譽譟?譛譁?逧?音谺?閠御?肴弍蜿?譽譟?generatedImages
  const latestBatch = generationBatches.value.length > 0 ? generationBatches.value[0] : null
  
  if (!latestBatch || latestBatch.isHistory) {
    // 豐?譛画音谺?謌冶?弍蜴?彰隶?蠖墓音谺??御?堺?晏?
    return
  }
  
    // 譽豬区弍蜷?譏?隗??醍函謌
  const isVideoGeneration = latestBatch.type === 'video'
    
    // 闔?蜿門?梧紛逧?署遉?隸榊?螳??域?謐?逕滓?邀?蝙倶??逕?荳榊酔逧?署遉?隸肴?撰??    let fullPrompt = ''
    if (isVideoGeneration) {
      // 隗??醍函謌蝉??逕?videoMultilineTagInputRef
      if (videoMultilineTagInputRef.value) {
        fullPrompt = videoMultilineTagInputRef.value.getAllOriginalContent() || videoMultilineTagInputRef.value.getFullText()
      } else if (videoPromptTags.value.length > 0) {
        const mappedTags = videoPromptTags.value.map(tag => videoTagMapping.value[tag] || tag)
        fullPrompt = mappedTags.join(', ')
      }
      console.log('[蜴?彰隶?蠖評 隗??醍函謌先署遉?隸?', fullPrompt)
    } else {
      // 蝗?迚?函謌蝉??逕?multilineTagInputRef
      if (multilineTagInputRef.value) {
        fullPrompt = multilineTagInputRef.value.getAllOriginalContent()
      } else {
        fullPrompt = prompt.value
      }
    }
  
  // 笨?莉取音谺?逧дasks譫???螳梧紛逧?eneratedImages謨?扈??亥桁諡?謌仙粥蜥悟??雍?逧??
  const allGeneratedImages = latestBatch.tasks.map(task => {
    if (task.status === 'completed' && task.imageUrl) {
      // 謌仙粥逧?崟迚?      return {
        url: task.imageUrl,
        index: task.index,
        timestamp: Date.now()
      }
    } else if (task.status === 'failed') {
      // 螟?雍?逧?崟迚??御?晏?倬漠隸?菫?諱?
      return {
        error: task.error || '逕滓?螟?雍?',
        index: task.index,
        timestamp: Date.now()
      }
    }
    return null
  }).filter(Boolean)
    
    const historyItem = {
    prompt: fullPrompt || latestBatch.prompt,
    mode: isVideoGeneration ? 'video-generation' : (latestBatch.params?.mode || generationMode.value),
    size: isVideoGeneration ? `${videoResolution.value} (${videoRatio.value})` : (latestBatch.params?.size || imageSize.value),
    quantity: isVideoGeneration ? 1 : latestBatch.tasks.length,
    generatedImages: allGeneratedImages, // 笨?蛹?性謌仙粥蜥悟??雍?逧??梧紛蛻苓??
      referenceImages: uploadedImages.value
        .filter(img => img.url && !img.url.startsWith('blob:')) // 霑???謗?blob URL
        .map(img => ({
        url: img.url,
        name: img.name
      })),
    // 肌 譁?蠅橸?壻?晏?伜??逕?謠千??隸埼画叫迥?諤∝柱蜿り?崟ID
    selectedCommonPrompts: Array.from(selectedCommonPromptIds.value),
    selectedReferenceImages: uploadedImages.value
      .filter(img => img.dbId && typeof img.dbId === 'number') // 蜿?菫晏?俶怏謨育噪蜿り?崟謨?謐?蠎的D
      .map(img => img.dbId),
      timestamp: Date.now()
    }
    
    console.log('[蜴?彰隶?蠖評 蜃????晏?:', {
      mode: historyItem.mode,
      isVideo: isVideoGeneration,
      totalResults: allGeneratedImages.length,
      successResults: allGeneratedImages.filter(img => img.url).length,
      failedResults: allGeneratedImages.filter(img => img.error).length,
      selectedCommonPrompts: historyItem.selectedCommonPrompts,
      selectedReferenceImages: historyItem.selectedReferenceImages,
      uploadedImagesDetail: uploadedImages.value.map(img => ({ 
        id: img.id, 
        dbId: img.dbId, 
        name: img.name,
        hasDbId: !!img.dbId 
      }))
    })
    
    // 隹?畑蜴?彰隶?蠖慕????逧???蜉譁?豕?    historyPanelRef.value?.addHistoryItem(historyItem)
}

// 菫晏?伜芦蜴?彰隶?蠖包?井?晉蕗蜴滓怏蜃?謨??御???榊?謇句勘隹?畑??
// 霎?勧蜃?謨??夊??荵画??蛻呵??霎?蠑冗音谿雁?礼??
const escapeRegExp = (string) => {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
}

// 莉主紙蜿?隶?蠖募刈霓?const loadFromHistory = async (historyItem) => {
  console.log('[蜉霓?蜴?彰隶?蠖評', historyItem)
  
  // 譽譟?譏?蜷?譏?隗??第??蠑
  if (historyItem.mode === 'video-generation') {
    console.log('[蜉霓?隗??大紙蜿?] 隗??第??蠑擾?悟?蟋句刈霓?蜿よ?)
    
    // 蛻?困蛻?隗??醍函謌先??蠑?    generationMode.value = 'image-to-video'
    
    // 貂???隗??醍嶌蜈?迥?諤?    firstFrameFile.value = null
    firstFramePreview.value = ''
    lastFrameFile.value = null
    lastFramePreview.value = ''
    
    // 蜉霓?隗??第署遉?隸?    console.log('[蜉霓?隗??大紙蜿?] 謠千??隸?', historyItem.prompt)
    console.log('[蜉霓?隗??大紙蜿?] videoMultilineTagInputRef:', videoMultilineTagInputRef.value)
    
    if (historyItem.prompt) {
      if (videoMultilineTagInputRef.value) {
        videoMultilineTagInputRef.value.setFullText(historyItem.prompt)
        console.log('[蜉霓?隗??大紙蜿?] 謠千??隸榊??隶?鄂?騾夊?㎎ef')
      } else {
        // 螟?畑?夂峩謗?隶?鄂?蛻?prompt蜿倬?
        prompt.value = historyItem.prompt
        console.log('[蜉霓?隗??大紙蜿?] 謠千??隸榊??隶?鄂?蛻?prompt蜿倬?')
      }
    }
    
    // 蜉霓?隗??第??蝙
    if (historyItem.videoData && historyItem.videoData.videoModelId) {
      videoSelectedModelId.value = historyItem.videoData.videoModelId
      console.log('[蜉霓?隗??大紙蜿?] 隗??第??蝙句??隶?鄂?', historyItem.videoData.videoModelId)
    }
    
    // 蜉霓?隗??大盾謨?
    if (historyItem.videoData) {
      if (historyItem.videoData.duration) {
        videoDuration.value = historyItem.videoData.duration
      }
      if (historyItem.videoData.resolution) {
        videoResolution.value = historyItem.videoData.resolution
      }
      if (historyItem.videoData.ratio) {
        videoRatio.value = historyItem.videoData.ratio
      }
    }
    
    // 蜉霓?蜿り?崟?亥?よ棡譛会??    console.log('[蜉霓?隗??大紙蜿?] 譽譟?蜿り?崟:', {
      hasReferenceImages: !!historyItem.referenceImages,
      count: historyItem.referenceImages?.length,
      referenceImages: historyItem.referenceImages
    })
    
    if (historyItem.referenceImages && historyItem.referenceImages.length > 0) {
      console.log('[蜉霓?隗??大紙蜿?] 蠑蟋句刈霓?蜿り?崟:', historyItem.referenceImages)
      
      for (const refImage of historyItem.referenceImages) {
        try {
          if (!refImage || !refImage.url) {
            console.warn('[蜉霓?隗??大紙蜿?] 霍?霑?裏謨亥盾閠?崟:', refImage)
            continue
          }
          
          console.log('[蜉霓?隗??大紙蜿?] 蜉霓?蜿り?崟:', { type: refImage.type, url: refImage.url })
          
          // 菴?逕?莉?逅?磁蜿?闔?蜿門崟迚
          const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(refImage.url)}`
          const response = await fetch(proxyUrl, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          })
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }
          
          const blob = await response.blob()
          const file = new File([blob], refImage.name || 'referenceImage.png', {
            type: blob.type || 'image/png'
          })
          
          console.log('[蜉霓?隗??大紙蜿?] Blob霓?謐?謌仙粥:', { size: blob.size, type: blob.type })
          
          // 譬?謐?邀?蝙句刈霓?蛻?蟇?蠎皮噪菴咲??
          if (refImage.type === 'first') {
            firstFrameFile.value = file
            firstFramePreview.value = URL.createObjectURL(blob)
            console.log('[蜉霓?隗??大紙蜿?] 鬥門??蜿り?崟蟾?隶?鄂?)
          } else if (refImage.type === 'last') {
            lastFrameFile.value = file
            lastFramePreview.value = URL.createObjectURL(blob)
            console.log('[蜉霓?隗??大紙蜿?] 蟆?蟶?蜿り?崟蟾?隶?鄂?)
          }
          
          console.log('[蜉霓?隗??大紙蜿?] 蜿り?崟蜉霓?謌仙粥:', refImage.type)
        } catch (error) {
          console.error('[蜉霓?隗??大紙蜿?] 蜿り?崟蜉霓?螟?雍?:', error)
          ElMessage.warning(`蜿り?崟蜉霓?螟?雍?: ${error.message}`)
        }
      }
    } else {
      console.log('[蜉霓?隗??大紙蜿?] 譌蜿り?崟謨?謐??域枚逕溯???第?譌?隶?蠖包?')
    }
    
    // 蜉霓?逕滓?逧????大芦扈捺棡蛹?    if (historyItem.generatedImages && historyItem.generatedImages.length > 0) {
      const videoResult = historyItem.generatedImages[0]
      
      // 蛻帛??隗??第音谺?
      const batchId = `batch_video_history_${Date.now()}`
      const newBatch = {
        id: batchId,
        type: 'video',
        timestamp: new Date(historyItem.createdAt),
        status: 'completed',
        tasks: [{
          id: `task_${Date.now()}`,
          status: 'completed',
          index: 1
        }],
        results: [{
          isVideo: true,
          url: videoResult.url,
          duration: videoResult.duration || historyItem.videoData?.duration || '10',
          resolution: videoResult.resolution || historyItem.videoData?.resolution || '1080p',
          ratio: videoResult.ratio || historyItem.videoData?.ratio || '16:9',
          seed: videoResult.seed || historyItem.videoData?.seed,
          timestamp: new Date(historyItem.createdAt).getTime()
        }],
        prompt: historyItem.prompt,
        params: {
          modelId: historyItem.videoData?.videoModelId,
          duration: historyItem.videoData?.duration,
          resolution: historyItem.videoData?.resolution
        }
      }
      
      generationBatches.value.unshift(newBatch)
    }
    
    // 荳肴仞遉?謠千???檎?HistoryPanel 扈滉?譏?遉?
    return
  }
  
  // 蝗?迚???蠑丞??炊
  // 驥肴眠蜉霓?蟶?逕?謠千??隸榊柱蜿り?崟?檎??菫晄???譏蟆?弍譛譁?逧
  await loadCommonPrompts()
  await loadUserPrompts()
  
  // 貂???蠖灘燕迥?諤?  promptTags.value = []
  prompt.value = ''
  selectedCommonPromptIds.value.clear()
  
  // 肌 莨伜喧?壼?諱?螟榊??逕?謠千??隸埼画叫迥?諤??悟?螟?炊謇句勘霎灘?逧?署遉?隸?  if (historyItem.selectedCommonPrompts && historyItem.selectedCommonPrompts.length > 0) {
    console.log('[蜴?彰隶?蠖募刈霓?] 諱?螟榊??逕?謠千??隸?', historyItem.selectedCommonPrompts)
    
    // 遑?菫晏??逕?謠千??隸榊??蜉霓?
    if (commonPrompts.value.length === 0) {
      await loadCommonPrompts()
    }
    
    // 諱?螟埼画叫迥?諤?    historyItem.selectedCommonPrompts.forEach(promptId => {
      selectedCommonPromptIds.value.add(promptId)
    })
    
    console.log('[蜴?彰隶?蠖募刈霓?] 蟾?諱?螟?, selectedCommonPromptIds.value.size, '荳?蟶?逕?謠千??隸')
    
    // 莉主?梧紛謠千??隸堺??遘?髯?蟶?逕?謠千??隸咲噪蜀????悟宵菫晉蕗逕?謌?謇句勘霎灘?逧?Κ蛻
    let manualPrompt = historyItem.prompt || ''
    
    // 闔?蜿匁園譛蛾我??逧???逕?謠千??隸榊?螳?
    const selectedCommonPromptTexts = historyItem.selectedCommonPrompts
      .map(id => {
        const commonPrompt = commonPrompts.value.find(cp => cp.id === id)
        return commonPrompt?.content || ''
      })
      .filter(text => text.length > 0)
    
    // 莉主?梧紛謠千??隸堺??遘?髯?謇譛牙??逕?謠千??隸咲噪蜀???    for (const commonText of selectedCommonPromptTexts) {
      // 蟆晁?慕??遑?蛹?驟榊??遘?髯??亥桁諡?蜿?閭?逧?怜捷蜥檎??譬??
      manualPrompt = manualPrompt.replace(new RegExp(`${escapeRegExp(commonText)}\\s*,?\\s*`, 'g'), '')
      manualPrompt = manualPrompt.replace(new RegExp(`,?\\s*${escapeRegExp(commonText)}\\s*`, 'g'), '')
    }
    
    // 貂?炊螟壻?咏噪騾怜捷蜥檎??譬?    manualPrompt = manualPrompt
      .replace(/,\s*,/g, ',')  // 霑樒??逧?怜捷
      .replace(/^\s*,\s*/, '')  // 蠑螟?逧?怜捷
      .replace(/,\s*$/, '')     // 扈灘??逧?怜捷
      .trim()
    
    console.log('[蜴?彰隶?蠖募刈霓?] 蛻???蜷守噪謇句勘謠千??隸?', manualPrompt)
    
    // 隶?鄂?謇句勘霎灘?逧?署遉?隸搾?井?榊桁蜷?蟶?逕?謠千??隸搾?
    if (multilineTagInputRef.value) {
      multilineTagInputRef.value.setFullText(manualPrompt)
    } else {
      prompt.value = manualPrompt
    }
  } else {
    // 豐?譛牙??逕?謠千??隸肴慮?檎峩謗?隶?鄂?螳梧紛謠千??隸
  if (historyItem.prompt) {
    if (multilineTagInputRef.value) {
      multilineTagInputRef.value.setFullText(historyItem.prompt)
    } else {
  prompt.value = historyItem.prompt
      }
    }
  }
  
  imageSize.value = historyItem.size
  generationMode.value = historyItem.mode
  generateQuantity.value = historyItem.quantity || 1
  
  // 貂???蠖灘燕逧??贋?蝗?迚?  uploadedImages.value = []
  uploadedFiles.value = []
  
  // 肌 莨伜?菴?逕? selectedReferenceImages?亥盾閠?崟ID蛻苓????  if (historyItem.mode === 'image-to-image') {
    // 譁?譯1?壼?よ棡譛牙盾閠?崟ID蛻苓???碁夊?⑩D蜉霓?
    if (historyItem.selectedReferenceImages && historyItem.selectedReferenceImages.length > 0) {
      console.log('[蜴?彰隶?蠖募刈霓?] 騾夊?⑩D蜉霓?蜿り?崟:', historyItem.selectedReferenceImages)
      
      try {
        const loadedImages = await loadReferenceImagesByIds(historyItem.selectedReferenceImages)
        console.log('[蜴?彰隶?蠖募刈霓?] 蜿り?崟蜉霓?謌仙粥:', loadedImages.length, '蠑?)
      } catch (error) {
        console.error('[蜴?彰隶?蠖募刈霓?] 騾夊?⑩D蜉霓?蜿り?崟螟?雍?:', error)
        ElMessage.warning('蜿り?崟蜉霓?螟?雍?')
      }
    }
    // 譁?譯2?壼?螳?譌?譬?蠑擾?御??逕?referenceImages URL蛻苓??
    else if (historyItem.referenceImages && historyItem.referenceImages.length > 0) {
      console.log('[蜴?彰隶?蠖募刈霓?] 騾夊?ⅡRL蜉霓?蜿り?崟?域立譬?蠑擾??)
      
    for (const refImage of historyItem.referenceImages) {
      try {
        // 譽譟?URL譏?蜷?譛画譜
        if (!refImage || !refImage.url) {
            console.warn('[蜴?彰隶?蠖募刈霓?] 霍?霑?裏謨育噪蜿り?崟:', refImage)
            continue
          }
          
          // 霑???謗画裏謨育噪URL
          if (refImage.url.includes('undefined') || refImage.url.startsWith('blob:')) {
            console.warn('[蜴?彰隶?蠖募刈霓?] 霍?霑?裏謨育噪蜿り?崟URL:', refImage.url)
          continue
        }
        
        // 菴?逕?莉?逅?磁蜿?闔?蜿門崟迚??碁∩蜈垢ORS髣?鬚
        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(refImage.url)}`
        const response = await fetch(proxyUrl, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        
        const blob = await response.blob()
        
        // 遑?菫晄怏豁?遑?逧МIME邀?蝙句柱譁???謇?螻募錐
        let mimeType = blob.type || 'image/png'
        let fileName = refImage.name || '蜴?彰蜿り?崟'
        
        // 螯よ棡MIME邀?蝙倶??遨?謌匁裏謨茨?梧?謐?URL謌夜?倩??隶?鄂?荳?png
        if (!mimeType || !mimeType.startsWith('image/')) {
          mimeType = 'image/png'
        }
        
        // 遑?菫晄枚莉?蜷肴怏豁?遑?逧?黄螻募錐
        if (!fileName.includes('.')) {
          const extension = mimeType.split('/')[1] || 'png'
          fileName = `${fileName}.${extension}`
        }
        
        const file = new File([blob], fileName, {
          type: mimeType
        })
        
      const imageData = {
        id: Date.now() + Math.random(),
        url: refImage.url,
          file: file, // 邇?蝨?譛画枚莉?蠑慕畑?悟庄莉?逕?莠守函謌
        name: refImage.name || '蜴?彰蜿り?崟'
      }
        
      uploadedImages.value.push(imageData)
        uploadedFiles.value.push(file) // 蜷梧慮豺?蜉蛻?uploadedFiles謨?扈
      } catch (error) {
        console.error('蜉霓?蜴?彰蜿り?崟螟?雍?:', error)
        // 螯よ棡蜉霓?螟?雍??御?咲┯豺?蜉蛻?uploadedImages逕?莠取仞遉??御???堺?壽怏譁???蠑慕?        const imageData = {
          id: Date.now() + Math.random(),
          url: refImage.url,
          file: null,
          name: refImage.name || '蜴?彰蜿り?崟'
        }
        uploadedImages.value.push(imageData)
        uploadedFiles.value.push(null) // 菫晄戟謨?扈?酔豁?
      }
    }
    }
    // 譁?譯3?壼?螳?譌?譬?蠑丞黒蠑蜿り?崟
    else if (historyItem.referenceImage) {
    try {
      // 菴?逕?莉?逅?磁蜿?闔?蜿門崟迚??碁∩蜈垢ORS髣?鬚
      const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(historyItem.referenceImage)}`
      const response = await fetch(proxyUrl, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
      }
      
      const blob = await response.blob()
      
      // 遑?菫晄怏豁?遑?逧МIME邀?蝙句柱譁???謇?螻募錐
      let mimeType = blob.type || 'image/png'
      let fileName = '蜴?彰蜿り?崟'
      
      // 螯よ棡MIME邀?蝙倶??遨?謌匁裏謨茨?梧?謐?URL謌夜?倩??隶?鄂?荳?png
      if (!mimeType || !mimeType.startsWith('image/')) {
        mimeType = 'image/png'
      }
      
      // 遑?菫晄枚莉?蜷肴怏豁?遑?逧?黄螻募錐
      if (!fileName.includes('.')) {
        const extension = mimeType.split('/')[1] || 'png'
        fileName = `${fileName}.${extension}`
      }
      
      const file = new File([blob], fileName, {
        type: mimeType
      })
      
      const imageData = {
        id: Date.now() + Math.random(),
        url: historyItem.referenceImage,
        file: file, // 邇?蝨?譛画枚莉?蠑慕畑?悟庄莉?逕?莠守函謌
        name: '蜴?彰蜿り?崟'
      }
      
      uploadedImages.value.push(imageData)
      uploadedFiles.value.push(file) // 蜷梧慮豺?蜉蛻?uploadedFiles謨?扈
    } catch (error) {
        console.error('[蜴?彰隶?蠖募刈霓?] 蜉霓?蜴?彰蜿り?崟螟?雍?:', error)
      // 螯よ棡蜉霓?螟?雍??御?咲┯豺?蜉蛻?uploadedImages逕?莠取仞遉??御???堺?壽怏譁???蠑慕?    const imageData = {
      id: Date.now() + Math.random(),
      url: historyItem.referenceImage,
      file: null,
      name: '蜴?彰蜿り?崟'
    }
    uploadedImages.value.push(imageData)
    uploadedFiles.value.push(null) // 菫晄戟謨?扈?酔豁?
      }
    }
  }
  
  // 蜉霓?逕滓?逧??懷?  let loadedImages = []
  if (historyItem.generatedImages) {
    loadedImages = historyItem.generatedImages
    // 蜿?蟆??蜉溽噪蝗?迚??句?扈 generatedImages?育畑莠主?莉門粥閭??
    generatedImages.value = historyItem.generatedImages.filter(img => img.url && !img.error)
  } else if (historyItem.generatedImage) {
    // 蜈?螳?譌?譬?蠑?    loadedImages = [{
      url: historyItem.generatedImage,
      index: 1,
      timestamp: historyItem.timestamp
    }]
    generatedImages.value = loadedImages
  }
  
  // 笨?蛻帛??謇?谺?蟇?雎??御??蜴?彰隶?蠖戊?蝨?逕滓?扈捺棡髱?譚?譏?遉?
  if (loadedImages.length > 0) {
    const historyBatchId = `batch_history_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    
    // 笨?豁?遑?螟?炊謌仙粥蜥悟??雍?逧?崟迚
    const tasks = loadedImages.map((img, index) => {
      // 譽譟?蝗?迚?弍蜷?螟?雍??亥桁蜷?error蟄玲??荳疲??譛疫rl??      const hasFailed = img.error || (!img.url && !img.isVideo)
      
      return {
        id: `task_history_${Date.now()}_${index}`,
        status: hasFailed ? 'failed' : 'completed', // 笨?譬?謐?譏?蜷?譛影rror隶?鄂?迥?諤?        imageUrl: img.url || null,
        index: img.index || (index + 1),
        progress: hasFailed ? 0 : 100,
        error: img.error || null, // 笨?菫晏?倬漠隸?菫?諱?
        downloaded: false // 蜴?彰隶?蠖穂?咲?怜??荳玖??      }
    })
    
    // 隶?邂玲?蜉溷柱螟?雍?逧?焚驥
    const successCount = tasks.filter(t => t.status === 'completed').length
    const failedCount = tasks.filter(t => t.status === 'failed').length
    
    // 笨?譬?謐?謌仙粥螟?雍?諠??隶?鄂?謇?谺?迥?諤?    let batchStatus = 'completed'
    if (successCount === 0) {
      batchStatus = 'failed' // 蜈?驛?螟?雍?
    } else if (failedCount > 0) {
      batchStatus = 'partial' // 驛?蛻???雍?
    }
    
    const historyBatch = {
      id: historyBatchId,
      type: 'image',
      timestamp: new Date(historyItem.timestamp || Date.now()),
      status: batchStatus, // 笨?菴?逕?隶?邂怜?逧?憾諤?      tasks: tasks,
      results: loadedImages.filter(img => img.url && !img.error), // 蜿?蛹?性謌仙粥逧??捺棡
      prompt: historyItem.prompt || '',
      params: {
        size: historyItem.size || imageSize.value,
        quantity: loadedImages.length,
        mode: historyItem.mode || generationMode.value,
        modelId: historyItem.modelId || selectedModelId.value
      },
      isHistory: true // 譬???荳?蜴?彰隶?蠖墓音谺?    }
    
    // 蟆?紙蜿?謇?谺?豺?蜉蛻?謇?谺?蛻苓??鬘?驛?
    generationBatches.value.unshift(historyBatch)
    completedTasks.value = successCount
    
    console.log('[蜴?彰隶?蠖評 蟾?蛻帛??謇?谺?蟇?雎?', {
      batchId: historyBatch.id,
      status: batchStatus,
      success: successCount,
      failed: failedCount,
      total: loadedImages.length
    })
  }
  
  showHistory.value = false
  ElMessage.success('蜴?彰隶?蠖募??蜉霓?蛻?逕滓?扈捺棡髱?譚?')
}

// 螟?炊謠千??隸埼画叫
const handleSelectPrompt = async (promptData) => {
  try {
    console.log('[謠千??隸榊刈霓?] 蠑蟋句刈霓?', promptData)
    
    // 1. 蠖?蠎墓????蠖灘燕迥?諤?  promptTags.value = []
  prompt.value = ''
  selectedCommonPromptIds.value.clear()
  uploadedImages.value = []
  uploadedFiles.value = []
  
    // 貂???螟夊?瑚?灘?扈????亥?よ棡蟄伜惠?
    if (multilineTagInputRef.value) {
      multilineTagInputRef.value.clearTags()
      multilineTagInputRef.value.setInputText('')
    }
    
    // 2. 諱?螟咲函謌先??蠑丞柱蜿よ?  generationMode.value = promptData.generation_mode || 'text-to-image'
  imageSize.value = promptData.image_size || '1024x1792'
  generateQuantity.value = promptData.generate_quantity || 1
  
    // 3. 諱?螟肴??蝙矩画叫
    if (promptData.model_id) {
      selectedModelId.value = parseInt(promptData.model_id)
    }
    
    // 4. 遲牙? DOM 譖?譁?
    await nextTick()
    
    // 5. 諱?螟肴???
  if (promptData.tags) {
    try {
      const tags = JSON.parse(promptData.tags)
      promptTags.value = tags
        
        if (multilineTagInputRef.value) {
          tags.forEach(tag => {
            multilineTagInputRef.value.addTag(tag)
          })
        }
    } catch (error) {
      console.error('隗?譫先???螟?雍?:', error)
      promptTags.value = []
    }
  }
  
    // 6. 諱?螟肴焔蜉?霎灘?蜀???
  if (promptData.manual_input && multilineTagInputRef.value) {
    multilineTagInputRef.value.setInputText(promptData.manual_input)
  }
  
    // 7. 諱?螟埼画叫逧???逕?謠千??隸
  if (promptData.selected_common_prompts) {
    try {
      const selectedIds = JSON.parse(promptData.selected_common_prompts)
      // 螯よ棡蟶?逕?謠千??隸肴焚謐?荳?遨??悟?蜉霓?      if (commonPrompts.value.length === 0) {
        await loadCommonPrompts()
      }
      selectedIds.forEach(id => {
        selectedCommonPromptIds.value.add(id)
      })
    } catch (error) {
      console.error('隗?譫仙??逕?謠千??隸埼画叫螟?雍?:', error)
    }
  }
  
    // 8. 諱?螟榊盾閠?崟?亥?よ??蜉霓??御?埼仆蝪樔??豬∫?具??  if (promptData.selected_reference_images) {
    try {
      const selectedImageIds = JSON.parse(promptData.selected_reference_images)
        console.log('[謠千??隸榊刈霓?] 髴隕∝刈霓?逧?盾閠?崟IDs:', selectedImageIds)
        
        // 蠑よ??蜉霓?蜿り?崟?御?埼仆蝪樔??豬∫??        if (selectedImageIds && selectedImageIds.length > 0) {
          loadReferenceImagesByIds(selectedImageIds).catch(err => {
            console.error('[謠千??隸榊刈霓?] 蜉霓?蜿り?崟螟?雍?:', err)
          })
        }
    } catch (error) {
      console.error('隗?譫仙盾閠?崟騾画叫螟?雍?:', error)
    }
  }
  
  showPromptManager.value = false
  ElMessage.success('謠千??隸榊??蜉霓?')
    console.log('[謠千??隸榊刈霓?] 蜉霓?螳梧?')
  } catch (error) {
    console.error('[謠千??隸榊刈霓?] 蜉霓?螟?雍?:', error)
    ElMessage.error('蜉霓?謠千??隸榊??雍? ' + (error.message || '譛?遏?髞呵??'))
  }
}

// 譬?謐?ID蛻苓??蜉霓?蜿り?崟
const loadReferenceImagesByIds = async (imageIds) => {
  try {
    console.log('[蜿り?崟蜉霓?] 蠑蟋句刈霓?蜿り?崟:', imageIds)
    
    // 騾夊?②PI闔?蜿門盾閠?崟隸?諠
    for (const imageId of imageIds) {
      try {
        const token = localStorage.getItem('token')
        const response = await fetch(`/api/reference-images/${imageId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        
        if (response.ok) {
          const result = await response.json()
          if (result.success && result.data) {
            const refImage = result.data
            
            // 豺?蜉蛻?uploadedImages
            uploadedImages.value.push({
              id: refImage.id,
              dbId: refImage.id, // 菫晏?俶焚謐?蠎的D逕?莠主紙蜿?隶?蠖
              url: refImage.oss_url || refImage.url,
              name: refImage.name || refImage.original_name || '蜿り?崟'
            })
            
            console.log('[蜿り?崟蜉霓?] 蜉霓?謌仙粥:', refImage.name)
          }
        }
      } catch (err) {
        console.error(`[蜿り?崟蜉霓?] 蜉霓?蝗?迚 ${imageId} 螟?雍?:`, err)
      }
    }
    
    console.log('[蜿り?崟蜉霓?] 螳梧??悟??蜉霓?', uploadedImages.value.length, '蠑蜿り?崟')
  } catch (error) {
    console.error('[蜿り?崟蜉霓?] 蜉霓?螟?雍?:', error)
  }
}

// 騾画叫逕?謌?謠千??隸?const selectUserPrompt = async (userPrompt) => {
  try {
    const token = localStorage.getItem('token')
    let latestPromptData = userPrompt
    
    if (token) {
      // 蟾?逋?蠖包?壻?取恪蜉?蝎?闔?蜿匁怙譁?謨?謐?      console.log('[謠千??隸榊刈霓?] 莉取恪蜉?蝎?闔?蜿匁怙譁?謨?謐?', userPrompt.id)
      
      try {
        const response = await fetch(`/api/prompts/${userPrompt.id}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        
        if (response.ok) {
          const result = await response.json()
          if (result.success) {
            // 霓?謐?譛榊苅蝎?謨?謐?荳?蜑咲??譬?蠑
            latestPromptData = {
              id: result.data.id.toString(),
              title: result.data.title,
              content: result.data.content,
              referenceImageUrl: result.data.reference_image_url || null,
              tags: result.data.tags,
              manual_input: result.data.manual_input,
              selected_common_prompts: result.data.selected_common_prompts,
              selected_reference_images: result.data.selected_reference_images,
              generation_mode: result.data.generation_mode,
              image_size: result.data.image_size,
              generate_quantity: result.data.generate_quantity
            }
            console.log('[謠千??隸榊刈霓?] 闔?蜿門芦譛譁?謨?謐?', latestPromptData)
          }
        }
      } catch (fetchError) {
        console.warn('[謠千??隸榊刈霓?] 闔?蜿匁怙譁?謨?謐?螟?雍??御??逕?郛灘?俶焚謐?:', fetchError)
        // 扈?扈?菴?逕?郛灘?俶焚謐?
      }
    }
    
    // 菴?逕?譛譁?謨?謐?謇?陦悟錘扈?蜉霓?騾?霎
    // 貂???蠖灘燕迥?諤?    promptTags.value = []
    prompt.value = ''
    selectedCommonPromptIds.value.clear()
    uploadedImages.value = []
    uploadedFiles.value = []
    
    // 諱?螟咲函謌先??蠑丞柱蜈?莉冶??鄂?    generationMode.value = latestPromptData.generation_mode || 'text-to-image'
    imageSize.value = latestPromptData.image_size || '1024x1792'
    generateQuantity.value = latestPromptData.generate_quantity || 1
    
    // 諱?螟肴???蜥梧焔蜉?霎灘?    if (latestPromptData.tags) {
      try {
        const tags = JSON.parse(latestPromptData.tags)
        promptTags.value = tags
        // 逕?莠斬utoConvertToTags荳?false?碁怙隕∵焔蜉?隶?鄂?譬???        if (multilineTagInputRef.value) {
          // 蜈域????邇?譛画???          multilineTagInputRef.value.clearTags()
          // 騾蝉??豺?蜉譬???
          tags.forEach(tag => {
            multilineTagInputRef.value.addTag(tag)
          })
        }
      } catch (error) {
        console.error('隗?譫先???螟?雍?:', error)
        promptTags.value = []
      }
    }
    
    // 諱?螟肴焔蜉?霎灘?蜀???
    if (latestPromptData.manual_input && multilineTagInputRef.value) {
      multilineTagInputRef.value.setInputText(latestPromptData.manual_input)
    }
    
    // 諱?螟肴署遉?隸榊?螳??亥?よ棡豐?譛画焔蜉?霎灘??悟?菴?逕?content蟄玲????    if (!latestPromptData.manual_input && latestPromptData.content && multilineTagInputRef.value) {
      multilineTagInputRef.value.setInputText(latestPromptData.content)
    }
    
    // 諱?螟埼画叫逧???逕?謠千??隸
    if (latestPromptData.selected_common_prompts) {
      try {
        const selectedIds = JSON.parse(latestPromptData.selected_common_prompts)
        // 螯よ棡蟶?逕?謠千??隸肴焚謐?荳?遨??悟?蜉霓?        if (commonPrompts.value.length === 0) {
          await loadCommonPrompts()
        }
        selectedIds.forEach(id => {
          selectedCommonPromptIds.value.add(id)
        })
      } catch (error) {
        console.error('隗?譫仙??逕?謠千??隸埼画叫螟?雍?:', error)
      }
    }
    
    // 諱?螟榊盾閠?崟 - 菫?螟搾?壻??逕?referenceImageUrl閠御?肴弍referenceImage
    if (latestPromptData.referenceImageUrl) {
      try {
        // 菴?逕?莉?逅?磁蜿?闔?蜿門崟迚??碁∩蜈垢ORS髣?鬚
        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(latestPromptData.referenceImageUrl)}`
        const response = await fetch(proxyUrl, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        
        const blob = await response.blob()
        
        // 遑?菫晄怏豁?遑?逧МIME邀?蝙句柱譁???謇?螻募錐
        let mimeType = blob.type || 'image/png'
        let fileName = '蜿り?崟'
        
        // 螯よ棡MIME邀?蝙倶??遨?謌匁裏謨茨?梧?謐?URL謌夜?倩??隶?鄂?荳?png
        if (!mimeType || !mimeType.startsWith('image/')) {
          mimeType = 'image/png'
        }
        
        // 遑?菫晄枚莉?蜷肴怏豁?遑?逧?黄螻募錐
        if (!fileName.includes('.')) {
          const extension = mimeType.split('/')[1] || 'png'
          fileName = `${fileName}.${extension}`
        }
        
        const file = new File([blob], fileName, {
          type: mimeType
        })
        
        const imageData = {
          id: Date.now() + Math.random(),
          url: latestPromptData.referenceImageUrl, // 菴?逕?蜿り?崟體?謗??御?肴弍蟆?擇蝗?
          file: file, // 邇?蝨?譛画枚莉?蠑慕畑?悟庄莉?逕?莠守函謌
          name: '蜿り?崟'
        }
        
        uploadedImages.value.push(imageData)
        uploadedFiles.value.push(file) // 蜷梧慮豺?蜉蛻?uploadedFiles謨?扈
      } catch (error) {
        console.error('蜉霓?蜿り?崟螟?雍?:', error)
        // 螯よ棡蜉霓?螟?雍??御?咲┯豺?蜉蛻?uploadedImages逕?莠取仞遉??御???堺?壽怏譁???蠑慕?        const imageData = {
          id: Date.now() + Math.random(),
          url: latestPromptData.referenceImageUrl,
          file: null,
          name: '蜿り?崟'
        }
        uploadedImages.value.push(imageData)
        uploadedFiles.value.push(null) // 菫晄戟謨?扈?酔豁?
        ElMessage.warning('蜿り?崟蜉霓?螟?雍??悟庄閭?譌豕慕畑莠守函謌?)
      }
    }
    
    // 諱?螟埼画叫逧?盾閠?崟
    if (latestPromptData.selected_reference_images) {
      try {
        const selectedImageIds = JSON.parse(latestPromptData.selected_reference_images)
        // 霑咎代髴隕∵?謐?ID莉主??逕?蜿り?崟荳?謇?蛻?蟇?蠎皮噪蝗?迚
        // 證よ慮霍?霑??悟屏荳?髴隕??晏?也噪API隹?畑譚?闔?蜿門盾閠?崟隸?諠
      } catch (error) {
        console.error('隗?譫仙盾閠?崟騾画叫螟?雍?:', error)
      }
    }
    
    ElMessage.success('謠千??隸榊??蜉霓?')
  } catch (error) {
    console.error('[謠千??隸榊刈霓?] 蜉霓?螟?雍?:', error)
    ElMessage.error('蜉霓?謠千??隸榊??雍? ' + (error.message || '譛?遏?髞呵??'))
  }
}

// 郛冶?醍畑謌?謠千??隸?const editUserPrompt = (userPrompt) => {
  showPromptManager.value = true
  // 蜿?莉?莨騾堤?冶?醍噪謠千??隸巧D扈儕romptManager扈???
}

// 蛻髯?逕?謌?謠千??隸?const deleteUserPrompt = async (promptId) => {
  try {
    await ElMessageBox.confirm('遑?螳夊?∝唖髯?霑吩??謠千??隸榊雛?', '謠千??', {
      confirmButtonText: '遑?螳',
      cancelButtonText: '蜿匁?',
      type: 'warning'
    })
    
    // 莉四ocalStorage荳?蛻髯?    const savedPrompts = JSON.parse(localStorage.getItem('promptManager') || '[]')
    const updatedPrompts = savedPrompts.filter(p => p.id !== promptId)
    localStorage.setItem('promptManager', JSON.stringify(updatedPrompts))
    
    // 譖?譁?譛?蝨?謨?謐?
    userPrompts.value = updatedPrompts
    
    ElMessage.success('謠千??隸榊??蛻髯?')
  } catch (error) {
    // 逕?謌?蜿匁?亥唖髯?
  }
}

// 螟?炊蝗?迚?刈霓?髞呵??
const handleImageError = (event) => {
  event.target.style.display = 'none'
  event.target.nextElementSibling.style.display = 'flex'
}

// 螟?炊讓?蝙句崟譬?刈霓?髞呵??
const handleModelIconError = (event) => {
  event.target.style.display = 'none'
}

// 螟?炊逕?謌?謠千??隸肴峩譁?const handleUserPromptsUpdated = () => {
  loadUserPrompts()
}

// 螟?炊螟夊?梧???霎灘?蜿伜喧
const handlePromptChange = (newTags) => {
  promptTags.value = newTags
  // 蜷梧??譖?譁? prompt 蜿倬??井?晄戟蜷大錘蜈?螳??
  // 菴?逕?getAllOriginalContent闔?蜿門?梧紛蜀???
  if (multilineTagInputRef.value) {
    prompt.value = multilineTagInputRef.value.getAllOriginalContent()
  } else {
    prompt.value = newTags.join(', ')
  }
}

// 螟?炊隗??大?夊?梧???霎灘?蜿伜喧
const handleVideoPromptChange = (newTags) => {
  videoPromptTags.value = newTags
  // 蜷梧??譖?譁?隗??第署遉?隸榊序驥?  if (videoMultilineTagInputRef.value) {
    // 霑咎代蜿?莉?豺?蜉隗??第署遉?隸咲噪螟?炊騾?霎
    console.log('隗??第署遉?隸榊序蛹?', videoMultilineTagInputRef.value.getAllOriginalContent())
  }
}

// InputTag 逶?蜈?譁?豕包?井?晉蕗逕?莠主髄蜷主?螳??
// 螟?炊譬???蜿伜喧
const handlePromptTagsChange = (newTags) => {
  promptTags.value = newTags
  // 蜷梧??譖?譁? prompt 蜿倬??井?晄戟蜷大錘蜈?螳??
  prompt.value = newTags.join(', ')
}

// 螟?炊豺?蜉譬???
const handleAddTag = (tag) => {
  // 蜿?莉?蝨?霑咎代豺?蜉閾?螳壻?蛾?霎
  console.log('豺?蜉譬???:', tag)
}

// 螟?炊遘?髯?譬???
const handleRemoveTag = (tag) => {
  // 譽譟?譏?蜷?譏?蟶?逕?謠千??隸肴????悟?よ棡譏?蛻呎峩譁?騾我??迥?諤?  const commonPrompt = commonPrompts.value.find(p => p.name === tag)
  if (commonPrompt) {
    selectedCommonPromptIds.value.delete(commonPrompt.id)
  }
  console.log('遘?髯?譬???:', tag)
}

// 豺?蜉蟶?逕?謠千??隸?const addCommonPrompt = (commonPrompt, promptId) => {
  // 蛻?困騾我??迥?諤?  if (selectedCommonPromptIds.value.has(promptId)) {
    // 螯よ棡蟾?騾我???悟?蜿匁?磯我??
    selectedCommonPromptIds.value.delete(promptId)
    // 莉取???謨?扈???遘?髯?
    const commonPromptObj = commonPrompts.value.find(p => p.id === promptId)
    if (commonPromptObj) {
      const index = promptTags.value.findIndex(tag => tag === commonPromptObj.name)
      if (index > -1) {
        promptTags.value.splice(index, 1)
      }
    }
  } else {
    // 螯よ棡譛?騾我???悟?騾我??蟷?豺?蜉蛻?譬???謨?扈
    selectedCommonPromptIds.value.add(promptId)
    const commonPromptObj = commonPrompts.value.find(p => p.id === promptId)
    if (commonPromptObj && !promptTags.value.includes(commonPromptObj.name)) {
      promptTags.value.push(commonPromptObj.name)
    }
  }
}

// 豺?蜉隗??大??逕?謠千??隸?const addVideoCommonPrompt = (videoPrompt, promptId) => {
  // 蛻?困騾我??迥?諤?  if (selectedVideoPromptIds.value.has(promptId)) {
    // 螯よ棡蟾?騾我???悟?蜿匁?磯我??
    selectedVideoPromptIds.value.delete(promptId)
    // 莉取???謨?扈???遘?髯?
    const videoPromptObj = videoCommonPrompts.value.find(p => p.id === promptId)
    if (videoPromptObj) {
      const index = videoPromptTags.value.findIndex(tag => tag === videoPromptObj.name)
      if (index > -1) {
        videoPromptTags.value.splice(index, 1)
      }
    }
  } else {
    // 螯よ棡譛?騾我???悟?騾我??蟷?豺?蜉蛻?譬???謨?扈
    selectedVideoPromptIds.value.add(promptId)
    const videoPromptObj = videoCommonPrompts.value.find(p => p.id === promptId)
    if (videoPromptObj && !videoPromptTags.value.includes(videoPromptObj.name)) {
      videoPromptTags.value.push(videoPromptObj.name)
    }
  }
}

// 莉取署遉?隸肴枚譛?荳?遘?髯?謖??壼?螳?const removePromptFromText = (promptToRemove) => {
  if (!prompt.value.trim()) return
  
  // 遘?髯?邊?遑?蛹?驟咲噪蜀???  let updatedPrompt = prompt.value
    .replace(new RegExp(promptToRemove + ',\\s*', 'g'), '') // 遘?髯? "蜀???, "
    .replace(new RegExp(',\\s*' + promptToRemove, 'g'), '') // 遘?髯? ", 蜀???"
    .replace(new RegExp('^' + promptToRemove + '$', 'g'), '') // 遘?髯?蜊慕峡逧??螳?    .trim()
  
  // 貂?炊螟壻?咏噪騾怜捷
  updatedPrompt = updatedPrompt.replace(/,\s*,/g, ',').replace(/^,|,$/g, '')
  
  prompt.value = updatedPrompt
}

// 螟?炊蝗?迚?せ蜃?
const handleImageClick = (imageData) => {
  console.log('蝗?迚?せ蜃?:', imageData)
  
  // 逶?謗?菴?逕?莨蜈?逧?崟迚?焚謐?謇灘?鬚??
  currentPreviewImage.value = imageData.src
  currentPreviewTitle.value = imageData.title || '逕滓?逧?崟迚?
  showImageModal.value = true
  
  // 譟?謇?蝗?迚?園螻樒噪謇?谺?
  let foundBatch = null
  let imageIndexInBatch = -1
  
  for (const batch of generationBatches.value) {
    if (batch.results && batch.results.length > 0) {
      const index = batch.results.findIndex(img => img.url === imageData.src)
      if (index !== -1) {
        foundBatch = batch
        imageIndexInBatch = index
        break
      }
    }
  }
  
  if (foundBatch) {
    // 謇?蛻?莠?園螻樊音谺??瑚??鄂?蠖灘燕謇?谺?逧??贋?区枚
    currentViewingBatchId.value = foundBatch.id
    currentBatchImages.value = foundBatch.results
    currentImageIndex.value = imageIndexInBatch
    console.log('[螟?蝗?鬚??? 謇?谺?:', foundBatch.id, '邏?蠑:', imageIndexInBatch, '諤?謨?:', foundBatch.results.length)
  } else {
    // 譛?謇?蛻?謇?谺??亥庄閭?譏?蜴?彰隶?蠖募刈霓?逧?崟迚??会?御??逕?蜈?螻蛻苓??
    currentViewingBatchId.value = null
    currentBatchImages.value = generatedImages.value
    const imageIndex = generatedImages.value.findIndex(img => img.url === imageData.src)
    currentImageIndex.value = imageIndex !== -1 ? imageIndex : -1
    console.log('[螟?蝗?鬚??? 菴?逕?蜈?螻蛻苓???檎??蠑?', currentImageIndex.value)
  }
  
  // 驥咲??郛?謾?蜥梧雷霓?  imageScale.value = 1
  imageRotation.value = 0
  imagePosition.value = { x: 0, y: 0 }
}


// 螟?炊蝗?迚??玖??
const handleImageDownload = async (imageData) => {
  try {
    // 謇?蛻?蟇?蠎皮噪蝗?迚?焚謐??御?伜?菴?逕?originalUrl
    const imageIndex = generatedImages.value.findIndex(img => img.url === imageData.src)
    const downloadUrl = imageIndex !== -1 && generatedImages.value[imageIndex].originalUrl 
      ? generatedImages.value[imageIndex].originalUrl 
      : imageData.src
    
    console.log(`荳玖??蝗?迚??御??逕?URL: ${downloadUrl}`)
    
    // 譬?謐?URL邀?蝙矩画叫荳玖??譁?蠑
    let response
    if (needsProxyDownload(downloadUrl)) {
      // 菴?逕?莉?逅?PI荳玖??蝗?迚??碁∩蜈垢ORS髣?鬚
      const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
      console.log(`[荳玖??] 菴?逕?莉?逅??玖??: ${proxyUrl}`)
      response = await fetch(proxyUrl, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
    } else {
      // 逶?謗?荳玖??譛?蝨?蝗?迚
      console.log(`[荳玖??] 逶?謗?荳玖??: ${downloadUrl}`)
      response = await fetch(downloadUrl)
    }
    
    if (!response.ok) {
      throw new Error('闔?蜿門崟迚???雍?')
    }
    
    const blob = await response.blob()
    const blobUrl = URL.createObjectURL(blob)
    
    // 蛻帛??荳玖??體?謗?
    const link = document.createElement('a')
    link.href = blobUrl
    link.download = imageData.title || `image-${Date.now()}.png`
    link.target = '_self' // 遑?菫晏惠蠖灘燕遯怜哨荳玖??    
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    
    // 貂?炊blob URL
    URL.revokeObjectURL(blobUrl)
    
    ElMessage.success('荳玖??謌仙粥')
  } catch (error) {
    console.error('荳玖??螟?雍?:', error)
    ElMessage.error('荳玖??螟?雍?')
  }
}

// 螟?炊蝗?迚????
const handleImagePreview = (imageData) => {
  const previewWindow = window.open('', '_blank', 'width=800,height=600')
  previewWindow.document.write(`
    <html>
      <head>
        <title>蝗?迚???? - ${imageData.title}</title>
        <style>
          body { margin: 0; padding: 20px; background: #f5f5f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
          img { max-width: 100%; max-height: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 8px; }
        </style>
      </head>
      <body>
        <img src="${imageData.src}" alt="${imageData.title}" />
      </body>
    </html>
  `)
}

// 闔?蜿門?灘燕菴?逕?逧??梧紛謠千??隸
const getCurrentPrompt = () => {
  if (multilineTagInputRef.value) {
    // 菴?逕?扈???逧?etAllOriginalContent譁?豕戊執蜿門?梧紛蜀????亥桁諡?譬???譏蟆?柱謇句勘霎灘???    return multilineTagInputRef.value.getAllOriginalContent()
  } else if (promptTags.value.length > 0) {
    // 螟?畑譁?譯茨?壽焔蜉?螟?炊譬???譏蟆?    const mappedTags = promptTags.value.map(tag => tagMapping.value[tag] || tag)
    return mappedTags.join(', ')
  } else {
    return prompt.value
  }
}

// 螟?炊豺?蜉蛻?謠千??隸咲??逅
const handleAddToPrompts = async (imageData) => {
  try {
    // 菴?逕?閾?螳壻?牙??隸晄??????
    const result = await showAddPromptDialogForm(imageData)
    
    if (result) {
      const { title, content } = result
      
      if (!title || !content) {
        ElMessage.warning('隸?霎灘?螳梧紛逧???伜柱蜀???)
        return
      }
      
      const token = localStorage.getItem('token')
      
      if (token) {
        // 蟾?逋?蠖包?御??逕?API菫晏?伜芦譛榊苅蝎?
        // 菫?螟搾?壻?騾貞盾閠?崟URL閠御?肴弍逕滓?扈捺棡蝗?URL
        const referenceImageUrl = uploadedImages.value.length > 0 ? uploadedImages.value[0].url : null
        // 菫?螟搾?壼??擇菴?逕?逕滓?扈捺棡蝗?
        const coverImageUrl = imageData.src // 菴?逕?逕滓?扈捺棡蝗?菴應??蟆??        await savePromptToServerWithImage(title, content, referenceImageUrl, coverImageUrl)
      } else {
        // 譛?逋?蠖包?御??逕?譛?蝨?蟄伜お
        // 菫?螟搾?壻?騾貞盾閠?崟URL閠御?肴弍逕滓?扈捺棡蝗?URL
        const referenceImageUrl = uploadedImages.value.length > 0 ? uploadedImages.value[0].url : null
        // 菫?螟搾?壼??擇菴?逕?逕滓?扈捺棡蝗?
        const coverImageUrl = imageData.src // 菴?逕?逕滓?扈捺棡蝗?菴應??蟆??        await savePromptToLocalWithImage(title, content, referenceImageUrl, coverImageUrl)
      }
      
      ElMessage.success('蟾?豺?蜉蛻?謠千??隸咲??逅?)
      
      // 菫?螟搾?壻?晏?俶?蜉溷錘遶句叉蛻?譁?謠千??隸榊?陦?      await loadUserPrompts()
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('豺?蜉蛻?謠千??隸榊??雍?:', error)
      ElMessage.error('豺?蜉螟?雍?')
    }
  }
}

// 譏?遉?豺?蜉謠千??隸榊??隸晄?
const showAddPromptDialogForm = (imageData) => {
  return new Promise((resolve, reject) => {
    // 蛻帛??蟇?隸晄????蝎?    const dialogContainer = document.createElement('div')
    dialogContainer.innerHTML = `
      <div class="add-prompt-dialog-overlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      ">
        <div class="add-prompt-dialog" style="
          background: white;
          border-radius: 8px;
          padding: 24px;
          width: 500px;
          max-width: 90vw;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        ">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #303133;">豺?蜉蛻?謠千??隸咲??逅</h3>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #606266;">譬??</label>
            <input type="text" id="prompt-title" placeholder="隸?霎灘?謠千??隸肴??" style="
              width: 100%;
              padding: 12px;
              border: 1px solid #dcdfe6;
              border-radius: 4px;
              font-size: 14px;
              box-sizing: border-box;
            " value="${imageData.title || ''}">
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #606266;">蜀???</label>
            <textarea id="prompt-content" placeholder="隸?霎灘?謠千??隸榊?螳?" style="
              width: 100%;
              padding: 12px;
              border: 1px solid #dcdfe6;
              border-radius: 4px;
              font-size: 14px;
              height: 120px;
              resize: vertical;
              box-sizing: border-box;
              font-family: inherit;
            ">${imageData.prompt || '隸?謠剰??霑吝?蝗?迚?噪謠千??隸?}</textarea>
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 12px;">
            <button id="cancel-btn" style="
              padding: 8px 16px;
              border: 1px solid #dcdfe6;
              background: white;
              color: #606266;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
            ">蜿匁?</button>
            <button id="confirm-btn" style="
              padding: 8px 16px;
              border: none;
              background: #409eff;
              color: white;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
            ">遑?螳</button>
          </div>
        </div>
      </div>
    `
    
    document.body.appendChild(dialogContainer)
    
    const titleInput = dialogContainer.querySelector('#prompt-title')
    const contentInput = dialogContainer.querySelector('#prompt-content')
    const cancelBtn = dialogContainer.querySelector('#cancel-btn')
    const confirmBtn = dialogContainer.querySelector('#confirm-btn')
    
    // 閨夂┬蛻?譬??倩?灘?譯
    titleInput.focus()
    
    // 蜿匁?域潔髓?莠倶??
    cancelBtn.onclick = () => {
      document.body.removeChild(dialogContainer)
      reject('cancel')
    }
    
    // 遑?螳壽潔髓?莠倶??
    confirmBtn.onclick = () => {
      const title = titleInput.value.trim()
      const content = contentInput.value.trim()
      
      if (!title || !content) {
        ElMessage.warning('隸?霎灘?螳梧紛逧???伜柱蜀???)
        return
      }
      
      document.body.removeChild(dialogContainer)
      resolve({ title, content })
    }
    
    // 蝗櫁??髞?莠倶??    const handleKeydown = (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        confirmBtn.click()
      } else if (e.key === 'Escape') {
        cancelBtn.click()
      }
    }
    
    document.addEventListener('keydown', handleKeydown)
    
    // 貂?炊莠倶??逶大成蝎?    const cleanup = () => {
      document.removeEventListener('keydown', handleKeydown)
    }
    
    cancelBtn.addEventListener('click', cleanup)
    confirmBtn.addEventListener('click', cleanup)
  })
}

// 菫晏?俶署遉?隸榊芦譛榊苅蝎??亥??蝗?迚??
const savePromptToServerWithImage = async (title, content, referenceImageUrl, coverImageUrl) => {
  const token = localStorage.getItem('token')
  const formData = new FormData()
  
  formData.append('title', title)
  formData.append('content', content)
  
  // 豺?蜉讓?蝙紀D
  if (selectedModelId.value) {
    formData.append('modelId', selectedModelId.value)
  }
  
  // 菫晏?伜?灘燕逧?憾諤∽??諱?  const tags = promptTags.value || []
  // 菫?螟肯anualInput闔?蜿夜?霎托?碁∩蜈榊?伜?undefined"蟄礼??荳?  let manualInput = ''
  if (multilineTagInputRef.value && multilineTagInputRef.value.inputText) {
    manualInput = multilineTagInputRef.value.inputText
    // 螯よ棡inputText譏?蟄礼??荳?"undefined"?悟?隶?荳?遨?蟄礼??荳?
    if (manualInput === 'undefined') {
      manualInput = ''
    }
  }
  const selectedCommonPrompts = Array.from(selectedCommonPromptIds.value)
  const selectedReferenceImages = uploadedImages.value.map(img => img.id)
  
  formData.append('tags', JSON.stringify(tags))
  formData.append('manualInput', manualInput)
  formData.append('selectedCommonPrompts', JSON.stringify(selectedCommonPrompts))
  formData.append('selectedReferenceImages', JSON.stringify(selectedReferenceImages))
  formData.append('generationMode', generationMode.value)
  formData.append('imageSize', imageSize.value)
  formData.append('generateQuantity', generateQuantity.value.toString())
  
  // 螯よ棡譛牙盾閠?崟URL?檎峩謗?莨騾旦RL
  if (referenceImageUrl) {
    formData.append('referenceImageUrl', referenceImageUrl)
  }
  
  // 螯よ棡譛牙??擇蝗?URL?御?騾貞??擇蝗?URL
  if (coverImageUrl) {
    formData.append('coverImageUrl', coverImageUrl)
  }
  
  const response = await fetch('/api/prompts', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  })
  
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.message || '菫晏?伜??雍?')
  }
}

// 菫晏?俶署遉?隸榊芦譛?蝨?蟄伜お?亥??蝗?迚???const savePromptToLocalWithImage = async (title, content, referenceImageUrl, coverImageUrl) => {
      // 闔?蜿也鴫譛臥噪謠千??隸榊?陦?
      const existingPrompts = JSON.parse(localStorage.getItem('promptManager') || '[]')
      
      // 蛻帛??譁?逧?署遉?隸埼??
      const newPrompt = {
        id: Date.now().toString(),
        title: title,
        content: content,
        // 菫?螟搾?壼??擇菴?逕?逕滓?扈捺棡蝗??御???晏?伜盾閠?崟體?謗?
        referenceImage: coverImageUrl || referenceImageUrl, // 蟆?擇莨伜?菴?逕?逕滓?扈捺棡蝗?        referenceImageUrl: referenceImageUrl, // 菫晏?伜盾閠?崟體?謗?逕?莠守せ蜃?譌?蜉霓?        createdAt: Date.now(),
        updatedAt: Date.now()
      }
      
      // 豺?蜉蛻?蛻苓??      existingPrompts.unshift(newPrompt)
      
      // 菫晏?伜芦譛?蝨?蟄伜?      localStorage.setItem('promptManager', JSON.stringify(existingPrompts))
}

// 譬?蠑丞喧蝗?迚?慮髣?const formatImageTime = (timestamp) => {
  if (!timestamp) return ''
  const date = new Date(timestamp)
  const now = new Date()
  const diff = now - date
  
  if (diff < 60000) { // 1蛻?帖蜀?    return '蛻壼?'
  } else if (diff < 3600000) { // 1蟆乗慮蜀?    return `${Math.floor(diff / 60000)}蛻?帖蜑港
  } else if (diff < 86400000) { // 1螟?蜀
    return `${Math.floor(diff / 3600000)}蟆乗慮蜑港
  } else {
    return date.toLocaleDateString()
  }
}

// 闔?蜿門崟迚??呈
const getImageBadges = (image) => {
  const badges = []
  
  if (image.index) {
    badges.push({
      text: `${image.index}蜿?`,
      type: 'primary'
    })
  }
  
  if (image.timestamp) {
    const now = Date.now()
    const diff = now - image.timestamp
    if (diff < 60000) { // 1蛻?帖蜀?      badges.push({
        text: '譁?,
        type: 'success'
      })
    }
  }
  
  return badges
}

// 莉主??逕?謠千??隸肴峩譁?譬???譏蟆
const updateTagMappingFromCommonPrompts = (commonPromptsData) => {
  // 蛻帛??譁?逧?丐蟆???雎??悟?悟?貂???荵句燕逧?丐蟆
  const newTagMapping = {}
  
  // 蟆?焚謐?蠎謎??逧???逕?謠千??隸肴??蜉蛻?譏蟆???  commonPromptsData.forEach(prompt => {
    if (prompt.title && prompt.content) {
      newTagMapping[prompt.title] = prompt.content
    }
  })

  // 譖?譁?譬???譏蟆
  tagMapping.value = newTagMapping
  
  console.log('譬???譏蟆???譖?譁?', newTagMapping)
}

// 莉手???大??逕?謠千??隸肴峩譁?譬???譏蟆
const updateVideoTagMappingFromCommonPrompts = (videoPromptsData) => {
  // 蛻帛??譁?逧?丐蟆???雎??悟?悟?貂???荵句燕逧?丐蟆
  const newVideoTagMapping = {}
  
  // 蟆?焚謐?蠎謎??逧????大??逕?謠千??隸肴??蜉蛻?譏蟆???  videoPromptsData.forEach(prompt => {
    if (prompt.title && prompt.content) {
      newVideoTagMapping[prompt.title] = prompt.content
    }
  })

  // 譖?譁?隗??第???譏蟆
  videoTagMapping.value = newVideoTagMapping
  
  console.log('隗??第???譏蟆???譖?譁?', newVideoTagMapping)
}

// 蜉霓?蟶?逕?謠千??隸?const loadCommonPrompts = async () => {
  try {
    const token = localStorage.getItem('token')
    if (!token) {
      // 螯よ棡豐?譛液oken?御??逕?鮟倩??謠千??隸
      commonPrompts.value = [
        {
          id: '1',
          name: '驥大?樊??愍髟?,
          content: 'Her thin-framed glasses add a touch of sophistication.',
          createdAt: Date.now() - 86400000
        },
        {
          id: '2',
          name: '莠?迚?霑伜次',
          content: 'Please fully restore the facial features and hairstyles of the individuals in the uploaded images.',
          createdAt: Date.now() - 172800000
        },
        {
          id: '3',
          name: '鬩?蟆?霎?扈?濶?荳晏??,
          content: 'Her dark hair is pulled back in a low ponytail and tied with a silky dark green scarf with a subtle floral or leaf pattern, tied in a soft bow.',
          createdAt: Date.now() - 259200000
        }
      ]
      // 莉朱?倩??謠千??隸肴峩譁?譬???譏蟆
      updateTagMappingFromCommonPrompts(commonPrompts.value.map(prompt => ({
        title: prompt.name,
        content: prompt.content
      })))
      return
    }
    
    // 莉取恪蜉?蝎?API蜉霓?蟶?逕?謠千??隸?    const response = await fetch('/api/prompts/common', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    
    if (response.ok) {
      const result = await response.json()
      if (result.success) {
        // 霓?謐?譛榊苅蝎?謨?謐?譬?蠑丈??蜑咲??譬?蠑
        commonPrompts.value = result.data.map(prompt => ({
          id: prompt.id.toString(),
          name: prompt.title,
          content: prompt.content,
          createdAt: new Date(prompt.created_at).getTime(),
          updatedAt: new Date(prompt.updated_at).getTime()
        }))
        
        // 譖?譁?譬???譏蟆??壼??焚謐?蠎謎??逧???逕?謠千??隸榊?螳?譏蟆?芦譬???譏?遉?譁??        updateTagMappingFromCommonPrompts(result.data)
        
        // 蜷梧慮譖?譁?localStorage菴應??郛灘?
      localStorage.setItem('commonPrompts', JSON.stringify(commonPrompts.value))
      } else {
        throw new Error(result.message || '蜉霓?蟶?逕?謠千??隸榊??雍?)
      }
    } else if (response.status === 401) {
      // 隶?隸∝??雍??梧??勁郛灘?伜??驥肴眠逋?蠖
      clearAllUserCache()
      isLoggedIn.value = false
      currentUser.value = null
      ElMessage.error('逋?蠖募??霑?悄?瑚??驥肴眠逋?蠖?)
    } else {
      throw new Error('鄂醍?懆??豎ょ??雍?')
    }
  } catch (error) {
    console.error('蜉霓?蟶?逕?謠千??隸榊??雍?', error)
    
    // 螯よ棡API隹?畑螟?雍??悟?晁?穂?四ocalStorage蜉霓?菴應??螟?畑
    try {
      const savedPrompts = localStorage.getItem('commonPrompts')
      if (savedPrompts) {
        commonPrompts.value = JSON.parse(savedPrompts)
        // 莉守?灘?倡噪蟶?逕?謠千??隸肴峩譁?譬???譏蟆?        updateTagMappingFromCommonPrompts(commonPrompts.value.map(prompt => ({
          title: prompt.name,
          content: prompt.content
        })))
        ElMessage.warning('蟾?莉取悽蝨?郛灘?伜刈霓?蟶?逕?謠千??隸?)
      } else {
        // 菴?逕?鮟倩??謠千??隸?        commonPrompts.value = [
          {
            id: '1',
            name: '驥大?樊??愍髟?,
            content: 'Her thin-framed glasses add a touch of sophistication.',
            createdAt: Date.now() - 86400000
          },
          {
            id: '2',
            name: '莠?迚?霑伜次',
            content: 'Please fully restore the facial features and hairstyles of the individuals in the uploaded images.',
            createdAt: Date.now() - 172800000
          },
          {
            id: '3',
            name: '鬩?蟆?霎?扈?濶?荳晏??,
            content: 'Her dark hair is pulled back in a low ponytail and tied with a silky dark green scarf with a subtle floral or leaf pattern, tied in a soft bow.',
            createdAt: Date.now() - 259200000
          }
        ]
        // 莉朱?倩??謠千??隸肴峩譁?譬???譏蟆
        updateTagMappingFromCommonPrompts(commonPrompts.value.map(prompt => ({
          title: prompt.name,
          content: prompt.content
        })))
      }
    } catch (localError) {
      console.error('莉取悽蝨?郛灘?伜刈霓?螟?雍?', localError)
    commonPrompts.value = []
    }
  }
}

// 蜉霓?隗??大??逕?謠千??隸?const loadVideoCommonPrompts = async () => {
  try {
    const token = localStorage.getItem('token')
    if (!token) {
      // 螯よ棡豐?譛液oken?御??逕?鮟倩??隗??第署遉?隸
      videoCommonPrompts.value = [
        {
          id: 'v1',
          name: '螂碑?',
          content: 'running, dynamic movement, motion blur, energetic',
          createdAt: Date.now() - 86400000
        },
        {
          id: 'v2',
          name: '蠕?隨',
          content: 'smiling, happy expression, cheerful, joyful',
          createdAt: Date.now() - 172800000
        },
        {
          id: 'v3',
          name: '蠕?鬟',
          content: 'gentle breeze, wind effect, flowing movement, natural',
          createdAt: Date.now() - 259200000
        },
        {
          id: 'v4',
          name: '髦?蜈',
          content: 'sunlight, bright lighting, warm atmosphere, golden hour',
          createdAt: Date.now() - 345600000
        },
        {
          id: 'v5',
          name: '闕牙慍',
          content: 'grass field, green landscape, natural environment, outdoor',
          createdAt: Date.now() - 432000000
        },
        {
          id: 'v6',
          name: '諷?蜉?菴?,
          content: 'slow motion, cinematic effect, dramatic timing, smooth',
          createdAt: Date.now() - 518400000
        }
      ]
      // 莉朱?倩??隗??第署遉?隸肴峩譁?譬???譏蟆
      updateVideoTagMappingFromCommonPrompts(videoCommonPrompts.value.map(prompt => ({
        title: prompt.name,
        content: prompt.content
      })))
      return
    }
    
    // 莉取恪蜉?蝎?API蜉霓?隗??大??逕?謠千??隸?    const response = await fetch('/api/prompts/video-common', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    
    if (response.ok) {
      const result = await response.json()
      if (result.success) {
        // 霓?謐?譛榊苅蝎?謨?謐?譬?蠑丈??蜑咲??譬?蠑
        videoCommonPrompts.value = result.data.map(prompt => ({
          id: prompt.id.toString(),
          name: prompt.title,
          content: prompt.content,
          createdAt: new Date(prompt.created_at).getTime(),
          updatedAt: new Date(prompt.updated_at).getTime()
        }))
        
        // 譖?譁?譬???譏蟆??壼??焚謐?蠎謎??逧????大??逕?謠千??隸榊?螳?譏蟆?芦譬???譏?遉?譁??        updateVideoTagMappingFromCommonPrompts(result.data)
        
        // 蜷梧慮譖?譁?localStorage菴應??郛灘?
        localStorage.setItem('videoCommonPrompts', JSON.stringify(videoCommonPrompts.value))
      } else {
        throw new Error(result.message || '蜉霓?隗??大??逕?謠千??隸榊??雍?)
      }
    } else if (response.status === 401) {
      // 隶?隸∝??雍??梧??勁郛灘?伜??驥肴眠逋?蠖
      clearAllUserCache()
      isLoggedIn.value = false
      currentUser.value = null
      ElMessage.error('逋?蠖募??霑?悄?瑚??驥肴眠逋?蠖?)
    } else {
      throw new Error('鄂醍?懆??豎ょ??雍?')
    }
  } catch (error) {
    console.error('蜉霓?隗??大??逕?謠千??隸榊??雍?', error)
    
    // 螯よ棡API隹?畑螟?雍??悟?晁?穂?四ocalStorage蜉霓?菴應??螟?畑
    try {
      const savedPrompts = localStorage.getItem('videoCommonPrompts')
      if (savedPrompts) {
        videoCommonPrompts.value = JSON.parse(savedPrompts)
        // 莉守?灘?倡噪隗??大??逕?謠千??隸肴峩譁?譬???譏蟆?        updateVideoTagMappingFromCommonPrompts(videoCommonPrompts.value.map(prompt => ({
          title: prompt.name,
          content: prompt.content
        })))
        ElMessage.warning('蟾?莉取悽蝨?郛灘?伜刈霓?隗??大??逕?謠千??隸?)
      } else {
        // 菴?逕?鮟倩??隗??第署遉?隸?        videoCommonPrompts.value = [
          {
            id: 'v1',
            name: '螂碑?',
            content: 'running, dynamic movement, motion blur, energetic',
            createdAt: Date.now() - 86400000
          },
          {
            id: 'v2',
            name: '蠕?隨',
            content: 'smiling, happy expression, cheerful, joyful',
            createdAt: Date.now() - 172800000
          },
          {
            id: 'v3',
            name: '蠕?鬟',
            content: 'gentle breeze, wind effect, flowing movement, natural',
            createdAt: Date.now() - 259200000
          },
          {
            id: 'v4',
            name: '髦?蜈',
            content: 'sunlight, bright lighting, warm atmosphere, golden hour',
            createdAt: Date.now() - 345600000
          },
          {
            id: 'v5',
            name: '闕牙慍',
            content: 'grass field, green landscape, natural environment, outdoor',
            createdAt: Date.now() - 432000000
          },
          {
            id: 'v6',
            name: '諷?蜉?菴?,
            content: 'slow motion, cinematic effect, dramatic timing, smooth',
            createdAt: Date.now() - 518400000
          }
        ]
        // 莉朱?倩??隗??第署遉?隸肴峩譁?譬???譏蟆
        updateVideoTagMappingFromCommonPrompts(videoCommonPrompts.value.map(prompt => ({
          title: prompt.name,
          content: prompt.content
        })))
      }
    } catch (localError) {
      console.error('莉取悽蝨?郛灘?伜刈霓?螟?雍?', localError)
      videoCommonPrompts.value = []
    }
  }
}

// 螟?炊蟶?逕?謠千??隸肴峩譁?const handleCommonPromptsUpdated = (updatedPrompts) => {
  // 隶?鄂?蛻髯?譖?譁?譬??
  isUpdatingFromDelete.value = true
  
  // 譖?譁?蟶?逕?謠千??隸榊?陦?  commonPrompts.value = updatedPrompts
  
  // 貂?炊蟾?蛻髯?謠千??隸咲噪騾我??迥?諤?  const currentPromptIds = new Set(updatedPrompts.map(p => p.id))
  const selectedIdsToRemove = []
  
  selectedCommonPromptIds.value.forEach(id => {
    if (!currentPromptIds.has(id)) {
      selectedIdsToRemove.push(id)
    }
  })
  
  // 遘?髯?蟾?蛻髯?謠千??隸咲噪騾我??迥?諤?  selectedIdsToRemove.forEach(id => {
    selectedCommonPromptIds.value.delete(id)
  })
  
  // 貂?炊譬???謨?扈???蟾?蛻髯?逧???逕?謠千??隸
  const currentPromptNames = new Set(updatedPrompts.map(p => p.name))
  const originalTags = [...promptTags.value] // 菫晏?伜次蟋区???謨?扈
  
  promptTags.value = promptTags.value.filter(tag => {
    // 菫晉蕗髱槫??逕?謠千??隸肴????梧?閠??咲┯蟄伜惠逧???逕?謠千??隸肴???    const isCommonPrompt = originalTags.some(t => t === tag) && commonPrompts.value.some(p => p.name === tag)
    return !isCommonPrompt || currentPromptNames.has(tag)
  })
  
  // 謇句勘蜷梧??騾我??迥?諤??碁∩蜈購atch逶大成蝎?逧???謇?
  syncSelectedStateFromTags()
  
  // 驥咲??蛻髯?譖?譁?譬??
  isUpdatingFromDelete.value = false
}

// 螟?炊隗??大??逕?謠千??隸肴峩譁?const handleVideoCommonPromptsUpdated = (updatedPrompts) => {
  // 譖?譁?隗??大??逕?謠千??隸榊?陦?  videoCommonPrompts.value = updatedPrompts
  
  // 貂?炊蟾?蛻髯?謠千??隸咲噪騾我??迥?諤?  const currentPromptIds = new Set(updatedPrompts.map(p => p.id))
  const selectedIdsToRemove = []
  
  selectedVideoPromptIds.value.forEach(id => {
    if (!currentPromptIds.has(id)) {
      selectedIdsToRemove.push(id)
    }
  })
  
  // 遘?髯?蟾?蛻髯?謠千??隸咲噪騾我??迥?諤?  selectedIdsToRemove.forEach(id => {
    selectedVideoPromptIds.value.delete(id)
  })
  
  // 貂?炊譬???謨?扈???蟾?蛻髯?逧????大??逕?謠千??隸
  const currentPromptNames = new Set(updatedPrompts.map(p => p.name))
  
  videoPromptTags.value = videoPromptTags.value.filter(tag => {
    // 菫晉蕗髱槫??逕?謠千??隸肴????梧?閠??咲┯蟄伜惠逧???逕?謠千??隸肴???    return !videoCommonPrompts.value.some(p => p.name === tag) || currentPromptNames.has(tag)
  })
  
  // 驥肴眠蜉霓?隗??大??逕?謠千??隸榊?陦?  loadVideoCommonPrompts()
}

// 蠑?遯礼嶌蜈?譁?豕
const closeImageModal = () => {
  showImageModal.value = false
}

// 謇灘?隗??鷹???
const openVideoPreview = (video) => {
  currentPreviewVideo.value = {
    url: video.url || '',
    duration: video.duration || '',
    resolution: video.resolution || '',
    ratio: video.ratio || ''
  }
  showVideoModal.value = true
}

// 蜈?髣?隗??鷹???
const closeVideoModal = () => {
  showVideoModal.value = false
  // 貂???蠖灘燕鬚??郁???
  currentPreviewVideo.value = {
    url: '',
    duration: '',
    resolution: '',
    ratio: ''
  }
}

const prevImage = () => {
  if (currentImageIndex.value > 0 && currentBatchImages.value.length > 0) {
    currentImageIndex.value--
    currentPreviewImage.value = currentBatchImages.value[currentImageIndex.value].url
    currentPreviewTitle.value = `逕滓?逧?崟迚?${currentImageIndex.value + 1}`
    console.log('[螟?蝗?鄙?鬘?] 荳贋?蠑?', currentImageIndex.value + 1, '/', currentBatchImages.value.length)
    // 驥咲??郛?謾?蜥梧雷霓?    imageScale.value = 1
    imageRotation.value = 0
    imagePosition.value = { x: 0, y: 0 }
  }
}

const nextImage = () => {
  if (currentImageIndex.value < currentBatchImages.value.length - 1 && currentBatchImages.value.length > 0) {
    currentImageIndex.value++
    currentPreviewImage.value = currentBatchImages.value[currentImageIndex.value].url
    currentPreviewTitle.value = `逕滓?逧?崟迚?${currentImageIndex.value + 1}`
    console.log('[螟?蝗?鄙?鬘?] 荳倶?蠑?', currentImageIndex.value + 1, '/', currentBatchImages.value.length)
    // 驥咲??郛?謾?蜥梧雷霓?    imageScale.value = 1
    imageRotation.value = 0
    imagePosition.value = { x: 0, y: 0 }
  }
}

const zoomIn = () => {
  imageScale.value = Math.min(imageScale.value * 1.2, 5)
}

const zoomOut = () => {
  imageScale.value = Math.max(imageScale.value / 1.2, 0.1)
}

const resetZoom = () => {
  imageScale.value = 1
  imageRotation.value = 0
  imagePosition.value = { x: 0, y: 0 }
}

const rotateLeft = () => {
  imageRotation.value -= 90
}

const rotateRight = () => {
  imageRotation.value += 90
}

const handleImageWheel = (event) => {
  event.preventDefault()
  if (event.deltaY < 0) {
    zoomIn()
  } else {
    zoomOut()
  }
}

const startDrag = (event) => {
  isDragging.value = true
  dragStart.value = { x: event.clientX, y: event.clientY }
}

const handleDrag = (event) => {
  if (!isDragging.value) return
  
  const deltaX = event.clientX - dragStart.value.x
  const deltaY = event.clientY - dragStart.value.y
  
  imagePosition.value.x += deltaX
  imagePosition.value.y += deltaY
  
  dragStart.value = { x: event.clientX, y: event.clientY }
}

const endDrag = () => {
  isDragging.value = false
}

const downloadCurrentImage = async () => {
  const image = currentBatchImages.value[currentImageIndex.value]
  if (image) {
    try {
      // 莨伜?菴?逕?蜴溽函體?謗???AL體?謗??会?悟?よ棡豐?譛牙?菴?逕?OSS體?謗?
      const downloadUrl = image.originalUrl || image.url
      
      console.log(`荳玖??蠖灘燕蝗?迚: ${downloadUrl}`)
      
      // 譬?謐?URL邀?蝙矩画叫荳玖??譁?蠑擾?碁∩蜈垢ORS髣?鬚
      let response
      if (needsProxyDownload(downloadUrl)) {
        // 菴?逕?莉?逅?PI荳玖???碁∩蜈垢ORS髣?鬚
        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
        console.log(`[螟?蝗?荳玖??] 菴?逕?莉?逅: ${proxyUrl}`)
        response = await fetch(proxyUrl, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
      } else {
        // 逶?謗?荳玖??譛?蝨?蝗?迚
        console.log(`[螟?蝗?荳玖??] 逶?謗?荳玖??: ${downloadUrl}`)
        response = await fetch(downloadUrl)
      }
      
      if (!response.ok) {
        throw new Error('闔?蜿門崟迚???雍?')
      }
      
      const blob = await response.blob()
      const blobUrl = URL.createObjectURL(blob)
      
      const link = document.createElement('a')
      link.href = blobUrl
      link.download = `generated-image-${currentImageIndex.value + 1}-${Date.now()}.png`
      link.target = '_self'
      
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      
      URL.revokeObjectURL(blobUrl)
      
      ElMessage.success('荳玖??謌仙粥')
    } catch (error) {
      console.error('荳玖??螟?雍?:', error)
      ElMessage.error('荳玖??螟?雍?')
    }
  }
}

// 菫晏?伜?灘燕蝗?迚???謠千??隸
const saveCurrentImageAsPrompt = async () => {
  const image = currentBatchImages.value[currentImageIndex.value]
  if (!image) {
    ElMessage.warning('譌豕戊執蜿門?灘燕蝗?迚???諱?')
    return
  }
  
  // 譟?謇?蝗?迚?園螻樒噪謇?谺??瑚執蜿匁署遉?隸
  let batchPrompt = ''
  if (currentViewingBatchId.value) {
    const batch = generationBatches.value.find(b => b.id === currentViewingBatchId.value)
    batchPrompt = batch?.prompt || ''
  }
  
  // 螯よ棡謇?荳榊芦謇?谺?謠千??隸搾?悟?晁?穂??逕?蜈?螻prompt
  if (!batchPrompt && prompt.value) {
    batchPrompt = prompt.value
  }
  
  // 譫?蝗?迚?焚謐?  const imageData = {
    src: image.url,
    prompt: batchPrompt,
    title: currentPreviewTitle.value || `逕滓?逧?崟迚?${currentImageIndex.value + 1}`
  }
  
  console.log('[菫晏?俶署遉?隸江 蝗?迚?焚謐?:', imageData)
  
  // 隹?畑蟾?譛臥噪豺?蜉蛻?謠千??隸榊?謨?  await handleAddToPrompts(imageData)
}

// 隶?隸∫嶌蜈?譁?豕
const checkAuthStatus = () => {
  const token = localStorage.getItem('token')
  const user = localStorage.getItem('user')
  
  console.log('譽譟?隶?隸∫憾諤?', {
    token: token ? '蟄伜惠' : '荳榊?伜?,
    user: user ? '蟄伜惠' : '荳榊?伜?,
    tokenLength: token ? token.length : 0
  })
  
  if (token && user) {
    try {
      currentUser.value = JSON.parse(user)
      isLoggedIn.value = true
      console.log('逕?謌?蟾?逋?蠖?', currentUser.value)
    } catch (error) {
      console.error('隗?譫千畑謌?菫?諱?螟?雍?:', error)
      localStorage.removeItem('token')
      localStorage.removeItem('user')
    }
  } else {
    console.log('逕?謌?譛?逋?蠖?)
  }
}

// 蟇?闊?螟?炊蜃?謨?
const handleNavigate = (page) => {
  // 髴隕∫匳蠖慕噪鬘?髱?
  if (!isLoggedIn.value && (page === 'workspace' || page === 'history')) {
    showLoginDialog.value = true
    return
  }
  activePage.value = page
}

// 螟?炊"荳髞?蜷梧??蜉溯?
const handleUseTemplate = (params) => {
  if (!isLoggedIn.value) {
    // 譛?逋?蠖包?壻?晏?伜盾謨?蟷?譏?遉?逋?蠖募??遯?    workspaceInitialParams.value = params
    showLoginDialog.value = true
    return
  }
  
  // 蟾?逋?蠖包?壼??蜈?盾謨?蟷?霍?霓?蛻?蟾?菴懷?  activePage.value = 'workspace'
  
  // 蝪?蜈???蜊募盾謨?
  setTimeout(() => {
    if (params.prompt) {
      if (multilineTagInputRef.value) {
        multilineTagInputRef.value.setFullText(params.prompt)
      } else {
        prompt.value = params.prompt
      }
    }
    if (params.modelId) {
      selectedModelId.value = params.modelId
    }
    if (params.size) {
      imageSize.value = params.size
    }
    
    ElMessage.success('蜿よ焚蟾?蝪?蜈??悟庄莉?逶?謗?逕滓???)
  }, 100)
}

// 蜿大??芦鬥夜??蜉溯?const publishToHome = async (imageData, batchInfo) => {
  try {
    const workData = {
      coverUrl: imageData.url,
      contentType: imageData.isVideo ? 'video' : 'image',
      prompt: batchInfo?.prompt || (multilineTagInputRef.value ? multilineTagInputRef.value.getFullText() : prompt.value),
      modelId: imageData.isVideo ? (batchInfo?.params?.modelDbId || videoSelectedModelId.value) : selectedModelId.value,
      modelName: imageData.isVideo 
        ? videoModels.value.find(m => m.id === (batchInfo?.params?.modelDbId || videoSelectedModelId.value))?.name
        : availableModels.value.find(m => m.id === selectedModelId.value)?.name,
      size: imageData.isVideo ? (batchInfo?.params?.resolution || videoResolution.value) : imageSize.value
    }
    
    // 螯よ棡譏?隗??托?梧??蜉隗??第焚謐?
    if (imageData.isVideo) {
      workData.videoData = {
        duration: imageData.duration || batchInfo?.params?.duration,
        resolution: imageData.resolution || batchInfo?.params?.resolution,
        ratio: imageData.ratio || batchInfo?.params?.ratio,
        fps: imageData.fps
      }
    }
    
    const response = await publishWork(workData)
    
    if (response.data.success) {
      ElMessage.success('笨?菴懷刀蟾?謌仙粥蜿大??芦鬥夜????)
    } else {
      throw new Error(response.data.message || '蜿大????雍?')
    }
  } catch (error) {
    console.error('蜿大????雍?:', error)
    ElMessage.error('蜿大????雍??? + (error.message || '譛?遏?髞呵??'))
  }
}

const handleLoginSuccess = async (user) => {
  currentUser.value = user
  isLoggedIn.value = true
  
  // 螯よ棡譛牙????炊逧???菴懷床蜿よ焚?井?髞?蜷梧???会?悟?蠎皮畑螳???
  if (workspaceInitialParams.value) {
    activePage.value = 'workspace'
    
    // 蝪?蜈?盾謨?
    const params = workspaceInitialParams.value
    if (params.prompt) {
      if (multilineTagInputRef.value) {
        multilineTagInputRef.value.setFullText(params.prompt)
      } else {
        prompt.value = params.prompt
      }
    }
    if (params.modelId) {
      selectedModelId.value = params.modelId
    }
    if (params.size) {
      imageSize.value = params.size
    }
    
    // 貂???蜿よ焚
    workspaceInitialParams.value = null
  } else {
    // 蜷?蛻呵??霓?蛻?蟾?菴懷床
    activePage.value = 'workspace'
  }
  
  // 逋?蠖墓?蜉溷錘闔?蜿門??逕?蜿り?崟蜥梧署遉?隸
  fetchCommonReferenceImages()
  loadCommonPrompts()
  loadVideoCommonPrompts() // 蜉霓?隗??大??逕?謠千??隸?  loadUserPrompts() // 蜉霓?逕?謌?謠千??隸?  
  // 譽豬句??荳贋?localStorage荳?逧?署遉?隸?  await checkAndUploadLocalStoragePrompts()
  
  ElMessage.success('逋?蠖墓?蜉滂??)
}

const handleLogout = async () => {
  try {
    await ElMessageBox.confirm('遑?螳夊??蜃?逋?蠖募雛??, '謠千??', {
      confirmButtonText: '遑?螳',
      cancelButtonText: '蜿匁?',
      type: 'warning'
    })
    
    // 隹?畑譛榊苅遶?騾蜃?逋?蠖墓磁蜿?    try {
      const token = localStorage.getItem('token')
      if (token) {
        await fetch('/api/auth/logout', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
      }
    } catch (error) {
      console.error('隹?畑騾蜃?逋?蠖墓磁蜿?螟?雍?', error)
      // 蜊?菴?譛榊苅遶?隹?畑螟?雍??御?溯?∵??勁譛?蝨?郛灘?
    }
    
    // 菴?逕?蟾?蜈?蜃?謨?貂?勁謇譛臥畑謌?郛灘??    const clearSuccess = clearAllUserCache()
    
    // 驥咲??迥?諤?    isLoggedIn.value = false
    currentUser.value = null
    
    // 貂???蠎皮畑謨?謐?
    generatedImages.value = []
    uploadedImages.value = []
    uploadedFiles.value = []
    prompt.value = ''
    promptTags.value = []
    userPrompts.value = []
    commonPrompts.value = []
    selectedCommonPromptIds.value.clear()
    
    // 霍?霓?蛻?鬥夜??    activePage.value = 'home'
    
    if (clearSuccess) {
      ElMessage.success('蟾?騾蜃?逋?蠖包?梧園譛臥?灘?伜??貂?勁')
    } else {
      ElMessage.warning('蟾?騾蜃?逋?蠖包?御??Κ蛻??灘?俶??勁螟?雍?)
    }
  } catch (error) {
    // 逕?謌?蜿匁?磯蜃?  }
}

// 蜉霓?逕?謌?謠千??隸?const loadUserPrompts = async () => {
  try {
    userPromptsLoading.value = true
    
    const token = localStorage.getItem('token')
    if (!token) {
      userPrompts.value = []
      return
    }
    
    // 莉取恪蜉?蝎?API蜉霓?謠千??隸?    const response = await fetch('/api/prompts', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    
    if (response.ok) {
      const result = await response.json()
      if (result.success) {
        // 霓?謐?譛榊苅蝎?謨?謐?譬?蠑丈??蜑咲??譬?蠑
        userPrompts.value = result.data.map(prompt => ({
          id: prompt.id.toString(),
          title: prompt.title,
          content: prompt.content,
          // 菫?螟搾?壼??擇菴?逕?逕滓?扈捺棡蝗??御???晏?倡噪蜿り?崟體?謗?菫晄戟荳榊序
          referenceImage: prompt.cover_image_url || prompt.oss_url || prompt.reference_image_url || null,
          // 菫晏?伜盾閠?崟體?謗?逕?莠守せ蜃?蜊?迚?慮蜉霓?          referenceImageUrl: prompt.reference_image_url || null,
          createdAt: new Date(prompt.created_at).getTime(),
          updatedAt: new Date(prompt.updated_at).getTime(),
          // 豺?蜉郛?螟?逧??髞?蟄玲??          tags: prompt.tags,
          manual_input: prompt.manual_input,
          selected_common_prompts: prompt.selected_common_prompts,
          selected_reference_images: prompt.selected_reference_images,
          generation_mode: prompt.generation_mode,
          image_size: prompt.image_size,
          generate_quantity: prompt.generate_quantity
        }))
        
        // 蜷梧慮譖?譁?localStorage菴應??郛灘?
        localStorage.setItem('promptManager', JSON.stringify(userPrompts.value))
      } else {
        throw new Error(result.message || '蜉霓?謠千??隸榊??雍?)
      }
    } else if (response.status === 401) {
      // 隶?隸∝??雍??梧??勁郛灘?伜??驥肴眠逋?蠖
      clearAllUserCache()
      isLoggedIn.value = false
      currentUser.value = null
      ElMessage.error('逋?蠖募??霑?悄?瑚??驥肴眠逋?蠖?)
    } else {
      throw new Error('鄂醍?懆??豎ょ??雍?')
    }
  } catch (error) {
    console.error('蜉霓?逕?謌?謠千??隸榊??雍?', error)
    
    // 螯よ棡API隹?畑螟?雍??悟?晁?穂?四ocalStorage蜉霓?菴應??螟?畑
    try {
    const savedPrompts = localStorage.getItem('promptManager')
    if (savedPrompts) {
      userPrompts.value = JSON.parse(savedPrompts)
        ElMessage.warning('蟾?莉取悽蝨?郛灘?伜刈霓?謠千??隸?)
    } else {
      userPrompts.value = []
    }
    } catch (localError) {
      console.error('莉取悽蝨?郛灘?伜刈霓?螟?雍?', localError)
    userPrompts.value = []
    }
  } finally {
    userPromptsLoading.value = false
  }
}

// 譽豬句??荳贋?localStorage荳?逧?署遉?隸?const checkAndUploadLocalStoragePrompts = async () => {
  try {
    const token = localStorage.getItem('token')
    if (!token) {
      return
    }

    // 譽譟?localStorage荳?譏?蜷?譛画署遉?隸肴焚謐?    const promptCardsData = localStorage.getItem('promptManager')
    const commonPromptsData = localStorage.getItem('commonPrompts')
    
    let promptCards = []
    let commonPrompts = []
    
    // 隗?譫先署遉?隸榊今迚?焚謐?    if (promptCardsData) {
      try {
        const parsed = JSON.parse(promptCardsData)
        if (Array.isArray(parsed) && parsed.length > 0) {
          promptCards = parsed
        }
      } catch (error) {
        console.error('隗?譫先署遉?隸榊今迚?焚謐?螟?雍?', error)
      }
    }
    
    // 隗?譫仙??逕?謠千??隸肴焚謐?    if (commonPromptsData) {
      try {
        const parsed = JSON.parse(commonPromptsData)
        if (Array.isArray(parsed) && parsed.length > 0) {
          commonPrompts = parsed
        }
      } catch (error) {
        console.error('隗?譫仙??逕?謠千??隸肴焚謐?螟?雍?', error)
      }
    }
    
    // 螯よ棡豐?譛画焚謐?髴隕∽?贋??檎峩謗?霑泌屓
    if (promptCards.length === 0 && commonPrompts.length === 0) {
      return
    }
    
    // 譏?遉?遑?隶?蟇?隸晄??    const confirmResult = await ElMessageBox.confirm(
      `譽豬句芦謔?譛 ${promptCards.length} 荳?謠千??隸榊今迚??${commonPrompts.length} 荳?蟶?逕?謠千??隸榊?伜お蝨?譛?蝨??梧弍蜷?隕∽?贋?蛻?譛榊苅蝎??歔,
      '荳贋?譛?蝨?謠千??隸?,
      {
        confirmButtonText: '荳贋?',
        cancelButtonText: '遞榊錘',
        type: 'info',
        distinguishCancelAndClose: true
      }
    ).catch(() => {
      // 逕?謌?蜿匁?域?蜈?髣?蟇?隸晄?
      return false
    })
    
    if (!confirmResult) {
      return
    }
    
    // 譏?遉?荳贋?霑帛??
    const loadingInstance = ElLoading.service({
      lock: true,
      text: '豁?蝨?荳贋?謠千??隸?..',
      background: 'rgba(0, 0, 0, 0.7)'
    })
    
    try {
      // 隹?畑謇?驥丈?贋?API
      const response = await fetch('/api/prompts/batch-upload', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          promptCards,
          commonPrompts
        })
      })
      
      if (!response.ok) {
        throw new Error('荳贋?螟?雍?')
      }
      
      const result = await response.json()
      
      if (result.success) {
        const { promptCards: promptCardsResult, commonPrompts: commonPromptsResult } = result.data
        const totalSuccess = promptCardsResult.success + commonPromptsResult.success
        const totalFailed = promptCardsResult.failed + commonPromptsResult.failed
        
        if (totalSuccess > 0) {
          ElMessage.success(`謌仙粥荳贋? ${totalSuccess} 荳?謠千??隸榊芦譛榊苅蝎?`)
          
          // 驥肴眠蜉霓?譛榊苅蝎?荳顔噪謠千??隸
          await loadUserPrompts()
          await loadCommonPrompts()
          
          // 蜿?騾会?壽??勁localStorage荳?逧?署遉?隸肴焚謐??磯∩蜈埼?螟堺?贋???          if (totalFailed === 0) {
            const clearResult = await ElMessageBox.confirm(
              '謇譛画署遉?隸榊??謌仙粥荳贋??梧弍蜷?貂?勁譛?蝨?郛灘?假??,
              '貂?勁譛?蝨?郛灘?',
              {
                confirmButtonText: '貂?勁',
                cancelButtonText: '菫晉蕗',
                type: 'success'
              }
            ).catch(() => false)
            
            if (clearResult) {
              localStorage.removeItem('promptManager')
              localStorage.removeItem('commonPrompts')
              ElMessage.success('譛?蝨?郛灘?伜??貂??)
            }
          }
        }
        
        if (totalFailed > 0) {
          const errors = [...promptCardsResult.errors, ...commonPromptsResult.errors]
          ElMessage.warning(`${totalFailed} 荳?謠千??隸堺?贋?螟?雍??瑚??譽譟?譏?蜷?譛蛾?螟榊?螳?`)
          console.warn('荳贋?螟?雍?逧?署遉?隸:', errors)
        }
      } else {
        throw new Error(result.message || '荳贋?螟?雍?')
      }
    } catch (error) {
      console.error('荳贋?謠千??隸榊??雍?', error)
      ElMessage.error(`荳贋?螟?雍?: ${error.message}`)
    } finally {
      loadingInstance.close()
    }
    
  } catch (error) {
    console.error('譽豬詰ocalStorage謠千??隸榊??雍?', error)
  }
}

// 蜷梧??騾我??迥?諤∽?取???謨?扈
const syncSelectedStateFromTags = () => {
  // 貂???蠖灘燕騾我??迥?諤?  selectedCommonPromptIds.value.clear()
  
  // 譽譟?蜩?莠帛??逕?謠千??隸榊惠譬???荳?
  commonPrompts.value.forEach(promptItem => {
    if (promptTags.value.includes(promptItem.name)) {
      selectedCommonPromptIds.value.add(promptItem.id)
    }
  })
}

// 逶大成謠千??隸肴???蜿伜喧?悟酔豁?譖?譁?騾我??迥?諤?watch(promptTags, (newTags) => {
  // 蜿?譛牙惠髱槫唖髯?謫堺?懈慮謇崎?蜉?蜷梧??
  // 蛻髯?謫堺?應?夐夊? handleCommonPromptsUpdated 謇句勘蜷梧??
  if (!isUpdatingFromDelete.value) {
    syncSelectedStateFromTags()
  }
})

// 逶大成逕滓?讓?蠑丞序蛹厄?碁?鄂?逶?蠎皮噪謠千??隸咲憾諤?watch(generationMode, (newMode) => {
  if (newMode === 'image-to-video') {
    // 蛻?困蛻?AI隗??第??蠑乗慮?檎??菫晁???第署遉?隸榊??蜉霓?
    if (videoCommonPrompts.value.length === 0) {
      loadVideoCommonPrompts()
    }
  }
})

// 扈???謖り??譌?譽譟?隶?隸∫憾諤?onMounted(() => {
  checkAuthStatus()
  fetchAvailableModels() // 闔?蜿門庄逕?讓?蝙句?陦?
  fetchVideoModels() // 闔?蜿冶???第??蝙句?陦?
  if (isLoggedIn.value) {
  fetchCommonReferenceImages()
  loadCommonPrompts()
  loadVideoCommonPrompts() // 蜉霓?隗??大??逕?謠千??隸?    loadUserPrompts()
  }
})
</script>

<style>
/* 蜈?螻驥咲???檎??菫晏?謾?蠑丞??? - 菴?逕?髱枹coped譬?蠑剰??尠謇譛蛾?倩??譬?蠑?*/
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100% !important;
  width: 100% !important;
  margin: 0 !important;
  padding: 0 !important;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
  background: #f5f7fa !important;
  overflow-x: hidden !important;
}

#app {
  height: 100vh !important;
  width: 100vw !important;
  margin: 0 !important;
  padding: 0 !important;
}
</style>

<style scoped>
/* 譁?蠅橸?壼?皮畑譬?螳?蝎? */
.app-root {
  display: flex;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  background: #f8fafc;
}

.main-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
}

.main-layout {
  display: flex;
  height: 100vh;
  width: 100%;
  margin: 0;
  padding: 0;
  background: #f8fafc;
  overflow: hidden;
  gap: 16px;
}

/* 蟾?萓?髱?譚??啜AB蛻?困 + 逕?謌?雍?謌?邉?扈 */
.left-panel {
  width: 350px;
  height: calc(100vh - 32px);
  margin: 16px 0 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 0;
  flex-shrink: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  border: 1px solid #e2e8f0;
  overflow: hidden;
}

/* TAB蛻?困蛹?蝓 */
.tab-section {
  background: white;
  border-radius: 12px 12px 0 0;
  box-shadow: none;
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  position: relative;
}

/* Tab螟?驛?螳?蝎? */
.tab-header {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 16px 16px 0 16px;
}

/* Tab邂?逅?潔髓? */
.prompts-manage-header {
  padding: 0 16px 6px 16px;
  border-bottom: 1px solid rgba(226, 232, 240, 0.6);
  margin-bottom: 4px;
}

.prompts-manage-btn {
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 12px;
  height: 28px;
  width: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
  font-weight: 500;
}

.prompts-manage-btn:hover {
  background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.left-tabs {
  height: 100%;
  display: flex;
  flex-direction: column;
  flex: 1;
}

.left-tabs .el-tabs__header {
  margin: 0 24px 0 24px;
  padding-bottom: 12px;
  background: transparent;
  border-bottom: 1px solid #e2e8f0;
}

.left-tabs .el-tabs__content {
  flex: 1;
  padding: 0;
  overflow: hidden;
}

.left-tabs .el-tab-pane {
  height: 100%;
  overflow: hidden;
}

.left-tabs .el-tabs__nav-wrap::after {
  display: none;
}

.left-tabs .el-tabs__item {
  font-size: 14px;
  font-weight: 600;
  color: #64748b;
  padding: 0 28px;
  height: 40px;
  line-height: 40px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.left-tabs .el-tabs__item.is-active {
  color: #667eea;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.left-tabs .el-tabs__item:hover {
  color: #667eea;
  background: rgba(102, 126, 234, 0.1);
}

.tab-content {
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  padding: 0 12px 12px 12px;
}

/* 謠千??隸榊今迚???蝎?*/
/* 謠千??隸咲大???∝??蝎?*/
.prompts-waterfall-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 8px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  align-content: start;
  grid-auto-rows: min-content;
  max-height: calc(100vh - 200px);
  scrollbar-width: thin;
  scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

.prompts-waterfall-container::-webkit-scrollbar {
  width: 6px;
}

.prompts-waterfall-container::-webkit-scrollbar-track {
  background: transparent;
}

.prompts-waterfall-container::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 3px;
}

.prompts-waterfall-container::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 0, 0, 0.3);
}

/* 蜉霓?迥?諤∵?蠑?*/
.loading-prompts {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 200px;
}

/* 轢大???∵署遉?隸榊今迚??蠑 */
.prompt-card-waterfall {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 8px;
  padding: 0;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid rgba(226, 232, 240, 0.8);
  display: flex;
  flex-direction: column;
  aspect-ratio: 3/4;
  width: 100%;
  min-height: 150px;
  max-height: 200px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  overflow: hidden;
}

.prompt-card-waterfall:hover {
  background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
  border-color: #667eea;
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
}

.card-image-waterfall {
  width: 100%;
  height: 85%;
  border-radius: 0;
  overflow: hidden;
  margin-bottom: 0;
  background: linear-gradient(135deg, #f5f5f5 0%, #e8f2ff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  position: relative;
}

.card-image-waterfall img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 0;
}

.no-image-waterfall {
  color: #94a3b8;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
}

.card-content-waterfall {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 4px;
}

.card-title-waterfall {
  font-size: 11px;
  font-weight: 600;
  color: #334155;
  margin: 0 0 2px 0;
  line-height: 1.2;
  text-align: center;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
}



.card-content {
  margin-bottom: 8px;
}

.card-title {
  font-size: 13px;
  font-weight: 600;
  color: #333;
  margin: 0 0 4px 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-text {
  font-size: 11px;
  color: #666;
  margin: 0;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.card-actions {
  display: flex;
  gap: 4px;
}

.card-actions .el-button {
  flex: 1;
  font-size: 11px;
  padding: 4px 8px;
  height: auto;
}

/* 遨?迥?諤?*/
.empty-prompts {
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.empty-prompts .el-icon {
  color: #ccc;
  margin-bottom: 12px;
}

.empty-prompts p {
  margin: 0 0 16px 0;
  font-size: 14px;
}

/* 豺?蜉謠千??隸榊玄蝓?*/
.add-prompt-section {
  padding: 16px;
  border-top: 1px solid #f0f0f0;
  background: #fafafa;
}

.add-prompt-btn {
  width: 100%;
  height: 36px;
  font-size: 13px;
}

/* 逕?謌?雍?謌?蜊?迚??亥?暮Κ?梧裏髣?霍晢? */
.user-account-card {
  background: white;
  border-radius: 0 0 12px 12px;
  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
  padding: 12px 20px;
  height: 60px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  border-top: 1px solid #e2e8f0;
  position: relative;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 0;
}

.user-avatar {
  flex-shrink: 0;
}

.user-details {
  flex: 1;
  min-width: 0;
}

.username {
  font-size: 13px;
  font-weight: 600;
  color: #333;
  margin-bottom: 1px;
}

.user-status {
  font-size: 11px;
  color: #52c41a;
}

.user-actions {
  display: flex;
  justify-content: flex-end;
}

.more-btn {
  padding: 4px;
  color: #666;
}

.more-btn:hover {
  color: #333;
}

.control-panel {
  width: 450px;
  height: calc(100vh - 32px);
  margin: 16px 0;
  background: white;
  padding: 12px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  border: 1px solid #e2e8f0;
  overflow-y: auto;
  flex-shrink: 0;
}

.result-panel {
  flex: 1;
  height: calc(100vh - 32px);
  margin: 16px 16px 16px 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  border: 1px solid #e2e8f0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.result-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #e2e8f0;
  background: white;
  flex-shrink: 0;
  border-radius: 12px 12px 0 0;
}

.result-header h2 {
  margin: 0;
  color: #334155;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}


.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.auto-download-switch {
  display: flex;
  align-items: center;
}

.auto-download-switch .el-switch {
  --el-switch-on-color: #67c23a;
  --el-switch-off-color: #dcdfe6;
}

.auto-download-switch .el-switch__label {
  font-size: 12px;
  color: #606266;
}

.result-content {
  flex: 1;
  padding: 8px 12px;
  display: flex;
  align-items: flex-start;
  overflow-y: auto;
}

/* 逕滓?霑帛??蛹?蝓 */
.generating-result {
  flex: 1;
  display: flex;
  flex-direction: column;
  width: 100%;
}

.generating-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid #e4e7ed;
}

.generating-header h3 {
  margin: 0;
  color: #303133;
  font-size: 18px;
  font-weight: 600;
}

.progress-text {
  color: #409EFF;
  font-weight: 600;
  font-size: 14px;
}

/* 莉?蜉?鄂第? */
.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 240px)); /* 荳屍esults-grid菫晄戟荳閾?*/
  gap: 12px;
  flex: 1;
  margin-top: 8px;
}

/* 莉?蜉?蜊?迚 */
.task-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  border: 2px solid transparent;
  height: 200px; /* 荳屍esults-grid菫晄戟荳閾?*/
  display: flex;
  align-items: center;
  justify-content: center;
}

.task-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.task-pending {
  border-color: #e4e7ed;
}

.task-processing {
  border-color: #409EFF;
  animation: pulse 2s infinite;
}

.task-completed {
  border-color: #67c23a;
}

.task-failed {
  border-color: #f56c6c;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(64, 158, 255, 0.4);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(64, 158, 255, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(64, 158, 255, 0);
  }
}

.task-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: 12px;
}

.task-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.pending-icon {
  color: #909399;
}

.processing-icon {
  color: #409EFF;
  animation: spin 1s linear infinite;
}

.completed-icon {
  color: #67c23a;
}

.failed-icon {
  color: #f56c6c;
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.task-info h4 {
  margin: 0 0 4px 0;
  color: #303133;
  font-size: 16px;
  font-weight: 600;
}

.task-info p {
  margin: 0;
  color: #606266;
  font-size: 14px;
}

/* 髞呵??菫?諱?譬?蠑 - 蟆丞?嶺?比?崎???螳?蝎? */
.task-info p.error-message {
  font-size: 12px;
  color: #f56c6c;
  word-wrap: break-word;
  word-break: break-word;
  overflow-wrap: break-word;
  max-width: 100%;
  line-height: 1.4;
}

.task-progress {
  width: 100%;
  margin-top: 8px;
}

/* 莉?蜉?迥?諤∵?り??*/
.task-summary {
  width: 100%;
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.summary-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #e4e7ed;
}

.summary-header h3 {
  margin: 0;
  color: #303133;
  font-size: 18px;
  font-weight: 600;
}

.summary-text {
  color: #67c23a;
  font-weight: 600;
  font-size: 14px;
}

.summary-tasks {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.summary-task {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 8px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.summary-task.task-pending {
  border-color: #e4e7ed;
  background: #f8f9fa;
}

.summary-task.task-processing {
  border-color: #409EFF;
  background: #f0f9ff;
}

.summary-task.task-completed {
  border-color: #67c23a;
  background: #f0f9f0;
}

.summary-task.task-failed {
  border-color: #f56c6c;
  background: #fef0f0;
}

.summary-task-icon {
  font-size: 16px;
}

.summary-task-text {
  font-size: 14px;
  font-weight: 500;
  color: #303133;
}

.history-section {
  margin-bottom: 24px;
}

.history-btn {
  width: 100%;
  height: 44px;
  font-size: 16px;
  font-weight: 500;
  border-radius: 8px;
}

.mode-section {
  margin-bottom: 24px;
  padding: 16px;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.mode-section h3 {
  margin: 0 0 12px 0;
  font-size: 15px;
  font-weight: 600;
  color: #334155;
  display: flex;
  align-items: center;
  gap: 8px;
}


/* 蜈?螻Tab蛻?困譬?蠑 */
.global-mode-tabs {
  width: 100%;
  margin-bottom: 1px;
}

.global-mode-tabs .el-tabs__header {
  margin: 0;
  padding-bottom: 0;
  background: transparent;
  border-bottom: 1px solid #e2e8f0;
}

.global-mode-tabs .el-tabs__nav-wrap {
  padding: 0;
}

.global-mode-tabs .el-tabs__nav-wrap::after {
  display: none;
}

.global-mode-tabs .el-tabs__nav {
  display: flex;
  width: 100%;
  background: transparent;
}

.global-mode-tabs .el-tabs__item {
  flex: 1;
  font-size: 15px;
  font-weight: 500;
  color: #64748b;
  padding: 0 20px;
  height: 44px;
  line-height: 44px;
  transition: all 0.3s ease;
  text-align: center;
  background: transparent;
  border: none;
  position: relative;
}

.global-mode-tabs .el-tabs__item.is-active {
  color: #3b82f6;
  background: transparent;
}

.global-mode-tabs .el-tabs__item.is-active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60%;
  height: 3px;
  background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
  border-radius: 2px;
}

.global-mode-tabs .el-tabs__item:hover:not(.is-active) {
  color: #3b82f6;
  background: rgba(59, 130, 246, 0.05);
}

.global-mode-tabs .el-tabs__content {
  display: none;
}

.prompt-section {
  margin-bottom: 8px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
}

.prompt-header {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  margin-bottom: 8px;
}



.prompt-manager-btn {
  border-radius: 6px;
  font-size: 12px;
  padding: 6px 12px;
}

/* 螟夊?梧???霎灘?扈???譬?蠑 */
.prompt-input-tag {
  width: 100%;
  margin-bottom: 16px;
}

.prompt-input-tag :deep(.tags-container) {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border: 1px solid #e4e7ed;
  transition: all 0.3s ease;
}

.prompt-input-tag :deep(.tags-container:hover) {
  border-color: #c0c4cc;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.prompt-input-tag :deep(.tags-container.is-focused) {
  border-color: #409eff;
  box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
}

.prompt-input-tag :deep(.tag-item) {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
  font-weight: 500;
  margin: 0;
  max-width: 200px;
  word-break: break-all;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.prompt-input-tag :deep(.tag-item:hover) {
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.prompt-input-tag :deep(.tag-item .el-tag__close) {
  color: white;
  font-size: 12px;
}

.prompt-input-tag :deep(.tag-item .el-tag__close:hover) {
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
}

.prompt-input-tag :deep(.textarea-input .el-textarea__inner) {
  background: transparent;
  border: none;
  font-size: 14px;
  line-height: 1.5;
  color: #606266;
}

.prompt-input-tag :deep(.textarea-input .el-textarea__inner::placeholder) {
  color: #a8abb2;
  font-style: italic;
}

.prompt-input-tag :deep(.input-hint) {
  color: #909399;
  font-size: 12px;
}

.common-prompts {
  margin-top: 12px;
}

.common-prompts-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.common-prompts-label {
  font-size: 12px;
  color: #666;
  font-weight: 500;
}

.manage-prompts-btn {
  font-size: 11px;
  padding: 2px 6px;
  height: auto;
}

.common-prompts-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.common-prompts-buttons .el-button {
  font-size: 12px;
  padding: 4px 8px;
  height: auto;
  margin: 0;
  transition: all 0.3s ease;
}

.common-prompts-buttons .el-button.selected-prompt {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  border-color: #3b82f6;
  color: white;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  transform: translateY(-1px);
}

.common-prompts-buttons .el-button.selected-prompt:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
  border-color: #2563eb;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.image-upload-section {
  margin-bottom: 16px;
  padding: 16px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.image-upload-section h3 {
  margin: 0 0 12px 0;
  color: #334155;
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}


.image-upload-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.image-upload-header h3 {
  margin: 0;
  color: #334155;
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}


.reference-manager-btn {
  font-size: 12px;
}

.upload-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.image-uploader {
  width: 100%;
  display: flex;
  justify-content: center;
}

.upload-placeholder-square {
  width: 80px;
  height: 80px;
  border: 2px dashed #d9d9d9;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #fafafa;
}

.upload-placeholder-square:hover {
  border-color: #409eff;
  background: #f0f9ff;
  transform: translateY(-2px);
}

.upload-icon {
  font-size: 24px;
  color: #c0c4cc;
}

.upload-text-container {
  text-align: center;
}

.upload-text {
  font-size: 14px;
  color: #606266;
  margin-bottom: 4px;
}

.upload-hint {
  font-size: 12px;
  color: #909399;
}



.image-preview {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.image-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.image-preview:hover .image-overlay {
  opacity: 1;
}

/* 蟾?荳贋?蝗?迚?玄蝓?*/
.uploaded-images {
  margin-top: 16px;
}

.images-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 14px;
  color: #333;
}

/* 讓?蜷第賜蛻礼噪蝗?迚??第?*/
.images-horizontal-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.image-item-small {
  position: relative;
  width: 50px;
  height: 50px;
  border-radius: 4px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  flex-shrink: 0;
}

.image-item-small img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-overlay-small {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.image-item-small:hover .image-overlay-small {
  opacity: 1;
}

.image-overlay-small .el-button {
  padding: 2px 6px;
  font-size: 10px;
  height: auto;
}


/* 蟶?逕?蜿り?崟蝗?譬?玄蝓 */
.common-reference-icons {
  margin-top: 16px;
}

.icons-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 14px;
  color: #333;
  font-weight: 500;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* 蛻???譬???譬?蠑 */
.category-tabs {
  display: flex;
  gap: 6px;
}

.category-tab {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: #f5f7fa;
  border: 1px solid #e4e7ed;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 12px;
}

.category-tab:hover {
  background: #ecf5ff;
  border-color: #b3d8ff;
}

.category-tab.active {
  background: #409eff;
  border-color: #409eff;
  color: white;
}

.category-name {
  font-weight: 500;
}

.category-count {
  opacity: 0.8;
  font-size: 11px;
}


.collapse-btn {
  font-size: 12px;
  padding: 4px 8px;
  height: auto;
}

.icons-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 6px;
  transition: all 0.3s ease;
}

.icons-grid.collapsed {
  max-height: 92px; /* 2陦檎噪鬮伜?? */
  overflow: hidden;
}

.reference-icon {
  width: 40px;
  height: 40px;
  border-radius: 4px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 2px solid transparent;
}

.reference-icon:hover {
  border-color: #409eff;
  transform: scale(1.05);
}

.reference-icon img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.settings-section {
  margin-bottom: 8px;
  padding: 12px;
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  border-radius: 6px;
  border: 1px solid rgba(226, 232, 240, 0.5);
  display: flex;
  gap: 8px;
}

.settings-section.compact-section {
  padding: 8px;
  margin-bottom: 6px;
}

.setting-item {
  flex: 1;
}

.setting-item h3 {
  margin: 0 0 10px 0;
  color: #334155;
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}


.setting-select {
  width: 100%;
}

.setting-select .el-select__wrapper {
  border-radius: 8px;
  height: 40px;
}

/* 荳贋?倶??蛻怜???譬?蠑 */
.settings-section.vertical-layout {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.settings-section.vertical-layout .setting-item {
  width: 100%;
}

/* 譬???騾画叫蝎?譬?蠑?- 蜿ら?蜴溷梛蝗?邂郤?隶?隶?*/
.tag-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}

.tag-option {
  padding: 6px 12px;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  background: #ffffff;
  color: #64748b;
  font-size: 13px;
  font-weight: 400;
  cursor: pointer;
  transition: all 0.15s ease;
  user-select: none;
  text-align: center;
  min-width: 32px;
}

.tag-option:hover {
  border-color: #667eea;
  color: #667eea;
  background: #f8faff;
}

.tag-option.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: #667eea;
  color: #ffffff;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

/* ==================== 豈比?矩画叫蝎?譬?蠑?==================== */
.ratio-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 6px;
}

.ratio-option {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  border: 1.5px solid #e2e8f0;
  border-radius: 6px;
  background: #ffffff;
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
  min-width: 45px;
}

.ratio-option:hover {
  border-color: #667eea;
  background: #f8faff;
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
}

.ratio-option.active {
  border-color: #667eea;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  transform: translateY(-2px);
}

.ratio-option.active .ratio-box {
  border-color: #ffffff;
  background: rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
}

.ratio-option.active .ratio-text {
  color: #ffffff;
  font-weight: 600;
}

.ratio-box {
  border: 2px solid #94a3b8;
  background: transparent;
  transition: all 0.2s ease;
}

.ratio-text {
  font-size: 10px;
  color: #64748b;
  font-weight: 500;
  transition: all 0.2s ease;
  white-space: nowrap;
  line-height: 1;
}

/* 荳榊酔豈比?狗噪郤?譯???蟇?- 蠅槫刈2px */
.ratio-box.ratio-1-1 {
  width: 14px;
  height: 14px;
  border-radius: 2px;
}

.ratio-box.ratio-16-9 {
  width: 18px;
  height: 11px;
  border-radius: 2px;
}

.ratio-box.ratio-9-16 {
  width: 11px;
  height: 18px;
  border-radius: 2px;
}

.ratio-box.ratio-4-3 {
  width: 16px;
  height: 12px;
  border-radius: 2px;
}

.ratio-box.ratio-3-4 {
  width: 12px;
  height: 16px;
  border-radius: 2px;
}

.ratio-box.ratio-3-2 {
  width: 17px;
  height: 12px;
  border-radius: 2px;
}

.ratio-box.ratio-2-3 {
  width: 12px;
  height: 17px;
  border-radius: 2px;
}

.ratio-box.ratio-21-9 {
  width: 20px;
  height: 10px;
  border-radius: 2px;
}

.ratio-box.ratio-9-21 {
  width: 10px;
  height: 20px;
  border-radius: 2px;
}

.ratio-box.ratio-4-5 {
  width: 14px;
  height: 17px;
  border-radius: 2px;
}

.ratio-box.ratio-5-4 {
  width: 17px;
  height: 14px;
  border-radius: 2px;
}

.action-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 8px;
  padding: 8px;
  background: #f8fafc;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
}

.concurrent-tip {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  margin-top: 12px;
  background: #e0f2fe;
  border-radius: 8px;
  border: 1px solid #7dd3fc;
  font-size: 13px;
  color: #0369a1;
}

.concurrent-tip .el-icon {
  font-size: 16px;
  flex-shrink: 0;
}

/* 遑?菫晄潔髓?螳悟?蟇?鮨 */
.action-buttons .el-button {
  margin: 0;
  padding: 0;
  border: none;
  box-sizing: border-box;
}

.generate-btn {
  width: 100%;
  height: 48px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

.generate-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
}

.reset-btn {
  width: 100%;
  height: 48px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.empty-result {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 400px;
  width: 100%;
  padding: 40px 20px;
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  max-width: 300px;
}

.empty-icon-container {
  position: relative;
  margin-bottom: 24px;
}

.empty-icon {
  font-size: 80px;
  color: #e0e0e0;
  z-index: 2;
  position: relative;
}

.empty-decoration {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 120px;
  height: 120px;
}

.decoration-circle {
  position: absolute;
  border-radius: 50%;
  opacity: 0.1;
  animation: float 3s ease-in-out infinite;
}

.circle-1 {
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #409EFF, #67C23A);
  top: 0;
  left: 0;
  animation-delay: 0s;
}

.circle-2 {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #E6A23C, #F56C6C);
  top: 20px;
  right: 0;
  animation-delay: 1s;
}

.circle-3 {
  width: 30px;
  height: 30px;
  background: linear-gradient(135deg, #909399, #C0C4CC);
  bottom: 0;
  left: 20px;
  animation-delay: 2s;
}

.empty-title {
  font-size: 24px;
  font-weight: 600;
  color: #606266;
  margin: 0 0 12px 0;
}

.empty-description {
  font-size: 14px;
  color: #909399;
  margin: 0;
  line-height: 1.5;
}

@keyframes float {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-10px);
  }
}

@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.images-result {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.images-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
  padding: 12px;
  flex: 1;
  overflow-y: auto;
  align-content: start;
}


.images-actions {
  text-align: center;
  padding-top: 16px;
  border-top: 1px solid #f0f0f0;
}

.images-actions .el-button {
  border-radius: 8px;
  font-weight: 500;
  padding: 12px 24px;
}

/* 蜩榊?泌?剰??隶?*/
@media (max-width: 1400px) {
  .left-panel {
    width: 320px;
  }
  
  .control-panel {
    width: 420px;
  }
}

@media (max-width: 1200px) {
  .main-layout {
    flex-direction: column;
    min-height: auto;
    gap: 0;
  }
  
  .left-panel {
    width: 100%;
    min-height: auto;
    flex-direction: row;
    gap: 0;
    border-right: none;
    border-bottom: 1px solid #e2e8f0;
    margin: 0;
    border-radius: 0;
  }
  
  .tab-section {
    flex: 1;
    border-radius: 0;
    height: 300px;
  }
  
  .user-account-card {
    width: 280px;
    flex-shrink: 0;
    border-radius: 0;
    height: 300px;
    border-top: none;
    border-left: 1px solid #e2e8f0;
  }
  
  .control-panel {
    width: 100%;
    height: auto;
    max-height: 500px;
    margin: 0;
    border-radius: 0;
  }
  
  .result-panel {
    height: 400px;
    margin: 0;
    border-radius: 0;
  }
  
  .images-grid {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
  }
}

@media (max-width: 768px) {
  .main-layout {
    min-height: 100vh;
    gap: 0;
  }
  
  .left-panel {
    flex-direction: column;
    gap: 0;
    min-height: auto;
    border-bottom: 1px solid #e2e8f0;
    margin: 0;
    border-radius: 0;
  }
  
  .tab-section {
    border-radius: 0;
    height: 250px;
  }
  
  .user-account-card {
    width: 100%;
    border-radius: 0;
    height: 60px;
    border-top: 1px solid #e2e8f0;
    border-left: none;
  }
  
  .control-panel {
    padding: 16px;
    height: auto;
    max-height: 400px;
    margin: 0;
    border-radius: 0;
  }
  
  /* 遘?蜉?遶?蜈?螻Tab譬?蠑丈?伜喧 */
  .global-mode-tabs {
    margin-bottom: 16px;
  }
  
  .global-mode-tabs .el-tabs__item {
    font-size: 14px;
    padding: 0 16px;
    height: 40px;
    line-height: 40px;
  }
  
  /* 遘?蜉?遶?蟶?逕?謠千??隸肴潔髓?莨伜喧 */
  .common-prompts-buttons {
    gap: 6px;
  }
  
  .common-prompts-buttons .el-button {
    font-size: 11px;
    padding: 3px 6px;
  }
  
  .common-prompts-buttons .el-button.selected-prompt {
    transform: none;
    box-shadow: 0 1px 4px rgba(59, 130, 246, 0.3);
  }
  
  .common-prompts-buttons .el-button.selected-prompt:hover {
    transform: none;
    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
  }
  
  .result-header {
    padding: 12px 16px;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .result-header h2 {
    font-size: 18px;
  }
  
  .header-actions {
    width: 100%;
    justify-content: center;
  }
  
  .result-content {
    padding: 16px;
  }
  
  .images-grid {
    grid-template-columns: 1fr;
    gap: 12px;
    padding: 12px;
  }
  
  .upload-placeholder-square,
  .image-preview {
    width: 80px;
    height: 80px;
  }
}

/* 貊壼勘譚?譬?蠑?*/
.control-panel::-webkit-scrollbar {
  width: 6px;
}

.control-panel::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.control-panel::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.control-panel::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* 蝗?迚????亥??遯玲?蠑 */
.image-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(5px);
}

.image-modal-content {
  position: relative;
  width: 90%;
  height: 90%;
  max-width: 1200px;
  max-height: 800px;
  display: flex;
  flex-direction: column;
  background: #1a1a1a;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.close-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 40px;
  height: 40px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 18px;
  cursor: pointer;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

.image-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
  background: #000;
}

.preview-image {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  cursor: grab;
  transition: transform 0.1s ease;
  user-select: none;
}

.preview-image:active {
  cursor: grabbing;
}

.image-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  background: rgba(0, 0, 0, 0.8);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
}

.nav-controls {
  display: flex;
  align-items: center;
  gap: 16px;
}

.nav-btn {
  width: 36px;
  height: 36px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 16px;
}

.nav-btn:hover:not(:disabled) {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

.nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.image-counter {
  color: white;
  font-size: 14px;
  font-weight: 500;
  min-width: 60px;
  text-align: center;
}

.zoom-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.control-btn {
  width: 32px;
  height: 32px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 14px;
}

.control-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

.download-btn {
  width: 36px;
  height: 36px;
  background: rgba(64, 158, 255, 0.8);
  border: none;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 16px;
}

.download-btn:hover {
  background: rgba(64, 158, 255, 1);
  transform: scale(1.1);
}

.save-prompt-btn {
  padding: 10px 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.save-prompt-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.save-prompt-btn .el-icon {
  font-size: 16px;
}

/* 隗??鷹???亥??遯玲?蠑 */
.video-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(5px);
}

.video-modal-content {
  position: relative;
  width: 90%;
  max-width: 1200px;
  display: flex;
  flex-direction: column;
  background: #1a1a1a;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  padding: 20px;
}

.video-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 16px;
}

.preview-video {
  width: 100%;
  max-height: 70vh;
  object-fit: contain;
}

.video-modal-info {
  display: flex;
  gap: 20px;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  margin-bottom: 16px;
}

.video-modal-info .info-row {
  color: #e0e0e0;
  font-size: 14px;
}

.video-modal-info .info-row strong {
  color: #fff;
  margin-right: 8px;
}

.download-btn-video {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 20px;
  background: rgba(64, 158, 255, 0.8);
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.download-btn-video:hover {
  background: rgba(64, 158, 255, 1);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(64, 158, 255, 0.4);
}

/* 蠑?蛻?髫占酪蜿り?崟邂?逅???遯礼噪header */
.el-dialog .el-dialog__header {
  display: none !important;
}

.el-dialog .el-dialog__body {
  padding: 0 !important;
  overflow: hidden !important;
  height: calc(80vh - 80px) !important; /* 蠅槫刈蜀???蛹?蝓滄?伜??蛻?0vh */
  max-height: calc(60vh - 60px) !important; /* 髯仙宛譛螟?鬮伜??*/
  margin-top: -20px !important; /* 蜷台?顔??蜉?蜀???蛹?蝓 */
}

/* 遑?菫晏??遯玲悽霄?荳肴?壼?*/
.el-dialog {
  overflow: hidden !important;
  height: 80vh !important;
  max-height: 80vh !important;
}

.el-dialog__wrapper {
  overflow: hidden !important;
}

/* 遑?菫晏??遯怜?螳?蛹?蝓滉?肴?壼?*/
.el-dialog .el-dialog__body {
  overflow: hidden !important;
}

/* 遑?菫晏??遯怜??蝎?荳肴?壼?*/
.el-dialog .el-dialog__container {
  overflow: hidden !important;
}

/* 遑?菫晏??遯礼噪謇譛牙?仙?邏驛?荳堺?壼??閾?貊壼?*/
.el-dialog * {
  box-sizing: border-box;
}

/* 迚?蛻?遑?菫晏??遯怜?螳?荳堺?壽??蜃? */
.el-dialog .el-dialog__body > * {
  max-height: 100%;
  overflow: hidden;
}

/* 蠖灘??遯玲遠蠑譌??碁亟豁?鬘?髱?貊壼勘 */
body.el-popup-parent--hidden {
  overflow: hidden !important;
}

/* 髦?豁? el-overlay 蜥?el-modal-dialog 蟇?閾?鬘?髱?貊壼勘 */
.el-overlay {
  overflow: hidden !important;
}

.el-modal-dialog {
  overflow: hidden !important;
}

.el-modal-dialog .el-dialog__wrapper {
  overflow: hidden !important;
}

.el-modal-dialog .el-dialog__container {
  overflow: hidden !important;
}

.el-modal-dialog .el-dialog__body {
  overflow: hidden !important;
}

/* 蠑?蛻?豸磯勁謇譛牙??遯礼噪貊壼勘譚?*/
.el-dialog,
.el-dialog__wrapper,
.el-dialog__container,
.el-dialog__body,
.el-overlay,
.el-modal-dialog,
.el-modal-dialog .el-dialog__wrapper,
.el-modal-dialog .el-dialog__container,
.el-modal-dialog .el-dialog__body {
  overflow: hidden !important;
  scrollbar-width: none !important; /* Firefox */
  -ms-overflow-style: none !important; /* IE and Edge */
}

/* 髫占酪 Webkit 豬剰?亥勣逧??壼勘譚?*/
.el-dialog::-webkit-scrollbar,
.el-dialog__wrapper::-webkit-scrollbar,
.el-dialog__container::-webkit-scrollbar,
.el-dialog__body::-webkit-scrollbar,
.el-overlay::-webkit-scrollbar,
.el-modal-dialog::-webkit-scrollbar,
.el-modal-dialog .el-dialog__wrapper::-webkit-scrollbar,
.el-modal-dialog .el-dialog__container::-webkit-scrollbar,
.el-modal-dialog .el-dialog__body::-webkit-scrollbar {
  display: none !important;
  width: 0 !important;
  height: 0 !important;
}

/* 遑?菫晏??遯怜?螳?荳堺?夊???霎?逡 */
.el-dialog .el-dialog__body,
.el-modal-dialog .el-dialog__body {
  max-height: calc(80vh - 120px) !important;
  overflow: hidden !important;
}

/* 蠑?蛻?隶?鄂?蠑?遯怜??蟇??碁亟豁?蜀???貅?蜃?*/
.el-dialog {
  max-height: 80vh !important;
  height: auto !important;
  overflow: hidden !important;
}

.el-dialog__wrapper {
  max-height: 80vh !important;
  overflow: hidden !important;
}

.el-dialog__container {
  max-height: 80vh !important;
  overflow: hidden !important;
}

/* 遑?菫晏??遯怜?螳?蛹?蝓滓怏蝗?螳夐?伜??*/
.el-dialog__body {
  max-height: calc(80vh - 120px) !important;
  overflow: hidden !important;
  padding: 0 !important;
}

/* 蠑?蛻?豸磯勁謇譛牙庄閭?逧??壼勘譚?- 譖?蜈?髱?逧???尠 */
*[class*="el-dialog"],
*[class*="el-overlay"],
*[class*="el-modal"] {
  overflow: hidden !important;
  scrollbar-width: none !important;
  -ms-overflow-style: none !important;
}

*[class*="el-dialog"]::-webkit-scrollbar,
*[class*="el-overlay"]::-webkit-scrollbar,
*[class*="el-modal"]::-webkit-scrollbar {
  display: none !important;
  width: 0 !important;
  height: 0 !important;
}

/* 迚?蛻?髓亥??蠑?遯礼噪譬?蜈?? */
.el-dialog__wrapper,
.el-overlay,
.el-modal__wrapper {
  overflow: hidden !important;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
}

html {
  overflow-x: hidden;
}

/* 蜩榊?泌?剰??隶?*/
@media (max-width: 768px) {
  .image-modal-content {
    width: 95%;
    height: 95%;
  }
  
  .image-controls {
    padding: 12px 16px;
    flex-direction: column;
    gap: 12px;
  }
  
  .nav-controls,
  .zoom-controls {
    gap: 8px;
  }
  
  .nav-btn,
  .control-btn,
  .download-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
  
  .image-counter {
    font-size: 12px;
  }
}

/* 讓?蝙矩画叫蝎?譬?蠑?*/
.model-selector {
  width: 100%;
}

.model-option {
  display: flex;
  align-items: center;
  gap: 8px;
}

.model-icon {
  width: 24px;
  height: 24px;
  object-fit: contain;
  flex-shrink: 0;
  border-radius: 4px;
}

.model-name {
  flex: 1;
  font-weight: 500;
  color: #303133;
}

.default-tag {
  margin-left: auto;
  font-size: 12px;
  color: #67c23a;
  padding: 2px 6px;
  border: 1px solid #67c23a;
  border-radius: 3px;
  white-space: nowrap;
}

.model-description {
  font-size: 12px;
  color: #909399;
  line-height: 1.4;
}

/* 讓?蝙矩画叫蝎?荳区級譯??蠑丈?伜喧 */
:deep(.el-select-dropdown__item) {
  padding: 8px 12px;
}

:deep(.el-select-dropdown__item:hover) {
  background-color: #f5f7fa;
}

:deep(.el-select-dropdown__item.selected) {
  background-color: #ecf5ff;
  color: #409eff;
}

/* 隗??醍函謌仙玄蝓滓?蠑 */
.video-input-section {
  margin-top: 20px;
}

.video-result-container {
  height: 100%;
}

.reference-images-section {
  margin-top: 10px;
}

/* 鬥門??蟶?蟷?謗貞??? */
.frame-upload-container {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
}

.frame-upload-item {
  flex: 1;
  min-width: 0;
}

.frame-label {
  display: flex;
  align-items: center;
  margin-bottom: 6px;
  font-weight: 500;
  color: #333;
  font-size: 13px;
}

.frame-hint {
  margin-left: 4px;
  font-size: 11px;
  color: #999;
  font-weight: normal;
}

/* 鬥門??蟶?荳贋?蛹?蝓滓?蠑?*/
.frame-upload {
  width: 100%;
}

.frame-upload .el-upload-dragger {
  width: 100%;
  height: 80px;
  border: 2px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s;
}

.frame-upload .el-upload-dragger:hover {
  border-color: #409eff;
}

.frame-upload-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 8px;
}

.frame-upload-icon {
  font-size: 20px;
  color: #c0c4cc;
  margin-bottom: 4px;
}

.frame-upload-text {
  text-align: center;
}

.frame-upload-text p {
  margin: 0;
  font-size: 12px;
  color: #606266;
  line-height: 1.2;
}

.frame-upload-hint {
  font-size: 10px !important;
  color: #909399 !important;
}

/* 菫晉蕗蜴滓怏逧вeference譬?蠑丈??蜈?螳?蜈?莉夜Κ蛻?*/
.reference-upload-item {
  margin-bottom: 20px;
}

.reference-label {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  font-weight: 500;
  color: #333;
}

.reference-hint {
  margin-left: 4px;
  font-size: 12px;
  color: #999;
  font-weight: normal;
}

.upload-area {
  text-align: center;
  padding: 30px 20px;
  border: 2px dashed #d9d9d9;
  border-radius: 6px;
  background-color: #fafafa;
  transition: border-color 0.3s;
}

.upload-area:hover {
  border-color: #409eff;
}

.upload-icon {
  font-size: 36px;
  color: #c0c4cc;
  margin-bottom: 12px;
}

.upload-text p {
  margin: 0;
  color: #666;
}

.upload-hint {
  font-size: 12px;
  color: #999;
  margin-top: 4px;
}

.upload-instructions {
  margin-top: 16px;
}

.instruction-list {
  margin: 0;
  padding-left: 16px;
  font-size: 13px;
  line-height: 1.6;
}

.instruction-list li {
  margin-bottom: 4px;
  color: #666;
}

/* 譁?蠅樒噪隗??醍嶌蜈?譬?蠑?*/
/* 邏?蜃台?贋?蟶?? */
.upload-compact-grid {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.upload-compact-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex: 1;
  min-width: 180px;
}

.compact-label {
  font-size: 13px;
  font-weight: 600;
  color: #606266;
}

.compact-preview-box {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  background: #f5f7fa;
  border-radius: 4px;
  border: 1px solid #dcdfe6;
  height: 32px;
}

.compact-thumb {
  width: 24px;
  height: 24px;
  object-fit: cover;
  border-radius: 3px;
  flex-shrink: 0;
}

.compact-filename {
  flex: 1;
  font-size: 13px;
  color: #409eff;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.compact-uploader {
  height: 32px;
}

.compact-uploader .el-button {
  width: 100%;
  height: 100%;
  padding: 4px 12px;
}

/* 邏?蜃大盾謨?陦悟??? */
.params-compact-row {
  display: flex;
  gap: 8px;
}

.param-compact-col {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.param-compact-col label {
  font-size: 13px;
  font-weight: 600;
  color: #606266;
}

.param-compact-col .el-select {
  width: 100%;
}

.param-hint-inline {
  font-size: 11px;
  color: #909399;
  margin-top: 2px;
  line-height: 1.4;
}

/* 謚伜匠鬮倡??騾蛾??譬?蠑 */
.compact-section {
  margin: 8px 0;
}

.advanced-collapse {
  border: none;
  background: transparent;
}

.advanced-collapse .el-collapse-item__header {
  background: transparent;
  border: none;
  padding: 0;
  height: auto;
  line-height: normal;
}

.advanced-collapse .el-collapse-item__wrap {
  border: none;
  background: transparent;
}

.advanced-collapse .el-collapse-item__content {
  padding: 8px 0 0 0;
}

.collapse-title {
  margin: 0;
  font-size: 15px;
  font-weight: 600;
  color: #303133;
}

.advanced-options-compact {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 6px;
}

.option-item-compact {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.option-item-compact label {
  font-size: 13px;
  font-weight: 600;
  color: #606266;
}

.option-checkboxes {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}

.option-checkboxes .el-checkbox {
  margin: 0;
}

/* 邏?蜃大盾閠?崟邂?逅??蠑 */
.reference-compact-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.reference-actions-row {
  display: flex;
  gap: 6px;
  align-items: center;
}

.uploaded-images-compact {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 8px;
  border: 1px solid #e2e8f0;
}

.compact-images-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 13px;
}

.image-count {
  color: #606266;
  font-weight: 500;
}

.compact-images-grid {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
}

.compact-image-item {
  position: relative;
  width: 40px;
  height: 40px;
  border-radius: 4px;
  overflow: hidden;
  border: 1px solid #dcdfe6;
}

.compact-image-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.remove-btn {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 16px;
  height: 16px;
  min-height: 16px;
  padding: 0;
  font-size: 10px;
}

.more-images-indicator {
  width: 40px;
  height: 40px;
  background: #f0f2f5;
  border: 1px dashed #d9d9d9;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #909399;
  font-weight: 500;
}

/* 雜???蜃題???台?贋?譬?蠑?*/
.video-upload-ultra-compact {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.video-upload-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 120px;
}

.ultra-compact-label {
  font-size: 12px;
  font-weight: 600;
  color: #606266;
  margin: 0;
}

.ultra-compact-preview {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 8px;
  background: #f5f7fa;
  border-radius: 4px;
  border: 1px solid #dcdfe6;
  height: 36px;
}

.ultra-thumb {
  width: 24px;
  height: 24px;
  object-fit: cover;
  border-radius: 3px;
  flex-shrink: 0;
}

.ultra-compact-uploader {
  height: 36px;
}

.ultra-compact-uploader .el-button {
  width: 100%;
  height: 100%;
  font-size: 12px;
}

/* 蝗?逕溷崟邏?蜃台?贋?譬?蠑?*/
.image-upload-header-inline {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.image-upload-header-inline h3 {
  margin: 0;
  font-size: 15px;
  font-weight: 600;
  color: #303133;
}

.reference-upload-compact {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 1px;
}

.uploaded-compact-display {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: #f5f7fa;
  border-radius: 4px;
  border: 1px solid #dcdfe6;
}

.upload-count {
  font-size: 13px;
  color: #606266;
  font-weight: 500;
}

.uploaded-thumbnails-compact {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}

.thumbnail-item-compact {
  position: relative;
  width: 60px;
  height: 60px;
  border-radius: 6px;
  overflow: visible;
  border: 2px solid #dcdfe6;
  transition: all 0.3s ease;
}

.thumbnail-item-compact::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 4px;
  overflow: hidden;
  z-index: 1;
}

.thumbnail-item-compact:hover {
  border-color: #409eff;
  transform: scale(1.05);
}

/* 諡匁郷迥?諤∵?蠑?*/
.thumbnail-item-compact.dragging {
  opacity: 0.5;
  cursor: move;
}

.thumbnail-item-compact.drag-over {
  border: 2px dashed #409eff;
  background-color: rgba(64, 158, 255, 0.1);
  box-shadow: 0 0 10px rgba(64, 158, 255, 0.3);
}

.thumbnail-item-compact.drag-over::after {
  content: '';
  position: absolute;
  top: -4px;
  left: -4px;
  right: -4px;
  bottom: -4px;
  border: 2px dashed #409eff;
  border-radius: 8px;
  animation: pulse 0.8s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.thumbnail-item-compact img {
  cursor: pointer;
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 4px;
  position: relative;
  z-index: 2;
}

.remove-thumb-btn {
  position: absolute;
  top: -10px;
  right: -10px;
  width: 22px;
  height: 22px;
  min-height: 22px;
  padding: 0;
  font-size: 12px;
  z-index: 10;
  background: #f56c6c;
  border-color: #f56c6c;
  box-shadow: 0 2px 8px rgba(245, 108, 108, 0.4);
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: auto;
}

.remove-thumb-btn:hover {
  background: #f78989;
  border-color: #f78989;
  transform: scale(1.1);
}

.thumbnail-item-compact:hover .remove-thumb-btn {
  opacity: 1;
}

/* 蜀?＃蟶?逕?蜿り?崟譬?蠑 */
.common-reference-icons-inline {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e2e8f0;
}

.icons-header-inline {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.icons-header-inline > span {
  font-size: 14px;
  font-weight: 600;
  color: #606266;
}

.header-actions-inline {
  display: flex;
  align-items: center;
  gap: 12px;
}

.category-tabs-inline {
  display: flex;
  gap: 8px;
}

.category-tab-inline {
  padding: 4px 10px;
  background: #f5f7fa;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 12px;
}

.category-tab-inline:hover {
  background: #e6e8eb;
}

.category-tab-inline.active {
  background: #409eff;
  color: white;
}

.category-name {
  font-weight: 500;
}

.category-count {
  opacity: 0.7;
  margin-left: 4px;
}

.icons-grid-inline {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
  gap: 8px;
  max-height: 200px;
  overflow-y: auto;
  transition: max-height 0.3s ease;
}

.icons-grid-inline.collapsed {
  max-height: 120px;
}

.reference-icon-inline {
  width: 50px;
  height: 50px;
  border-radius: 6px;
  overflow: hidden;
  cursor: grab;
  border: 2px solid #e2e8f0;
  transition: all 0.3s ease;
}

.reference-icon-inline:active {
  cursor: grabbing;
}

.reference-icon-inline:hover {
  border-color: #409eff;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
}

.reference-icon-inline img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* 蟶?逕?蜿り?崟蜉霓?蜉?逕? */
.reference-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  gap: 12px;
  color: #909399;
  font-size: 14px;
}

.reference-loading .el-icon {
  color: #409eff;
}

.upload-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.upload-item {
  display: flex;
  flex-direction: column;
}

.upload-label {
  margin-bottom: 8px;
  color: #303133;
  font-weight: 600;
  font-size: 14px;
}

.image-uploader {
  width: 100%;
}

.image-preview {
  position: relative;
  width: 100%;
  height: 200px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px dashed #d9d9d9;
}

.image-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  opacity: 0;
  transition: opacity 0.3s;
}

.image-preview:hover .image-overlay {
  opacity: 1;
}

.upload-placeholder {
  width: 100%;
  height: 200px;
  border: 2px dashed #d9d9d9;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #909399;
  transition: border-color 0.3s;
}

.upload-placeholder:hover {
  border-color: #409eff;
}

.upload-icon {
  font-size: 32px;
  margin-bottom: 12px;
}

.upload-text {
  font-size: 14px;
  margin-bottom: 4px;
}

.upload-hint {
  font-size: 12px;
  color: #c0c4cc;
}

.params-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.param-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.param-item label {
  color: #303133;
  font-weight: 600;
  font-size: 14px;
}

.param-select,
.param-input {
  width: 100%;
}

.advanced-options {
  margin-top: 20px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
}

.options-grid {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.option-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
}

.option-item.full-width {
  flex-direction: column;
  grid-column: 1 / -1; /* 蜊謐?謨?陦 */
}

.option-item.full-width label {
  font-weight: 500;
  margin-bottom: 8px;
  color: #333;
}

.option-item.full-width .el-input,
.option-item.full-width .el-select {
  width: 100%;
}

.option-item .el-checkbox {
  margin-top: 2px;
}

.option-desc {
  color: #6c757d;
  font-size: 14px;
  line-height: 1.4;
  flex: 1;
}

@media (max-width: 768px) {
  .upload-grid {
    grid-template-columns: 1fr;
  }
  
  .params-grid {
    grid-template-columns: 1fr;
  }
}

/* 隗??大今迚??蠑 */
.video-card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
}

.video-card:hover {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
}

.video-player {
  width: 100%;
  height: auto;
  display: block;
  background: #000;
}

.video-info {
  padding: 15px;
  background: #f8f9fa;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  border-top: 1px solid #e9ecef;
}

.video-info .info-item {
  font-size: 13px;
  color: #495057;
  line-height: 1.5;
}

.video-info .info-item strong {
  color: #212529;
  margin-right: 4px;
}

.video-actions {
  padding: 15px;
  display: flex;
  justify-content: center;
  gap: 10px;
  border-top: 1px solid #e9ecef;
}

.video-actions .el-button {
  flex: 1;
  max-width: 200px;
}

/* ==================== 謇?谺?邉?扈滓?蠑 ==================== */
.result-content {
  max-height: calc(100vh - 100px); /* 髯仙宛譛螟?鬮伜???悟?蟆大?暮Κ遨?逋? */
  overflow-y: auto; /* 蜷?逕?蝙ら峩貊壼勘 */
  padding-right: 10px; /* 荳?貊壼勘譚?逡吝?遨?髣? */
}

/* 閾?螳壻?画?壼勘譚?譬?蠑 */
.result-content::-webkit-scrollbar {
  width: 8px;
}

.result-content::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.result-content::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
  transition: background 0.3s ease;
}

.result-content::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.batches-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 0;
  width: 100%;
}

.batch-card {
  background: white;
  border-radius: 8px;
  padding: 12px 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border: 1px solid #e8eaed;
  transition: all 0.3s ease;
}

.batch-card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  transform: translateY(-2px);
}

.batch-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid #f0f2f5;
}

.batch-info {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  flex: 1;
}

.batch-type {
  font-weight: 600;
  color: #409eff;
  font-size: 15px;
  padding: 4px 12px;
  background: #ecf5ff;
  border-radius: 6px;
  flex-shrink: 0;
}

.batch-time {
  color: #909399;
  font-size: 13px;
  padding: 4px 8px;
  background: #f5f7fa;
  border-radius: 4px;
}

.batch-prompt {
  color: #606266;
  font-size: 13px;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 400px;
}

/* 謇?谺?讓?蝙区??? - 邏?霍溷?batch-type 蜷朱擇 */
.batch-model-tag {
  padding: 4px 10px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  flex-shrink: 0;
}

.status-pending {
  background: #f4f4f5;
  color: #909399;
}

.status-processing {
  background: #ecf5ff;
  color: #409eff;
  animation: pulse 2s ease-in-out infinite;
}

.status-completed {
  background: #f0f9ff;
  color: #67c23a;
}

.status-partial {
  background: #fdf6ec;
  color: #e6a23c;
}

.status-failed {
  background: #fef0f0;
  color: #f56c6c;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 240px));
  gap: 12px;
  margin-top: 8px;
}

.results-grid .video-card,
.results-grid .main-card,
.tasks-grid .main-card {
  width: 100%;
  height: 200px;
}

/* 郛?逡?蝗?讓?蠑擾?嗷esults-grid蜀?噪隗??大今迚 */
.results-grid .video-card-thumbnail {
  cursor: pointer;
  position: relative;
}

.results-grid .video-card-thumbnail .video-player {
  height: 100%;
  object-fit: cover;
  pointer-events: none;
}

.results-grid .video-card-thumbnail .video-info,
.results-grid .video-card-thumbnail .video-actions {
  display: none;
}

/* 豺?蜉隗??第眺謾?蝗?譬???尠螻?*/
.results-grid .video-card-thumbnail::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 60px;
  height: 60px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.results-grid .video-card-thumbnail::before {
  content: '笆?;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-45%, -50%);
  color: white;
  font-size: 26px;
  z-index: 1;
  pointer-events: none;
}
</style>



