<template>
  <!-- æœªç™»å½•çŠ¶æ€æ˜¾ç¤ºç™»å½•é¡µé¢ -->
  <LoginForm v-if="!isLoggedIn" @login-success="handleLoginSuccess" />
  
  <!-- å·²ç™»å½•çŠ¶æ€æ˜¾ç¤ºä¸»åº”ç”¨ -->
  <div v-else class="main-layout">
      <!-- å·¦ä¾§é¢æ¿ï¼šTABåˆ‡æ¢ + ç”¨æˆ·è´¦æˆ·ç³»ç»Ÿ -->
      <div class="left-panel">
        <!-- TABåˆ‡æ¢åŒºåŸŸ -->
        <div class="tab-section">
          <div class="tab-header">
            <el-tabs v-model="activeTab" class="left-tabs">
              <el-tab-pane label="æˆ‘çš„æç¤ºè¯" name="prompts">
                <div class="tab-content">
                  <!-- æç¤ºè¯ç®¡ç†æŒ‰é’® -->
                  <div class="prompts-manage-header">
          <el-button 
            type="primary" 
                      size="small" 
                      @click="showPromptManager = true"
                      class="prompts-manage-btn"
                    >
                      <el-icon><Setting /></el-icon>
                      ç®¡ç†æç¤ºè¯
          </el-button>
        </div>

                  <!-- æç¤ºè¯ç€‘å¸ƒæµåˆ—è¡¨ -->
                  <div class="prompts-waterfall-container">
                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div v-if="userPromptsLoading" class="loading-prompts">
                      <LoadingCard 
                        title="åŠ è½½æç¤ºè¯ä¸­..." 
                        subtitle="æ­£åœ¨è·å–æ‚¨çš„ä¸ªäººæç¤ºè¯"
                        size="small"
                      />
                    </div>
                    
                    <!-- ç©ºçŠ¶æ€ -->
                    <div v-else-if="userPrompts.length === 0" class="empty-prompts">
                      <el-icon size="48"><Document /></el-icon>
                      <p>æš‚æ— æç¤ºè¯</p>
            <el-button 
              type="primary" 
              size="small" 
              @click="showPromptManager = true"
            >
                        ç®¡ç†æç¤ºè¯
            </el-button>
                    </div>
                    
                    <!-- æç¤ºè¯å¡ç‰‡ -->
                    <div
                      v-else
                      v-for="userPrompt in userPrompts"
                      :key="userPrompt.id"
                      class="prompt-card-waterfall"
                      @click="selectUserPrompt(userPrompt)"
                    >
                      <div class="card-image-waterfall">
                        <img 
                          v-if="userPrompt.referenceImage" 
                          :src="userPrompt.referenceImage" 
                          :alt="userPrompt.title"
                          @error="handleImageError"
                        />
                        <div v-else class="no-image-waterfall">
                          <el-icon size="24"><Picture /></el-icon>
                        </div>
                      </div>
                      <div class="card-content-waterfall">
                        <h4 class="card-title-waterfall">{{ userPrompt.title }}</h4>
                      </div>
                    </div>
                  </div>
                </div>
              </el-tab-pane>
              
              <el-tab-pane label="ç”Ÿæˆå†å²" name="history">
                <div class="tab-content">
                  <HistoryPanel ref="historyPanelRef" @select-history="loadFromHistory" />
                </div>
              </el-tab-pane>
            </el-tabs>
          </div>
        </div>
        
        <!-- ç”¨æˆ·è´¦æˆ·ç³»ç»Ÿï¼ˆåº•éƒ¨å°å¡ç‰‡ï¼‰ -->
        <div class="user-account-card">
          <div class="user-info">
            <div class="user-avatar">
              <el-avatar :size="32" :src="currentUser.avatar">
                {{ currentUser.username?.charAt(0)?.toUpperCase() }}
              </el-avatar>
            </div>
            <div class="user-details">
              <div class="username">{{ currentUser.username }}</div>
              <div class="user-status">åœ¨çº¿</div>
            </div>
          </div>
          <div class="user-actions">
            <el-dropdown trigger="click" placement="top-start">
              <el-button type="text" size="small" class="more-btn">
                <el-icon><MoreFilled /></el-icon>
              </el-button>
              <template #dropdown>
                <el-dropdown-menu>
                  <el-dropdown-item v-if="currentUser?.is_admin" @click="showAdminDashboard = true">
                    <el-icon><Setting /></el-icon>
                    ç®¡ç†å‘˜æ§åˆ¶å°
                  </el-dropdown-item>
                  <el-dropdown-item @click="handleLogout">
                    <el-icon><SwitchButton /></el-icon>
                    é€€å‡ºç™»å½•
                  </el-dropdown-item>
                </el-dropdown-menu>
              </template>
            </el-dropdown>
          </div>
        </div>
      </div>
      
      <!-- ä¸­é—´æ§åˆ¶é¢æ¿ -->
      <div class="control-panel">
        <!-- å…¨å±€Tabåˆ‡æ¢ -->
        <el-tabs v-model="generationMode" class="global-mode-tabs">
          <el-tab-pane label="æ–‡ç”Ÿå›¾" name="text-to-image"></el-tab-pane>
          <el-tab-pane label="å›¾ç”Ÿå›¾" name="image-to-image"></el-tab-pane>
          <el-tab-pane label="AIè§†é¢‘" name="image-to-video"></el-tab-pane>
        </el-tabs>

        <!-- æç¤ºè¯è¾“å…¥ -->
        <div class="prompt-section">
          <div class="prompt-header">
            <!-- æ¨¡å‹é€‰æ‹©å’Œé‡ç½®æŒ‰é’® - æ–‡ç”Ÿå›¾å’Œå›¾ç”Ÿå›¾ -->
            <div v-if="generationMode !== 'image-to-video'" style="display: flex; gap: 8px; align-items: center;">
              <el-select
                v-model="selectedModelId"
                placeholder="é€‰æ‹©AIæ¨¡å‹"
                size="small"
                @change="onModelChange"
                style="width: 200px"
              >
                <el-option
                  v-for="model in filteredAvailableModels"
                  :key="model.id"
                  :label="model.name"
                  :value="model.id"
                >
                  <div class="model-option">
                    <span class="model-name">{{ model.name }}</span>
                    <span v-if="model.is_default" class="default-tag">é»˜è®¤</span>
                  </div>
                </el-option>
              </el-select>
              <el-button @click="resetForm" size="small">é‡ç½®</el-button>
            </div>
            <!-- æ¨¡å‹é€‰æ‹©å’Œé‡ç½®æŒ‰é’® - è§†é¢‘æ¨¡å¼ -->
            <div v-else style="display: flex; gap: 8px; align-items: center;">
              <el-select
                v-model="videoSelectedModelId"
                placeholder="é€‰æ‹©è§†é¢‘æ¨¡å‹"
                size="small"
                :loading="videoModelsLoading"
                style="width: 200px"
              >
                <el-option
                  v-for="model in videoModels"
                  :key="model.id"
                  :label="model.name"
                  :value="model.id"
                >
                  <div class="model-option">
                    <div class="model-name">{{ model.name }}</div>
                  </div>
                </el-option>
              </el-select>
              <el-button @click="resetVideoForm" size="small">é‡ç½®</el-button>
            </div>
          </div>
          
          <!-- æ–‡ç”Ÿå›¾å’Œå›¾ç”Ÿå›¾çš„æç¤ºè¯è¾“å…¥ -->
          <template v-if="generationMode === 'text-to-image' || generationMode === 'image-to-image'">
            <!-- ä½¿ç”¨è‡ªå®šä¹‰å¤šè¡Œæ ‡ç­¾è¾“å…¥ç»„ä»¶ -->
            <MultilineTagInput
              ref="multilineTagInputRef"
              v-model="promptTags"
              placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å›¾åƒ,ä¾‹å¦‚:ä¸€åªå¯çˆ±çš„çŒ«å’ª,æŸ”è½¯çš„æ¯›å‘,å¤§çœ¼ç›,é˜³å…‰ä¸‹å¾®ç¬‘..."
              class="prompt-input-tag"
              :max-tags="20"
              :min-rows="3"
              :max-rows="6"
              :show-hint="true"
              separator=","
              :auto-convert-to-tags="false"
              :tag-mapping="tagMapping"
              @change="handlePromptChange"
            />
            <!-- å¸¸ç”¨æç¤ºè¯ -->
            <div class="common-prompts">
              <div class="common-prompts-header">
                <div class="common-prompts-label">å¸¸ç”¨æç¤ºè¯ï¼š</div>
                <el-button 
                  size="small" 
                  type="primary" 
                  plain
                  @click="showCommonPromptsManager = true"
                  class="manage-prompts-btn"
                >
                  ç®¡ç†
                </el-button>
              </div>
              <div class="common-prompts-buttons">
                <el-button
                  v-for="commonPrompt in commonPrompts"
                  :key="commonPrompt.id"
                  size="small"
                  :type="selectedCommonPromptIds.has(commonPrompt.id) ? 'primary' : 'info'"
                  :plain="!selectedCommonPromptIds.has(commonPrompt.id)"
                  @click="addCommonPrompt(commonPrompt, commonPrompt.id)"
                  :class="{ 'selected-prompt': selectedCommonPromptIds.has(commonPrompt.id) }"
                >
                  {{ commonPrompt.name }}
                </el-button>
              </div>
            </div>
          </template>
          
          <!-- AIè§†é¢‘çš„æç¤ºè¯è¾“å…¥ -->
          <template v-else-if="generationMode === 'image-to-video'">
            <!-- ä½¿ç”¨è‡ªå®šä¹‰å¤šè¡Œæ ‡ç­¾è¾“å…¥ç»„ä»¶ -->
            <MultilineTagInput
              ref="videoMultilineTagInputRef"
              v-model="videoPromptTags"
              placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹,ä¾‹å¦‚:ä¸€åªå¯çˆ±çš„çŒ«å’ªåœ¨è‰åœ°ä¸Šå¥”è·‘,é˜³å…‰æ˜åªš,å¾®é£è½»æ‹‚..."
              class="prompt-input-tag"
              :max-tags="20"
              :min-rows="3"
              :max-rows="6"
              :show-hint="true"
              separator=","
              :auto-convert-to-tags="false"
              :tag-mapping="videoTagMapping"
              @change="handleVideoPromptChange"
            />
            <!-- è§†é¢‘å¸¸ç”¨æç¤ºè¯ -->
            <div class="common-prompts">
              <div class="common-prompts-header">
                <div class="common-prompts-label">è§†é¢‘å¸¸ç”¨æç¤ºè¯ï¼š</div>
                <el-button 
                  size="small" 
                  type="primary" 
                  plain
                  @click="showVideoPromptsManager = true"
                  class="manage-prompts-btn"
                >
                  ç®¡ç†
                </el-button>
              </div>
              <div class="common-prompts-buttons">
                <el-button
                  v-for="videoPrompt in videoCommonPrompts"
                  :key="videoPrompt.id"
                  size="small"
                  :type="selectedVideoPromptIds.has(videoPrompt.id) ? 'primary' : 'info'"
                  :plain="!selectedVideoPromptIds.has(videoPrompt.id)"
                  @click="addVideoCommonPrompt(videoPrompt, videoPrompt.id)"
                  :class="{ 'selected-prompt': selectedVideoPromptIds.has(videoPrompt.id) }"
                >
                  {{ videoPrompt.name }}
                </el-button>
              </div>
            </div>
          </template>
        </div>

        <!-- å›¾ç”Ÿå›¾æ¨¡å¼ä¸‹çš„å›¾ç‰‡ä¸Šä¼  - ç´§å‡‘æŒ‰é’®å¼ -->
        <div v-if="generationMode === 'image-to-image'" class="settings-section vertical-layout compact-section">
          <div class="setting-item">
            <div class="image-upload-header-inline">
              <h3>å‚è€ƒå›¾ç‰‡</h3>
              <el-button 
                type="primary" 
                size="small" 
                :icon="Picture" 
                @click="showReferenceManager = true"
              >
                å¸¸ç”¨å‚è€ƒå›¾
              </el-button>
            </div>
            
            <div class="reference-upload-compact">
              <!-- ä¸Šä¼ æŒ‰é’® -->
              <el-upload
                ref="uploadRef"
                :auto-upload="false"
                :on-change="handleImageChange"
                :show-file-list="false"
                accept="image/*"
                multiple
                class="compact-uploader"
              >
                <el-button size="small" :icon="Plus">ä¸Šä¼ å‚è€ƒå›¾</el-button>
              </el-upload>
            </div>
            
            <!-- å·²ä¸Šä¼ å›¾ç‰‡ç¼©ç•¥å›¾ -->
            <div v-if="uploadedImages.length > 0" class="uploaded-thumbnails-compact">
              <div 
                v-for="(image, index) in uploadedImages" 
                :key="image.id" 
                class="thumbnail-item-compact"
                :class="{ 
                  'dragging': draggedImageIndex === index,
                  'drag-over': dropTargetIndex === index
                }"
                draggable="true"
                @dragstart="handleDragStart(index, $event)"
                @dragover.prevent="handleDragOver(index, $event)"
                @dragleave="handleDragLeave"
                @drop="handleDrop(index, $event)"
                @dragend="handleDragEnd"
              >
                <img 
                  :src="image.url" 
                  :alt="image.name"
                  @click="handleThumbnailClick(image.id)"
                  style="cursor: pointer;"
                  title="ç‚¹å‡»æ›¿æ¢å›¾ç‰‡"
                />
                <el-button 
                  type="danger" 
                  size="small" 
                  circle 
                  class="remove-thumb-btn"
                  @click.stop="removeImage(image.id)"
                >
                  <el-icon><Close /></el-icon>
                </el-button>
              </div>
            </div>
            
            <!-- å¸¸ç”¨å‚è€ƒå›¾å°å›¾æ ‡ -->
            <div v-if="isLoadingReferenceImages || commonReferenceImages.length > 0" class="common-reference-icons-inline">
              <div class="icons-header-inline">
                <span>å¸¸ç”¨å‚è€ƒå›¾</span>
                <div class="header-actions-inline">
                  <!-- åˆ†ç±»åˆ‡æ¢æ ‡ç­¾ -->
                  <div v-if="referenceCategories.length > 1" class="category-tabs-inline">
                    <div 
                      v-for="category in referenceCategories" 
                      :key="category.id"
                      class="category-tab-inline"
                      :class="{ active: activeReferenceCategoryId === category.id }"
                      @click="setActiveReferenceCategory(category.id)"
                    >
                      <span class="category-name">{{ category.name }}</span>
                      <span class="category-count">({{ getReferenceCategoryImageCount(category.id) }})</span>
                    </div>
                  </div>
                  <el-button 
                    v-if="commonReferenceImages.length > 16" 
                    size="small" 
                    type="text" 
                    @click="toggleReferenceIconsCollapse"
                    class="collapse-btn"
                  >
                    {{ isReferenceIconsCollapsed ? 'å±•å¼€' : 'æŠ˜å ' }}
                  </el-button>
                </div>
              </div>
              
              <!-- åŠ è½½åŠ¨ç”» -->
              <div v-if="isLoadingReferenceImages" class="reference-loading">
                <el-icon class="is-loading" :size="24">
                  <Loading />
                </el-icon>
                <span>åŠ è½½å¸¸ç”¨å‚è€ƒå›¾ä¸­...</span>
              </div>
              
              <!-- å‚è€ƒå›¾ç½‘æ ¼ -->
              <div v-else class="icons-grid-inline" :class="{ collapsed: isReferenceIconsCollapsed }">
                <div 
                  v-for="image in displayedReferenceImages" 
                  :key="image.id" 
                  class="reference-icon-inline"
                  draggable="true"
                  @click="insertCommonReferenceImage(image)"
                  @dragstart="handleCommonImageDragStart(image, $event)"
                  :title="`${image.originalName || image.filename}\næ‹–æ‹½åˆ°ä¸Šæ–¹ç¼©ç•¥å›¾å¯æ›¿æ¢`"
                >
                  <img :src="image.url" :alt="image.originalName || image.filename" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AIè§†é¢‘æ¨¡å¼ä¸‹çš„è¾“å…¥æ§ä»¶ -->
        <div v-if="generationMode === 'image-to-video'" class="video-input-section">

          <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ (ä»…åœ¨æ¨¡å‹æ”¯æŒæ—¶æ˜¾ç¤º) - è¶…ç´§å‡‘æ¨¡å¼ -->
          <div v-if="supportsFirstFrame || supportsLastFrame" class="settings-section vertical-layout compact-section">
            <div class="setting-item">
              <h3>ä¸Šä¼ å›¾ç‰‡</h3>
              <div class="video-upload-ultra-compact">
                <!-- é¦–å¸§å›¾ç‰‡ -->
                <div v-if="supportsFirstFrame" class="video-upload-item">
                  <label class="ultra-compact-label">é¦–å¸§ <span v-if="firstFrameRequired" style="color: #f56c6c;">*</span></label>
                  <div v-if="firstFramePreview" class="ultra-compact-preview">
                    <img :src="firstFramePreview" alt="é¦–å¸§" class="ultra-thumb" />
                    <el-button size="small" text @click="firstFrameFile = null; firstFramePreview = ''">
                      <el-icon><Close /></el-icon>
                    </el-button>
                  </div>
                  <el-upload
                    v-else
                    class="ultra-compact-uploader"
                    :show-file-list="false"
                    :before-upload="handleFirstFrameUpload"
                    :accept="'image/*'"
                  >
                    <el-button size="small" :icon="Plus">ä¸Šä¼ </el-button>
                  </el-upload>
                </div>

                <!-- å°¾å¸§å›¾ç‰‡ -->
                <div v-if="supportsLastFrame" class="video-upload-item">
                  <label class="ultra-compact-label">å°¾å¸§</label>
                  <div v-if="lastFramePreview" class="ultra-compact-preview">
                    <img :src="lastFramePreview" alt="å°¾å¸§" class="ultra-thumb" />
                    <el-button size="small" text @click="lastFrameFile = null; lastFramePreview = ''">
                      <el-icon><Close /></el-icon>
                    </el-button>
                  </div>
                  <el-upload
                    v-else
                    class="ultra-compact-uploader"
                    :show-file-list="false"
                    :before-upload="handleLastFrameUpload"
                    :accept="'image/*'"
                  >
                    <el-button size="small" :icon="Plus">ä¸Šä¼ </el-button>
                  </el-upload>
                </div>
              </div>
            </div>
          </div>

          <!-- è§†é¢‘å‚æ•° - ç´§å‡‘æ¨ªå‘å¸ƒå±€ -->
          <div class="settings-section vertical-layout compact-section">
            <div class="setting-item">
              <h3>è§†é¢‘å‚æ•°</h3>
              
              <!-- Sora2 ä¸“ç”¨å‚æ•° -->
              <div v-if="isSoraModel" class="params-compact-row">
                <div class="param-compact-col">
                  <label>æ—¶é•¿</label>
                  <el-select v-model="videoDuration" placeholder="æ—¶é•¿" size="small">
                    <el-option label="10ç§’" value="10" />
                    <el-option label="15ç§’" value="15" :disabled="!isSoraPro" />
                    <el-option label="25ç§’" value="25" :disabled="!isSoraPro" />
                  </el-select>
                  <div v-if="!isSoraPro && (videoDuration === '15' || videoDuration === '25')" class="param-hint-inline">
                    ä»… Pro æ”¯æŒ
                  </div>
                </div>
                
                <div class="param-compact-col">
                  <label>å®½é«˜æ¯”</label>
                  <el-select v-model="videoAspectRatio" placeholder="æ¯”ä¾‹" size="small">
                    <el-option label="æ¨ªå± (16:9)" value="16:9" />
                    <el-option label="ç«–å± (9:16)" value="9:16" />
                  </el-select>
                </div>

                <div class="param-compact-col">
                  <label>HD é«˜æ¸…</label>
                  <el-switch 
                    v-model="videoHd" 
                    size="small"
                    :disabled="!isSoraPro || videoDuration === '25'"
                  />
                  <div v-if="!isSoraPro" class="param-hint-inline">
                    ä»… Pro
                  </div>
                  <div v-else-if="videoDuration === '25'" class="param-hint-inline">
                    25ç§’ä¸æ”¯æŒ
                  </div>
                  <div v-else-if="videoHd" class="param-hint-inline">
                    +8åˆ†é’Ÿ
                  </div>
                </div>
                
                <div class="param-compact-col">
                  <label>æ°´å°</label>
                  <el-switch v-model="videoWatermark" size="small" />
                </div>
              </div>

              <!-- å…¶ä»–æ¨¡å‹çš„é€šç”¨å‚æ•° -->
              <div v-else class="params-compact-row">
                <div class="param-compact-col">
                  <label>æ—¶é•¿</label>
                  <el-select v-model="videoDuration" placeholder="æ—¶é•¿" size="small">
                    <el-option label="5ç§’" :value="5" />
                    <el-option label="10ç§’" :value="10" />
                  </el-select>
                </div>
                
                <div class="param-compact-col">
                  <label>åˆ†è¾¨ç‡</label>
                  <el-select v-model="videoResolution" placeholder="åˆ†è¾¨ç‡" size="small">
                    <el-option label="480p" value="480p" />
                    <el-option label="720p" value="720p" />
                    <el-option label="1080p" value="1080p" />
                  </el-select>
                </div>

                <div class="param-compact-col">
                  <label>å®½é«˜æ¯”</label>
                  <el-select v-model="videoRatio" placeholder="æ¯”ä¾‹" size="small">
                    <el-option label="16:9" value="16:9" />
                    <el-option label="9:16" value="9:16" />
                    <el-option label="4:3" value="4:3" />
                    <el-option label="1:1" value="1:1" />
                    <el-option label="ä¿æŒæ¯”ä¾‹" value="keep_ratio" />
                  </el-select>
                </div>
              </div>
            </div>
          </div>

          <!-- Sora2 å®¡æŸ¥æç¤º -->
          <div v-if="isSoraModel" class="settings-section vertical-layout compact-section">
            <el-alert 
              type="warning" 
              :closable="false"
              show-icon
            >
              <template #title>
                <strong>âš ï¸ Sora2 é‡è¦æç¤º</strong>
              </template>
              <div style="font-size: 12px; line-height: 1.6; margin-top: 4px;">
                <p style="margin: 4px 0; color: #E6A23C; font-weight: 600;">
                  <strong>âŒ ä¸¥ç¦çœŸäººç…§ç‰‡ï¼š</strong>å›¾ç‰‡ä¸­ä¸èƒ½æœ‰çœŸäººæˆ–çœ‹èµ·æ¥åƒçœŸäººçš„å›¾åƒ
                </p>
                <p style="margin: 4px 0;">â€¢ æç¤ºè¯ä¸èƒ½åŒ…å«æš´åŠ›ã€è‰²æƒ…ã€ç‰ˆæƒã€æ´»ç€çš„åäºº</p>
                <p style="margin: 4px 0;">â€¢ ç”Ÿæˆç»“æœä¼šè¿›è¡Œå®¡æŸ¥ï¼ˆå¯èƒ½åœ¨90%+æ—¶å¤±è´¥ï¼‰</p>
                <p style="margin: 8px 0 4px 0;">
                  <strong>â±ï¸ é¢„è®¡ç”Ÿæˆæ—¶é—´ï¼š</strong>
                </p>
                <p style="margin: 2px 0; padding-left: 16px;">
                  â€¢ 10ç§’è§†é¢‘ï¼š1-3åˆ†é’Ÿ<br>
                  â€¢ 15ç§’è§†é¢‘ï¼š3-5åˆ†é’Ÿ<br>
                  â€¢ 25ç§’è§†é¢‘ï¼š5-8åˆ†é’Ÿ<br>
                  â€¢ HDé«˜æ¸…æ¨¡å¼ï¼šé¢å¤–+8åˆ†é’Ÿ
                </p>
                <p style="margin: 8px 0 4px 0; color: #409EFF;">
                  <strong>ğŸ’¡ è¯·è€å¿ƒç­‰å¾…ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è½®è¯¢ç›´åˆ°å®Œæˆ</strong>
                </p>
              </div>
            </el-alert>
          </div>

          <!-- é«˜çº§é€‰é¡¹ - å¯æŠ˜å  -->
          <div v-if="isDoubaoModel || isVeoModel || isWanModel" class="settings-section vertical-layout compact-section">
            <el-collapse v-model="videoAdvancedExpanded" class="advanced-collapse">
              <el-collapse-item name="advanced">
                <template #title>
                  <h3 class="collapse-title">é«˜çº§é€‰é¡¹</h3>
                </template>
                <div class="advanced-options-compact">
                  <!-- éšæœºç§å­ -->
                  <div class="option-item-compact">
                    <label>éšæœºç§å­ï¼ˆå¯é€‰ï¼‰</label>
                    <el-input-number
                      v-model="videoSeed"
                      :min="0"
                      :max="2147483647"
                      placeholder="ç•™ç©ºéšæœº"
                      size="small"
                      style="width: 100%"
                    />
                  </div>
                  
                  <!-- è±†åŒ…ä¸“ç”¨é€‰é¡¹ -->
                  <div v-if="isDoubaoModel" class="option-checkboxes">
                    <el-checkbox v-model="videoWatermark">æ·»åŠ æ°´å°</el-checkbox>
                    <el-checkbox v-model="videoCameraFixed">å›ºå®šæ‘„åƒå¤´</el-checkbox>
                    <el-checkbox v-model="videoReturnLastFrame">è¿”å›å°¾å¸§å›¾åƒ</el-checkbox>
                  </div>
                  
                  <!-- VEO3ä¸“ç”¨é€‰é¡¹ -->
                  <div v-if="isVeoModel" class="option-checkboxes">
                    <el-checkbox v-model="videoEnhancePrompt">æç¤ºè¯ä¼˜åŒ–</el-checkbox>
                    <el-checkbox v-model="videoEnableUpsample">åˆ†è¾¨ç‡æå‡</el-checkbox>
                  </div>
                  
                  <!-- Wanä¸“ç”¨é€‰é¡¹ -->
                  <template v-if="isWanModel">
                    <div class="option-checkboxes">
                      <el-checkbox v-model="videoWatermark">æ·»åŠ æ°´å°</el-checkbox>
                      <el-checkbox v-model="videoPromptExtend">æç¤ºè¯é‡å†™</el-checkbox>
                    </div>
                    
                    <div class="option-item-compact">
                      <label>è´Ÿé¢æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                      <el-input
                        v-model="videoNegativePrompt"
                        type="textarea"
                        :rows="2"
                        placeholder="ä¸æƒ³å‡ºç°çš„å†…å®¹..."
                        maxlength="500"
                        show-word-limit
                        size="small"
                      />
                    </div>
                    
                    <div class="option-item-compact">
                      <label>å…·ä½“åˆ†è¾¨ç‡</label>
                      <el-select v-model="videoSize" placeholder="é€‰æ‹©" size="small">
                        <el-option label="1920x1080 (16:9)" value="1920x1080" />
                        <el-option label="1080x1920 (9:16)" value="1080x1920" />
                        <el-option label="1440x1440 (1:1)" value="1440x1440" />
                        <el-option label="1280x720 (16:9)" value="1280x720" />
                        <el-option label="720x1280 (9:16)" value="720x1280" />
                      </el-select>
                    </div>
                  </template>
                </div>
              </el-collapse-item>
            </el-collapse>
          </div>

          <!-- ç”ŸæˆæŒ‰é’® -->
          <div class="action-buttons">
            <el-button 
              type="primary" 
              :loading="videoGenerateCooldown"
              @click="handleVideoGeneration"
              :disabled="!videoCanGenerate || videoGenerateCooldown"
              class="generate-btn"
              size="large"
            >
              <el-icon v-if="!videoGenerateCooldown"><VideoPlay /></el-icon>
              {{ videoGenerateCooldown ? 'æäº¤ä¸­...' : 'å¼€å§‹ç”Ÿæˆè§†é¢‘' }}
            </el-button>
          </div>
        </div>


        <!-- å›¾ç‰‡æ¯”ä¾‹å’Œç”Ÿæˆæ•°é‡ - ä»…åœ¨éè§†é¢‘ç”Ÿæˆæ¨¡å¼ä¸‹æ˜¾ç¤º -->
        <div v-if="generationMode !== 'image-to-video'" class="settings-section vertical-layout">
          <div class="setting-item">
            <h3>{{ currentParamConfig.paramType === 'size' ? 'å›¾ç‰‡å°ºå¯¸' : 'å›¾ç‰‡æ¯”ä¾‹' }}</h3>
              <div class="ratio-selector">
                <div 
                  v-for="option in dynamicImageSizeOptions" 
                  :key="option.value"
                  class="ratio-option"
                  :class="{ active: imageSize === option.value }"
                  @click="imageSize = option.value"
                >
                  <div class="ratio-box" :class="getRatioClass(option.label)"></div>
                  <span class="ratio-text">{{ option.label }}</span>
                </div>
              </div>
          </div>
          
          <div class="setting-item">
            <h3>ç”Ÿæˆæ•°é‡</h3>
              <div class="tag-selector">
                <div 
                  v-for="option in quantityOptions" 
                  :key="option.value"
                  class="tag-option"
                  :class="{ active: generateQuantity === option.value }"
                  @click="generateQuantity = option.value"
                >
                  {{ option.label }}
                </div>
              </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® - ä»…åœ¨éè§†é¢‘ç”Ÿæˆæ¨¡å¼ä¸‹æ˜¾ç¤º -->
        <div v-if="generationMode !== 'image-to-video'" class="action-buttons">
          <el-button 
            type="primary" 
            :loading="imageGenerateCooldown"
            @click="generateImage"
            :disabled="imageGenerateCooldown"
            class="generate-btn"
            size="large"
          >
            {{ imageGenerateCooldown ? 'æäº¤ä¸­...' : 'ç”Ÿæˆå›¾ç‰‡' }}
          </el-button>
        </div>
      </div>

      <!-- å³ä¾§ç»“æœå±•ç¤º -->
      <div class="result-panel">
        <!-- å›¾ç‰‡ç”Ÿæˆæ¨¡å¼ï¼šæ˜¾ç¤ºå›¾ç‰‡ç”Ÿæˆç»“æœ -->
        <div>
          <div class="result-header">
          <h2>ç”Ÿæˆç»“æœ</h2>
            <div class="header-actions">
              <div class="auto-download-switch">
                <el-switch
                  v-model="autoDownloadEnabled"
                  active-text="è‡ªåŠ¨ä¸‹è½½"
                  inactive-text="æ‰‹åŠ¨ä¸‹è½½"
                  size="small"
                  style="--el-switch-on-color: #67c23a; --el-switch-off-color: #dcdfe6;"
                />
              </div>
              <el-button v-if="hasAnyResults" type="success" @click="downloadAllResults" :icon="Download" size="small">
                ä¸€é”®ä¸‹è½½å…¨éƒ¨
              </el-button>
            </div>
          </div>
          <div class="result-content">
          <!-- ç©ºçŠ¶æ€ -->
          <div v-if="generationBatches.length === 0" class="empty-result">
            <div class="empty-state">
              <div class="empty-icon-container">
                <el-icon class="empty-icon"><Picture /></el-icon>
                <div class="empty-decoration">
                  <div class="decoration-circle circle-1"></div>
                  <div class="decoration-circle circle-2"></div>
                  <div class="decoration-circle circle-3"></div>
                </div>
              </div>
              <h3 class="empty-title">ç­‰å¾…ç”Ÿæˆ</h3>
              <p class="empty-description">è¯·åœ¨å·¦ä¾§è¾“å…¥æç¤ºè¯å¼€å§‹ç”Ÿæˆå›¾ç‰‡æˆ–è§†é¢‘</p>
            </div>
          </div>
          
          <!-- æ‰¹æ¬¡å®¹å™¨ - æ˜¾ç¤ºæ‰€æœ‰æ‰¹æ¬¡ -->
          <div v-else class="batches-container">
            <div 
              v-for="batch in generationBatches" 
              :key="batch.id"
              class="batch-card"
            >
              <!-- æ‰¹æ¬¡å¤´éƒ¨ -->
              <div class="batch-header">
                <div class="batch-info">
                  <span class="batch-type">{{ batch.type === 'image' ? 'å›¾ç‰‡ç”Ÿæˆ' : 'è§†é¢‘ç”Ÿæˆ' }}</span>
                  <span v-if="getBatchModelName(batch)" class="batch-model-tag">{{ getBatchModelName(batch) }}</span>
                  <span class="batch-time">{{ formatTimestamp(batch.timestamp) }}</span>
                  <span class="batch-prompt" :title="batch.prompt">{{ batch.prompt.substring(0, 50) }}{{ batch.prompt.length > 50 ? '...' : '' }}</span>
                </div>
                <el-button 
                  size="small" 
                  @click="removeBatch(batch.id)"
                  :icon="Delete"
                >
                  æ¸…é™¤
                </el-button>
              </div>

              <!-- ä»»åŠ¡æˆ–ç»“æœå±•ç¤º -->
              <div v-if="batch.status !== 'completed'" class="tasks-grid">
                <!-- å¤„ç†ä¸­æ—¶æ˜¾ç¤ºä»»åŠ¡å¡ç‰‡æˆ–å·²å®Œæˆçš„å›¾ç‰‡ -->
                <div 
                  v-for="task in batch.tasks" 
                  :key="task.id"
                  :class="{
                    'task-card': !task.imageUrl,
                    'task-pending': task.status === 'pending',
                    'task-processing': task.status === 'processing',
                    'task-completed': task.status === 'completed' && !task.imageUrl,
                    'task-failed': task.status === 'failed'
                  }"
                >
                  <!-- å¦‚æœä»»åŠ¡å·²å®Œæˆä¸”æœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡ -->
                  <ImageCard
                    v-if="task.status === 'completed' && task.imageUrl"
                    :src="task.imageUrl"
                    :alt="`ç”Ÿæˆçš„å›¾ç‰‡ ${task.index}`"
                    :prompt="batch.prompt"
                    :title="`ç”Ÿæˆçš„å›¾ç‰‡ ${task.index}`"
                    :subtitle="`å®æ—¶ç”Ÿæˆ`"
                    :meta="[batch.params?.size || imageSize, `${task.index}å·`]"
                    :enable-cache="true"
                    :lazy="false"
                    class="main-card"
                    @click="handleImageClick"
                    @download="handleImageDownload"
                    @add-to-prompts="handleAddToPrompts"
                    @preview="handleImagePreview"
                  />
                  
                  <!-- å¦åˆ™æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€å¡ç‰‡ -->
                  <div v-else class="task-content">
                    <!-- ä»»åŠ¡çŠ¶æ€å›¾æ ‡ -->
                    <div class="task-icon">
                      <el-icon v-if="task.status === 'pending'" class="pending-icon"><Clock /></el-icon>
                      <el-icon v-else-if="task.status === 'processing'" class="processing-icon"><Loading /></el-icon>
                      <el-icon v-else-if="task.status === 'failed'" class="failed-icon"><Close /></el-icon>
                    </div>
                    
                    <!-- ä»»åŠ¡ä¿¡æ¯ -->
                    <div class="task-info">
                      <h4>ä»»åŠ¡ {{ task.index }}</h4>
                      <p v-if="task.status === 'pending'">ç­‰å¾…å¼€å§‹</p>
                      <p v-else-if="task.status === 'processing'">ç”Ÿæˆä¸­...</p>
                      <p v-else-if="task.status === 'failed'" class="error-message">{{ getSimplifiedError(task.error) }}</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div v-else class="results-grid">
                <!-- å®Œæˆæ—¶æ˜¾ç¤ºç»“æœ -->
                <template v-for="(result, index) in batch.results" :key="index">
                  <!-- è§†é¢‘ç»“æœ - ç¼©ç•¥å›¾æ¨¡å¼ï¼Œç‚¹å‡»æ‰“å¼€é¢„è§ˆ -->
                  <div v-if="result.isVideo" class="video-card video-card-thumbnail" @click="openVideoPreview(result)">
                    <video 
                      :src="result.url" 
                      class="video-player"
                      :poster="result.thumbnail"
                      preload="metadata"
                    >
                      æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                    </video>
                    <div class="video-info">
                      <div class="info-item"><strong>æ—¶é•¿:</strong> {{ result.duration }}ç§’</div>
                      <div class="info-item"><strong>åˆ†è¾¨ç‡:</strong> {{ result.resolution }}</div>
                      <div class="info-item"><strong>æ¯”ä¾‹:</strong> {{ result.ratio }}</div>
                      <div class="info-item" v-if="result.seed"><strong>ç§å­:</strong> {{ result.seed }}</div>
                    </div>
                    <div class="video-actions">
                      <el-button type="primary" size="small" @click.stop="downloadVideo(result.url)">
                        <el-icon><Download /></el-icon> ä¸‹è½½è§†é¢‘
                      </el-button>
                    </div>
                  </div>
                  
                  <!-- å›¾ç‰‡ç»“æœ -->
                  <ImageCard
                    v-else
                    :src="result.url"
                    :alt="`ç”Ÿæˆçš„å›¾ç‰‡ ${index + 1}`"
                    :prompt="batch.prompt"
                    :title="`ç”Ÿæˆçš„å›¾ç‰‡ ${index + 1}`"
                    :subtitle="formatImageTime(result.timestamp)"
                    :meta="[batch.params.size || imageSize, `${result.index || index + 1}å·`]"
                    :badges="getImageBadges(result)"
                    :enable-cache="true"
                    :lazy="true"
                    class="main-card"
                    @click="handleImageClick"
                    @download="handleImageDownload"
                    @add-to-prompts="handleAddToPrompts"
                    @preview="handleImagePreview"
                  />
                </template>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æç¤ºè¯ç®¡ç†å¯¹è¯æ¡† -->
    <PromptManager 
      v-model="showPromptManager" 
      @select-prompt="handleSelectPrompt" 
      @prompts-updated="handleUserPromptsUpdated"
    />

    <!-- è§†é¢‘å¸¸ç”¨æç¤ºè¯ç®¡ç†å¯¹è¯æ¡† -->
    <CommonPromptsManager 
      v-model="showVideoPromptsManager" 
      prompt-type="video"
      @prompts-updated="handleVideoCommonPromptsUpdated"
    />


    <!-- å¸¸ç”¨å‚è€ƒå›¾ç®¡ç†å¯¹è¯æ¡† -->
    <el-dialog v-model="showReferenceManager" width="98%" :close-on-click-modal="false" :show-header="false">
      
      <ReferenceImageManager 
        @select-images="handleReferenceImageSelect"
        @close="handleReferenceImageCancel"
        @images-updated="fetchCommonReferenceImages"
      />
    </el-dialog>

    <!-- å¸¸ç”¨æç¤ºè¯ç®¡ç†å¯¹è¯æ¡† -->
    <CommonPromptsManager 
      v-model="showCommonPromptsManager" 
      @prompts-updated="handleCommonPromptsUpdated" 
    />

    <!-- ç®¡ç†å‘˜æ§åˆ¶å°å¯¹è¯æ¡† -->
    <el-dialog 
      v-model="showAdminDashboard" 
      title="ç®¡ç†å‘˜æ§åˆ¶å°" 
      width="95%" 
      :close-on-click-modal="false"
      :show-close="true"
    >
      <AdminDashboard :current-user="currentUser" />
    </el-dialog>

    <!-- è‡ªå®šä¹‰å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
    <div v-if="showImageModal" class="image-modal" @click="closeImageModal">
      <div class="image-modal-content" @click.stop>
        <!-- å…³é—­æŒ‰é’® -->
        <button class="close-btn" @click="closeImageModal">
          <el-icon><Close /></el-icon>
        </button>
        
        <!-- å›¾ç‰‡å®¹å™¨ -->
        <div class="image-container">
          <img 
            :src="currentPreviewImage" 
            :alt="currentPreviewTitle"
            class="preview-image"
            :style="{ transform: `scale(${imageScale}) rotate(${imageRotation}deg)` }"
            @wheel="handleImageWheel"
            @mousedown="startDrag"
            @mousemove="handleDrag"
            @mouseup="endDrag"
            @mouseleave="endDrag"
          />
        </div>
        
        <!-- æ§åˆ¶æ  -->
        <div class="image-controls">
          <!-- å¯¼èˆªæŒ‰é’® -->
          <div class="nav-controls">
            <button 
              class="nav-btn prev-btn" 
              @click="prevImage"
              :disabled="currentImageIndex === 0"
            >
              <el-icon><ArrowLeft /></el-icon>
            </button>
            <span class="image-counter">{{ currentImageIndex + 1 }} / {{ currentBatchImages.length }}</span>
            <button 
              class="nav-btn next-btn" 
              @click="nextImage"
              :disabled="currentImageIndex === currentBatchImages.length - 1"
            >
              <el-icon><ArrowRight /></el-icon>
            </button>
          </div>
          
          <!-- ç¼©æ”¾å’Œæ—‹è½¬æ§åˆ¶ -->
          <div class="zoom-controls">
            <button class="control-btn" @click="zoomOut" title="ç¼©å°">
              <el-icon><ZoomOut /></el-icon>
            </button>
            <button class="control-btn" @click="resetZoom" title="é‡ç½®">
              <el-icon><Refresh /></el-icon>
            </button>
            <button class="control-btn" @click="zoomIn" title="æ”¾å¤§">
              <el-icon><ZoomIn /></el-icon>
            </button>
            <button class="control-btn" @click="rotateLeft" title="å·¦æ—‹è½¬">
              <el-icon><RefreshLeft /></el-icon>
            </button>
            <button class="control-btn" @click="rotateRight" title="å³æ—‹è½¬">
              <el-icon><RefreshRight /></el-icon>
            </button>
          </div>
          
          <!-- ä¸‹è½½æŒ‰é’® -->
          <button class="download-btn" @click="downloadCurrentImage" title="ä¸‹è½½å½“å‰å›¾ç‰‡">
            <el-icon><Download /></el-icon>
          </button>
          
          <!-- ä¿å­˜ä¸ºæç¤ºè¯æŒ‰é’® -->
          <button class="save-prompt-btn" @click="saveCurrentImageAsPrompt" title="ä¿å­˜ä¸ºæç¤ºè¯">
            <el-icon><Document /></el-icon>
            <span>ä¿å­˜æç¤ºè¯</span>
          </button>
        </div>
      </div>
  </div>

  <!-- è§†é¢‘é¢„è§ˆå¼¹çª— -->
  <div v-if="showVideoModal" class="video-modal" @click="closeVideoModal">
    <div class="video-modal-content" @click.stop>
      <!-- å…³é—­æŒ‰é’® -->
      <button class="close-btn" @click="closeVideoModal">
        <el-icon><Close /></el-icon>
      </button>
      
      <!-- è§†é¢‘å®¹å™¨ -->
      <div class="video-container">
        <video 
          :src="currentPreviewVideo.url" 
          controls 
          autoplay
          class="preview-video"
        >
          æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
        </video>
      </div>
      
      <!-- è§†é¢‘ä¿¡æ¯ -->
      <div class="video-modal-info">
        <div class="info-row" v-if="currentPreviewVideo.duration">
          <strong>æ—¶é•¿:</strong> {{ currentPreviewVideo.duration }}ç§’
        </div>
        <div class="info-row" v-if="currentPreviewVideo.resolution">
          <strong>åˆ†è¾¨ç‡:</strong> {{ currentPreviewVideo.resolution }}
        </div>
        <div class="info-row" v-if="currentPreviewVideo.ratio">
          <strong>æ¯”ä¾‹:</strong> {{ currentPreviewVideo.ratio }}
        </div>
      </div>
      
      <!-- ä¸‹è½½æŒ‰é’® -->
      <button class="download-btn-video" @click="downloadVideo(currentPreviewVideo.url)" title="ä¸‹è½½è§†é¢‘">
        <el-icon><Download /></el-icon>
        <span>ä¸‹è½½è§†é¢‘</span>
      </button>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, computed, watch } from 'vue'
import { ElMessage, ElMessageBox, ElSwitch } from 'element-plus'
import { Clock, Plus, Picture, Loading, Download, Collection, Close, ArrowLeft, ArrowRight, ZoomOut, ZoomIn, Refresh, RefreshLeft, RefreshRight, MoreFilled, SwitchButton, Document, Edit, VideoPlay, Delete, Check, InfoFilled } from '@element-plus/icons-vue'
import LoginForm from './components/LoginForm.vue'
import HistoryPanel from './components/HistoryPanel.vue'
import PromptManager from './components/PromptManager.vue'
import ReferenceImageManager from './components/ReferenceImageManager.vue'
import CommonPromptsManager from './components/CommonPromptsManager.vue'
import ImageCard from './components/ImageCard.vue'
import { clearAllUserCache } from './utils/cacheUtils'
import LoadingCard from './components/LoadingCard.vue'
import MultilineTagInput from './components/MultilineTagInput.vue'
import AdminDashboard from './components/AdminDashboard.vue'
import { generateImages, getGenerationResult, getAvailableModels } from './api/imageApi'
import { generateVideo, getVideoResult, getVideoGenerationStatus, getVideoModels } from './api/videoApi'

// è®¤è¯ç›¸å…³æ•°æ®
const isLoggedIn = ref(false)
const currentUser = ref(null)
const showAdminDashboard = ref(false)

// å“åº”å¼æ•°æ®
const generationMode = ref('text-to-image')
const prompt = ref('') // æç¤ºè¯ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
const promptTags = ref([]) // æç¤ºè¯æ ‡ç­¾æ•°ç»„
const multilineTagInputRef = ref() // å¤šè¡Œæ ‡ç­¾è¾“å…¥ç»„ä»¶å¼•ç”¨

// è§†é¢‘æç¤ºè¯ç›¸å…³æ•°æ®
const videoPromptTags = ref([]) // è§†é¢‘æç¤ºè¯æ ‡ç­¾æ•°ç»„
const videoMultilineTagInputRef = ref() // è§†é¢‘å¤šè¡Œæ ‡ç­¾è¾“å…¥ç»„ä»¶å¼•ç”¨
const videoCommonPrompts = ref([]) // è§†é¢‘å¸¸ç”¨æç¤ºè¯åˆ—è¡¨
const selectedVideoPromptIds = ref(new Set()) // é€‰ä¸­çš„è§†é¢‘å¸¸ç”¨æç¤ºè¯IDé›†åˆ
const videoTagMapping = ref({}) // è§†é¢‘æ ‡ç­¾æ˜ å°„
const showVideoPromptsManager = ref(false) // è§†é¢‘æç¤ºè¯ç®¡ç†å™¨æ˜¾ç¤ºçŠ¶æ€
const imageSize = ref('1024x1792')
const generateQuantity = ref(1)

// æ¨¡å‹é€‰æ‹©ç›¸å…³
const availableModels = ref([])
const selectedModelId = ref(null)

// è§†é¢‘ç”Ÿæˆç›¸å…³æ•°æ®
const videoModels = ref([])
const videoSelectedModelId = ref(null)
const videoModelsLoading = ref(false)
const videoModelsLoaded = ref(false)
const firstFrameFileList = ref([])
const lastFrameFileList = ref([])
const videoAutoDownload = ref(true)
const imageTypes = 'image/jpeg,image/jpg,image/png,image/gif,image/webp'

// æ–°å¢çš„è§†é¢‘ç›¸å…³å˜é‡
const firstFrameFile = ref(null)
const firstFramePreview = ref('')
const lastFrameFile = ref(null)
const lastFramePreview = ref('')
const videoDuration = ref(5)
const videoResolution = ref('720p')
const videoRatio = ref('16:9')
const videoWatermark = ref(false)
const videoCameraFixed = ref(false)
const videoReturnLastFrame = ref(false)
const videoSeed = ref(null)
// VEO3ä¸“ç”¨å‚æ•°
const videoEnhancePrompt = ref(true)
// é«˜çº§é€‰é¡¹æŠ˜å æ§åˆ¶
const videoAdvancedExpanded = ref([])
const videoEnableUpsample = ref(false)
// Wanä¸“ç”¨å‚æ•°
const videoNegativePrompt = ref('')
const videoPromptExtend = ref(false)
const videoSize = ref('1920x1080') // Wanä½¿ç”¨å…·ä½“åˆ†è¾¨ç‡
// Sora2ä¸“ç”¨å‚æ•°
const videoHd = ref(false) // HD é«˜æ¸…æ¨¡å¼
const videoAspectRatio = ref('16:9') // å®½é«˜æ¯”

// æ ‡ç­¾æ˜ å°„å¯¹è±¡ï¼šå°†æ ‡ç­¾æ˜¾ç¤ºæ–‡æœ¬æ˜ å°„åˆ°å®é™…çš„æç¤ºè¯å†…å®¹
// è¿™ä¸ªæ˜ å°„ä¼šä»æ•°æ®åº“ä¸­çš„å¸¸ç”¨æç¤ºè¯åŠ¨æ€æ›´æ–°
const tagMapping = ref({})

// Provider parameter configuration
const providerConfig = {
  doubao: {
    paramType: 'size',
    options: [
      { label: '512x512', value: '512x512' },
      { label: '1024x1024', value: '1024x1024' },
      { label: '1792x1024 (æ¨ªå›¾)', value: '1792x1024' },
      { label: '1024x1792 (ç«–å›¾)', value: '1024x1792' },
      { label: '1488x2079 (ç«–å›¾)', value: '1488x2079' },
      { label: '2048x2048', value: '2048x2048' },
      { label: '2K', value: '2K' }
    ]
  },
  'nano-banana': {
    paramType: 'aspect_ratio',
    options: [
      { label: '1:1', value: '1:1' },
      { label: '4:3', value: '4:3' },
      { label: '3:4', value: '3:4' },
      { label: '16:9', value: '16:9' },
      { label: '9:16', value: '9:16' },
      { label: '2:3', value: '2:3' },
      { label: '3:2', value: '3:2' },
      { label: '4:5', value: '4:5' },
      { label: '5:4', value: '5:4' },
      { label: '21:9', value: '21:9' }
    ]
  },
  qianwen: {
    paramType: 'aspect_ratio',
    options: [
      { label: '1:1', value: '1:1' },
      { label: '21:9', value: '21:9' },
      { label: '16:9', value: '16:9' },
      { label: '4:3', value: '4:3' },
      { label: '3:2', value: '3:2' },
      { label: '2:3', value: '2:3' },
      { label: '3:4', value: '3:4' },
      { label: '9:16', value: '9:16' },
      { label: '9:21', value: '9:21' }
    ]
  },
  kuaishou: {
    paramType: 'aspect_ratio',
    options: [
      { label: '1:1', value: '1:1' },
      { label: '16:9', value: '16:9' },
      { label: '9:16', value: '9:16' },
      { label: '4:3', value: '4:3' },
      { label: '3:4', value: '3:4' },
      { label: '3:2', value: '3:2' },
      { label: '2:3', value: '2:3' }
    ]
  },
  default: {
    paramType: 'aspect_ratio',
    options: [
      { label: '1:1', value: '1:1' },
      { label: '16:9', value: '16:9' },
      { label: '9:16', value: '9:16' }
    ]
  }
}

// Detect provider from model name
const detectProvider = (modelName) => {
  if (!modelName) return 'default'
  const name = modelName.toLowerCase()
  if (name.includes('doubao') || name.includes('seedream')) return 'doubao'
  if (name.includes('nano-banana') || name.includes('gemini')) return 'nano-banana'
  if (name.includes('qwen')) return 'qianwen'
  if (name.includes('kling')) return 'kuaishou'
  return 'default'
}

// Current provider computed property
const currentProvider = computed(() => {
  const model = availableModels.value.find(m => m.id === selectedModelId.value)
  return detectProvider(model?.name)
})

// Current parameter configuration
const currentParamConfig = computed(() => {
  return providerConfig[currentProvider.value] || providerConfig.default
})

// Dynamic image size options based on provider
const dynamicImageSizeOptions = computed(() => {
  return currentParamConfig.value.options
})

// ğŸ”§ æ–°å¢ï¼šæ ¹æ®ç”Ÿæˆæ¨¡å¼è¿‡æ»¤å¯ç”¨æ¨¡å‹
const filteredAvailableModels = computed(() => {
  const mode = generationMode.value
  
  // å¦‚æœæ˜¯è§†é¢‘ç”Ÿæˆæ¨¡å¼ï¼Œè¿”å›ç©ºæ•°ç»„ï¼ˆè§†é¢‘æœ‰è‡ªå·±çš„æ¨¡å‹åˆ—è¡¨ï¼‰
  if (mode === 'image-to-video') {
    return []
  }
  
  // è¿‡æ»¤æ¨¡å‹ï¼šåªæ˜¾ç¤ºæ”¯æŒå½“å‰æ¨¡å¼çš„æ¨¡å‹
  return availableModels.value.filter(model => {
    const supportedModes = model.supported_modes || 'both'
    
    // 'both' è¡¨ç¤ºåŒæ—¶æ”¯æŒæ–‡ç”Ÿå›¾å’Œå›¾ç”Ÿå›¾
    if (supportedModes === 'both') {
      return true
    }
    
    // 'text-to-image' åªåœ¨æ–‡ç”Ÿå›¾æ¨¡å¼æ˜¾ç¤º
    if (supportedModes === 'text-to-image' && mode === 'text-to-image') {
      return true
    }
    
    // 'image-to-image' åªåœ¨å›¾ç”Ÿå›¾æ¨¡å¼æ˜¾ç¤º
    if (supportedModes === 'image-to-image' && mode === 'image-to-image') {
      return true
    }
    
    return false
  })
})

  // å›¾ç‰‡æ¯”ä¾‹é€‰é¡¹ (ä¿ç•™ç”¨äºå‘åå…¼å®¹)
  const imageSizeOptions = ref([
    { label: '1:1', value: '1024x1024' },
    { label: '16:9 (æ¨ªå›¾)', value: '1792x1024' },
    { label: '9:16 (ç«–å›¾)', value: '1024x1792' }
  ])

  // ç”Ÿæˆæ•°é‡é€‰é¡¹
  const quantityOptions = ref([
    { label: '1', value: 1 },
    { label: '2', value: 2 },
    { label: '3', value: 3 },
    { label: '4', value: 4 },
    { label: '5', value: 5 },
    { label: '6', value: 6 },
    { label: '7', value: 7 },
    { label: '8', value: 8 }
  ])
const uploadedImages = ref([]) // æ”¹ä¸ºæ•°ç»„æ”¯æŒå¤šå¼ å›¾ç‰‡
const generatedImages = ref([]) // ä¿ç•™ç”¨äºå‘åå…¼å®¹
const isGenerating = ref(false)

// æ‰¹æ¬¡ç®¡ç†ç³»ç»Ÿï¼ˆæ”¯æŒå¹¶å‘ç”Ÿæˆï¼‰
const generationBatches = ref([]) // ç”Ÿæˆæ‰¹æ¬¡æ•°ç»„ï¼Œæ¯ä¸ªæ‰¹æ¬¡åŒ…å«å¤šä¸ªä»»åŠ¡
// æ‰¹æ¬¡å¯¹è±¡ç»“æ„: {
//   id: string,
//   type: 'image' | 'video',
//   timestamp: Date,
//   status: 'pending' | 'processing' | 'completed' | 'failed',
//   tasks: [...],
//   results: [...],
//   prompt: string,
//   params: {...}
// }
const generationTasks = ref([]) // ä¿ç•™ç”¨äºå‘åå…¼å®¹
const completedTasks = ref(0) // å·²å®Œæˆçš„ä»»åŠ¡æ•°é‡

// æŒ‰é’®å†·å´æ—¶é—´ï¼ˆé˜²æ­¢è¯¯è§¦ï¼‰
const imageGenerateCooldown = ref(false)
const videoGenerateCooldown = ref(false)
const showHistory = ref(false)
const showPromptManager = ref(false)
const showReferenceManager = ref(false)
const showCommonPromptsManager = ref(false)
const showAddPromptDialog = ref(false)
const activeTab = ref('prompts')
const uploadRef = ref()
const historyPanelRef = ref()
const uploadedFiles = ref([]) // ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶å¼•ç”¨æ•°ç»„
const commonReferenceImages = ref([]) // å¸¸ç”¨å‚è€ƒå›¾åˆ—è¡¨
const isReferenceIconsCollapsed = ref(false) // å¸¸ç”¨å‚è€ƒå›¾æŠ˜å çŠ¶æ€
const isLoadingReferenceImages = ref(false) // å¸¸ç”¨å‚è€ƒå›¾åŠ è½½çŠ¶æ€
const recentUsedImages = ref([]) // æœ€è¿‘ä½¿ç”¨çš„å‚è€ƒå›¾
const referenceCategories = ref([
  { id: 'all', name: 'å…¨éƒ¨' }
]) // å‚è€ƒå›¾åˆ†ç±»åˆ—è¡¨
const SYSTEM_REFERENCE_CATEGORY_NAMES = new Set(['é»˜è®¤åˆ†ç±»', 'æ¦›æ¨¿î…»é’å—™è¢«'])
const activeReferenceCategoryId = ref('all') // å½“å‰æ´»åŠ¨çš„å‚è€ƒå›¾åˆ†ç±»
const commonPrompts = ref([]) // å¸¸ç”¨æç¤ºè¯åˆ—è¡¨
const userPrompts = ref([]) // ç”¨æˆ·æç¤ºè¯åˆ—è¡¨
const userPromptsLoading = ref(false) // ç”¨æˆ·æç¤ºè¯åŠ è½½çŠ¶æ€
const selectedCommonPromptIds = ref(new Set()) // é€‰ä¸­çš„å¸¸ç”¨æç¤ºè¯IDé›†åˆ
const isUpdatingFromDelete = ref(false) // æ ‡è®°æ˜¯å¦æ­£åœ¨ä»åˆ é™¤æ“ä½œæ›´æ–°çŠ¶æ€
const autoDownloadEnabled = ref(true) // è‡ªåŠ¨ä¸‹è½½å¼€å…³çŠ¶æ€ï¼Œé»˜è®¤å¼€å¯

// å‚è€ƒå›¾æ‹–æ‹½å’Œæ›¿æ¢çŠ¶æ€
const draggedImageIndex = ref(null) // æ­£åœ¨æ‹–æ‹½çš„å›¾ç‰‡ç´¢å¼•
const dropTargetIndex = ref(null) // æ‹–æ‹½ç›®æ ‡ä½ç½®ç´¢å¼•
const replacingImageId = ref(null) // æ­£åœ¨æ›¿æ¢çš„å›¾ç‰‡ID
const draggedCommonImageId = ref(null) // æ­£åœ¨æ‹–æ‹½çš„å¸¸ç”¨å‚è€ƒå›¾ID

// å›¾ç‰‡é¢„è§ˆå¼¹çª—çŠ¶æ€
const showImageModal = ref(false)
const currentPreviewImage = ref('')
const currentPreviewTitle = ref('')
const currentImageIndex = ref(0)
const currentViewingBatchId = ref(null) // å½“å‰æŸ¥çœ‹çš„æ‰¹æ¬¡ID
const currentBatchImages = ref([]) // å½“å‰æ‰¹æ¬¡çš„å›¾ç‰‡åˆ—è¡¨
const imageScale = ref(1)
const imageRotation = ref(0)
const isDragging = ref(false)
const dragStart = ref({ x: 0, y: 0 })
const imagePosition = ref({ x: 0, y: 0 })

// è§†é¢‘é¢„è§ˆç›¸å…³
const showVideoModal = ref(false)
const currentPreviewVideo = ref({
  url: '',
  duration: '',
  resolution: '',
  ratio: ''
})

// å¤„ç†å›¾ç‰‡ä¸Šä¼ 
const handleImageChange = async (file) => {
  // éªŒè¯æ–‡ä»¶å¯¹è±¡
  if (!file || !file.raw) {
    console.error('æ— æ•ˆçš„æ–‡ä»¶å¯¹è±¡:', file)
    ElMessage.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼šæ— æ•ˆçš„æ–‡ä»¶')
    return
  }
  
  // æ£€æŸ¥æ˜¯å¦å¤„äºæ›¿æ¢æ¨¡å¼
  const isReplacing = replacingImageId.value !== null
  const replaceIndex = isReplacing ? uploadedImages.value.findIndex(img => img.id === replacingImageId.value) : -1
  
  if (isReplacing) {
    console.log('[æ›¿æ¢æ¨¡å¼] æ›¿æ¢å›¾ç‰‡ID:', replacingImageId.value, 'ç´¢å¼•:', replaceIndex)
  }
  
  // å…ˆæ˜¾ç¤ºæœ¬åœ°é¢„è§ˆ
  const reader = new FileReader()
  reader.onload = (e) => {
    const tempImageData = {
      id: Date.now() + Math.random(),
      url: e.target.result,
      file: file.raw,
      name: file.name,
      uploading: true // æ ‡è®°ä¸ºä¸Šä¼ ä¸­
    }
    
    if (isReplacing && replaceIndex !== -1) {
      // æ›¿æ¢æ¨¡å¼ï¼šæ›¿æ¢æŒ‡å®šä½ç½®çš„å›¾ç‰‡
      uploadedImages.value.splice(replaceIndex, 1, tempImageData)
      uploadedFiles.value.splice(replaceIndex, 1, file.raw)
      console.log('[æ›¿æ¢æ¨¡å¼] å·²æ›¿æ¢ç´¢å¼•', replaceIndex, 'çš„å›¾ç‰‡:', file.name)
      replacingImageId.value = null // æ¸…é™¤æ›¿æ¢æ ‡è®°
    } else {
      // æ·»åŠ æ¨¡å¼ï¼šæ·»åŠ åˆ°æœ«å°¾
      uploadedImages.value.push(tempImageData)
    uploadedFiles.value.push(file.raw)
      console.log('[æœ¬åœ°ä¸Šä¼ ] æ·»åŠ ä¸´æ—¶é¢„è§ˆ:', file.name)
    }
  }
  reader.readAsDataURL(file.raw)
  
  // å¼‚æ­¥ä¸Šä¼ åˆ°OSSå¹¶ä¿å­˜åˆ°æ•°æ®åº“
  try {
    console.log('[æœ¬åœ°ä¸Šä¼ ] å¼€å§‹ä¸Šä¼ åˆ°OSS:', file.name)
    const token = localStorage.getItem('token')
    
    if (!token) {
      console.warn('[æœ¬åœ°ä¸Šä¼ ] æœªç™»å½•ï¼Œè·³è¿‡ä¸Šä¼ åˆ°æ•°æ®åº“')
      return
    }
    
    const formData = new FormData()
    formData.append('image', file.raw)
    formData.append('category', 'user-upload') // ç”¨æˆ·ä¸Šä¼ ç±»åˆ«
    
    const response = await fetch('/api/reference-images/upload', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    })
    
    if (!response.ok) {
      throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status}`)
    }
    
    const result = await response.json()
    
    if (result.success && result.data) {
      const refImage = result.data
      console.log('[æœ¬åœ°ä¸Šä¼ ] ä¸Šä¼ æˆåŠŸï¼ŒID:', refImage.id)
      
      // æ›´æ–°å›¾ç‰‡ä¿¡æ¯ï¼Œæ›¿æ¢ä¸´æ—¶IDä¸ºæ•°æ®åº“ID
      let tempIndex = -1
      if (isReplacing && replaceIndex !== -1) {
        // æ›¿æ¢æ¨¡å¼ï¼šæ›´æ–°è¢«æ›¿æ¢çš„å›¾ç‰‡
        tempIndex = replaceIndex
      } else {
        // æ·»åŠ æ¨¡å¼ï¼šæŸ¥æ‰¾åˆšæ·»åŠ çš„ä¸´æ—¶å›¾ç‰‡
        tempIndex = uploadedImages.value.findIndex(img => img.name === file.name && img.uploading)
      }
      
      if (tempIndex !== -1) {
        uploadedImages.value[tempIndex] = {
          id: refImage.id,
          dbId: refImage.id, // ä¿å­˜æ•°æ®åº“ID
          url: refImage.oss_url || refImage.url,
          file: file.raw,
          name: file.name,
          uploading: false
        }
        console.log('[æœ¬åœ°ä¸Šä¼ ] å·²æ›´æ–°ä¸ºæ•°æ®åº“è®°å½•ï¼ŒID:', refImage.id)
      }
    }
  } catch (error) {
    console.error('[æœ¬åœ°ä¸Šä¼ ] ä¸Šä¼ åˆ°OSSå¤±è´¥:', error)
    // ä¸Šä¼ å¤±è´¥ä¸å½±å“ä½¿ç”¨ï¼Œä»ç„¶å¯ä»¥ç”¨æœ¬åœ°æ–‡ä»¶ç”Ÿæˆ
    // åªæ˜¯æ— æ³•ä¿å­˜åˆ°å†å²è®°å½•çš„å‚è€ƒå›¾åˆ—è¡¨
  }
}

// åˆ é™¤ä¸Šä¼ çš„å›¾ç‰‡
const removeImage = (imageId) => {
  const index = uploadedImages.value.findIndex(img => img.id === imageId)
  if (index !== -1) {
    uploadedImages.value.splice(index, 1)
    uploadedFiles.value.splice(index, 1)
  }
}

// æ¸…ç©ºæ‰€æœ‰ä¸Šä¼ çš„å›¾ç‰‡
const clearAllImages = () => {
  uploadedImages.value = []
  uploadedFiles.value = []
  uploadRef.value?.clearFiles()
}

// ç‚¹å‡»ç¼©ç•¥å›¾æ›¿æ¢å›¾ç‰‡
const handleThumbnailClick = (imageId) => {
  console.log('[æ›¿æ¢å›¾ç‰‡] ç‚¹å‡»ç¼©ç•¥å›¾ï¼Œå‡†å¤‡æ›¿æ¢:', imageId)
  replacingImageId.value = imageId
  // è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨
  uploadRef.value?.$el.querySelector('input[type="file"]')?.click()
}

// å¸¸ç”¨å‚è€ƒå›¾æ‹–æ‹½å¼€å§‹
const handleCommonImageDragStart = (image, event) => {
  event.dataTransfer.effectAllowed = 'copy'
  event.dataTransfer.setData('common-reference-image-id', image.id.toString())
  draggedCommonImageId.value = image.id
  console.log('[å¸¸ç”¨å‚è€ƒå›¾æ‹–æ‹½å¼€å§‹] å›¾ç‰‡ID:', image.id, 'åç§°:', image.originalName)
}

// æ‹–æ‹½å¼€å§‹
const handleDragStart = (index, event) => {
  draggedImageIndex.value = index
  event.dataTransfer.effectAllowed = 'move'
  event.dataTransfer.setData('text/plain', index.toString())
  console.log('[æ‹–æ‹½å¼€å§‹] ç´¢å¼•:', index)
}

// æ‹–æ‹½ç»è¿‡
const handleDragOver = (index, event) => {
  event.preventDefault()
  event.dataTransfer.dropEffect = 'move'
  if (draggedImageIndex.value !== null && draggedImageIndex.value !== index) {
    dropTargetIndex.value = index
  }
}

// æ‹–æ‹½ç¦»å¼€
const handleDragLeave = () => {
  dropTargetIndex.value = null
}

// æ”¾ç½®
const handleDrop = (index, event) => {
  event.preventDefault()
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯ä»å¸¸ç”¨å‚è€ƒå›¾æ‹–æ‹½è¿‡æ¥çš„
  const commonImageId = event.dataTransfer.getData('common-reference-image-id')
  if (commonImageId) {
    console.log('[æ‹–æ‹½æ›¿æ¢] ä»å¸¸ç”¨å‚è€ƒå›¾æ›¿æ¢ï¼Œç›®æ ‡ç´¢å¼•:', index, 'å›¾ç‰‡ID:', commonImageId)
    // æ›¿æ¢ä¸ºå¸¸ç”¨å‚è€ƒå›¾
    replaceWithCommonImage(index, commonImageId)
  } else if (draggedImageIndex.value !== null && draggedImageIndex.value !== index) {
    // é‡æ–°æ’åº
    console.log('[æ‹–æ‹½æ’åº] ä»ç´¢å¼•', draggedImageIndex.value, 'ç§»åŠ¨åˆ°', index)
    reorderImages(draggedImageIndex.value, index)
  }
  
  dropTargetIndex.value = null
  draggedImageIndex.value = null
}

// æ‹–æ‹½ç»“æŸ
const handleDragEnd = () => {
  draggedImageIndex.value = null
  dropTargetIndex.value = null
  console.log('[æ‹–æ‹½ç»“æŸ] æ¸…ç†çŠ¶æ€')
}

// é‡æ–°æ’åºå›¾ç‰‡
const reorderImages = (fromIndex, toIndex) => {
  console.log('[é‡æ–°æ’åº] ä»', fromIndex, 'åˆ°', toIndex)
  
  // é‡æ–°æ’åº uploadedImages æ•°ç»„
  const [movedImage] = uploadedImages.value.splice(fromIndex, 1)
  uploadedImages.value.splice(toIndex, 0, movedImage)
  
  // é‡æ–°æ’åº uploadedFiles æ•°ç»„ (å…³é”®ï¼šä¿æŒä¸APIå‘é€çš„é¡ºåºä¸€è‡´)
  const [movedFile] = uploadedFiles.value.splice(fromIndex, 1)
  uploadedFiles.value.splice(toIndex, 0, movedFile)
  
  console.log('[é‡æ–°æ’åºå®Œæˆ] æ–°é¡ºåº:', uploadedImages.value.map((img, i) => `${i}: ${img.name}`))
}

// ç”¨å¸¸ç”¨å‚è€ƒå›¾æ›¿æ¢æŒ‡å®šä½ç½®çš„å›¾ç‰‡
const replaceWithCommonImage = async (targetIndex, commonImageId) => {
  try {
    const commonImage = commonReferenceImages.value.find(img => img.id === parseInt(commonImageId))
    if (!commonImage) {
      console.error('[æ›¿æ¢å¤±è´¥] æ‰¾ä¸åˆ°å¸¸ç”¨å‚è€ƒå›¾:', commonImageId)
      return
    }
    
    console.log('[æ›¿æ¢å›¾ç‰‡] ç”¨å¸¸ç”¨å‚è€ƒå›¾æ›¿æ¢ç´¢å¼•', targetIndex, ':', commonImage.originalName)
    
    // ä½¿ç”¨ä»£ç†æ¥å£è·å–å›¾ç‰‡
    const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(commonImage.url)}`
    const response = await fetch(proxyUrl, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const blob = await response.blob()
    const file = new File([blob], commonImage.originalName || commonImage.filename, {
      type: blob.type || 'image/png'
    })
    
    // æ›¿æ¢æŒ‡å®šä½ç½®çš„å›¾ç‰‡
    const imageData = {
      id: commonImage.id,
      dbId: commonImage.id,
      url: commonImage.url,
      file: file,
      name: commonImage.originalName || commonImage.filename
    }
    
    uploadedImages.value.splice(targetIndex, 1, imageData)
    uploadedFiles.value.splice(targetIndex, 1, file)
    
    console.log('[æ›¿æ¢æˆåŠŸ] ä½ç½®', targetIndex, 'å·²æ›¿æ¢ä¸º:', imageData.name)
    ElMessage.success('å‚è€ƒå›¾å·²æ›¿æ¢')
  } catch (error) {
    console.error('[æ›¿æ¢å¤±è´¥]:', error)
    ElMessage.error('æ›¿æ¢å‚è€ƒå›¾å¤±è´¥: ' + error.message)
  }
}

// è§†é¢‘ç”Ÿæˆç›¸å…³æ–¹æ³•
const beforeVideoUpload = (file) => {
  console.log('beforeVideoUpload è¢«è°ƒç”¨:', file)
  
  const isValidType = imageTypes.split(',').some(type => file.type === type.trim())
  if (!isValidType) {
    console.log('æ–‡ä»¶ç±»å‹æ— æ•ˆ:', file.type)
    ElMessage.error('åªæ”¯æŒ JPGã€PNGã€GIFã€WebP æ ¼å¼çš„å›¾ç‰‡ï¼')
    return false
  }
  const isLt10M = file.size / 1024 / 1024 < 10
  if (!isLt10M) {
    console.log('æ–‡ä»¶è¿‡å¤§:', file.size)
    ElMessage.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 10MBï¼')
    return false
  }
  
  console.log('æ–‡ä»¶éªŒè¯é€šè¿‡ï¼Œè¿”å› false ä»¥è§¦å‘ on-change äº‹ä»¶')
  // å½“ auto-upload="false" æ—¶ï¼Œéœ€è¦è¿”å› false æ¥é˜»æ­¢è‡ªåŠ¨ä¸Šä¼ 
  // æ–‡ä»¶ä¼šé€šè¿‡ on-change äº‹ä»¶å¤„ç†
  return false
}

const handleVideoFileChange = (file, fileList, type) => {
  console.log('è§†é¢‘æ–‡ä»¶å˜åŒ–:', { file, fileList, type })
  
  if (type === 'first') {
    firstFrameFileList.value = fileList
    console.log('é¦–å¸§æ–‡ä»¶åˆ—è¡¨æ›´æ–°:', firstFrameFileList.value)
  } else if (type === 'last') {
    lastFrameFileList.value = fileList
    console.log('å°¾å¸§æ–‡ä»¶åˆ—è¡¨æ›´æ–°:', lastFrameFileList.value)
  }
}

const handleVideoFileRemove = (file, fileList, type) => {
  if (type === 'first') {
    firstFrameFileList.value = fileList
  } else if (type === 'last') {
    lastFrameFileList.value = fileList
  }
}

const resetVideoForm = () => {
  firstFrameFileList.value = []
  lastFrameFileList.value = []
  videoSelectedModelId.value = null
  videoAutoDownload.value = true
  // é‡ç½®æ–°å¢çš„å˜é‡
  firstFrameFile.value = null
  firstFramePreview.value = ''
  lastFrameFile.value = null
  lastFramePreview.value = ''
  videoDuration.value = 5
  videoResolution.value = '720p'
  videoRatio.value = '16:9'
  videoWatermark.value = false
  videoCameraFixed.value = false
  videoReturnLastFrame.value = false
  videoSeed.value = null
  // é‡ç½®VEO3ä¸“ç”¨å‚æ•°
  videoEnhancePrompt.value = true
  videoEnableUpsample.value = false
  // é‡ç½®Wanä¸“ç”¨å‚æ•°
  videoNegativePrompt.value = ''
  videoPromptExtend.value = false
  videoSize.value = '1920x1080'
  // æ³¨æ„ï¼šä¸æ¸…é™¤ generationBatchesï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨æ¸…é™¤å„æ‰¹æ¬¡
}

// å¤„ç†é¦–å¸§å›¾ç‰‡ä¸Šä¼ 
const handleFirstFrameUpload = (file) => {
  if (!file.type.startsWith('image/')) {
    ElMessage.error('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶')
    return false
  }
  
  if (file.size > 10 * 1024 * 1024) {
    ElMessage.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB')
    return false
  }
  
  firstFrameFile.value = file
  const reader = new FileReader()
  reader.onload = (e) => {
    firstFramePreview.value = e.target.result
  }
  reader.readAsDataURL(file)
  return false
}

// å¤„ç†å°¾å¸§å›¾ç‰‡ä¸Šä¼ 
const handleLastFrameUpload = (file) => {
  if (!file.type.startsWith('image/')) {
    ElMessage.error('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶')
    return false
  }
  
  if (file.size > 10 * 1024 * 1024) {
    ElMessage.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB')
    return false
  }
  
  lastFrameFile.value = file
  const reader = new FileReader()
  reader.onload = (e) => {
    lastFramePreview.value = e.target.result
  }
  reader.readAsDataURL(file)
  return false
}

  const handleVideoGeneration = async () => {
  // æ£€æŸ¥å†·å´çŠ¶æ€
  if (videoGenerateCooldown.value) {
    ElMessage.warning('è¯·ç¨å€™å†è¯•ï¼Œé¿å…é¢‘ç¹ç‚¹å‡»')
    return
  }
  
  // è·å–è§†é¢‘æç¤ºè¯å†…å®¹
  let promptText = ''
  if (videoMultilineTagInputRef.value) {
    promptText = videoMultilineTagInputRef.value.getFullText()
  } else if (videoPromptTags.value.length > 0) {
    // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨å¤„ç†è§†é¢‘æ ‡ç­¾æ˜ å°„
    const mappedTags = videoPromptTags.value.map(tag => videoTagMapping.value[tag] || tag)
    promptText = mappedTags.join(', ')
  } else {
    promptText = prompt.value
  }
  
  console.log('è§†é¢‘ç”Ÿæˆå‚æ•°æ£€æŸ¥:', {
    promptText: promptText.trim(),
    videoSelectedModelId: videoSelectedModelId.value,
    firstFrameFile: firstFrameFile.value,
    lastFrameFile: lastFrameFile.value,
    videoDuration: videoDuration.value,
    videoResolution: videoResolution.value,
    videoRatio: videoRatio.value
  })
  
  // åŸºæœ¬æ£€æŸ¥ï¼šæç¤ºè¯ã€æ¨¡å‹é€‰æ‹©å’Œé¦–å¸§å›¾ç‰‡
  if (!promptText.trim()) {
    ElMessage.warning('è¯·å¡«å†™æç¤ºè¯')
    return
  }
  
  if (!videoSelectedModelId.value) {
    ElMessage.warning('è¯·é€‰æ‹©è§†é¢‘æ¨¡å‹')
    return
  }
  
  // å¦‚æœæ¨¡å‹å¿…é¡»è¦é¦–å¸§å›¾ç‰‡ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼ ï¼ˆä»…image-to-videoæ¨¡å¼å¿…é¡»ï¼‰
  if (firstFrameRequired.value && !firstFrameFile.value) {
    ElMessage.warning('è¯·ä¸Šä¼ é¦–å¸§å›¾ç‰‡')
    return
  }

  // å¯åŠ¨å†·å´è®¡æ—¶å™¨ï¼ˆ2ç§’ï¼‰
  videoGenerateCooldown.value = true
  setTimeout(() => {
    videoGenerateCooldown.value = false
  }, 2000)

  // åˆ›å»ºæ–°æ‰¹æ¬¡
  const batchId = `batch_video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  const videoTask = {
    id: `video_task_${Date.now()}`,
    status: 'pending',
    imageUrl: '',
    videoUrl: '',
    index: 1,
    progress: 0,
    isVideo: true
  }
  
  const newBatch = {
    id: batchId,
    type: 'video',
    timestamp: new Date(),
    status: 'pending',
    tasks: [videoTask],
    results: [],
    prompt: promptText.trim(),
    params: {
      modelDbId: videoSelectedModelId.value,
      duration: videoDuration.value,
      resolution: videoResolution.value,
      ratio: videoRatio.value
    }
  }
  
  // å°†æ–°æ‰¹æ¬¡æ·»åŠ åˆ°æ•°ç»„å¼€å¤´ï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
  generationBatches.value.unshift(newBatch)

  try {
    // åˆ›å»ºä¸€ä¸ªpendingä»»åŠ¡å¡ç‰‡ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
    generationTasks.value = [videoTask]
    
    // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€ä¸ºå¤„ç†ä¸­
    newBatch.status = 'processing'
    videoTask.status = 'processing'
    
    // å‡†å¤‡è¯·æ±‚æ•°æ®
    const requestData = {
      prompt: promptText.trim(),
      modelDbId: videoSelectedModelId.value, // ä½¿ç”¨æ•°æ®åº“ID
      duration: videoDuration.value,
      resolution: videoResolution.value,
      ratio: videoRatio.value,
      watermark: videoWatermark.value,
      camerafixed: videoCameraFixed.value,
      return_last_frame: videoReturnLastFrame.value, // ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å
      seed: videoSeed.value,
      auto_download: videoAutoDownload.value,
      enhance_prompt: videoEnhancePrompt.value, // VEO3ä¸“ç”¨
      enable_upsample: videoEnableUpsample.value, // VEO3ä¸“ç”¨
      negative_prompt: videoNegativePrompt.value, // Wanä¸“ç”¨ï¼šè´Ÿé¢æç¤ºè¯
      prompt_extend: videoPromptExtend.value, // Wanä¸“ç”¨ï¼šæç¤ºè¯é‡å†™
      size: videoSize.value, // Wanä¸“ç”¨ï¼šå…·ä½“åˆ†è¾¨ç‡
      hd: videoHd.value, // Sora2ä¸“ç”¨ï¼šHD é«˜æ¸…
      aspect_ratio: videoAspectRatio.value // Sora2ä¸“ç”¨ï¼šå®½é«˜æ¯”
    }

    // æ ¹æ®ä¸Šä¼ çš„å›¾ç‰‡æ•°é‡å†³å®šç”Ÿæˆç±»å‹
    if (firstFrameFile.value && lastFrameFile.value) {
      // é¦–å°¾å¸§ç”Ÿæˆ
      console.log('ä½¿ç”¨é¦–å°¾å¸§ç”Ÿæˆæ¨¡å¼')
      requestData.firstFrame = firstFrameFile.value
      requestData.lastFrame = lastFrameFile.value
      requestData.generation_type = 'first_last_frame'
    } else if (firstFrameFile.value) {
      // æ™®é€šå‚è€ƒå›¾ç”Ÿæˆ
      console.log('ä½¿ç”¨é¦–å¸§å‚è€ƒå›¾ç”Ÿæˆæ¨¡å¼')
      requestData.firstFrame = firstFrameFile.value
      requestData.generation_type = 'reference'
    } else {
      // çº¯æ–‡æœ¬ç”Ÿæˆ
      console.log('ä½¿ç”¨çº¯æ–‡æœ¬ç”Ÿæˆæ¨¡å¼')
      requestData.generation_type = 'text_only'
    }

    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤„ç†ä¸­
    generationTasks.value[0].status = 'processing'
    
    // è°ƒç”¨è§†é¢‘ç”ŸæˆAPIï¼ˆæäº¤ä»»åŠ¡ï¼‰
    const response = await generateVideo(requestData)
    
    if (response.taskId) {
      // æ ¹æ®æ¨¡å‹å’Œå‚æ•°æ˜¾ç¤ºä¸åŒçš„ç­‰å¾…æç¤º
      let estimatedTime = '3-5åˆ†é’Ÿ';
      if (isSoraModel.value) {
        if (videoHd.value) {
          estimatedTime = '10-15åˆ†é’Ÿ';
        } else if (videoDuration.value === '25') {
          estimatedTime = '5-8åˆ†é’Ÿ';
        } else if (videoDuration.value === '15') {
          estimatedTime = '3-5åˆ†é’Ÿ';
        } else {
          estimatedTime = '1-3åˆ†é’Ÿ';
        }
        ElMessage.success({
          message: `Sora2ä»»åŠ¡å·²æäº¤ï¼é¢„è®¡éœ€è¦ ${estimatedTime}ï¼Œè¯·è€å¿ƒç­‰å¾…...`,
          duration: 5000
        });
      } else {
        ElMessage.success('è§†é¢‘ç”Ÿæˆä»»åŠ¡å·²æäº¤ï¼Œè¯·ç­‰å¾…...');
      }
      
      // æ ¹æ®æ¨¡å‹ç±»å‹åŠ¨æ€è®¾ç½®è½®è¯¢å‚æ•°
      let maxAttempts = 60 // é»˜è®¤æœ€å¤šè½®è¯¢60æ¬¡ï¼ˆ5åˆ†é’Ÿï¼‰
      const interval = 5000 // æ¯5ç§’æŸ¥è¯¢ä¸€æ¬¡
      
      // é’ˆå¯¹Sora2æ¨¡å‹å¢åŠ è½®è¯¢æ¬¡æ•°
      if (isSoraModel.value) {
        if (videoHd.value) {
          // HDæ¨¡å¼ï¼šéœ€è¦é¢å¤–8åˆ†é’Ÿï¼Œæ€»å…±çº¦12-15åˆ†é’Ÿ
          maxAttempts = 180 // 180æ¬¡ * 5ç§’ = 15åˆ†é’Ÿ
          console.log('[è§†é¢‘è½®è¯¢] Sora2 HDæ¨¡å¼ï¼Œæœ€å¤šè½®è¯¢180æ¬¡ï¼ˆçº¦15åˆ†é’Ÿï¼‰')
        } else if (videoDuration.value === '25') {
          // 25ç§’æ¨¡å¼ï¼šéœ€è¦çº¦8åˆ†é’Ÿ
          maxAttempts = 120 // 120æ¬¡ * 5ç§’ = 10åˆ†é’Ÿ
          console.log('[è§†é¢‘è½®è¯¢] Sora2 25ç§’æ¨¡å¼ï¼Œæœ€å¤šè½®è¯¢120æ¬¡ï¼ˆçº¦10åˆ†é’Ÿï¼‰')
        } else if (videoDuration.value === '15') {
          // 15ç§’æ¨¡å¼ï¼šéœ€è¦çº¦5åˆ†é’Ÿ
          maxAttempts = 100 // 100æ¬¡ * 5ç§’ = 8.3åˆ†é’Ÿ
          console.log('[è§†é¢‘è½®è¯¢] Sora2 15ç§’æ¨¡å¼ï¼Œæœ€å¤šè½®è¯¢100æ¬¡ï¼ˆçº¦8åˆ†é’Ÿï¼‰')
        } else {
          // 10ç§’æ¨¡å¼ï¼šéœ€è¦çº¦3åˆ†é’Ÿ
          maxAttempts = 80 // 80æ¬¡ * 5ç§’ = 6.7åˆ†é’Ÿ
          console.log('[è§†é¢‘è½®è¯¢] Sora2 10ç§’æ¨¡å¼ï¼Œæœ€å¤šè½®è¯¢80æ¬¡ï¼ˆçº¦7åˆ†é’Ÿï¼‰')
        }
      }
      
      for (let i = 0; i < maxAttempts; i++) {
        await new Promise(resolve => setTimeout(resolve, interval))
        
        try {
          const resultResponse = await getVideoResult(response.taskId)
          console.log(`[è§†é¢‘è½®è¯¢] ç¬¬${i + 1}æ¬¡æŸ¥è¯¢:`, {
            status: resultResponse.status,
            hasResult: !!resultResponse.result,
            fullResponse: resultResponse
          })
          
          // æ£€æŸ¥å¤šç§å¯èƒ½çš„æˆåŠŸçŠ¶æ€
          const isCompleted = resultResponse.status === 'completed' || 
                             resultResponse.status === 'success' ||
                             resultResponse.status === 'SUCCESS'
          
          if (isCompleted && resultResponse.result) {
            const result = resultResponse.result
            
            // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆ
            generationTasks.value[0].status = 'completed'
            generationTasks.value[0].videoUrl = result.url
            generationTasks.value[0].progress = 100
            
            const videoResult = {
              url: result.url,
              isVideo: true,
              thumbnail: result.thumbnail,
              duration: result.duration,
              resolution: result.resolution,
              ratio: result.ratio,
              fps: result.fps,
              seed: result.seed,
              timestamp: new Date().toISOString()
            }
            
            // å°†è§†é¢‘ç»“æœæ·»åŠ åˆ°ç”Ÿæˆç»“æœä¸­
            generatedImages.value = [videoResult]
            
            // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€å’Œç»“æœ
            if (newBatch) {
              newBatch.tasks[0].status = 'completed'
              newBatch.tasks[0].videoUrl = result.url
              newBatch.tasks[0].progress = 100
              newBatch.results = [videoResult]
              newBatch.status = 'completed'
              console.log('[æ‰¹æ¬¡æ›´æ–°] è§†é¢‘æ‰¹æ¬¡å·²å®Œæˆ:', {
                batchId: newBatch.id,
                status: newBatch.status,
                hasResults: newBatch.results.length > 0
              })
            } else {
              console.warn('[æ‰¹æ¬¡æ›´æ–°] è­¦å‘Šï¼šæ‰¾ä¸åˆ°æ‰¹æ¬¡å¯¹è±¡')
            }
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            try {
              await saveToHistoryAutomatically()
              console.log('è§†é¢‘å†å²è®°å½•å·²ä¿å­˜')
            } catch (historyError) {
              console.error('ä¿å­˜è§†é¢‘å†å²è®°å½•å¤±è´¥:', historyError)
              // ä¸å½±å“ä¸»æµç¨‹ï¼Œåªè®°å½•é”™è¯¯
            }
            
            ElMessage.success('è§†é¢‘ç”ŸæˆæˆåŠŸï¼')
            
            // æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦è‡ªåŠ¨ä¸‹è½½
            if (autoDownloadEnabled.value && result.url) {
              console.log('[è‡ªåŠ¨ä¸‹è½½] è§†é¢‘ç”Ÿæˆå®Œæˆï¼Œå‡†å¤‡ä¸‹è½½')
              setTimeout(async () => {
                try {
                  await downloadVideo(result.url, `video_${Date.now()}`)
                  ElMessage.success('è§†é¢‘å·²è‡ªåŠ¨ä¸‹è½½')
                } catch (downloadError) {
                  console.error('[è‡ªåŠ¨ä¸‹è½½] ä¸‹è½½å¤±è´¥:', downloadError)
                }
              }, 1000) // å»¶è¿Ÿ1ç§’åè‡ªåŠ¨ä¸‹è½½
            }
            
            break
          } else if (resultResponse.status === 'failed' || 
                     resultResponse.status === 'FAILED' || 
                     resultResponse.status === 'FAILURE') {
            // ç«‹å³æ ‡è®°ä»»åŠ¡å¤±è´¥å¹¶è·³å‡ºå¾ªç¯
            const errorMessage = resultResponse.error || resultResponse.message || 'è§†é¢‘ç”Ÿæˆå¤±è´¥'
            
            generationTasks.value[0].status = 'failed'
            generationTasks.value[0].error = errorMessage
            
            // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€
            if (newBatch) {
              newBatch.tasks[0].status = 'failed'
              newBatch.tasks[0].error = errorMessage
              newBatch.status = 'failed'
              console.log('[æ‰¹æ¬¡æ›´æ–°] è§†é¢‘æ‰¹æ¬¡å¤±è´¥:', {
                batchId: newBatch.id,
                status: newBatch.status,
                error: errorMessage
              })
            }
            
            ElMessage.error('è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼š' + errorMessage)
            console.log('[è§†é¢‘è½®è¯¢] æ£€æµ‹åˆ°å¤±è´¥çŠ¶æ€ï¼Œåœæ­¢è½®è¯¢')
            return // ç›´æ¥è¿”å›ï¼Œåœæ­¢è½®è¯¢
          }
          // ç»§ç»­ç­‰å¾…...
        } catch (pollError) {
          console.error('æŸ¥è¯¢è§†é¢‘ç»“æœå¤±è´¥:', pollError)
          // å¦‚æœæ˜¯failedçŠ¶æ€å¯¼è‡´çš„é”™è¯¯ï¼Œç›´æ¥æŠ›å‡ºï¼Œä¸ç»§ç»­è½®è¯¢
          if (pollError.message && pollError.message.includes('è§†é¢‘ç”Ÿæˆå¤±è´¥')) {
            throw pollError
          }
          // å…¶ä»–é”™è¯¯ï¼ˆå¦‚ç½‘ç»œé”™è¯¯ï¼‰ï¼Œåªåœ¨æœ€åä¸€æ¬¡å°è¯•æ—¶æŠ›å‡º
          if (i === maxAttempts - 1) {
            throw new Error('æŸ¥è¯¢è§†é¢‘ç»“æœè¶…æ—¶')
          }
        }
      }
      
      // å¦‚æœå¾ªç¯ç»“æŸä»æœªå®Œæˆï¼Œæ ‡è®°ä¸ºè¶…æ—¶å¤±è´¥
      if (generationTasks.value.length > 0 && generationTasks.value[0].status !== 'completed') {
        const timeoutMinutes = Math.round((maxAttempts * interval) / 60000)
        console.warn(`[è§†é¢‘ç”Ÿæˆ] è½®è¯¢è¶…æ—¶ï¼ˆ${timeoutMinutes}åˆ†é’Ÿï¼‰ï¼Œä½†ä»»åŠ¡å¯èƒ½ä»åœ¨åå°å¤„ç†`)
        
        let timeoutMessage = `æŸ¥è¯¢è¶…æ—¶ï¼ˆå·²ç­‰å¾…${timeoutMinutes}åˆ†é’Ÿï¼‰ï¼Œè¯·ç¨åæŸ¥çœ‹å†å²è®°å½•`
        if (isSoraModel.value) {
          timeoutMessage += '\næç¤ºï¼šSora2ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œä»»åŠ¡å¯èƒ½ä»åœ¨å¤„ç†ä¸­'
        }
        
        generationTasks.value[0].status = 'failed'
        generationTasks.value[0].error = timeoutMessage
        
        if (newBatch) {
          newBatch.tasks[0].status = 'failed'
          newBatch.tasks[0].error = 'æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·ç¨åæŸ¥çœ‹å†å²è®°å½•'
          newBatch.status = 'failed'
        }
        
        ElMessage.warning('æŸ¥è¯¢è¶…æ—¶ï¼Œè§†é¢‘å¯èƒ½ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹å†å²è®°å½•')
      }
    } else {
      // æ ‡è®°ä»»åŠ¡ä¸ºå¤±è´¥
      generationTasks.value[0].status = 'failed'
      generationTasks.value[0].error = response.message || 'è§†é¢‘ç”Ÿæˆå¤±è´¥'
      
      // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€
      if (newBatch) {
        newBatch.tasks[0].status = 'failed'
        newBatch.tasks[0].error = response.message || 'è§†é¢‘ç”Ÿæˆå¤±è´¥'
        newBatch.status = 'failed'
      }
      
      ElMessage.error(response.message || 'è§†é¢‘ç”Ÿæˆå¤±è´¥')
    }
  } catch (error) {
    console.error('è§†é¢‘ç”Ÿæˆå¤±è´¥:', error)
    
    // æ ‡è®°ä»»åŠ¡ä¸ºå¤±è´¥
    if (generationTasks.value.length > 0) {
      generationTasks.value[0].status = 'failed'
      generationTasks.value[0].error = error.message || 'æœªçŸ¥é”™è¯¯'
    }
    
    // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€
    if (newBatch) {
      newBatch.tasks[0].status = 'failed'
      newBatch.tasks[0].error = error.message || 'æœªçŸ¥é”™è¯¯'
      newBatch.status = 'failed'
    }
    
    ElMessage.error('è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  }
}

// ä¸‹è½½è§†é¢‘
const downloadVideo = async (videoUrl, filename) => {
  try {
    if (!videoUrl) {
      throw new Error('è§†é¢‘URLä¸ºç©º')
    }
    
    if (!filename) {
      filename = `video_${Date.now()}`
    }
    
    console.log('[ä¸‹è½½è§†é¢‘] å¼€å§‹ä¸‹è½½:', { videoUrl, filename })
    ElMessage.info('æ­£åœ¨å‡†å¤‡ä¸‹è½½è§†é¢‘...')
    
    // åˆ¤æ–­æ˜¯å¦éœ€è¦é€šè¿‡ä»£ç†ä¸‹è½½è§†é¢‘ï¼Œé¿å…CORSé—®é¢˜
    let fetchUrl = videoUrl
    const fetchOptions = {}
    
    if (needsProxyDownload(videoUrl)) {
      // ä½¿ç”¨ä»£ç†æ¥å£é¿å…CORS
      fetchUrl = `/api/proxy-image?url=${encodeURIComponent(videoUrl)}`
      fetchOptions.headers = {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
      console.log('[ä¸‹è½½è§†é¢‘] ä½¿ç”¨ä»£ç†ä¸‹è½½')
    } else {
      console.log('[ä¸‹è½½è§†é¢‘] ç›´æ¥ä¸‹è½½')
    }
    
    // ä½¿ç”¨fetchä¸‹è½½è§†é¢‘æ–‡ä»¶
    const response = await fetch(fetchUrl, fetchOptions)
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`)
    }
    
    const blob = await response.blob()
    console.log('[ä¸‹è½½è§†é¢‘] è·å–BlobæˆåŠŸ:', { size: blob.size, type: blob.type })
    
    const blobUrl = URL.createObjectURL(blob)
    
    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶é“¾æ¥å¹¶ç‚¹å‡»å®ƒ
    const link = document.createElement('a')
    link.href = blobUrl
    link.download = `${filename}.mp4`
    link.target = '_self'
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    
    // æ¸…ç†blob URL
    setTimeout(() => {
      URL.revokeObjectURL(blobUrl)
    }, 100)
    
    ElMessage.success('è§†é¢‘ä¸‹è½½æˆåŠŸ')
    return true
  } catch (error) {
    console.error('[ä¸‹è½½è§†é¢‘] å¤±è´¥:', error)
    ElMessage.error('è§†é¢‘ä¸‹è½½å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    throw error
  }
}

// å¤„ç†å¸¸ç”¨å‚è€ƒå›¾é€‰æ‹©
const handleReferenceImageSelect = async (selectedImages) => {
  if (selectedImages && selectedImages.length > 0) {
    // æ·»åŠ é€‰ä¸­çš„å›¾ç‰‡åˆ°ä¸Šä¼ åˆ—è¡¨
    for (const image of selectedImages) {
      try {
        // ä½¿ç”¨ä»£ç†æ¥å£è·å–å›¾ç‰‡ï¼Œé¿å…CORSé—®é¢˜
        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(image.url)}`
        const response = await fetch(proxyUrl, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        
        const blob = await response.blob()
        
        // ç¡®ä¿æœ‰æ­£ç¡®çš„MIMEç±»å‹å’Œæ–‡ä»¶æ‰©å±•å
        let mimeType = blob.type || 'image/png'
        let fileName = image.originalName || image.filename || 'å‚è€ƒå›¾'
        
        // å¦‚æœMIMEç±»å‹ä¸ºç©ºæˆ–æ— æ•ˆï¼Œæ ¹æ®URLæˆ–é»˜è®¤è®¾ç½®ä¸ºpng
        if (!mimeType || !mimeType.startsWith('image/')) {
          mimeType = 'image/png'
        }
        
        // ç¡®ä¿æ–‡ä»¶åæœ‰æ­£ç¡®çš„æ‰©å±•å
        if (!fileName.includes('.')) {
          const extension = mimeType.split('/')[1] || 'png'
          fileName = `${fileName}.${extension}`
        }
        
        const file = new File([blob], fileName, {
          type: mimeType
        })
        
        const imageData = {
          id: image.id || (Date.now() + Math.random()), // ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“ID
          dbId: image.id, // ä¿å­˜æ•°æ®åº“IDç”¨äºå†å²è®°å½•
          url: image.url,
          file: file,
          name: image.originalName || image.filename
        }
        
        uploadedImages.value.push(imageData)
        uploadedFiles.value.push(file)
      } catch (error) {
        console.error('è·å–å‚è€ƒå›¾å¤±è´¥:', error)
        ElMessage.error(`è·å–å‚è€ƒå›¾ ${image.originalName || image.filename} å¤±è´¥`)
      }
    }
    
    showReferenceManager.value = false
    ElMessage.success(`å·²æ·»åŠ  ${selectedImages.length} å¼ å‚è€ƒå›¾`)
  }
}

// å–æ¶ˆå‚è€ƒå›¾é€‰æ‹©
const handleReferenceImageCancel = () => {
  showReferenceManager.value = false
}

// è®¡ç®—å±æ€§ï¼šæ˜¾ç¤ºçš„å‚è€ƒå›¾ï¼ˆæ”¯æŒåˆ†ç±»è¿‡æ»¤å’Œæœ€è¿‘ä½¿ç”¨çš„åœ¨å‰ï¼‰
const displayedReferenceImages = computed(() => {
  let filteredImages = commonReferenceImages.value
  
  // æŒ‰åˆ†ç±»è¿‡æ»¤
  if (activeReferenceCategoryId.value !== 'all') {
    filteredImages = commonReferenceImages.value.filter(img => 
      (img.categoryId || 'default') === activeReferenceCategoryId.value
    )
  }
  
  // åˆå¹¶æœ€è¿‘ä½¿ç”¨çš„å›¾ç‰‡å’Œå…¶ä»–å›¾ç‰‡ï¼Œå»é‡
  const recentIds = recentUsedImages.value.map(img => img.id)
  const otherImages = filteredImages.filter(img => !recentIds.includes(img.id))
  
  const combinedImages = [...recentUsedImages.value, ...otherImages]
  
  // æŠ˜å çŠ¶æ€ä¸‹åªæ˜¾ç¤ºå‰16å¼ 
  const maxDisplay = isReferenceIconsCollapsed.value ? 16 : combinedImages.length
  
  return combinedImages.slice(0, maxDisplay)
})

// è®¡ç®—å±æ€§ï¼šè·å–å½“å‰é€‰æ‹©çš„è§†é¢‘æ¨¡å‹
const selectedVideoModel = computed(() => {
  if (!videoSelectedModelId.value || videoModels.value.length === 0) {
    return null
  }
  return videoModels.value.find(model => model.id === videoSelectedModelId.value)
})

// è®¡ç®—å±æ€§ï¼šå½“å‰æ¨¡å‹æ˜¯å¦æ”¯æŒé¦–å¸§å›¾ç‰‡
const supportsFirstFrame = computed(() => {
  return selectedVideoModel.value?.mode === 'image-to-video'
})

// è®¡ç®—å±æ€§ï¼šé¦–å¸§å›¾ç‰‡æ˜¯å¦å¿…é¡»ï¼ˆå›¾ç”Ÿè§†é¢‘æ¨¡å¼é¦–å¸§å¿…é¡»ï¼‰
const firstFrameRequired = computed(() => {
  return selectedVideoModel.value?.mode === 'image-to-video'
})

// è®¡ç®—å±æ€§ï¼šå½“å‰æ¨¡å‹æ˜¯å¦æ”¯æŒå°¾å¸§å›¾ç‰‡
const supportsLastFrame = computed(() => {
  return selectedVideoModel.value?.features?.supportLastFrame === true
})

// æ£€æµ‹æ˜¯å¦é€‰ä¸­äº†VEO3æ¨¡å‹
const isVeoModel = computed(() => {
  if (!videoSelectedModelId.value || !videoModels.value.length) {
    return false
  }
  const selectedModel = videoModels.value.find(m => m.id === videoSelectedModelId.value)
  return selectedModel?.provider === 'google'
})

// æ£€æµ‹æ˜¯å¦é€‰ä¸­äº†è±†åŒ…æ¨¡å‹
const isDoubaoModel = computed(() => {
  if (!videoSelectedModelId.value || !videoModels.value.length) {
    return false
  }
  const selectedModel = videoModels.value.find(m => m.id === videoSelectedModelId.value)
  return selectedModel?.provider === 'doubao'
})

// æ£€æµ‹æ˜¯å¦é€‰ä¸­äº†é˜¿é‡ŒWanæ¨¡å‹
const isWanModel = computed(() => {
  if (!videoSelectedModelId.value || !videoModels.value.length) {
    return false
  }
  const selectedModel = videoModels.value.find(m => m.id === videoSelectedModelId.value)
  return selectedModel?.provider === 'ali'
})

const isSoraModel = computed(() => {
  if (!videoSelectedModelId.value || !videoModels.value.length) {
    return false
  }
  const selectedModel = videoModels.value.find(m => m.id === videoSelectedModelId.value)
  return selectedModel?.provider === 'sora'
})

const isSoraPro = computed(() => {
  if (!videoSelectedModelId.value || !videoModels.value.length) {
    return false
  }
  const selectedModel = videoModels.value.find(m => m.id === videoSelectedModelId.value)
  return selectedModel?.model_id === 'sora-2-pro'
})

// ç›‘å¬è§†é¢‘æ¨¡å‹åˆ‡æ¢ï¼Œè‡ªåŠ¨è®¾ç½® Sora2 çš„é»˜è®¤å‚æ•°
watch(videoSelectedModelId, (newModelId) => {
  if (!newModelId || !videoModels.value.length) return
  
  const selectedModel = videoModels.value.find(m => m.id === newModelId)
  if (selectedModel?.provider === 'sora') {
    console.log('[App.vue] åˆ‡æ¢åˆ° Sora2 æ¨¡å‹ï¼Œè®¾ç½®é»˜è®¤å‚æ•°')
    // Sora2 é»˜è®¤å‚æ•°
    videoDuration.value = 10 // Sora2 æœ€å°æ—¶é•¿æ˜¯ 10 ç§’
    videoAspectRatio.value = '16:9'
    videoHd.value = false
  } else {
    // å…¶ä»–æ¨¡å‹çš„é»˜è®¤å‚æ•°
    if (videoDuration.value === 10 && selectedModel?.provider !== 'sora') {
      videoDuration.value = 5 // æ¢å¤é»˜è®¤ 5 ç§’
    }
  }
})

// æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æ‰¹æ¬¡æ­£åœ¨å¤„ç†
const hasProcessingImageBatch = computed(() => {
  return generationBatches.value.some(
    batch => batch.type === 'image' && (batch.status === 'pending' || batch.status === 'processing')
  )
})

// æ£€æŸ¥æ˜¯å¦æœ‰è§†é¢‘æ‰¹æ¬¡æ­£åœ¨å¤„ç†
const hasProcessingVideoBatch = computed(() => {
  const hasProcessing = generationBatches.value.some(
    batch => batch.type === 'video' && (batch.status === 'pending' || batch.status === 'processing')
  )
  
  return hasProcessing
})

// æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å®Œæˆçš„ç»“æœï¼ˆåŒ…æ‹¬éƒ¨åˆ†å®Œæˆï¼‰
const hasAnyResults = computed(() => {
  return generationBatches.value.some(
    batch => (batch.status === 'completed' || batch.status === 'partial') && batch.results && batch.results.length > 0
  )
})

// ç›‘æ§è§†é¢‘æ‰¹æ¬¡çŠ¶æ€å˜åŒ–ï¼ˆç”¨äºè°ƒè¯•ï¼‰
watch(
  () => generationBatches.value.filter(b => b.type === 'video'),
  (newVideoBatches, oldVideoBatches) => {
    if (newVideoBatches.length > 0) {
      console.log('[æ‰¹æ¬¡ç›‘æ§] è§†é¢‘æ‰¹æ¬¡çŠ¶æ€:', newVideoBatches.map(b => ({
        id: b.id.substring(0, 20) + '...',
        status: b.status,
        tasksStatus: b.tasks.map(t => t.status),
        hasResults: b.results.length
      })))
      console.log('[æ‰¹æ¬¡ç›‘æ§] hasProcessingVideoBatch =', hasProcessingVideoBatch.value)
    }
  },
  { deep: true }
)

// Watch for model selection changes and update imageSize based on provider
watch(selectedModelId, (newModelId) => {
  if (!newModelId) return
  
  const config = currentParamConfig.value
  if (config.options.length > 0) {
    // Try to find a matching default value or use the first option
    const defaultOption = config.options.find(opt => 
      opt.value === '1:1' || opt.value === '1024x1024'
    ) || config.options[0]
    
    imageSize.value = defaultOption.value
    
    console.log('[æ¨¡å‹åˆ‡æ¢] æ›´æ–°å‚æ•°é…ç½®:', {
      provider: currentProvider.value,
      paramType: config.paramType,
      newSize: imageSize.value
    })
  }
})

// ğŸ”§ æ–°å¢ï¼šç›‘å¬ç”Ÿæˆæ¨¡å¼å˜åŒ–ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ”¯æŒçš„æ¨¡å‹
watch(generationMode, (newMode) => {
  // å¦‚æœæ˜¯è§†é¢‘æ¨¡å¼ï¼Œä¸éœ€è¦å¤„ç†å›¾åƒæ¨¡å‹
  if (newMode === 'image-to-video') {
    return
  }
  
  // æ£€æŸ¥å½“å‰é€‰ä¸­çš„æ¨¡å‹æ˜¯å¦æ”¯æŒæ–°æ¨¡å¼
  const currentModel = availableModels.value.find(m => m.id === selectedModelId.value)
  if (!currentModel) {
    return
  }
  
  const supportedModes = currentModel.supported_modes || 'both'
  const isSupported = supportedModes === 'both' || supportedModes === newMode
  
  if (!isSupported) {
    // å½“å‰æ¨¡å‹ä¸æ”¯æŒæ–°æ¨¡å¼ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæ”¯æŒçš„æ¨¡å‹
    const filteredModels = filteredAvailableModels.value
    if (filteredModels.length > 0) {
      // ä¼˜å…ˆé€‰æ‹©é»˜è®¤æ¨¡å‹
      const defaultModel = filteredModels.find(m => m.is_default)
      selectedModelId.value = defaultModel ? defaultModel.id : filteredModels[0].id
      
      console.log('[æ¨¡å¼åˆ‡æ¢] è‡ªåŠ¨åˆ‡æ¢æ¨¡å‹:', {
        mode: newMode,
        oldModel: currentModel.name,
        newModel: availableModels.value.find(m => m.id === selectedModelId.value)?.name
      })
    }
  }
})

// è§†é¢‘ç”Ÿæˆè®¡ç®—å±æ€§
const videoCanGenerate = computed(() => {
  // ç›´æ¥ä»è§†é¢‘ MultilineTagInput ç»„ä»¶è·å–æç¤ºè¯å†…å®¹
  let promptText = ''
  if (videoMultilineTagInputRef.value) {
    promptText = videoMultilineTagInputRef.value.getFullText()
  } else if (videoPromptTags.value.length > 0) {
    // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨å¤„ç†è§†é¢‘æ ‡ç­¾æ˜ å°„
    const mappedTags = videoPromptTags.value.map(tag => videoTagMapping.value[tag] || tag)
    promptText = mappedTags.join(', ')
  } else {
    promptText = prompt.value
  }
  
  const promptValid = promptText.trim()
  const modelSelected = videoSelectedModelId.value
  const hasFirstFrame = firstFrameFile.value !== null
  
  // æ£€æŸ¥åŸºæœ¬æ¡ä»¶ï¼šæœ‰æç¤ºè¯ã€é€‰æ‹©äº†æ¨¡å‹
  // å¦‚æœæ¨¡å‹å¿…é¡»è¦é¦–å¸§å›¾ç‰‡ï¼ˆä»…image-to-videoæ¨¡å¼ï¼‰ï¼Œåˆ™è¿˜è¦æ£€æŸ¥æ˜¯å¦æœ‰é¦–å¸§å›¾ç‰‡
  let canGenerate = promptValid && modelSelected
  if (firstFrameRequired.value && canGenerate) {
    canGenerate = canGenerate && hasFirstFrame
  }
  
  console.log('videoCanGenerate è¯¦ç»†çŠ¶æ€:', {
    promptText,
    promptValid,
    videoSelectedModelId: videoSelectedModelId.value,
    modelSelected,
    hasFirstFrame,
    canGenerate,
    videoModels: videoModels.value.length,
    videoModelsLoaded: videoModelsLoaded.value
  })
  
  return canGenerate
})


// åˆ‡æ¢å‚è€ƒå›¾æŠ˜å çŠ¶æ€
const toggleReferenceIconsCollapse = () => {
  isReferenceIconsCollapsed.value = !isReferenceIconsCollapsed.value
}

// è®¾ç½®æ´»åŠ¨çš„å‚è€ƒå›¾åˆ†ç±»
const setActiveReferenceCategory = (categoryId) => {
  activeReferenceCategoryId.value = categoryId
}


// è·å–å‚è€ƒå›¾åˆ†ç±»å›¾ç‰‡æ•°é‡
const getReferenceCategoryImageCount = (categoryId) => {
  if (categoryId === 'all') {
    return commonReferenceImages.value.length
  }
  return commonReferenceImages.value.filter(img => 
    (img.categoryId || 'default') === categoryId
  ).length
}

// è·å–å‚è€ƒå›¾åˆ†ç±»åˆ—è¡¨
const fetchReferenceCategories = async () => {
  try {
    const token = localStorage.getItem('token')
    if (!token) return

    const response = await fetch('/api/reference-image-categories', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    if (response.ok) {
      const data = await response.json()
      const userCats = Array.isArray(data) ? data : []
      const filteredCategories = userCats.filter(category => {
        const name = (category.name || '').trim()
        return name && !SYSTEM_REFERENCE_CATEGORY_NAMES.has(name)
      })
      referenceCategories.value = [
        { id: 'all', name: 'å…¨éƒ¨' },
        ...filteredCategories
      ]
      if (!referenceCategories.value.some(category => category.id === activeReferenceCategoryId.value)) {
        activeReferenceCategoryId.value = 'all'
      }
    }
  } catch (error) {
    console.error('è·å–å‚è€ƒå›¾åˆ†ç±»å¤±è´¥:', error)
  }
}

// è·å–å¸¸ç”¨å‚è€ƒå›¾åˆ—è¡¨
const fetchCommonReferenceImages = async () => {
  try {
    isLoadingReferenceImages.value = true // å¼€å§‹åŠ è½½
    const token = localStorage.getItem('token')
    if (!token) {
      console.log('æœªç™»å½•ï¼Œæ— æ³•è·å–å‚è€ƒå›¾')
      return
    }

    const response = await fetch('/api/reference-images', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    if (response.ok) {
      const data = await response.json()
      const images = Array.isArray(data) ? data : (data.images || [])
      
      // æŒ‰æœ€è¿‘ä½¿ç”¨æ—¶é—´æ’åº
      commonReferenceImages.value = images.sort((a, b) => {
        const aLastUsed = localStorage.getItem(`lastUsed_${a.id}`) || 0
        const bLastUsed = localStorage.getItem(`lastUsed_${b.id}`) || 0
        return bLastUsed - aLastUsed
      })
      
      // æ›´æ–°æœ€è¿‘ä½¿ç”¨çš„å›¾ç‰‡åˆ—è¡¨
      updateRecentUsedImages()
      
      // åŒæ—¶è·å–åˆ†ç±»åˆ—è¡¨
      await fetchReferenceCategories()
    }
  } catch (error) {
    console.error('è·å–å¸¸ç”¨å‚è€ƒå›¾å¤±è´¥:', error)
  } finally {
    isLoadingReferenceImages.value = false // åŠ è½½å®Œæˆ
  }
}

// æ›´æ–°æœ€è¿‘ä½¿ç”¨çš„å›¾ç‰‡åˆ—è¡¨
const updateRecentUsedImages = () => {
  const recentIds = []
  const recentImages = []
  
  // ä»localStorageè·å–æœ€è¿‘ä½¿ç”¨çš„å›¾ç‰‡ID
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i)
    if (key && key.startsWith('lastUsed_')) {
      const imageId = key.replace('lastUsed_', '')
      recentIds.push({ id: imageId, timestamp: parseInt(localStorage.getItem(key)) })
    }
  }
  
  // æŒ‰æ—¶é—´æ’åºï¼Œå–å‰8ä¸ª
  recentIds.sort((a, b) => b.timestamp - a.timestamp)
  const topRecentIds = recentIds.slice(0, 8).map(item => item.id)
  
  // ä»å¸¸ç”¨å‚è€ƒå›¾ä¸­æ‰¾åˆ°å¯¹åº”çš„å›¾ç‰‡
  topRecentIds.forEach(id => {
    const image = commonReferenceImages.value.find(img => img.id === id)
    if (image) {
      recentImages.push(image)
    }
  })
  
  recentUsedImages.value = recentImages
}

// ç‚¹å‡»å¸¸ç”¨å‚è€ƒå›¾å›¾æ ‡è‡ªåŠ¨ç½®å…¥
const insertCommonReferenceImage = async (image) => {
  try {
    // ä½¿ç”¨ä»£ç†æ¥å£è·å–å›¾ç‰‡ï¼Œé¿å…CORSé—®é¢˜
    const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(image.url)}`
    const response = await fetch(proxyUrl, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const blob = await response.blob()
    
    // ç¡®ä¿æœ‰æ­£ç¡®çš„MIMEç±»å‹å’Œæ–‡ä»¶æ‰©å±•å
    let mimeType = blob.type || 'image/png'
    let fileName = image.originalName || image.filename || 'å‚è€ƒå›¾'
    
    // å¦‚æœMIMEç±»å‹ä¸ºç©ºæˆ–æ— æ•ˆï¼Œæ ¹æ®URLæˆ–é»˜è®¤è®¾ç½®ä¸ºpng
    if (!mimeType || !mimeType.startsWith('image/')) {
      mimeType = 'image/png'
    }
    
    // ç¡®ä¿æ–‡ä»¶åæœ‰æ­£ç¡®çš„æ‰©å±•å
    if (!fileName.includes('.')) {
      const extension = mimeType.split('/')[1] || 'png'
      fileName = `${fileName}.${extension}`
    }
    
    const file = new File([blob], fileName, {
      type: mimeType
    })
    
    const imageData = {
      id: image.id || (Date.now() + Math.random()), // ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“ID
      dbId: image.id, // ä¿å­˜æ•°æ®åº“IDç”¨äºå†å²è®°å½•
      url: image.url,
      file: file,
      name: image.originalName || image.filename
    }
    
    uploadedImages.value.push(imageData)
    uploadedFiles.value.push(file)
    
    // è®°å½•ä½¿ç”¨æ—¶é—´
    localStorage.setItem(`lastUsed_${image.id}`, Date.now().toString())
    updateRecentUsedImages()
    
    ElMessage.success('å‚è€ƒå›¾å·²æ·»åŠ ')
  } catch (error) {
    console.error('æ·»åŠ å‚è€ƒå›¾å¤±è´¥:', error)
    ElMessage.error('æ·»åŠ å‚è€ƒå›¾å¤±è´¥')
  }
}

// è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
const fetchAvailableModels = async () => {
  try {
    const response = await getAvailableModels()
    if (response.success) {
      availableModels.value = response.data.models
      
      // è®¾ç½®é»˜è®¤æ¨¡å‹
      const defaultModel = availableModels.value.find(model => model.is_default)
      if (defaultModel) {
        selectedModelId.value = defaultModel.id
      } else if (availableModels.value.length > 0) {
        selectedModelId.value = availableModels.value[0].id
      }
    }
  } catch (error) {
    console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error)
    ElMessage.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥')
  }
}

// è·å–è§†é¢‘æ¨¡å‹åˆ—è¡¨
const fetchVideoModels = async () => {
  try {
    console.log('å¼€å§‹è·å–è§†é¢‘æ¨¡å‹åˆ—è¡¨...')
    console.log('å½“å‰è®¤è¯çŠ¶æ€:', {
      isLoggedIn: isLoggedIn.value,
      token: localStorage.getItem('token') ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'
    })
    
    videoModelsLoading.value = true
    const response = await getVideoModels()
    console.log('è§†é¢‘æ¨¡å‹APIå“åº”:', response)
    
    if (response.success) {
      videoModels.value = response.models
      videoModelsLoaded.value = true
      console.log('è§†é¢‘æ¨¡å‹åˆ—è¡¨:', videoModels.value)
      
      // è®¾ç½®é»˜è®¤è§†é¢‘æ¨¡å‹
      const defaultModel = videoModels.value.find(model => model.is_default)
      if (defaultModel) {
        videoSelectedModelId.value = defaultModel.id
        console.log('è®¾ç½®é»˜è®¤è§†é¢‘æ¨¡å‹:', defaultModel, 'ID:', defaultModel.id)
      } else if (videoModels.value.length > 0) {
        videoSelectedModelId.value = videoModels.value[0].id
        console.log('è®¾ç½®ç¬¬ä¸€ä¸ªè§†é¢‘æ¨¡å‹:', videoModels.value[0], 'ID:', videoModels.value[0].id)
      }
      
      console.log('æœ€ç»ˆ videoSelectedModelId:', videoSelectedModelId.value)
    } else {
      console.error('è§†é¢‘æ¨¡å‹APIè¿”å›å¤±è´¥:', response)
      ElMessage.warning('è§†é¢‘æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
    }
  } catch (error) {
    console.error('è·å–è§†é¢‘æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error)
    // ä¸å†æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“é¡µé¢åŠ è½½
    // åªæ˜¾ç¤ºè­¦å‘Šï¼Œè®©ç”¨æˆ·ç»§ç»­ä½¿ç”¨å…¶ä»–åŠŸèƒ½
    if (error.message && !error.message.includes('401')) {
      ElMessage.warning('è§†é¢‘æ¨¡å‹æš‚æ—¶æ— æ³•åŠ è½½ï¼Œå…¶ä»–åŠŸèƒ½æ­£å¸¸ä½¿ç”¨')
    }
    console.error('é”™è¯¯è¯¦æƒ…:', {
      message: error.message,
      response: error.response?.data,
      status: error.response?.status
    })
  } finally {
    videoModelsLoading.value = false
  }
}

// æ¨¡å‹é€‰æ‹©å˜åŒ–å¤„ç†
const onModelChange = (modelId) => {
  const selectedModel = availableModels.value.find(model => model.id === modelId)
  if (selectedModel) {
    ElMessage.success(`å·²é€‰æ‹©æ¨¡å‹: ${selectedModel.name}`)
  }
}

// ç”Ÿæˆå›¾ç‰‡
const generateImage = async () => {
  // æ£€æŸ¥å†·å´çŠ¶æ€
  if (imageGenerateCooldown.value) {
    ElMessage.warning('è¯·ç¨å€™å†è¯•ï¼Œé¿å…é¢‘ç¹ç‚¹å‡»')
    return
  }
  
  // è·å–å®Œæ•´çš„æç¤ºè¯å†…å®¹ï¼ˆåŒ…æ‹¬æ ‡ç­¾æ˜ å°„å’Œè¾“å…¥æ–‡æœ¬ï¼‰
  let finalPrompt = ''
  
  if (multilineTagInputRef.value) {
    // ä½¿ç”¨ç»„ä»¶çš„getFullTextæ–¹æ³•è·å–å®Œæ•´å†…å®¹
    finalPrompt = multilineTagInputRef.value.getFullText()
  } else if (promptTags.value.length > 0) {
    // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨å¤„ç†æ ‡ç­¾æ˜ å°„
    const mappedTags = promptTags.value.map(tag => tagMapping.value[tag] || tag)
    finalPrompt = mappedTags.join(', ')
  } else {
    finalPrompt = prompt.value
  }
  
  // æ£€æŸ¥æç¤ºè¯æ˜¯å¦ä¸ºç©º
  if (!finalPrompt.trim()) {
    ElMessage.warning('è¯·è¾“å…¥æç¤ºè¯')
    return
  }

  if (generationMode.value === 'image-to-image' && uploadedImages.value.length === 0) {
    ElMessage.warning('è¯·ä¸Šä¼ å‚è€ƒå›¾ç‰‡')
    return
  }

  // å¯åŠ¨å†·å´è®¡æ—¶å™¨ï¼ˆ2ç§’ï¼‰
  imageGenerateCooldown.value = true
  setTimeout(() => {
    imageGenerateCooldown.value = false
  }, 2000)

  // åˆ›å»ºæ–°æ‰¹æ¬¡
  const batchId = `batch_img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  const taskCount = generateQuantity.value
  const tasks = []
  
  // ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºå ä½ç¬¦
  for (let i = 0; i < taskCount; i++) {
    tasks.push({
      id: `task_${Date.now()}_${i}`,
      status: 'pending', // pending, processing, completed, failed
      imageUrl: '',
      index: i + 1,
      progress: 0,
      downloaded: false // åˆå§‹åŒ–ä¸‹è½½æ ‡è®°
    })
  }
  
  const newBatch = {
    id: batchId,
    type: 'image',
    timestamp: new Date(),
    status: 'pending',
    tasks: tasks,
    results: [],
    prompt: finalPrompt,
    params: {
      size: imageSize.value,
      quantity: generateQuantity.value,
      mode: generationMode.value,
      modelId: selectedModelId.value
    }
  }
  
  // å°†æ–°æ‰¹æ¬¡æ·»åŠ åˆ°æ•°ç»„å¼€å¤´ï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
  generationBatches.value.unshift(newBatch)
  
  // è®¾ç½®å…¼å®¹å˜é‡ï¼ˆç”¨äºå†å²è®°å½•ä¿å­˜ç­‰åŠŸèƒ½ï¼‰
  generatedImages.value = []
  completedTasks.value = 0
  generationTasks.value = tasks

  try {
    console.log('å‘é€ç»™AIçš„å®Œæ•´æç¤ºè¯:', finalPrompt)
    
    // è¿‡æ»¤æ‰undefinedå’Œnullå€¼
    const validFiles = uploadedFiles.value.filter(file => file !== undefined && file !== null)
    console.log('åŸå§‹uploadedFiles:', uploadedFiles.value)
    console.log('è¿‡æ»¤åçš„validFiles:', validFiles)
    
    const result = await generateImages({
      prompt: finalPrompt,
      size: imageSize.value,
      paramType: currentParamConfig.value.paramType,
      quantity: generateQuantity.value,
      mode: generationMode.value,
      modelId: selectedModelId.value,
      images: validFiles // ä¼ é€’è¿‡æ»¤åçš„å›¾ç‰‡
    })

    console.log('ç”Ÿæˆä»»åŠ¡æäº¤ç»“æœ:', result)
    
    // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€ä¸ºå¤„ç†ä¸­
    const batch = generationBatches.value.find(b => b.id === batchId)
    if (batch) {
      batch.status = 'processing'
    }
    
    if (result.taskId) {
      // è½®è¯¢æŸ¥è¯¢ç»“æœï¼Œä¼ å…¥æ‰¹æ¬¡ID
      await pollGenerationResult(result.taskId, batchId)
    } else {
      throw new Error('ä»»åŠ¡æäº¤å¤±è´¥')
    }
    
  } catch (error) {
    console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error)
    
    // æ ‡è®°æ‰€æœ‰ä»»åŠ¡ä¸ºå¤±è´¥
    generationTasks.value.forEach(task => {
      task.status = 'failed'
      task.error = error.message || 'æœªçŸ¥é”™è¯¯'
    })
    
    // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€ä¸ºå¤±è´¥
    const batch = generationBatches.value.find(b => b.id === batchId)
    if (batch) {
      batch.status = 'failed'
      batch.tasks.forEach(task => {
        task.status = 'failed'
        task.error = error.message || 'æœªçŸ¥é”™è¯¯'
      })
    }
    
    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    ElMessage.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  }
}

// è½®è¯¢æŸ¥è¯¢ç”Ÿæˆç»“æœ - ä½¿ç”¨æ¸è¿›å¼é€€é¿ç­–ç•¥ä¼˜åŒ–æ€§èƒ½
const pollGenerationResult = async (taskId, batchId = null) => {
  const maxAttempts = 120 // å‡å°‘åˆ°120æ¬¡ï¼Œæœ€å¤šçº¦9åˆ†é’Ÿ
  let lastStatus = null
  
  // æ¸è¿›å¼é€€é¿ç­–ç•¥ï¼šæ ¹æ®å°è¯•æ¬¡æ•°åŠ¨æ€è°ƒæ•´è½®è¯¢é—´éš”
  const getPollingInterval = (attemptCount) => {
    if (attemptCount <= 10) return 2000   // å‰10æ¬¡ï¼ˆå‰20ç§’ï¼‰ï¼šæ¯2ç§’æŸ¥è¯¢ï¼Œå¿«é€Ÿå“åº”
    if (attemptCount <= 30) return 3000   // 10-30æ¬¡ï¼ˆ20ç§’-1.5åˆ†é’Ÿï¼‰ï¼šæ¯3ç§’
    if (attemptCount <= 60) return 5000   // 30-60æ¬¡ï¼ˆ1.5-4åˆ†é’Ÿï¼‰ï¼šæ¯5ç§’
    return 10000                          // 60æ¬¡åï¼ˆ4åˆ†é’Ÿ+ï¼‰ï¼šæ¯10ç§’ï¼Œå‡è½»æœåŠ¡å™¨å‹åŠ›
  }
  
  // æŸ¥æ‰¾å¯¹åº”çš„æ‰¹æ¬¡
  const batch = batchId ? generationBatches.value.find(b => b.id === batchId) : null
  
  for (let i = 0; i < maxAttempts; i++) {
    try {
      const result = await getGenerationResult(taskId)
      const currentInterval = getPollingInterval(i + 1)
      console.log(`æŸ¥è¯¢ç»“æœ (${i + 1}/${maxAttempts}, é—´éš”${currentInterval/1000}ç§’):`, result)
      
      // å¦‚æœçŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œè®°å½•æ—¥å¿—
      if (result.status !== lastStatus) {
        console.log(`ä»»åŠ¡çŠ¶æ€å˜åŒ–: ${lastStatus} -> ${result.status}`)
        lastStatus = result.status
      }
      
      if (result.status === 'completed' || result.status === 'partial') {
        // ç”Ÿæˆå®Œæˆæˆ–éƒ¨åˆ†å®Œæˆï¼Œå¤„ç†ç»“æœ
        const images = result.results || []
        const processedImages = []
        const successCount = result.successCount || images.length
        const totalCount = result.totalCount || images.length
        
        console.log('ç”Ÿæˆå®Œæˆï¼Œå¤„ç†ç»“æœ:', images)
        console.log(`æˆåŠŸ: ${successCount}/${totalCount}`)
        
        // ğŸ”§ ä¿®å¤ï¼šç›´æ¥æ›´æ–°æ‰¹æ¬¡çš„ä»»åŠ¡ï¼Œé¿å…ä½¿ç”¨å…¨å±€å˜é‡å¯¼è‡´æ‰¹æ¬¡æ··æ·†
        const targetTasks = batch ? batch.tasks : generationTasks.value
        
        // æ›´æ–°ä»»åŠ¡çŠ¶æ€
        for (let j = 0; j < images.length; j++) {
          const image = images[j]
          const taskIndex = j
          
          if (taskIndex < targetTasks.length) {
            if (image.url && !image.error) {
              // æˆåŠŸçš„å›¾ç‰‡
              targetTasks[taskIndex].status = 'completed'
              targetTasks[taskIndex].imageUrl = image.url
              targetTasks[taskIndex].progress = 100
              
              // æ·»åŠ åˆ°å¤„ç†ç»“æœä¸­
              processedImages.push({
                url: image.url,
                index: image.index,
                timestamp: image.timestamp
              })
            } else {
              // å¤±è´¥çš„å›¾ç‰‡
              targetTasks[taskIndex].status = 'failed'
              targetTasks[taskIndex].error = image.error || 'ç”Ÿæˆå¤±è´¥'
            }
          }
        }
        
        // æ ‡è®°å‰©ä½™ä»»åŠ¡ä¸ºå¤±è´¥ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        for (let k = images.length; k < targetTasks.length; k++) {
          targetTasks[k].status = 'failed'
          targetTasks[k].error = 'ä»»åŠ¡æœªæ‰§è¡Œ'
        }
        
        // å¦‚æœæœ‰æ‰¹æ¬¡ï¼Œæ›´æ–°æ‰¹æ¬¡çŠ¶æ€å’Œç»“æœ
        if (batch) {
          // æ›´æ–°æ‰¹æ¬¡ç»“æœ
          batch.results = processedImages
          
          // åªæœ‰å½“è¿™æ˜¯æœ€æ–°çš„æ‰¹æ¬¡æ—¶ï¼Œæ‰åŒæ­¥åˆ°å…¨å±€å˜é‡ï¼ˆå‘åå…¼å®¹ï¼‰
          const isLatestBatch = generationBatches.value[0]?.id === batchId
          if (isLatestBatch) {
        generatedImages.value = processedImages
        completedTasks.value = processedImages.length
            generationTasks.value = targetTasks
          }
          
          // âœ… æ ¹æ®å®é™…ç»“æœè®¾ç½®æ‰¹æ¬¡çŠ¶æ€
          if (result.status === 'partial') {
            batch.status = 'partial' // éƒ¨åˆ†æˆåŠŸ
          } else if (processedImages.length === 0) {
            batch.status = 'failed' // å…¨éƒ¨å¤±è´¥
          } else {
            batch.status = 'completed' // å…¨éƒ¨æˆåŠŸ
          }
          
          console.log(`[æ‰¹æ¬¡æ›´æ–°] æ‰¹æ¬¡çŠ¶æ€: ${batch.status}, æˆåŠŸ: ${processedImages.length}/${totalCount}`)
        } else {
          // æ²¡æœ‰æ‰¹æ¬¡æ—¶ï¼ˆå‘åå…¼å®¹æ—§ä»£ç ï¼‰
          generatedImages.value = processedImages
          completedTasks.value = processedImages.length
        }
        
        // è‡ªåŠ¨ä¿å­˜åˆ°å†å²è®°å½•
        await saveToHistoryAutomatically()
        
        // æ ¹æ®ç»“æœæ˜¾ç¤ºä¸åŒçš„æ¶ˆæ¯
        if (result.status === 'completed') {
          ElMessage.success(`æˆåŠŸç”Ÿæˆ${processedImages.length}å¼ å›¾ç‰‡ï¼`)
        } else {
          ElMessage.warning(`éƒ¨åˆ†ç”Ÿæˆå®Œæˆï¼šæˆåŠŸ${processedImages.length}å¼ ï¼Œå¤±è´¥${totalCount - processedImages.length}å¼ `)
        }
        
        // âœ… å®Œæˆæ—¶çš„è‡ªåŠ¨ä¸‹è½½ï¼šåªä¸‹è½½å½“å‰æ‰¹æ¬¡ä¸­è¿˜æœªä¸‹è½½çš„å›¾ç‰‡
        // æ³¨æ„ï¼šåœ¨è½®è¯¢è¿‡ç¨‹ä¸­å·²ç»é€ä¸ªä¸‹è½½äº†å®Œæˆçš„å›¾ç‰‡ï¼Œè¿™é‡Œåªå¤„ç†é—æ¼çš„æƒ…å†µ
        if (autoDownloadEnabled.value && processedImages.length > 0 && batch) {
          setTimeout(async () => {
            let downloadCount = 0
            for (let i = 0; i < batch.tasks.length; i++) {
              const task = batch.tasks[i]
              // åªä¸‹è½½å·²å®Œæˆä½†è¿˜æœªä¸‹è½½çš„å›¾ç‰‡
              if (task.status === 'completed' && task.imageUrl && !task.downloaded) {
                task.downloaded = true // æ ‡è®°ä¸ºå·²ä¸‹è½½
                try {
                  const result = processedImages.find(img => img.index === task.index)
                  if (result && result.url) {
                    const downloadUrl = result.url
                    // æ ¹æ®URLç±»å‹é€‰æ‹©ä¸‹è½½æ–¹å¼ï¼Œé¿å…CORSé—®é¢˜
                    const response = await fetch(
                      needsProxyDownload(downloadUrl)
                        ? `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
                        : downloadUrl,
                      needsProxyDownload(downloadUrl) ? {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                      } : {}
                    )
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`)
                    
                    const blob = await response.blob()
                    if (!blob.type.startsWith('image/')) throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶')
                    
                    const blobUrl = URL.createObjectURL(blob)
                    const link = document.createElement('a')
                    link.href = blobUrl
                    link.download = `ç”Ÿæˆçš„å›¾ç‰‡_${task.index}.png`
                    link.target = '_self'
                    document.body.appendChild(link)
                    link.click()
                    document.body.removeChild(link)
                    URL.revokeObjectURL(blobUrl)
                    downloadCount++
                  }
                } catch (error) {
                  console.error(`[è‡ªåŠ¨ä¸‹è½½] ä¸‹è½½å¤±è´¥:`, error)
                }
              }
            }
            if (downloadCount > 0) {
              console.log(`[è‡ªåŠ¨ä¸‹è½½] å®Œæˆæ—¶è¡¥å……ä¸‹è½½äº† ${downloadCount} å¼ å›¾ç‰‡`)
            }
          }, 1000) // å»¶è¿Ÿ1ç§’åè‡ªåŠ¨ä¸‹è½½ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
        }
        
        return
      } else if (result.status === 'failed') {
        // æ‰€æœ‰ä»»åŠ¡å¤±è´¥
        console.error('ç”Ÿæˆå¤±è´¥:', result.error)
        
        // ğŸ”§ ä¿®å¤ï¼šç›´æ¥æ›´æ–°æ‰¹æ¬¡çš„ä»»åŠ¡ï¼Œé¿å…ä½¿ç”¨å…¨å±€å˜é‡å¯¼è‡´æ‰¹æ¬¡æ··æ·†
        const targetTasks = batch ? batch.tasks : generationTasks.value
        
        targetTasks.forEach(task => {
          task.status = 'failed'
          task.error = result.error || 'ç”Ÿæˆå¤±è´¥'
        })
        
        // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€
        if (batch) {
          batch.status = 'failed'
          
          // åªæœ‰å½“è¿™æ˜¯æœ€æ–°çš„æ‰¹æ¬¡æ—¶ï¼Œæ‰åŒæ­¥åˆ°å…¨å±€å˜é‡ï¼ˆå‘åå…¼å®¹ï¼‰
          const isLatestBatch = generationBatches.value[0]?.id === batchId
          if (isLatestBatch) {
            generationTasks.value = targetTasks
          }
        }
        
        throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥')
      } else if (result.status === 'processing') {
        // âœ… å®æ—¶æ›´æ–°å·²ç”Ÿæˆçš„å›¾ç‰‡
        const images = result.results || []
        
        console.log(`[å®æ—¶æ›´æ–°] å·²ç”Ÿæˆ ${images.length} å¼ å›¾ç‰‡`)
        
        // ğŸ”§ ä¿®å¤ï¼šç›´æ¥æ›´æ–°æ‰¹æ¬¡çš„ä»»åŠ¡ï¼Œé¿å…ä½¿ç”¨å…¨å±€å˜é‡å¯¼è‡´æ‰¹æ¬¡æ··æ·†
        const targetTasks = batch ? batch.tasks : generationTasks.value
        
        // æ›´æ–°å·²ç”Ÿæˆçš„å›¾ç‰‡åˆ°ä»»åŠ¡ä¸­
        for (let j = 0; j < images.length; j++) {
          const image = images[j]
          const taskIndex = j
          
          if (taskIndex < targetTasks.length) {
            if (image.url && !image.error) {
              // æˆåŠŸçš„å›¾ç‰‡ - ç«‹å³æ˜¾ç¤º
              targetTasks[taskIndex].status = 'completed'
              targetTasks[taskIndex].imageUrl = image.url
              targetTasks[taskIndex].progress = 100
            } else if (image.error) {
              // å¤±è´¥çš„å›¾ç‰‡
              targetTasks[taskIndex].status = 'failed'
              targetTasks[taskIndex].error = image.error || 'ç”Ÿæˆå¤±è´¥'
            }
          }
        }
        
        // æ›´æ–°æœªç”Ÿæˆçš„ä»»åŠ¡ä¸ºå¤„ç†ä¸­
        for (let j = images.length; j < targetTasks.length; j++) {
          if (targetTasks[j].status === 'pending') {
            targetTasks[j].status = 'processing'
          }
        }
        
        // æ›´æ–°æ‰¹æ¬¡çŠ¶æ€å’Œå·²ç”Ÿæˆçš„ç»“æœ
        if (batch) {
          if (batch.status === 'pending') {
            batch.status = 'processing'
          }
          
          // åªæœ‰å½“è¿™æ˜¯æœ€æ–°çš„æ‰¹æ¬¡æ—¶ï¼Œæ‰åŒæ­¥åˆ°å…¨å±€å˜é‡ï¼ˆå‘åå…¼å®¹ï¼‰
          const isLatestBatch = generationBatches.value[0]?.id === batchId
          if (isLatestBatch) {
            generationTasks.value = targetTasks
          }
          
          // æ›´æ–°æ‰¹æ¬¡çš„å®æ—¶ç»“æœ
          batch.results = images.filter(img => img.url && !img.error).map(img => ({
            url: img.url,
            originalUrl: img.originalUrl,
            ossUrl: img.ossUrl,
            index: img.index,
            timestamp: img.timestamp
          }))
          
          // âœ… æ£€æŸ¥æ˜¯å¦æœ‰æ–°è½¬å­˜åˆ°OSSçš„å›¾ç‰‡ï¼Œå¦‚æœæœ‰ä¸”å¼€å¯äº†è‡ªåŠ¨ä¸‹è½½ï¼Œåˆ™è‡ªåŠ¨ä¸‹è½½
          // åªä¸‹è½½åˆšåˆšå®Œæˆçš„å•å¼ å›¾ç‰‡ï¼ˆçŠ¶æ€ä» pending/processing å˜ä¸º completedï¼‰
          if (autoDownloadEnabled.value) {
            console.log(`[è‡ªåŠ¨ä¸‹è½½] æ£€æŸ¥ä¸­, å›¾ç‰‡æ•°é‡: ${images.length}, è‡ªåŠ¨ä¸‹è½½å¼€å…³: ${autoDownloadEnabled.value}`)
            images.forEach((img, index) => {
              console.log(`[è‡ªåŠ¨ä¸‹è½½] æ£€æŸ¥å›¾ç‰‡${index + 1}: url=${img.url}, ossUrl=${img.ossUrl}`)
              if (img.ossUrl && img.url === img.ossUrl) {
                // è¿™æ˜¯åˆšè½¬å­˜åˆ°OSSçš„å›¾ç‰‡ï¼Œæ£€æŸ¥æ˜¯å¦å·²ä¸‹è½½è¿‡
                const task = batch.tasks[index]
                console.log(`[è‡ªåŠ¨ä¸‹è½½] æ‰¾åˆ°OSSå›¾ç‰‡, task.downloaded=${task?.downloaded}, task.status=${task?.status}`)
                
                // åªä¸‹è½½åˆšåˆšå®Œæˆä¸”æœªä¸‹è½½è¿‡çš„å›¾ç‰‡
                // ç¡®ä¿ä»»åŠ¡çŠ¶æ€å·²ç»æ˜¯ completedï¼ˆåœ¨ä¸Šé¢å·²ç»æ›´æ–°è¿‡çŠ¶æ€ï¼‰
                if (task && !task.downloaded && task.status === 'completed' && task.imageUrl) {
                  console.log(`[è‡ªåŠ¨ä¸‹è½½] OSSè½¬å­˜å®Œæˆï¼Œå¼€å§‹ä¸‹è½½: ${img.ossUrl}`)
                  task.downloaded = true // ç«‹å³æ ‡è®°ä¸ºå·²ä¸‹è½½ï¼Œé¿å…é‡å¤
                  
                  // å»¶è¿Ÿ500msåä¸‹è½½ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å›¾ç‰‡
                  setTimeout(async () => {
                    try {
                      // ä½¿ç”¨ç»Ÿä¸€çš„ä¸‹è½½é€»è¾‘ï¼Œé¿å…CORSé—®é¢˜
                      const downloadUrl = img.ossUrl
                      const response = await fetch(
                        needsProxyDownload(downloadUrl)
                          ? `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
                          : downloadUrl,
                        needsProxyDownload(downloadUrl) ? {
                          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        } : {}
                      )
                      
                      if (!response.ok) throw new Error(`HTTP ${response.status}`)
                      
                      const blob = await response.blob()
                      if (!blob.type.startsWith('image/')) throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶')
                      
                      const blobUrl = URL.createObjectURL(blob)
                      const link = document.createElement('a')
                      link.href = blobUrl
                      link.download = `ç”Ÿæˆçš„å›¾ç‰‡_${img.index || index + 1}.png`
                      link.target = '_self'
                      document.body.appendChild(link)
                      link.click()
                      document.body.removeChild(link)
                      URL.revokeObjectURL(blobUrl)
                      
                      console.log(`[è‡ªåŠ¨ä¸‹è½½] å®Œæˆ: ${img.ossUrl}`)
                    } catch (error) {
                      console.error(`[è‡ªåŠ¨ä¸‹è½½] å¤±è´¥: ${error.message}`)
                    }
                  }, 500)
                }
              }
            })
          }
        }
        
        // æ›´æ–°æ—§çš„ä»»åŠ¡å…¼å®¹é€»è¾‘ï¼ˆä¿ç•™å‘åå…¼å®¹ï¼‰
        if (batch && batch.status === 'pending') {
          batch.status = 'processing'
          batch.tasks.forEach(task => {
            if (task.status === 'pending') {
              task.status = 'processing'
            }
          })
        }
      }
      
      // ç»§ç»­ç­‰å¾…ï¼ˆä½¿ç”¨æ¸è¿›å¼é—´éš”ï¼‰
      const nextInterval = getPollingInterval(i + 1)
      await new Promise(resolve => setTimeout(resolve, nextInterval))
    } catch (error) {
      console.error(`è½®è¯¢ç¬¬${i + 1}æ¬¡å¤±è´¥:`, error)
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ç”Ÿæˆå¤±è´¥çš„é”™è¯¯
      if (error.message && error.message.includes('ç”Ÿæˆå¤±è´¥')) {
        console.log('æ£€æµ‹åˆ°ç”Ÿæˆå¤±è´¥ï¼Œåœæ­¢è½®è¯¢')
        // æ ‡è®°æ‰€æœ‰ä»»åŠ¡ä¸ºå¤±è´¥
        generationTasks.value.forEach(task => {
          task.status = 'failed'
          task.error = error.message
        })
        // é‡ç½®ç”ŸæˆçŠ¶æ€
        isGenerating.value = false
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        ElMessage.error('ç”Ÿæˆå¤±è´¥: ' + error.message)
        return // ç›´æ¥è¿”å›ï¼Œä¸å†ç»§ç»­è½®è¯¢
      }
      
      // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–APIé”™è¯¯ï¼Œç»§ç»­é‡è¯•
      if (error.message.includes('ç½‘ç»œ') || error.message.includes('API') || error.message.includes('æŸ¥è¯¢')) {
        if (i === maxAttempts - 1) {
          // æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥
          generationTasks.value.forEach(task => {
            task.status = 'failed'
          })
          isGenerating.value = false
          throw new Error('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•')
        }
        // ç»§ç»­é‡è¯•ï¼ˆä½¿ç”¨æ¸è¿›å¼é—´éš”ï¼‰
        const retryInterval = getPollingInterval(i + 1)
        await new Promise(resolve => setTimeout(resolve, retryInterval))
        continue
      }
      
      // å…¶ä»–é”™è¯¯ç›´æ¥æŠ›å‡º
      if (i === maxAttempts - 1) {
        // è¶…æ—¶ï¼Œæ ‡è®°æ‰€æœ‰ä»»åŠ¡ä¸ºå¤±è´¥
        generationTasks.value.forEach(task => {
          task.status = 'failed'
        })
        isGenerating.value = false
        throw error
      }
      // ç»§ç»­é‡è¯•ï¼ˆä½¿ç”¨æ¸è¿›å¼é—´éš”ï¼‰
      const retryInterval2 = getPollingInterval(i + 1)
      await new Promise(resolve => setTimeout(resolve, retryInterval2))
    }
  }
  
  // å¦‚æœå¾ªç¯ç»“æŸè¿˜æ²¡æœ‰è¿”å›ï¼Œè¯´æ˜è¶…æ—¶
  generationTasks.value.forEach(task => {
    task.status = 'failed'
  })
  isGenerating.value = false
  throw new Error('ç”Ÿæˆè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•')
}

// æ ¹æ®æ¯”ä¾‹æ ‡ç­¾è·å–å¯¹åº”çš„CSSç±»
const getRatioClass = (label) => {
  if (label.includes('1:1')) return 'ratio-1-1'
  if (label.includes('16:9')) return 'ratio-16-9'
  if (label.includes('9:16')) return 'ratio-9-16'
  if (label.includes('4:3')) return 'ratio-4-3'
  if (label.includes('3:4')) return 'ratio-3-4'
  if (label.includes('3:2')) return 'ratio-3-2'
  if (label.includes('2:3')) return 'ratio-2-3'
  if (label.includes('21:9')) return 'ratio-21-9'
  if (label.includes('9:21')) return 'ratio-9-21'
  if (label.includes('4:5')) return 'ratio-4-5'
  if (label.includes('5:4')) return 'ratio-5-4'
  return 'ratio-1-1'
}

// é‡ç½®è¡¨å•
const resetForm = () => {
  prompt.value = ''
  promptTags.value = []
  videoPromptTags.value = [] // æ¸…ç©ºè§†é¢‘æç¤ºè¯æ ‡ç­¾
  uploadedImages.value = [] // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å˜é‡å
  generatedImages.value = []
  uploadedFiles.value = [] // æ¸…é™¤æ–‡ä»¶å¼•ç”¨
  imageSize.value = '1024x1792'
  generateQuantity.value = 1
  generationMode.value = 'text-to-image'
  uploadRef.value?.clearFiles()
  
  // æ¸…ç©ºå¤šè¡Œæ ‡ç­¾è¾“å…¥ç»„ä»¶çš„å†…å®¹
  if (multilineTagInputRef.value) {
    multilineTagInputRef.value.clearTags()
    multilineTagInputRef.value.setInputText('')
  }
  
  // æ¸…ç©ºè§†é¢‘å¤šè¡Œæ ‡ç­¾è¾“å…¥ç»„ä»¶çš„å†…å®¹
  if (videoMultilineTagInputRef.value) {
    videoMultilineTagInputRef.value.clearTags()
    videoMultilineTagInputRef.value.setInputText('')
  }
  
  // é‡ç½®ä»»åŠ¡çŠ¶æ€
  generationTasks.value = []
  completedTasks.value = 0
  // æ³¨æ„ï¼šä¸æ¸…é™¤ generationBatchesï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨æ¸…é™¤å„æ‰¹æ¬¡
}

// ==================== æ‰¹æ¬¡ç®¡ç†è¾…åŠ©å‡½æ•° ====================

// æ ¼å¼åŒ–æ—¶é—´æˆ³æ˜¾ç¤º
const formatTimestamp = (date) => {
  return new Date(date).toLocaleString('zh-CN', {
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  })
}

// è·å–æ‰¹æ¬¡çŠ¶æ€æ–‡æœ¬
// ç®€åŒ–é”™è¯¯ä¿¡æ¯ï¼Œé¿å…è¶…å‡ºå®¹å™¨
const getSimplifiedError = (error) => {
  if (!error) return 'ç”Ÿæˆå‡ºé”™æˆ–è¿è§„ï¼Œè¯·é‡è¯•'
  
  // ç»Ÿä¸€ç®€åŒ–ä¸ºç®€çŸ­æç¤º
  return 'ç”Ÿæˆå‡ºé”™æˆ–è¿è§„ï¼Œè¯·é‡è¯•'
}

const getBatchStatusText = (batch) => {
  if (!batch.tasks || batch.tasks.length === 0) {
    return 'æ— ä»»åŠ¡'
  }
  
  const completed = batch.tasks.filter(t => t.status === 'completed').length
  const failed = batch.tasks.filter(t => t.status === 'failed').length
  const total = batch.tasks.length
  
  if (batch.status === 'completed') {
    return `å·²å®Œæˆ ${completed}/${total}`
  }
  if (batch.status === 'partial') {
    // ğŸ”§ ç®€åŒ–ï¼šä¸æ˜¾ç¤ºå¤±è´¥ä¸ªæ•°
    return `å·²å®Œæˆ ${completed}/${total}`
  }
  if (batch.status === 'failed') {
    return `å¤±è´¥ ${failed}/${total}`
  }
  if (batch.status === 'processing') {
    return `è¿›è¡Œä¸­ ${completed}/${total}`
  }
  return `ç­‰å¾…ä¸­ ${completed}/${total}`
}

// è·å–æ‰¹æ¬¡çš„æ¨¡å‹åç§°
const getBatchModelName = (batch) => {
  if (!batch.params) return null
  
  // å›¾ç‰‡ç”Ÿæˆæ¨¡å¼
  if (batch.type === 'image' && batch.params.modelId) {
    const model = availableModels.value.find(m => m.id === batch.params.modelId)
    return model?.name || null
  }
  
  // è§†é¢‘ç”Ÿæˆæ¨¡å¼
  if (batch.type === 'video' && batch.params.modelDbId) {
    const model = videoModels.value.find(m => m.id === batch.params.modelDbId)
    return model?.name || null
  }
  
  return null
}

// ç§»é™¤æŒ‡å®šæ‰¹æ¬¡
const removeBatch = (batchId) => {
  const index = generationBatches.value.findIndex(b => b.id === batchId)
  if (index !== -1) {
    generationBatches.value.splice(index, 1)
    ElMessage.success('æ‰¹æ¬¡å·²ç§»é™¤')
  }
}

// æ¸…é™¤æ‰€æœ‰æ‰¹æ¬¡
const clearAllBatches = () => {
  if (generationBatches.value.length === 0) {
    ElMessage.info('æš‚æ— æ‰¹æ¬¡')
    return
  }
  generationBatches.value = []
  ElMessage.success('å·²æ¸…é™¤æ‰€æœ‰æ‰¹æ¬¡')
}

// ==================== ä¸‹è½½ç›¸å…³å‡½æ•° ====================

// è¾…åŠ©å‡½æ•°ï¼šåˆ¤æ–­URLæ˜¯å¦éœ€è¦é€šè¿‡ä»£ç†ä¸‹è½½ï¼ˆé¿å…CORSï¼‰
const needsProxyDownload = (url) => {
  return (
    url.includes('creatimage.oss-cn-beijing.aliyuncs.com') || // é˜¿é‡Œäº‘OSS
    url.includes('tos-cn-beijing.volces.com') || // å­—èŠ‚è·³åŠ¨OSS (è±†åŒ…)
    url.includes('ark-content-generation') || // å­—èŠ‚è·³åŠ¨æ–¹èˆŸ
    (url.startsWith('http') && !url.includes('localhost')) // å…¶ä»–å¤–éƒ¨URL
  )
}

// ä¸‹è½½å•å¼ å›¾ç‰‡
const downloadSingleImage = async (image, index) => {
  try {
    ElMessage.info('æ­£åœ¨å‡†å¤‡ä¸‹è½½...')
    
    const downloadUrl = image.originalUrl || image.url
    
    // æ ¹æ®URLç±»å‹é€‰æ‹©ä¸‹è½½æ–¹å¼
    let response
    if (needsProxyDownload(downloadUrl)) {
      // ä½¿ç”¨ä»£ç†APIä¸‹è½½ï¼Œé¿å…CORSé—®é¢˜
      const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
      response = await fetch(proxyUrl, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
    } else {
      // ç›´æ¥ä¸‹è½½æœ¬åœ°å›¾ç‰‡
      response = await fetch(downloadUrl)
    }
    
    if (!response.ok) {
      throw new Error('è·å–å›¾ç‰‡å¤±è´¥')
    }
    
    const blob = await response.blob()
    const blobUrl = URL.createObjectURL(blob)
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const link = document.createElement('a')
    link.href = blobUrl
    link.download = `generated-image-${index + 1}-${Date.now()}.png`
    link.target = '_self' // ç¡®ä¿åœ¨å½“å‰çª—å£ä¸‹è½½
    
    // è§¦å‘ä¸‹è½½
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    
    // æ¸…ç†blob URL
    URL.revokeObjectURL(blobUrl)
    
    ElMessage.success(`ç¬¬${index + 1}å¼ å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼`)
  } catch (error) {
    console.error('ä¸‹è½½å¤±è´¥:', error)
    ElMessage.error('ä¸‹è½½å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  }
}

// ç»Ÿä¸€ä¸‹è½½æ‰€æœ‰ç»“æœï¼ˆå›¾ç‰‡å’Œè§†é¢‘ï¼‰
const downloadAllResults = async () => {
  // æ”¶é›†æ‰€æœ‰å®Œæˆæ‰¹æ¬¡çš„ç»“æœï¼ˆåŒ…æ‹¬éƒ¨åˆ†å®Œæˆï¼‰
  const allResults = []
  generationBatches.value.forEach(batch => {
    if ((batch.status === 'completed' || batch.status === 'partial') && batch.results && batch.results.length > 0) {
      batch.results.forEach(result => {
        allResults.push({
          ...result,
          type: batch.type
        })
      })
    }
  })
  
  if (allResults.length === 0) {
    ElMessage.warning('æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹')
    return
  }
  
  try {
    ElMessage.info('æ­£åœ¨å‡†å¤‡æ‰¹é‡ä¸‹è½½...')
    let imageCount = 0
    let videoCount = 0
    let failCount = 0
    
    for (let i = 0; i < allResults.length; i++) {
      const result = allResults[i]
      
      try {
        if (result.isVideo || result.type === 'video') {
          // ä¸‹è½½è§†é¢‘
          await downloadVideo(result.url, `video-${videoCount + 1}`)
          videoCount++
        } else {
          // ä¸‹è½½å›¾ç‰‡
          const downloadUrl = result.originalUrl || result.url
          
          // æ ¹æ®URLç±»å‹é€‰æ‹©ä¸‹è½½æ–¹å¼ï¼Œé¿å…CORSé—®é¢˜
          const response = await fetch(needsProxyDownload(downloadUrl)
            ? `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
            : downloadUrl,
            needsProxyDownload(downloadUrl) ? {
              headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            } : {}
          )
          
          if (!response.ok) throw new Error(`HTTP ${response.status}`)
          
          const blob = await response.blob()
          if (!blob.type.startsWith('image/')) throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶')
          
          const blobUrl = URL.createObjectURL(blob)
          const link = document.createElement('a')
          link.href = blobUrl
          link.download = `image-${imageCount + 1}-${Date.now()}.png`
          link.target = '_self'
          document.body.appendChild(link)
          link.click()
          document.body.removeChild(link)
          URL.revokeObjectURL(blobUrl)
          imageCount++
        }
      } catch (error) {
        console.error(`ä¸‹è½½ç¬¬${i + 1}é¡¹å¤±è´¥:`, error)
        failCount++
      }
      
      // æ·»åŠ å»¶è¿Ÿé¿å…æµè§ˆå™¨é˜»æ­¢å¤šä¸ªä¸‹è½½
      if (i < allResults.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 500))
      }
    }
    
    if (imageCount > 0 || videoCount > 0) {
      let msg = 'æˆåŠŸä¸‹è½½'
      if (imageCount > 0) msg += `${imageCount}å¼ å›¾ç‰‡`
      if (videoCount > 0) msg += `${imageCount > 0 ? 'ï¼Œ' : ''}${videoCount}ä¸ªè§†é¢‘`
      if (failCount > 0) msg += `ï¼Œ${failCount}é¡¹å¤±è´¥`
      ElMessage.success(msg)
    } else {
      ElMessage.error('æ‰€æœ‰å†…å®¹ä¸‹è½½å¤±è´¥')
    }
  } catch (error) {
    console.error('æ‰¹é‡ä¸‹è½½å¤±è´¥:', error)
    ElMessage.error('æ‰¹é‡ä¸‹è½½å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  }
}

// ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ï¼ˆå‘åå…¼å®¹ï¼‰
const downloadAllImages = async () => {
  if (generatedImages.value.length === 0) {
    ElMessage.warning('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡')
    return
  }

  try {
    ElMessage.info('æ­£åœ¨å‡†å¤‡æ‰¹é‡ä¸‹è½½...')
    const results = []
    
    for (let i = 0; i < generatedImages.value.length; i++) {
      const image = generatedImages.value[i]
      
      try {
        // å§‹ç»ˆä½¿ç”¨åŸå§‹é“¾æ¥ï¼ˆFALé“¾æ¥ï¼‰ï¼Œç¡®ä¿ä¸‹è½½åŸå›¾
        const downloadUrl = image.originalUrl || image.url
        
        console.log(`ä¸‹è½½ç¬¬${i + 1}å¼ å›¾ç‰‡: ${downloadUrl}`)
        
        // æ ¹æ®URLç±»å‹é€‰æ‹©ä¸‹è½½æ–¹å¼ï¼Œé¿å…CORSé—®é¢˜
        let response
        if (needsProxyDownload(downloadUrl)) {
          // ä½¿ç”¨ä»£ç†APIä¸‹è½½ï¼Œé¿å…CORSé—®é¢˜
          const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
          console.log(`[æ‰¹é‡ä¸‹è½½] ä½¿ç”¨ä»£ç†: ${proxyUrl}`)
          response = await fetch(proxyUrl, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          })
        } else {
          // ç›´æ¥ä¸‹è½½æœ¬åœ°å›¾ç‰‡
          console.log(`[æ‰¹é‡ä¸‹è½½] ç›´æ¥ä¸‹è½½: ${downloadUrl}`)
          response = await fetch(downloadUrl)
        }
        
      if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
      }
      
      const blob = await response.blob()
        
        // éªŒè¯blobç±»å‹
        if (!blob.type.startsWith('image/')) {
          throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶')
        }
        
      const blobUrl = URL.createObjectURL(blob)
      
      // åˆ›å»ºä¸‹è½½é“¾æ¥
      const link = document.createElement('a')
      link.href = blobUrl
      link.download = `generated-image-${i + 1}-${Date.now()}.png`
        link.target = '_self'
      
      // è§¦å‘ä¸‹è½½
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      
      // æ¸…ç†blob URL
      URL.revokeObjectURL(blobUrl)
        
        results.push({ index: i + 1, success: true })
        console.log(`ç¬¬${i + 1}å¼ å›¾ç‰‡ä¸‹è½½æˆåŠŸ`)
        
      } catch (error) {
        console.error(`ä¸‹è½½ç¬¬${i + 1}å¼ å›¾ç‰‡å¤±è´¥:`, error)
        results.push({ 
          index: i + 1, 
          success: false, 
          error: error.message 
        })
      }
      
      // æ·»åŠ å»¶è¿Ÿé¿å…æµè§ˆå™¨é˜»æ­¢å¤šä¸ªä¸‹è½½
      if (i < generatedImages.value.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 500))
      }
    }
    
    const successCount = results.filter(r => r.success).length
    const failCount = results.filter(r => !r.success).length
    
    if (successCount > 0) {
      ElMessage.success(`æˆåŠŸä¸‹è½½${successCount}å¼ å›¾ç‰‡${failCount > 0 ? `ï¼Œ${failCount}å¼ å¤±è´¥` : ''}`)
    } else {
      ElMessage.error('æ‰€æœ‰å›¾ç‰‡ä¸‹è½½å¤±è´¥')
    }
    
  } catch (error) {
    console.error('æ‰¹é‡ä¸‹è½½å¤±è´¥:', error)
    ElMessage.error('æ‰¹é‡ä¸‹è½½å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  }
}

// ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°
const saveImageToLocal = async (imageUrl) => {
  try {
    // è·å–å›¾ç‰‡æ•°æ®
    const response = await fetch(imageUrl)
    if (!response.ok) {
      throw new Error('è·å–å›¾ç‰‡å¤±è´¥')
    }
    
    const blob = await response.blob()
    
    // åˆ›å»ºæœ¬åœ°blob URL
    const localUrl = URL.createObjectURL(blob)
    
    // ä¿å­˜blobåˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¯é€‰ï¼Œç”¨äºæŒä¹…åŒ–ï¼‰
    const timestamp = Date.now()
    const fileName = `generated-image-${timestamp}.png`
    
    // å°†blob URLå’Œæ–‡ä»¶åå­˜å‚¨åˆ°æœ¬åœ°ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨
    const imageData = {
      url: localUrl,
      fileName: fileName,
      blob: blob,
      timestamp: timestamp
    }
    
    // å­˜å‚¨åˆ°sessionStorageï¼ˆé¡µé¢åˆ·æ–°åå¤±æ•ˆï¼Œä½†é¿å…å†…å­˜æ³„æ¼ï¼‰
    sessionStorage.setItem(`image_${timestamp}`, JSON.stringify({
      url: localUrl,
      fileName: fileName,
      timestamp: timestamp
    }))
    
    return localUrl
  } catch (error) {
    console.error('ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å¤±è´¥:', error)
    throw new Error('ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å¤±è´¥: ' + error.message)
  }
}

// è‡ªåŠ¨ä¿å­˜åˆ°å†å²è®°å½•
const saveToHistoryAutomatically = async () => {
  // âœ… æ”¹ä¸ºæ£€æŸ¥æœ€æ–°çš„æ‰¹æ¬¡è€Œä¸æ˜¯åªæ£€æŸ¥ generatedImages
  const latestBatch = generationBatches.value.length > 0 ? generationBatches.value[0] : null
  
  if (!latestBatch || latestBatch.isHistory) {
    // æ²¡æœ‰æ‰¹æ¬¡æˆ–è€…æ˜¯å†å²è®°å½•æ‰¹æ¬¡ï¼Œä¸ä¿å­˜
    return
  }
  
    // æ£€æµ‹æ˜¯å¦æ˜¯è§†é¢‘ç”Ÿæˆ
  const isVideoGeneration = latestBatch.type === 'video'
    
    // è·å–å®Œæ•´çš„æç¤ºè¯å†…å®¹ï¼ˆæ ¹æ®ç”Ÿæˆç±»å‹ä½¿ç”¨ä¸åŒçš„æç¤ºè¯æºï¼‰
    let fullPrompt = ''
    if (isVideoGeneration) {
      // è§†é¢‘ç”Ÿæˆä½¿ç”¨videoMultilineTagInputRef
      if (videoMultilineTagInputRef.value) {
        fullPrompt = videoMultilineTagInputRef.value.getAllOriginalContent() || videoMultilineTagInputRef.value.getFullText()
      } else if (videoPromptTags.value.length > 0) {
        const mappedTags = videoPromptTags.value.map(tag => videoTagMapping.value[tag] || tag)
        fullPrompt = mappedTags.join(', ')
      }
      console.log('[å†å²è®°å½•] è§†é¢‘ç”Ÿæˆæç¤ºè¯:', fullPrompt)
    } else {
      // å›¾ç‰‡ç”Ÿæˆä½¿ç”¨multilineTagInputRef
      if (multilineTagInputRef.value) {
        fullPrompt = multilineTagInputRef.value.getAllOriginalContent()
      } else {
        fullPrompt = prompt.value
      }
    }
  
  // âœ… ä»æ‰¹æ¬¡çš„tasksæ„å»ºå®Œæ•´çš„generatedImagesæ•°ç»„ï¼ˆåŒ…æ‹¬æˆåŠŸå’Œå¤±è´¥çš„ï¼‰
  const allGeneratedImages = latestBatch.tasks.map(task => {
    if (task.status === 'completed' && task.imageUrl) {
      // æˆåŠŸçš„å›¾ç‰‡
      return {
        url: task.imageUrl,
        index: task.index,
        timestamp: Date.now()
      }
    } else if (task.status === 'failed') {
      // å¤±è´¥çš„å›¾ç‰‡ï¼Œä¿å­˜é”™è¯¯ä¿¡æ¯
      return {
        error: task.error || 'ç”Ÿæˆå¤±è´¥',
        index: task.index,
        timestamp: Date.now()
      }
    }
    return null
  }).filter(Boolean)
    
    const historyItem = {
    prompt: fullPrompt || latestBatch.prompt,
    mode: isVideoGeneration ? 'video-generation' : (latestBatch.params?.mode || generationMode.value),
    size: isVideoGeneration ? `${videoResolution.value} (${videoRatio.value})` : (latestBatch.params?.size || imageSize.value),
    quantity: isVideoGeneration ? 1 : latestBatch.tasks.length,
    generatedImages: allGeneratedImages, // âœ… åŒ…å«æˆåŠŸå’Œå¤±è´¥çš„å®Œæ•´åˆ—è¡¨
      referenceImages: uploadedImages.value
        .filter(img => img.url && !img.url.startsWith('blob:')) // è¿‡æ»¤æ‰ blob URL
        .map(img => ({
        url: img.url,
        name: img.name
      })),
    // ğŸ”§ æ–°å¢ï¼šä¿å­˜å¸¸ç”¨æç¤ºè¯é€‰æ‹©çŠ¶æ€å’Œå‚è€ƒå›¾ID
    selectedCommonPrompts: Array.from(selectedCommonPromptIds.value),
    selectedReferenceImages: uploadedImages.value
      .filter(img => img.dbId && typeof img.dbId === 'number') // åªä¿å­˜æœ‰æ•ˆçš„å‚è€ƒå›¾æ•°æ®åº“ID
      .map(img => img.dbId),
      timestamp: Date.now()
    }
    
    console.log('[å†å²è®°å½•] å‡†å¤‡ä¿å­˜:', {
      mode: historyItem.mode,
      isVideo: isVideoGeneration,
      totalResults: allGeneratedImages.length,
      successResults: allGeneratedImages.filter(img => img.url).length,
      failedResults: allGeneratedImages.filter(img => img.error).length,
      selectedCommonPrompts: historyItem.selectedCommonPrompts,
      selectedReferenceImages: historyItem.selectedReferenceImages,
      uploadedImagesDetail: uploadedImages.value.map(img => ({ 
        id: img.id, 
        dbId: img.dbId, 
        name: img.name,
        hasDbId: !!img.dbId 
      }))
    })
    
    // è°ƒç”¨å†å²è®°å½•ç»„ä»¶çš„æ·»åŠ æ–¹æ³•
    historyPanelRef.value?.addHistoryItem(historyItem)
}

// ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆä¿ç•™åŸæœ‰å‡½æ•°ï¼Œä½†ä¸å†æ‰‹åŠ¨è°ƒç”¨ï¼‰

// è¾…åŠ©å‡½æ•°ï¼šè½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
const escapeRegExp = (string) => {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
}

// ä»å†å²è®°å½•åŠ è½½
const loadFromHistory = async (historyItem) => {
  console.log('[åŠ è½½å†å²è®°å½•]', historyItem)
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯è§†é¢‘æ¨¡å¼
  if (historyItem.mode === 'video-generation') {
    console.log('[åŠ è½½è§†é¢‘å†å²] è§†é¢‘æ¨¡å¼ï¼Œå¼€å§‹åŠ è½½å‚æ•°')
    
    // åˆ‡æ¢åˆ°è§†é¢‘ç”Ÿæˆæ¨¡å¼
    generationMode.value = 'image-to-video'
    
    // æ¸…ç©ºè§†é¢‘ç›¸å…³çŠ¶æ€
    firstFrameFile.value = null
    firstFramePreview.value = ''
    lastFrameFile.value = null
    lastFramePreview.value = ''
    
    // åŠ è½½è§†é¢‘æç¤ºè¯
    console.log('[åŠ è½½è§†é¢‘å†å²] æç¤ºè¯:', historyItem.prompt)
    console.log('[åŠ è½½è§†é¢‘å†å²] videoMultilineTagInputRef:', videoMultilineTagInputRef.value)
    
    if (historyItem.prompt) {
      if (videoMultilineTagInputRef.value) {
        videoMultilineTagInputRef.value.setFullText(historyItem.prompt)
        console.log('[åŠ è½½è§†é¢‘å†å²] æç¤ºè¯å·²è®¾ç½®é€šè¿‡ref')
      } else {
        // å¤‡ç”¨ï¼šç›´æ¥è®¾ç½®åˆ°promptå˜é‡
        prompt.value = historyItem.prompt
        console.log('[åŠ è½½è§†é¢‘å†å²] æç¤ºè¯å·²è®¾ç½®åˆ°promptå˜é‡')
      }
    }
    
    // åŠ è½½è§†é¢‘æ¨¡å‹
    if (historyItem.videoData && historyItem.videoData.videoModelId) {
      videoSelectedModelId.value = historyItem.videoData.videoModelId
      console.log('[åŠ è½½è§†é¢‘å†å²] è§†é¢‘æ¨¡å‹å·²è®¾ç½®:', historyItem.videoData.videoModelId)
    }
    
    // åŠ è½½è§†é¢‘å‚æ•°
    if (historyItem.videoData) {
      if (historyItem.videoData.duration) {
        videoDuration.value = historyItem.videoData.duration
      }
      if (historyItem.videoData.resolution) {
        videoResolution.value = historyItem.videoData.resolution
      }
      if (historyItem.videoData.ratio) {
        videoRatio.value = historyItem.videoData.ratio
      }
    }
    
    // åŠ è½½å‚è€ƒå›¾ï¼ˆå¦‚æœæœ‰ï¼‰
    console.log('[åŠ è½½è§†é¢‘å†å²] æ£€æŸ¥å‚è€ƒå›¾:', {
      hasReferenceImages: !!historyItem.referenceImages,
      count: historyItem.referenceImages?.length,
      referenceImages: historyItem.referenceImages
    })
    
    if (historyItem.referenceImages && historyItem.referenceImages.length > 0) {
      console.log('[åŠ è½½è§†é¢‘å†å²] å¼€å§‹åŠ è½½å‚è€ƒå›¾:', historyItem.referenceImages)
      
      for (const refImage of historyItem.referenceImages) {
        try {
          if (!refImage || !refImage.url) {
            console.warn('[åŠ è½½è§†é¢‘å†å²] è·³è¿‡æ— æ•ˆå‚è€ƒå›¾:', refImage)
            continue
          }
          
          console.log('[åŠ è½½è§†é¢‘å†å²] åŠ è½½å‚è€ƒå›¾:', { type: refImage.type, url: refImage.url })
          
          // ä½¿ç”¨ä»£ç†æ¥å£è·å–å›¾ç‰‡
          const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(refImage.url)}`
          const response = await fetch(proxyUrl, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          })
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }
          
          const blob = await response.blob()
          const file = new File([blob], refImage.name || 'referenceImage.png', {
            type: blob.type || 'image/png'
          })
          
          console.log('[åŠ è½½è§†é¢‘å†å²] Blobè½¬æ¢æˆåŠŸ:', { size: blob.size, type: blob.type })
          
          // æ ¹æ®ç±»å‹åŠ è½½åˆ°å¯¹åº”çš„ä½ç½®
          if (refImage.type === 'first') {
            firstFrameFile.value = file
            firstFramePreview.value = URL.createObjectURL(blob)
            console.log('[åŠ è½½è§†é¢‘å†å²] é¦–å¸§å‚è€ƒå›¾å·²è®¾ç½®')
          } else if (refImage.type === 'last') {
            lastFrameFile.value = file
            lastFramePreview.value = URL.createObjectURL(blob)
            console.log('[åŠ è½½è§†é¢‘å†å²] å°¾å¸§å‚è€ƒå›¾å·²è®¾ç½®')
          }
          
          console.log('[åŠ è½½è§†é¢‘å†å²] å‚è€ƒå›¾åŠ è½½æˆåŠŸ:', refImage.type)
        } catch (error) {
          console.error('[åŠ è½½è§†é¢‘å†å²] å‚è€ƒå›¾åŠ è½½å¤±è´¥:', error)
          ElMessage.warning(`å‚è€ƒå›¾åŠ è½½å¤±è´¥: ${error.message}`)
        }
      }
    } else {
      console.log('[åŠ è½½è§†é¢‘å†å²] æ— å‚è€ƒå›¾æ•°æ®ï¼ˆæ–‡ç”Ÿè§†é¢‘æˆ–æ—§è®°å½•ï¼‰')
    }
    
    // åŠ è½½ç”Ÿæˆçš„è§†é¢‘åˆ°ç»“æœåŒº
    if (historyItem.generatedImages && historyItem.generatedImages.length > 0) {
      const videoResult = historyItem.generatedImages[0]
      
      // åˆ›å»ºè§†é¢‘æ‰¹æ¬¡
      const batchId = `batch_video_history_${Date.now()}`
      const newBatch = {
        id: batchId,
        type: 'video',
        timestamp: new Date(historyItem.createdAt),
        status: 'completed',
        tasks: [{
          id: `task_${Date.now()}`,
          status: 'completed',
          index: 1
        }],
        results: [{
          isVideo: true,
          url: videoResult.url,
          duration: videoResult.duration || historyItem.videoData?.duration || '10',
          resolution: videoResult.resolution || historyItem.videoData?.resolution || '1080p',
          ratio: videoResult.ratio || historyItem.videoData?.ratio || '16:9',
          seed: videoResult.seed || historyItem.videoData?.seed,
          timestamp: new Date(historyItem.createdAt).getTime()
        }],
        prompt: historyItem.prompt,
        params: {
          modelId: historyItem.videoData?.videoModelId,
          duration: historyItem.videoData?.duration,
          resolution: historyItem.videoData?.resolution
        }
      }
      
      generationBatches.value.unshift(newBatch)
    }
    
    // ä¸æ˜¾ç¤ºæç¤ºï¼Œç”± HistoryPanel ç»Ÿä¸€æ˜¾ç¤º
    return
  }
  
  // å›¾ç‰‡æ¨¡å¼å¤„ç†
  // é‡æ–°åŠ è½½å¸¸ç”¨æç¤ºè¯å’Œå‚è€ƒå›¾ï¼Œç¡®ä¿æ ‡ç­¾æ˜ å°„æ˜¯æœ€æ–°çš„
  await loadCommonPrompts()
  await loadUserPrompts()
  
  // æ¸…ç©ºå½“å‰çŠ¶æ€
  promptTags.value = []
  prompt.value = ''
  selectedCommonPromptIds.value.clear()
  
  // ğŸ”§ ä¼˜åŒ–ï¼šå…ˆæ¢å¤å¸¸ç”¨æç¤ºè¯é€‰æ‹©çŠ¶æ€ï¼Œå†å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„æç¤ºè¯
  if (historyItem.selectedCommonPrompts && historyItem.selectedCommonPrompts.length > 0) {
    console.log('[å†å²è®°å½•åŠ è½½] æ¢å¤å¸¸ç”¨æç¤ºè¯:', historyItem.selectedCommonPrompts)
    
    // ç¡®ä¿å¸¸ç”¨æç¤ºè¯å·²åŠ è½½
    if (commonPrompts.value.length === 0) {
      await loadCommonPrompts()
    }
    
    // æ¢å¤é€‰æ‹©çŠ¶æ€
    historyItem.selectedCommonPrompts.forEach(promptId => {
      selectedCommonPromptIds.value.add(promptId)
    })
    
    console.log('[å†å²è®°å½•åŠ è½½] å·²æ¢å¤', selectedCommonPromptIds.value.size, 'ä¸ªå¸¸ç”¨æç¤ºè¯')
    
    // ä»å®Œæ•´æç¤ºè¯ä¸­ç§»é™¤å¸¸ç”¨æç¤ºè¯çš„å†…å®¹ï¼Œåªä¿ç•™ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥çš„éƒ¨åˆ†
    let manualPrompt = historyItem.prompt || ''
    
    // è·å–æ‰€æœ‰é€‰ä¸­çš„å¸¸ç”¨æç¤ºè¯å†…å®¹
    const selectedCommonPromptTexts = historyItem.selectedCommonPrompts
      .map(id => {
        const commonPrompt = commonPrompts.value.find(cp => cp.id === id)
        return commonPrompt?.content || ''
      })
      .filter(text => text.length > 0)
    
    // ä»å®Œæ•´æç¤ºè¯ä¸­ç§»é™¤æ‰€æœ‰å¸¸ç”¨æç¤ºè¯çš„å†…å®¹
    for (const commonText of selectedCommonPromptTexts) {
      // å°è¯•ç²¾ç¡®åŒ¹é…å¹¶ç§»é™¤ï¼ˆåŒ…æ‹¬å¯èƒ½çš„é€—å·å’Œç©ºæ ¼ï¼‰
      manualPrompt = manualPrompt.replace(new RegExp(`${escapeRegExp(commonText)}\\s*,?\\s*`, 'g'), '')
      manualPrompt = manualPrompt.replace(new RegExp(`,?\\s*${escapeRegExp(commonText)}\\s*`, 'g'), '')
    }
    
    // æ¸…ç†å¤šä½™çš„é€—å·å’Œç©ºæ ¼
    manualPrompt = manualPrompt
      .replace(/,\s*,/g, ',')  // è¿ç»­çš„é€—å·
      .replace(/^\s*,\s*/, '')  // å¼€å¤´çš„é€—å·
      .replace(/,\s*$/, '')     // ç»“å°¾çš„é€—å·
      .trim()
    
    console.log('[å†å²è®°å½•åŠ è½½] åˆ†ç¦»åçš„æ‰‹åŠ¨æç¤ºè¯:', manualPrompt)
    
    // è®¾ç½®æ‰‹åŠ¨è¾“å…¥çš„æç¤ºè¯ï¼ˆä¸åŒ…å«å¸¸ç”¨æç¤ºè¯ï¼‰
    if (multilineTagInputRef.value) {
      multilineTagInputRef.value.setFullText(manualPrompt)
    } else {
      prompt.value = manualPrompt
    }
  } else {
    // æ²¡æœ‰å¸¸ç”¨æç¤ºè¯æ—¶ï¼Œç›´æ¥è®¾ç½®å®Œæ•´æç¤ºè¯
  if (historyItem.prompt) {
    if (multilineTagInputRef.value) {
      multilineTagInputRef.value.setFullText(historyItem.prompt)
    } else {
  prompt.value = historyItem.prompt
      }
    }
  }
  
  imageSize.value = historyItem.size
  generationMode.value = historyItem.mode
  generateQuantity.value = historyItem.quantity || 1
  
  // æ¸…ç©ºå½“å‰çš„ä¸Šä¼ å›¾ç‰‡
  uploadedImages.value = []
  uploadedFiles.value = []
  
  // ğŸ”§ ä¼˜å…ˆä½¿ç”¨ selectedReferenceImagesï¼ˆå‚è€ƒå›¾IDåˆ—è¡¨ï¼‰
  if (historyItem.mode === 'image-to-image') {
    // æ–¹æ¡ˆ1ï¼šå¦‚æœæœ‰å‚è€ƒå›¾IDåˆ—è¡¨ï¼Œé€šè¿‡IDåŠ è½½
    if (historyItem.selectedReferenceImages && historyItem.selectedReferenceImages.length > 0) {
      console.log('[å†å²è®°å½•åŠ è½½] é€šè¿‡IDåŠ è½½å‚è€ƒå›¾:', historyItem.selectedReferenceImages)
      
      try {
        const loadedImages = await loadReferenceImagesByIds(historyItem.selectedReferenceImages)
        console.log('[å†å²è®°å½•åŠ è½½] å‚è€ƒå›¾åŠ è½½æˆåŠŸ:', loadedImages.length, 'å¼ ')
      } catch (error) {
        console.error('[å†å²è®°å½•åŠ è½½] é€šè¿‡IDåŠ è½½å‚è€ƒå›¾å¤±è´¥:', error)
        ElMessage.warning('å‚è€ƒå›¾åŠ è½½å¤±è´¥')
      }
    }
    // æ–¹æ¡ˆ2ï¼šå…¼å®¹æ—§æ ¼å¼ï¼Œä½¿ç”¨ referenceImages URLåˆ—è¡¨
    else if (historyItem.referenceImages && historyItem.referenceImages.length > 0) {
      console.log('[å†å²è®°å½•åŠ è½½] é€šè¿‡URLåŠ è½½å‚è€ƒå›¾ï¼ˆæ—§æ ¼å¼ï¼‰')
      
    for (const refImage of historyItem.referenceImages) {
      try {
        // æ£€æŸ¥URLæ˜¯å¦æœ‰æ•ˆ
        if (!refImage || !refImage.url) {
            console.warn('[å†å²è®°å½•åŠ è½½] è·³è¿‡æ— æ•ˆçš„å‚è€ƒå›¾:', refImage)
            continue
          }
          
          // è¿‡æ»¤æ‰æ— æ•ˆçš„URL
          if (refImage.url.includes('undefined') || refImage.url.startsWith('blob:')) {
            console.warn('[å†å²è®°å½•åŠ è½½] è·³è¿‡æ— æ•ˆçš„å‚è€ƒå›¾URL:', refImage.url)
          continue
        }
        
        // ä½¿ç”¨ä»£ç†æ¥å£è·å–å›¾ç‰‡ï¼Œé¿å…CORSé—®é¢˜
        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(refImage.url)}`
        const response = await fetch(proxyUrl, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        
        const blob = await response.blob()
        
        // ç¡®ä¿æœ‰æ­£ç¡®çš„MIMEç±»å‹å’Œæ–‡ä»¶æ‰©å±•å
        let mimeType = blob.type || 'image/png'
        let fileName = refImage.name || 'å†å²å‚è€ƒå›¾'
        
        // å¦‚æœMIMEç±»å‹ä¸ºç©ºæˆ–æ— æ•ˆï¼Œæ ¹æ®URLæˆ–é»˜è®¤è®¾ç½®ä¸ºpng
        if (!mimeType || !mimeType.startsWith('image/')) {
          mimeType = 'image/png'
        }
        
        // ç¡®ä¿æ–‡ä»¶åæœ‰æ­£ç¡®çš„æ‰©å±•å
        if (!fileName.includes('.')) {
          const extension = mimeType.split('/')[1] || 'png'
          fileName = `${fileName}.${extension}`
        }
        
        const file = new File([blob], fileName, {
          type: mimeType
        })
        
      const imageData = {
        id: Date.now() + Math.random(),
        url: refImage.url,
          file: file, // ç°åœ¨æœ‰æ–‡ä»¶å¼•ç”¨ï¼Œå¯ä»¥ç”¨äºç”Ÿæˆ
        name: refImage.name || 'å†å²å‚è€ƒå›¾'
      }
        
      uploadedImages.value.push(imageData)
        uploadedFiles.value.push(file) // åŒæ—¶æ·»åŠ åˆ°uploadedFilesæ•°ç»„
      } catch (error) {
        console.error('åŠ è½½å†å²å‚è€ƒå›¾å¤±è´¥:', error)
        // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä»ç„¶æ·»åŠ åˆ°uploadedImagesç”¨äºæ˜¾ç¤ºï¼Œä½†ä¸ä¼šæœ‰æ–‡ä»¶å¼•ç”¨
        const imageData = {
          id: Date.now() + Math.random(),
          url: refImage.url,
          file: null,
          name: refImage.name || 'å†å²å‚è€ƒå›¾'
        }
        uploadedImages.value.push(imageData)
        uploadedFiles.value.push(null) // ä¿æŒæ•°ç»„åŒæ­¥
      }
    }
    }
    // æ–¹æ¡ˆ3ï¼šå…¼å®¹æ—§æ ¼å¼å•å¼ å‚è€ƒå›¾
    else if (historyItem.referenceImage) {
    try {
      // ä½¿ç”¨ä»£ç†æ¥å£è·å–å›¾ç‰‡ï¼Œé¿å…CORSé—®é¢˜
      const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(historyItem.referenceImage)}`
      const response = await fetch(proxyUrl, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
      }
      
      const blob = await response.blob()
      
      // ç¡®ä¿æœ‰æ­£ç¡®çš„MIMEç±»å‹å’Œæ–‡ä»¶æ‰©å±•å
      let mimeType = blob.type || 'image/png'
      let fileName = 'å†å²å‚è€ƒå›¾'
      
      // å¦‚æœMIMEç±»å‹ä¸ºç©ºæˆ–æ— æ•ˆï¼Œæ ¹æ®URLæˆ–é»˜è®¤è®¾ç½®ä¸ºpng
      if (!mimeType || !mimeType.startsWith('image/')) {
        mimeType = 'image/png'
      }
      
      // ç¡®ä¿æ–‡ä»¶åæœ‰æ­£ç¡®çš„æ‰©å±•å
      if (!fileName.includes('.')) {
        const extension = mimeType.split('/')[1] || 'png'
        fileName = `${fileName}.${extension}`
      }
      
      const file = new File([blob], fileName, {
        type: mimeType
      })
      
      const imageData = {
        id: Date.now() + Math.random(),
        url: historyItem.referenceImage,
        file: file, // ç°åœ¨æœ‰æ–‡ä»¶å¼•ç”¨ï¼Œå¯ä»¥ç”¨äºç”Ÿæˆ
        name: 'å†å²å‚è€ƒå›¾'
      }
      
      uploadedImages.value.push(imageData)
      uploadedFiles.value.push(file) // åŒæ—¶æ·»åŠ åˆ°uploadedFilesæ•°ç»„
    } catch (error) {
        console.error('[å†å²è®°å½•åŠ è½½] åŠ è½½å†å²å‚è€ƒå›¾å¤±è´¥:', error)
      // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä»ç„¶æ·»åŠ åˆ°uploadedImagesç”¨äºæ˜¾ç¤ºï¼Œä½†ä¸ä¼šæœ‰æ–‡ä»¶å¼•ç”¨
    const imageData = {
      id: Date.now() + Math.random(),
      url: historyItem.referenceImage,
      file: null,
      name: 'å†å²å‚è€ƒå›¾'
    }
    uploadedImages.value.push(imageData)
    uploadedFiles.value.push(null) // ä¿æŒæ•°ç»„åŒæ­¥
      }
    }
  }
  
  // åŠ è½½ç”Ÿæˆçš„ä½œå“
  let loadedImages = []
  if (historyItem.generatedImages) {
    loadedImages = historyItem.generatedImages
    // åªå°†æˆåŠŸçš„å›¾ç‰‡èµ‹å€¼ç»™ generatedImagesï¼ˆç”¨äºå…¶ä»–åŠŸèƒ½ï¼‰
    generatedImages.value = historyItem.generatedImages.filter(img => img.url && !img.error)
  } else if (historyItem.generatedImage) {
    // å…¼å®¹æ—§æ ¼å¼
    loadedImages = [{
      url: historyItem.generatedImage,
      index: 1,
      timestamp: historyItem.timestamp
    }]
    generatedImages.value = loadedImages
  }
  
  // âœ… åˆ›å»ºæ‰¹æ¬¡å¯¹è±¡ï¼Œä½¿å†å²è®°å½•èƒ½åœ¨ç”Ÿæˆç»“æœé¢æ¿æ˜¾ç¤º
  if (loadedImages.length > 0) {
    const historyBatchId = `batch_history_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    
    // âœ… æ­£ç¡®å¤„ç†æˆåŠŸå’Œå¤±è´¥çš„å›¾ç‰‡
    const tasks = loadedImages.map((img, index) => {
      // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å¤±è´¥ï¼ˆåŒ…å«errorå­—æ®µä¸”æ²¡æœ‰urlï¼‰
      const hasFailed = img.error || (!img.url && !img.isVideo)
      
      return {
        id: `task_history_${Date.now()}_${index}`,
        status: hasFailed ? 'failed' : 'completed', // âœ… æ ¹æ®æ˜¯å¦æœ‰errorè®¾ç½®çŠ¶æ€
        imageUrl: img.url || null,
        index: img.index || (index + 1),
        progress: hasFailed ? 0 : 100,
        error: img.error || null, // âœ… ä¿å­˜é”™è¯¯ä¿¡æ¯
        downloaded: false // å†å²è®°å½•ä¸ç®—å·²ä¸‹è½½
      }
    })
    
    // è®¡ç®—æˆåŠŸå’Œå¤±è´¥çš„æ•°é‡
    const successCount = tasks.filter(t => t.status === 'completed').length
    const failedCount = tasks.filter(t => t.status === 'failed').length
    
    // âœ… æ ¹æ®æˆåŠŸå¤±è´¥æƒ…å†µè®¾ç½®æ‰¹æ¬¡çŠ¶æ€
    let batchStatus = 'completed'
    if (successCount === 0) {
      batchStatus = 'failed' // å…¨éƒ¨å¤±è´¥
    } else if (failedCount > 0) {
      batchStatus = 'partial' // éƒ¨åˆ†å¤±è´¥
    }
    
    const historyBatch = {
      id: historyBatchId,
      type: 'image',
      timestamp: new Date(historyItem.timestamp || Date.now()),
      status: batchStatus, // âœ… ä½¿ç”¨è®¡ç®—å‡ºçš„çŠ¶æ€
      tasks: tasks,
      results: loadedImages.filter(img => img.url && !img.error), // åªåŒ…å«æˆåŠŸçš„ç»“æœ
      prompt: historyItem.prompt || '',
      params: {
        size: historyItem.size || imageSize.value,
        quantity: loadedImages.length,
        mode: historyItem.mode || generationMode.value,
        modelId: historyItem.modelId || selectedModelId.value
      },
      isHistory: true // æ ‡è®°ä¸ºå†å²è®°å½•æ‰¹æ¬¡
    }
    
    // å°†å†å²æ‰¹æ¬¡æ·»åŠ åˆ°æ‰¹æ¬¡åˆ—è¡¨é¡¶éƒ¨
    generationBatches.value.unshift(historyBatch)
    completedTasks.value = successCount
    
    console.log('[å†å²è®°å½•] å·²åˆ›å»ºæ‰¹æ¬¡å¯¹è±¡:', {
      batchId: historyBatch.id,
      status: batchStatus,
      success: successCount,
      failed: failedCount,
      total: loadedImages.length
    })
  }
  
  showHistory.value = false
  ElMessage.success('å†å²è®°å½•å·²åŠ è½½åˆ°ç”Ÿæˆç»“æœé¢æ¿')
}

// å¤„ç†æç¤ºè¯é€‰æ‹©
const handleSelectPrompt = async (promptData) => {
  try {
    console.log('[æç¤ºè¯åŠ è½½] å¼€å§‹åŠ è½½:', promptData)
    
    // 1. å½»åº•æ¸…ç©ºå½“å‰çŠ¶æ€
  promptTags.value = []
  prompt.value = ''
  selectedCommonPromptIds.value.clear()
  uploadedImages.value = []
  uploadedFiles.value = []
  
    // æ¸…ç©ºå¤šè¡Œè¾“å…¥ç»„ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (multilineTagInputRef.value) {
      multilineTagInputRef.value.clearTags()
      multilineTagInputRef.value.setInputText('')
    }
    
    // 2. æ¢å¤ç”Ÿæˆæ¨¡å¼å’Œå‚æ•°
  generationMode.value = promptData.generation_mode || 'text-to-image'
  imageSize.value = promptData.image_size || '1024x1792'
  generateQuantity.value = promptData.generate_quantity || 1
  
    // 3. æ¢å¤æ¨¡å‹é€‰æ‹©
    if (promptData.model_id) {
      selectedModelId.value = parseInt(promptData.model_id)
    }
    
    // 4. ç­‰å¾… DOM æ›´æ–°
    await nextTick()
    
    // 5. æ¢å¤æ ‡ç­¾
  if (promptData.tags) {
    try {
      const tags = JSON.parse(promptData.tags)
      promptTags.value = tags
        
        if (multilineTagInputRef.value) {
          tags.forEach(tag => {
            multilineTagInputRef.value.addTag(tag)
          })
        }
    } catch (error) {
      console.error('è§£ææ ‡ç­¾å¤±è´¥:', error)
      promptTags.value = []
    }
  }
  
    // 6. æ¢å¤æ‰‹åŠ¨è¾“å…¥å†…å®¹
  if (promptData.manual_input && multilineTagInputRef.value) {
    multilineTagInputRef.value.setInputText(promptData.manual_input)
  }
  
    // 7. æ¢å¤é€‰æ‹©çš„å¸¸ç”¨æç¤ºè¯
  if (promptData.selected_common_prompts) {
    try {
      const selectedIds = JSON.parse(promptData.selected_common_prompts)
      // å¦‚æœå¸¸ç”¨æç¤ºè¯æ•°æ®ä¸ºç©ºï¼Œå…ˆåŠ è½½
      if (commonPrompts.value.length === 0) {
        await loadCommonPrompts()
      }
      selectedIds.forEach(id => {
        selectedCommonPromptIds.value.add(id)
      })
    } catch (error) {
      console.error('è§£æå¸¸ç”¨æç¤ºè¯é€‰æ‹©å¤±è´¥:', error)
    }
  }
  
    // 8. æ¢å¤å‚è€ƒå›¾ï¼ˆå¼‚æ­¥åŠ è½½ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
  if (promptData.selected_reference_images) {
    try {
      const selectedImageIds = JSON.parse(promptData.selected_reference_images)
        console.log('[æç¤ºè¯åŠ è½½] éœ€è¦åŠ è½½çš„å‚è€ƒå›¾IDs:', selectedImageIds)
        
        // å¼‚æ­¥åŠ è½½å‚è€ƒå›¾ï¼Œä¸é˜»å¡ä¸»æµç¨‹
        if (selectedImageIds && selectedImageIds.length > 0) {
          loadReferenceImagesByIds(selectedImageIds).catch(err => {
            console.error('[æç¤ºè¯åŠ è½½] åŠ è½½å‚è€ƒå›¾å¤±è´¥:', err)
          })
        }
    } catch (error) {
      console.error('è§£æå‚è€ƒå›¾é€‰æ‹©å¤±è´¥:', error)
    }
  }
  
  showPromptManager.value = false
  ElMessage.success('æç¤ºè¯å·²åŠ è½½')
    console.log('[æç¤ºè¯åŠ è½½] åŠ è½½å®Œæˆ')
  } catch (error) {
    console.error('[æç¤ºè¯åŠ è½½] åŠ è½½å¤±è´¥:', error)
    ElMessage.error('åŠ è½½æç¤ºè¯å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  }
}

// æ ¹æ®IDåˆ—è¡¨åŠ è½½å‚è€ƒå›¾
const loadReferenceImagesByIds = async (imageIds) => {
  try {
    console.log('[å‚è€ƒå›¾åŠ è½½] å¼€å§‹åŠ è½½å‚è€ƒå›¾:', imageIds)
    
    // é€šè¿‡APIè·å–å‚è€ƒå›¾è¯¦æƒ…
    for (const imageId of imageIds) {
      try {
        const token = localStorage.getItem('token')
        const response = await fetch(`/api/reference-images/${imageId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        
        if (response.ok) {
          const result = await response.json()
          if (result.success && result.data) {
            const refImage = result.data
            
            // æ·»åŠ åˆ°uploadedImages
            uploadedImages.value.push({
              id: refImage.id,
              dbId: refImage.id, // ä¿å­˜æ•°æ®åº“IDç”¨äºå†å²è®°å½•
              url: refImage.oss_url || refImage.url,
              name: refImage.name || refImage.original_name || 'å‚è€ƒå›¾'
            })
            
            console.log('[å‚è€ƒå›¾åŠ è½½] åŠ è½½æˆåŠŸ:', refImage.name)
          }
        }
      } catch (err) {
        console.error(`[å‚è€ƒå›¾åŠ è½½] åŠ è½½å›¾ç‰‡ ${imageId} å¤±è´¥:`, err)
      }
    }
    
    console.log('[å‚è€ƒå›¾åŠ è½½] å®Œæˆï¼Œå·²åŠ è½½', uploadedImages.value.length, 'å¼ å‚è€ƒå›¾')
  } catch (error) {
    console.error('[å‚è€ƒå›¾åŠ è½½] åŠ è½½å¤±è´¥:', error)
  }
}

// é€‰æ‹©ç”¨æˆ·æç¤ºè¯
const selectUserPrompt = async (userPrompt) => {
  // æ¸…ç©ºå½“å‰çŠ¶æ€
  promptTags.value = []
  prompt.value = ''
  selectedCommonPromptIds.value.clear()
  uploadedImages.value = []
  uploadedFiles.value = []
  
  // æ¢å¤ç”Ÿæˆæ¨¡å¼å’Œå…¶ä»–è®¾ç½®
  generationMode.value = userPrompt.generation_mode || 'text-to-image'
  imageSize.value = userPrompt.image_size || '1024x1792'
  generateQuantity.value = userPrompt.generate_quantity || 1
  
  // æ¢å¤æ ‡ç­¾å’Œæ‰‹åŠ¨è¾“å…¥
  if (userPrompt.tags) {
    try {
      const tags = JSON.parse(userPrompt.tags)
      promptTags.value = tags
      // ç”±äºautoConvertToTagsä¸ºfalseï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®æ ‡ç­¾
      if (multilineTagInputRef.value) {
        // å…ˆæ¸…ç©ºç°æœ‰æ ‡ç­¾
        multilineTagInputRef.value.clearTags()
        // é€ä¸ªæ·»åŠ æ ‡ç­¾
        tags.forEach(tag => {
          multilineTagInputRef.value.addTag(tag)
        })
      }
    } catch (error) {
      console.error('è§£ææ ‡ç­¾å¤±è´¥:', error)
      promptTags.value = []
    }
  }
  
  // æ¢å¤æ‰‹åŠ¨è¾“å…¥å†…å®¹
  if (userPrompt.manual_input && multilineTagInputRef.value) {
    multilineTagInputRef.value.setInputText(userPrompt.manual_input)
  }
  
  // æ¢å¤æç¤ºè¯å†…å®¹ï¼ˆå¦‚æœæ²¡æœ‰æ‰‹åŠ¨è¾“å…¥ï¼Œåˆ™ä½¿ç”¨contentå­—æ®µï¼‰
  if (!userPrompt.manual_input && userPrompt.content && multilineTagInputRef.value) {
    multilineTagInputRef.value.setInputText(userPrompt.content)
  }
  
  // æ¢å¤é€‰æ‹©çš„å¸¸ç”¨æç¤ºè¯
  if (userPrompt.selected_common_prompts) {
    try {
      const selectedIds = JSON.parse(userPrompt.selected_common_prompts)
      // å¦‚æœå¸¸ç”¨æç¤ºè¯æ•°æ®ä¸ºç©ºï¼Œå…ˆåŠ è½½
      if (commonPrompts.value.length === 0) {
        await loadCommonPrompts()
      }
      selectedIds.forEach(id => {
        selectedCommonPromptIds.value.add(id)
      })
    } catch (error) {
      console.error('è§£æå¸¸ç”¨æç¤ºè¯é€‰æ‹©å¤±è´¥:', error)
    }
  }
  
  // æ¢å¤å‚è€ƒå›¾ - ä¿®å¤ï¼šä½¿ç”¨referenceImageUrlè€Œä¸æ˜¯referenceImage
  if (userPrompt.referenceImageUrl) {
    try {
      // ä½¿ç”¨ä»£ç†æ¥å£è·å–å›¾ç‰‡ï¼Œé¿å…CORSé—®é¢˜
      const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(userPrompt.referenceImageUrl)}`
      const response = await fetch(proxyUrl, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
      }
      
      const blob = await response.blob()
      
      // ç¡®ä¿æœ‰æ­£ç¡®çš„MIMEç±»å‹å’Œæ–‡ä»¶æ‰©å±•å
      let mimeType = blob.type || 'image/png'
      let fileName = 'å‚è€ƒå›¾'
      
      // å¦‚æœMIMEç±»å‹ä¸ºç©ºæˆ–æ— æ•ˆï¼Œæ ¹æ®URLæˆ–é»˜è®¤è®¾ç½®ä¸ºpng
      if (!mimeType || !mimeType.startsWith('image/')) {
        mimeType = 'image/png'
      }
      
      // ç¡®ä¿æ–‡ä»¶åæœ‰æ­£ç¡®çš„æ‰©å±•å
      if (!fileName.includes('.')) {
        const extension = mimeType.split('/')[1] || 'png'
        fileName = `${fileName}.${extension}`
      }
      
      const file = new File([blob], fileName, {
        type: mimeType
      })
      
      const imageData = {
        id: Date.now() + Math.random(),
        url: userPrompt.referenceImageUrl, // ä½¿ç”¨å‚è€ƒå›¾é“¾æ¥ï¼Œä¸æ˜¯å°é¢å›¾
        file: file, // ç°åœ¨æœ‰æ–‡ä»¶å¼•ç”¨ï¼Œå¯ä»¥ç”¨äºç”Ÿæˆ
        name: 'å‚è€ƒå›¾'
      }
      
      uploadedImages.value.push(imageData)
      uploadedFiles.value.push(file) // åŒæ—¶æ·»åŠ åˆ°uploadedFilesæ•°ç»„
    } catch (error) {
      console.error('åŠ è½½å‚è€ƒå›¾å¤±è´¥:', error)
      // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä»ç„¶æ·»åŠ åˆ°uploadedImagesç”¨äºæ˜¾ç¤ºï¼Œä½†ä¸ä¼šæœ‰æ–‡ä»¶å¼•ç”¨
      const imageData = {
        id: Date.now() + Math.random(),
        url: userPrompt.referenceImageUrl,
        file: null,
        name: 'å‚è€ƒå›¾'
      }
      uploadedImages.value.push(imageData)
      uploadedFiles.value.push(null) // ä¿æŒæ•°ç»„åŒæ­¥
      ElMessage.warning('å‚è€ƒå›¾åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ— æ³•ç”¨äºç”Ÿæˆ')
    }
  }
  
  // æ¢å¤é€‰æ‹©çš„å‚è€ƒå›¾
  if (userPrompt.selected_reference_images) {
    try {
      const selectedImageIds = JSON.parse(userPrompt.selected_reference_images)
      // è¿™é‡Œéœ€è¦æ ¹æ®IDä»å¸¸ç”¨å‚è€ƒå›¾ä¸­æ‰¾åˆ°å¯¹åº”çš„å›¾ç‰‡
      // æš‚æ—¶è·³è¿‡ï¼Œå› ä¸ºéœ€è¦é¢å¤–çš„APIè°ƒç”¨æ¥è·å–å‚è€ƒå›¾è¯¦æƒ…
    } catch (error) {
      console.error('è§£æå‚è€ƒå›¾é€‰æ‹©å¤±è´¥:', error)
    }
  }
  
  ElMessage.success('æç¤ºè¯å·²åŠ è½½')
}

// ç¼–è¾‘ç”¨æˆ·æç¤ºè¯
const editUserPrompt = (userPrompt) => {
  showPromptManager.value = true
  // å¯ä»¥ä¼ é€’ç¼–è¾‘çš„æç¤ºè¯IDç»™PromptManagerç»„ä»¶
}

// åˆ é™¤ç”¨æˆ·æç¤ºè¯
const deleteUserPrompt = async (promptId) => {
  try {
    await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºè¯å—ï¼Ÿ', 'æç¤º', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    
    // ä»localStorageä¸­åˆ é™¤
    const savedPrompts = JSON.parse(localStorage.getItem('promptManager') || '[]')
    const updatedPrompts = savedPrompts.filter(p => p.id !== promptId)
    localStorage.setItem('promptManager', JSON.stringify(updatedPrompts))
    
    // æ›´æ–°æœ¬åœ°æ•°æ®
    userPrompts.value = updatedPrompts
    
    ElMessage.success('æç¤ºè¯å·²åˆ é™¤')
  } catch (error) {
    // ç”¨æˆ·å–æ¶ˆåˆ é™¤
  }
}

// å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
const handleImageError = (event) => {
  event.target.style.display = 'none'
  event.target.nextElementSibling.style.display = 'flex'
}

// å¤„ç†ç”¨æˆ·æç¤ºè¯æ›´æ–°
const handleUserPromptsUpdated = () => {
  loadUserPrompts()
}

// å¤„ç†å¤šè¡Œæ ‡ç­¾è¾“å…¥å˜åŒ–
const handlePromptChange = (newTags) => {
  promptTags.value = newTags
  // åŒæ­¥æ›´æ–° prompt å˜é‡ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
  // ä½¿ç”¨getAllOriginalContentè·å–å®Œæ•´å†…å®¹
  if (multilineTagInputRef.value) {
    prompt.value = multilineTagInputRef.value.getAllOriginalContent()
  } else {
    prompt.value = newTags.join(', ')
  }
}

// å¤„ç†è§†é¢‘å¤šè¡Œæ ‡ç­¾è¾“å…¥å˜åŒ–
const handleVideoPromptChange = (newTags) => {
  videoPromptTags.value = newTags
  // åŒæ­¥æ›´æ–°è§†é¢‘æç¤ºè¯å˜é‡
  if (videoMultilineTagInputRef.value) {
    // è¿™é‡Œå¯ä»¥æ·»åŠ è§†é¢‘æç¤ºè¯çš„å¤„ç†é€»è¾‘
    console.log('è§†é¢‘æç¤ºè¯å˜åŒ–:', videoMultilineTagInputRef.value.getAllOriginalContent())
  }
}

// InputTag ç›¸å…³æ–¹æ³•ï¼ˆä¿ç•™ç”¨äºå‘åå…¼å®¹ï¼‰
// å¤„ç†æ ‡ç­¾å˜åŒ–
const handlePromptTagsChange = (newTags) => {
  promptTags.value = newTags
  // åŒæ­¥æ›´æ–° prompt å˜é‡ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
  prompt.value = newTags.join(', ')
}

// å¤„ç†æ·»åŠ æ ‡ç­¾
const handleAddTag = (tag) => {
  // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰é€»è¾‘
  console.log('æ·»åŠ æ ‡ç­¾:', tag)
}

// å¤„ç†ç§»é™¤æ ‡ç­¾
const handleRemoveTag = (tag) => {
  // æ£€æŸ¥æ˜¯å¦æ˜¯å¸¸ç”¨æç¤ºè¯æ ‡ç­¾ï¼Œå¦‚æœæ˜¯åˆ™æ›´æ–°é€‰ä¸­çŠ¶æ€
  const commonPrompt = commonPrompts.value.find(p => p.name === tag)
  if (commonPrompt) {
    selectedCommonPromptIds.value.delete(commonPrompt.id)
  }
  console.log('ç§»é™¤æ ‡ç­¾:', tag)
}

// æ·»åŠ å¸¸ç”¨æç¤ºè¯
const addCommonPrompt = (commonPrompt, promptId) => {
  // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
  if (selectedCommonPromptIds.value.has(promptId)) {
    // å¦‚æœå·²é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
    selectedCommonPromptIds.value.delete(promptId)
    // ä»æ ‡ç­¾æ•°ç»„ä¸­ç§»é™¤
    const commonPromptObj = commonPrompts.value.find(p => p.id === promptId)
    if (commonPromptObj) {
      const index = promptTags.value.findIndex(tag => tag === commonPromptObj.name)
      if (index > -1) {
        promptTags.value.splice(index, 1)
      }
    }
  } else {
    // å¦‚æœæœªé€‰ä¸­ï¼Œåˆ™é€‰ä¸­å¹¶æ·»åŠ åˆ°æ ‡ç­¾æ•°ç»„
    selectedCommonPromptIds.value.add(promptId)
    const commonPromptObj = commonPrompts.value.find(p => p.id === promptId)
    if (commonPromptObj && !promptTags.value.includes(commonPromptObj.name)) {
      promptTags.value.push(commonPromptObj.name)
    }
  }
}

// æ·»åŠ è§†é¢‘å¸¸ç”¨æç¤ºè¯
const addVideoCommonPrompt = (videoPrompt, promptId) => {
  // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
  if (selectedVideoPromptIds.value.has(promptId)) {
    // å¦‚æœå·²é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
    selectedVideoPromptIds.value.delete(promptId)
    // ä»æ ‡ç­¾æ•°ç»„ä¸­ç§»é™¤
    const videoPromptObj = videoCommonPrompts.value.find(p => p.id === promptId)
    if (videoPromptObj) {
      const index = videoPromptTags.value.findIndex(tag => tag === videoPromptObj.name)
      if (index > -1) {
        videoPromptTags.value.splice(index, 1)
      }
    }
  } else {
    // å¦‚æœæœªé€‰ä¸­ï¼Œåˆ™é€‰ä¸­å¹¶æ·»åŠ åˆ°æ ‡ç­¾æ•°ç»„
    selectedVideoPromptIds.value.add(promptId)
    const videoPromptObj = videoCommonPrompts.value.find(p => p.id === promptId)
    if (videoPromptObj && !videoPromptTags.value.includes(videoPromptObj.name)) {
      videoPromptTags.value.push(videoPromptObj.name)
    }
  }
}

// ä»æç¤ºè¯æ–‡æœ¬ä¸­ç§»é™¤æŒ‡å®šå†…å®¹
const removePromptFromText = (promptToRemove) => {
  if (!prompt.value.trim()) return
  
  // ç§»é™¤ç²¾ç¡®åŒ¹é…çš„å†…å®¹
  let updatedPrompt = prompt.value
    .replace(new RegExp(promptToRemove + ',\\s*', 'g'), '') // ç§»é™¤ "å†…å®¹, "
    .replace(new RegExp(',\\s*' + promptToRemove, 'g'), '') // ç§»é™¤ ", å†…å®¹"
    .replace(new RegExp('^' + promptToRemove + '$', 'g'), '') // ç§»é™¤å•ç‹¬çš„å†…å®¹
    .trim()
  
  // æ¸…ç†å¤šä½™çš„é€—å·
  updatedPrompt = updatedPrompt.replace(/,\s*,/g, ',').replace(/^,|,$/g, '')
  
  prompt.value = updatedPrompt
}

// å¤„ç†å›¾ç‰‡ç‚¹å‡»
const handleImageClick = (imageData) => {
  console.log('å›¾ç‰‡ç‚¹å‡»:', imageData)
  
  // ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„å›¾ç‰‡æ•°æ®æ‰“å¼€é¢„è§ˆ
  currentPreviewImage.value = imageData.src
  currentPreviewTitle.value = imageData.title || 'ç”Ÿæˆçš„å›¾ç‰‡'
  showImageModal.value = true
  
  // æŸ¥æ‰¾å›¾ç‰‡æ‰€å±çš„æ‰¹æ¬¡
  let foundBatch = null
  let imageIndexInBatch = -1
  
  for (const batch of generationBatches.value) {
    if (batch.results && batch.results.length > 0) {
      const index = batch.results.findIndex(img => img.url === imageData.src)
      if (index !== -1) {
        foundBatch = batch
        imageIndexInBatch = index
        break
      }
    }
  }
  
  if (foundBatch) {
    // æ‰¾åˆ°äº†æ‰€å±æ‰¹æ¬¡ï¼Œè®¾ç½®å½“å‰æ‰¹æ¬¡çš„ä¸Šä¸‹æ–‡
    currentViewingBatchId.value = foundBatch.id
    currentBatchImages.value = foundBatch.results
    currentImageIndex.value = imageIndexInBatch
    console.log('[å¤§å›¾é¢„è§ˆ] æ‰¹æ¬¡:', foundBatch.id, 'ç´¢å¼•:', imageIndexInBatch, 'æ€»æ•°:', foundBatch.results.length)
  } else {
    // æœªæ‰¾åˆ°æ‰¹æ¬¡ï¼ˆå¯èƒ½æ˜¯å†å²è®°å½•åŠ è½½çš„å›¾ç‰‡ï¼‰ï¼Œä½¿ç”¨å…¨å±€åˆ—è¡¨
    currentViewingBatchId.value = null
    currentBatchImages.value = generatedImages.value
    const imageIndex = generatedImages.value.findIndex(img => img.url === imageData.src)
    currentImageIndex.value = imageIndex !== -1 ? imageIndex : -1
    console.log('[å¤§å›¾é¢„è§ˆ] ä½¿ç”¨å…¨å±€åˆ—è¡¨ï¼Œç´¢å¼•:', currentImageIndex.value)
  }
  
  // é‡ç½®ç¼©æ”¾å’Œæ—‹è½¬
  imageScale.value = 1
  imageRotation.value = 0
  imagePosition.value = { x: 0, y: 0 }
}


// å¤„ç†å›¾ç‰‡ä¸‹è½½
const handleImageDownload = async (imageData) => {
  try {
    // æ‰¾åˆ°å¯¹åº”çš„å›¾ç‰‡æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨originalUrl
    const imageIndex = generatedImages.value.findIndex(img => img.url === imageData.src)
    const downloadUrl = imageIndex !== -1 && generatedImages.value[imageIndex].originalUrl 
      ? generatedImages.value[imageIndex].originalUrl 
      : imageData.src
    
    console.log(`ä¸‹è½½å›¾ç‰‡ï¼Œä½¿ç”¨URL: ${downloadUrl}`)
    
    // æ ¹æ®URLç±»å‹é€‰æ‹©ä¸‹è½½æ–¹å¼
    let response
    if (needsProxyDownload(downloadUrl)) {
      // ä½¿ç”¨ä»£ç†APIä¸‹è½½å›¾ç‰‡ï¼Œé¿å…CORSé—®é¢˜
      const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
      console.log(`[ä¸‹è½½] ä½¿ç”¨ä»£ç†ä¸‹è½½: ${proxyUrl}`)
      response = await fetch(proxyUrl, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
    } else {
      // ç›´æ¥ä¸‹è½½æœ¬åœ°å›¾ç‰‡
      console.log(`[ä¸‹è½½] ç›´æ¥ä¸‹è½½: ${downloadUrl}`)
      response = await fetch(downloadUrl)
    }
    
    if (!response.ok) {
      throw new Error('è·å–å›¾ç‰‡å¤±è´¥')
    }
    
    const blob = await response.blob()
    const blobUrl = URL.createObjectURL(blob)
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const link = document.createElement('a')
    link.href = blobUrl
    link.download = imageData.title || `image-${Date.now()}.png`
    link.target = '_self' // ç¡®ä¿åœ¨å½“å‰çª—å£ä¸‹è½½
    
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    
    // æ¸…ç†blob URL
    URL.revokeObjectURL(blobUrl)
    
    ElMessage.success('ä¸‹è½½æˆåŠŸ')
  } catch (error) {
    console.error('ä¸‹è½½å¤±è´¥:', error)
    ElMessage.error('ä¸‹è½½å¤±è´¥')
  }
}

// å¤„ç†å›¾ç‰‡é¢„è§ˆ
const handleImagePreview = (imageData) => {
  const previewWindow = window.open('', '_blank', 'width=800,height=600')
  previewWindow.document.write(`
    <html>
      <head>
        <title>å›¾ç‰‡é¢„è§ˆ - ${imageData.title}</title>
        <style>
          body { margin: 0; padding: 20px; background: #f5f5f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
          img { max-width: 100%; max-height: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 8px; }
        </style>
      </head>
      <body>
        <img src="${imageData.src}" alt="${imageData.title}" />
      </body>
    </html>
  `)
}

// è·å–å½“å‰ä½¿ç”¨çš„å®Œæ•´æç¤ºè¯
const getCurrentPrompt = () => {
  if (multilineTagInputRef.value) {
    // ä½¿ç”¨ç»„ä»¶çš„getAllOriginalContentæ–¹æ³•è·å–å®Œæ•´å†…å®¹ï¼ˆåŒ…æ‹¬æ ‡ç­¾æ˜ å°„å’Œæ‰‹åŠ¨è¾“å…¥ï¼‰
    return multilineTagInputRef.value.getAllOriginalContent()
  } else if (promptTags.value.length > 0) {
    // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨å¤„ç†æ ‡ç­¾æ˜ å°„
    const mappedTags = promptTags.value.map(tag => tagMapping.value[tag] || tag)
    return mappedTags.join(', ')
  } else {
    return prompt.value
  }
}

// å¤„ç†æ·»åŠ åˆ°æç¤ºè¯ç®¡ç†
const handleAddToPrompts = async (imageData) => {
  try {
    // ä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†ç»„ä»¶
    const result = await showAddPromptDialogForm(imageData)
    
    if (result) {
      const { title, content } = result
      
      if (!title || !content) {
        ElMessage.warning('è¯·è¾“å…¥å®Œæ•´çš„æ ‡é¢˜å’Œå†…å®¹')
        return
      }
      
      const token = localStorage.getItem('token')
      
      if (token) {
        // å·²ç™»å½•ï¼Œä½¿ç”¨APIä¿å­˜åˆ°æœåŠ¡å™¨
        // ä¿®å¤ï¼šä¼ é€’å‚è€ƒå›¾URLè€Œä¸æ˜¯ç”Ÿæˆç»“æœå›¾URL
        const referenceImageUrl = uploadedImages.value.length > 0 ? uploadedImages.value[0].url : null
        // ä¿®å¤ï¼šå°é¢ä½¿ç”¨ç”Ÿæˆç»“æœå›¾
        const coverImageUrl = imageData.src // ä½¿ç”¨ç”Ÿæˆç»“æœå›¾ä½œä¸ºå°é¢
        await savePromptToServerWithImage(title, content, referenceImageUrl, coverImageUrl)
      } else {
        // æœªç™»å½•ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨
        // ä¿®å¤ï¼šä¼ é€’å‚è€ƒå›¾URLè€Œä¸æ˜¯ç”Ÿæˆç»“æœå›¾URL
        const referenceImageUrl = uploadedImages.value.length > 0 ? uploadedImages.value[0].url : null
        // ä¿®å¤ï¼šå°é¢ä½¿ç”¨ç”Ÿæˆç»“æœå›¾
        const coverImageUrl = imageData.src // ä½¿ç”¨ç”Ÿæˆç»“æœå›¾ä½œä¸ºå°é¢
        await savePromptToLocalWithImage(title, content, referenceImageUrl, coverImageUrl)
      }
      
      ElMessage.success('å·²æ·»åŠ åˆ°æç¤ºè¯ç®¡ç†')
      
      // ä¿®å¤ï¼šä¿å­˜æˆåŠŸåç«‹å³åˆ·æ–°æç¤ºè¯åˆ—è¡¨
      await loadUserPrompts()
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('æ·»åŠ åˆ°æç¤ºè¯å¤±è´¥:', error)
      ElMessage.error('æ·»åŠ å¤±è´¥')
    }
  }
}

// æ˜¾ç¤ºæ·»åŠ æç¤ºè¯å¯¹è¯æ¡†
const showAddPromptDialogForm = (imageData) => {
  return new Promise((resolve, reject) => {
    // åˆ›å»ºå¯¹è¯æ¡†å®¹å™¨
    const dialogContainer = document.createElement('div')
    dialogContainer.innerHTML = `
      <div class="add-prompt-dialog-overlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      ">
        <div class="add-prompt-dialog" style="
          background: white;
          border-radius: 8px;
          padding: 24px;
          width: 500px;
          max-width: 90vw;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        ">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #303133;">æ·»åŠ åˆ°æç¤ºè¯ç®¡ç†</h3>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #606266;">æ ‡é¢˜</label>
            <input type="text" id="prompt-title" placeholder="è¯·è¾“å…¥æç¤ºè¯æ ‡é¢˜" style="
              width: 100%;
              padding: 12px;
              border: 1px solid #dcdfe6;
              border-radius: 4px;
              font-size: 14px;
              box-sizing: border-box;
            " value="${imageData.title || ''}">
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #606266;">å†…å®¹</label>
            <textarea id="prompt-content" placeholder="è¯·è¾“å…¥æç¤ºè¯å†…å®¹" style="
              width: 100%;
              padding: 12px;
              border: 1px solid #dcdfe6;
              border-radius: 4px;
              font-size: 14px;
              height: 120px;
              resize: vertical;
              box-sizing: border-box;
              font-family: inherit;
            ">${imageData.prompt || 'è¯·æè¿°è¿™å¼ å›¾ç‰‡çš„æç¤ºè¯'}</textarea>
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 12px;">
            <button id="cancel-btn" style="
              padding: 8px 16px;
              border: 1px solid #dcdfe6;
              background: white;
              color: #606266;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
            ">å–æ¶ˆ</button>
            <button id="confirm-btn" style="
              padding: 8px 16px;
              border: none;
              background: #409eff;
              color: white;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
            ">ç¡®å®š</button>
          </div>
        </div>
      </div>
    `
    
    document.body.appendChild(dialogContainer)
    
    const titleInput = dialogContainer.querySelector('#prompt-title')
    const contentInput = dialogContainer.querySelector('#prompt-content')
    const cancelBtn = dialogContainer.querySelector('#cancel-btn')
    const confirmBtn = dialogContainer.querySelector('#confirm-btn')
    
    // èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
    titleInput.focus()
    
    // å–æ¶ˆæŒ‰é’®äº‹ä»¶
    cancelBtn.onclick = () => {
      document.body.removeChild(dialogContainer)
      reject('cancel')
    }
    
    // ç¡®å®šæŒ‰é’®äº‹ä»¶
    confirmBtn.onclick = () => {
      const title = titleInput.value.trim()
      const content = contentInput.value.trim()
      
      if (!title || !content) {
        ElMessage.warning('è¯·è¾“å…¥å®Œæ•´çš„æ ‡é¢˜å’Œå†…å®¹')
        return
      }
      
      document.body.removeChild(dialogContainer)
      resolve({ title, content })
    }
    
    // å›è½¦é”®äº‹ä»¶
    const handleKeydown = (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        confirmBtn.click()
      } else if (e.key === 'Escape') {
        cancelBtn.click()
      }
    }
    
    document.addEventListener('keydown', handleKeydown)
    
    // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
    const cleanup = () => {
      document.removeEventListener('keydown', handleKeydown)
    }
    
    cancelBtn.addEventListener('click', cleanup)
    confirmBtn.addEventListener('click', cleanup)
  })
}

// ä¿å­˜æç¤ºè¯åˆ°æœåŠ¡å™¨ï¼ˆå¸¦å›¾ç‰‡ï¼‰
const savePromptToServerWithImage = async (title, content, referenceImageUrl, coverImageUrl) => {
  const token = localStorage.getItem('token')
  const formData = new FormData()
  
  formData.append('title', title)
  formData.append('content', content)
  
  // æ·»åŠ æ¨¡å‹ID
  if (selectedModelId.value) {
    formData.append('modelId', selectedModelId.value)
  }
  
  // ä¿å­˜å½“å‰çš„çŠ¶æ€ä¿¡æ¯
  const tags = promptTags.value || []
  // ä¿®å¤manualInputè·å–é€»è¾‘ï¼Œé¿å…å­˜å‚¨"undefined"å­—ç¬¦ä¸²
  let manualInput = ''
  if (multilineTagInputRef.value && multilineTagInputRef.value.inputText) {
    manualInput = multilineTagInputRef.value.inputText
    // å¦‚æœinputTextæ˜¯å­—ç¬¦ä¸²"undefined"ï¼Œåˆ™è®¾ä¸ºç©ºå­—ç¬¦ä¸²
    if (manualInput === 'undefined') {
      manualInput = ''
    }
  }
  const selectedCommonPrompts = Array.from(selectedCommonPromptIds.value)
  const selectedReferenceImages = uploadedImages.value.map(img => img.id)
  
  formData.append('tags', JSON.stringify(tags))
  formData.append('manualInput', manualInput)
  formData.append('selectedCommonPrompts', JSON.stringify(selectedCommonPrompts))
  formData.append('selectedReferenceImages', JSON.stringify(selectedReferenceImages))
  formData.append('generationMode', generationMode.value)
  formData.append('imageSize', imageSize.value)
  formData.append('generateQuantity', generateQuantity.value.toString())
  
  // å¦‚æœæœ‰å‚è€ƒå›¾URLï¼Œç›´æ¥ä¼ é€’URL
  if (referenceImageUrl) {
    formData.append('referenceImageUrl', referenceImageUrl)
  }
  
  // å¦‚æœæœ‰å°é¢å›¾URLï¼Œä¼ é€’å°é¢å›¾URL
  if (coverImageUrl) {
    formData.append('coverImageUrl', coverImageUrl)
  }
  
  const response = await fetch('/api/prompts', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  })
  
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.message || 'ä¿å­˜å¤±è´¥')
  }
}

// ä¿å­˜æç¤ºè¯åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¸¦å›¾ç‰‡ï¼‰
const savePromptToLocalWithImage = async (title, content, referenceImageUrl, coverImageUrl) => {
      // è·å–ç°æœ‰çš„æç¤ºè¯åˆ—è¡¨
      const existingPrompts = JSON.parse(localStorage.getItem('promptManager') || '[]')
      
      // åˆ›å»ºæ–°çš„æç¤ºè¯é¡¹
      const newPrompt = {
        id: Date.now().toString(),
        title: title,
        content: content,
        // ä¿®å¤ï¼šå°é¢ä½¿ç”¨ç”Ÿæˆç»“æœå›¾ï¼Œä½†ä¿å­˜å‚è€ƒå›¾é“¾æ¥
        referenceImage: coverImageUrl || referenceImageUrl, // å°é¢ä¼˜å…ˆä½¿ç”¨ç”Ÿæˆç»“æœå›¾
        referenceImageUrl: referenceImageUrl, // ä¿å­˜å‚è€ƒå›¾é“¾æ¥ç”¨äºç‚¹å‡»æ—¶åŠ è½½
        createdAt: Date.now(),
        updatedAt: Date.now()
      }
      
      // æ·»åŠ åˆ°åˆ—è¡¨
      existingPrompts.unshift(newPrompt)
      
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('promptManager', JSON.stringify(existingPrompts))
}

// æ ¼å¼åŒ–å›¾ç‰‡æ—¶é—´
const formatImageTime = (timestamp) => {
  if (!timestamp) return ''
  const date = new Date(timestamp)
  const now = new Date()
  const diff = now - date
  
  if (diff < 60000) { // 1åˆ†é’Ÿå†…
    return 'åˆšåˆš'
  } else if (diff < 3600000) { // 1å°æ—¶å†…
    return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`
  } else if (diff < 86400000) { // 1å¤©å†…
    return `${Math.floor(diff / 3600000)}å°æ—¶å‰`
  } else {
    return date.toLocaleDateString()
  }
}

// è·å–å›¾ç‰‡è§’æ ‡
const getImageBadges = (image) => {
  const badges = []
  
  if (image.index) {
    badges.push({
      text: `${image.index}å·`,
      type: 'primary'
    })
  }
  
  if (image.timestamp) {
    const now = Date.now()
    const diff = now - image.timestamp
    if (diff < 60000) { // 1åˆ†é’Ÿå†…
      badges.push({
        text: 'æ–°',
        type: 'success'
      })
    }
  }
  
  return badges
}

// ä»å¸¸ç”¨æç¤ºè¯æ›´æ–°æ ‡ç­¾æ˜ å°„
const updateTagMappingFromCommonPrompts = (commonPromptsData) => {
  // åˆ›å»ºæ–°çš„æ˜ å°„å¯¹è±¡ï¼Œå®Œå…¨æ¸…ç©ºä¹‹å‰çš„æ˜ å°„
  const newTagMapping = {}
  
  // å°†æ•°æ®åº“ä¸­çš„å¸¸ç”¨æç¤ºè¯æ·»åŠ åˆ°æ˜ å°„ä¸­
  commonPromptsData.forEach(prompt => {
    if (prompt.title && prompt.content) {
      newTagMapping[prompt.title] = prompt.content
    }
  })

  // æ›´æ–°æ ‡ç­¾æ˜ å°„
  tagMapping.value = newTagMapping
  
  console.log('æ ‡ç­¾æ˜ å°„å·²æ›´æ–°:', newTagMapping)
}

// ä»è§†é¢‘å¸¸ç”¨æç¤ºè¯æ›´æ–°æ ‡ç­¾æ˜ å°„
const updateVideoTagMappingFromCommonPrompts = (videoPromptsData) => {
  // åˆ›å»ºæ–°çš„æ˜ å°„å¯¹è±¡ï¼Œå®Œå…¨æ¸…ç©ºä¹‹å‰çš„æ˜ å°„
  const newVideoTagMapping = {}
  
  // å°†æ•°æ®åº“ä¸­çš„è§†é¢‘å¸¸ç”¨æç¤ºè¯æ·»åŠ åˆ°æ˜ å°„ä¸­
  videoPromptsData.forEach(prompt => {
    if (prompt.title && prompt.content) {
      newVideoTagMapping[prompt.title] = prompt.content
    }
  })

  // æ›´æ–°è§†é¢‘æ ‡ç­¾æ˜ å°„
  videoTagMapping.value = newVideoTagMapping
  
  console.log('è§†é¢‘æ ‡ç­¾æ˜ å°„å·²æ›´æ–°:', newVideoTagMapping)
}

// åŠ è½½å¸¸ç”¨æç¤ºè¯
const loadCommonPrompts = async () => {
  try {
    const token = localStorage.getItem('token')
    if (!token) {
      // å¦‚æœæ²¡æœ‰tokenï¼Œä½¿ç”¨é»˜è®¤æç¤ºè¯
      commonPrompts.value = [
        {
          id: '1',
          name: 'é‡‘å±æ¡†çœ¼é•œ',
          content: 'Her thin-framed glasses add a touch of sophistication.',
          createdAt: Date.now() - 86400000
        },
        {
          id: '2',
          name: 'äººç‰©è¿˜åŸ',
          content: 'Please fully restore the facial features and hairstyles of the individuals in the uploaded images.',
          createdAt: Date.now() - 172800000
        },
        {
          id: '3',
          name: 'é©¬å°¾è¾«ç»¿è‰²ä¸å¸¦',
          content: 'Her dark hair is pulled back in a low ponytail and tied with a silky dark green scarf with a subtle floral or leaf pattern, tied in a soft bow.',
          createdAt: Date.now() - 259200000
        }
      ]
      // ä»é»˜è®¤æç¤ºè¯æ›´æ–°æ ‡ç­¾æ˜ å°„
      updateTagMappingFromCommonPrompts(commonPrompts.value.map(prompt => ({
        title: prompt.name,
        content: prompt.content
      })))
      return
    }
    
    // ä»æœåŠ¡å™¨APIåŠ è½½å¸¸ç”¨æç¤ºè¯
    const response = await fetch('/api/prompts/common', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    
    if (response.ok) {
      const result = await response.json()
      if (result.success) {
        // è½¬æ¢æœåŠ¡å™¨æ•°æ®æ ¼å¼ä¸ºå‰ç«¯æ ¼å¼
        commonPrompts.value = result.data.map(prompt => ({
          id: prompt.id.toString(),
          name: prompt.title,
          content: prompt.content,
          createdAt: new Date(prompt.created_at).getTime(),
          updatedAt: new Date(prompt.updated_at).getTime()
        }))
        
        // æ›´æ–°æ ‡ç­¾æ˜ å°„ï¼šå°†æ•°æ®åº“ä¸­çš„å¸¸ç”¨æç¤ºè¯å†…å®¹æ˜ å°„åˆ°æ ‡ç­¾æ˜¾ç¤ºæ–‡æœ¬
        updateTagMappingFromCommonPrompts(result.data)
        
        // åŒæ—¶æ›´æ–°localStorageä½œä¸ºç¼“å­˜
      localStorage.setItem('commonPrompts', JSON.stringify(commonPrompts.value))
      } else {
        throw new Error(result.message || 'åŠ è½½å¸¸ç”¨æç¤ºè¯å¤±è´¥')
      }
    } else if (response.status === 401) {
      // è®¤è¯å¤±è´¥ï¼Œæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•
      clearAllUserCache()
      isLoggedIn.value = false
      currentUser.value = null
      ElMessage.error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
    } else {
      throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥')
    }
  } catch (error) {
    console.error('åŠ è½½å¸¸ç”¨æç¤ºè¯å¤±è´¥:', error)
    
    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½ä½œä¸ºå¤‡ç”¨
    try {
      const savedPrompts = localStorage.getItem('commonPrompts')
      if (savedPrompts) {
        commonPrompts.value = JSON.parse(savedPrompts)
        // ä»ç¼“å­˜çš„å¸¸ç”¨æç¤ºè¯æ›´æ–°æ ‡ç­¾æ˜ å°„
        updateTagMappingFromCommonPrompts(commonPrompts.value.map(prompt => ({
          title: prompt.name,
          content: prompt.content
        })))
        ElMessage.warning('å·²ä»æœ¬åœ°ç¼“å­˜åŠ è½½å¸¸ç”¨æç¤ºè¯')
      } else {
        // ä½¿ç”¨é»˜è®¤æç¤ºè¯
        commonPrompts.value = [
          {
            id: '1',
            name: 'é‡‘å±æ¡†çœ¼é•œ',
            content: 'Her thin-framed glasses add a touch of sophistication.',
            createdAt: Date.now() - 86400000
          },
          {
            id: '2',
            name: 'äººç‰©è¿˜åŸ',
            content: 'Please fully restore the facial features and hairstyles of the individuals in the uploaded images.',
            createdAt: Date.now() - 172800000
          },
          {
            id: '3',
            name: 'é©¬å°¾è¾«ç»¿è‰²ä¸å¸¦',
            content: 'Her dark hair is pulled back in a low ponytail and tied with a silky dark green scarf with a subtle floral or leaf pattern, tied in a soft bow.',
            createdAt: Date.now() - 259200000
          }
        ]
        // ä»é»˜è®¤æç¤ºè¯æ›´æ–°æ ‡ç­¾æ˜ å°„
        updateTagMappingFromCommonPrompts(commonPrompts.value.map(prompt => ({
          title: prompt.name,
          content: prompt.content
        })))
      }
    } catch (localError) {
      console.error('ä»æœ¬åœ°ç¼“å­˜åŠ è½½å¤±è´¥:', localError)
    commonPrompts.value = []
    }
  }
}

// åŠ è½½è§†é¢‘å¸¸ç”¨æç¤ºè¯
const loadVideoCommonPrompts = async () => {
  try {
    const token = localStorage.getItem('token')
    if (!token) {
      // å¦‚æœæ²¡æœ‰tokenï¼Œä½¿ç”¨é»˜è®¤è§†é¢‘æç¤ºè¯
      videoCommonPrompts.value = [
        {
          id: 'v1',
          name: 'å¥”è·‘',
          content: 'running, dynamic movement, motion blur, energetic',
          createdAt: Date.now() - 86400000
        },
        {
          id: 'v2',
          name: 'å¾®ç¬‘',
          content: 'smiling, happy expression, cheerful, joyful',
          createdAt: Date.now() - 172800000
        },
        {
          id: 'v3',
          name: 'å¾®é£',
          content: 'gentle breeze, wind effect, flowing movement, natural',
          createdAt: Date.now() - 259200000
        },
        {
          id: 'v4',
          name: 'é˜³å…‰',
          content: 'sunlight, bright lighting, warm atmosphere, golden hour',
          createdAt: Date.now() - 345600000
        },
        {
          id: 'v5',
          name: 'è‰åœ°',
          content: 'grass field, green landscape, natural environment, outdoor',
          createdAt: Date.now() - 432000000
        },
        {
          id: 'v6',
          name: 'æ…¢åŠ¨ä½œ',
          content: 'slow motion, cinematic effect, dramatic timing, smooth',
          createdAt: Date.now() - 518400000
        }
      ]
      // ä»é»˜è®¤è§†é¢‘æç¤ºè¯æ›´æ–°æ ‡ç­¾æ˜ å°„
      updateVideoTagMappingFromCommonPrompts(videoCommonPrompts.value.map(prompt => ({
        title: prompt.name,
        content: prompt.content
      })))
      return
    }
    
    // ä»æœåŠ¡å™¨APIåŠ è½½è§†é¢‘å¸¸ç”¨æç¤ºè¯
    const response = await fetch('/api/prompts/video-common', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    
    if (response.ok) {
      const result = await response.json()
      if (result.success) {
        // è½¬æ¢æœåŠ¡å™¨æ•°æ®æ ¼å¼ä¸ºå‰ç«¯æ ¼å¼
        videoCommonPrompts.value = result.data.map(prompt => ({
          id: prompt.id.toString(),
          name: prompt.title,
          content: prompt.content,
          createdAt: new Date(prompt.created_at).getTime(),
          updatedAt: new Date(prompt.updated_at).getTime()
        }))
        
        // æ›´æ–°æ ‡ç­¾æ˜ å°„ï¼šå°†æ•°æ®åº“ä¸­çš„è§†é¢‘å¸¸ç”¨æç¤ºè¯å†…å®¹æ˜ å°„åˆ°æ ‡ç­¾æ˜¾ç¤ºæ–‡æœ¬
        updateVideoTagMappingFromCommonPrompts(result.data)
        
        // åŒæ—¶æ›´æ–°localStorageä½œä¸ºç¼“å­˜
        localStorage.setItem('videoCommonPrompts', JSON.stringify(videoCommonPrompts.value))
      } else {
        throw new Error(result.message || 'åŠ è½½è§†é¢‘å¸¸ç”¨æç¤ºè¯å¤±è´¥')
      }
    } else if (response.status === 401) {
      // è®¤è¯å¤±è´¥ï¼Œæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•
      clearAllUserCache()
      isLoggedIn.value = false
      currentUser.value = null
      ElMessage.error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
    } else {
      throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥')
    }
  } catch (error) {
    console.error('åŠ è½½è§†é¢‘å¸¸ç”¨æç¤ºè¯å¤±è´¥:', error)
    
    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½ä½œä¸ºå¤‡ç”¨
    try {
      const savedPrompts = localStorage.getItem('videoCommonPrompts')
      if (savedPrompts) {
        videoCommonPrompts.value = JSON.parse(savedPrompts)
        // ä»ç¼“å­˜çš„è§†é¢‘å¸¸ç”¨æç¤ºè¯æ›´æ–°æ ‡ç­¾æ˜ å°„
        updateVideoTagMappingFromCommonPrompts(videoCommonPrompts.value.map(prompt => ({
          title: prompt.name,
          content: prompt.content
        })))
        ElMessage.warning('å·²ä»æœ¬åœ°ç¼“å­˜åŠ è½½è§†é¢‘å¸¸ç”¨æç¤ºè¯')
      } else {
        // ä½¿ç”¨é»˜è®¤è§†é¢‘æç¤ºè¯
        videoCommonPrompts.value = [
          {
            id: 'v1',
            name: 'å¥”è·‘',
            content: 'running, dynamic movement, motion blur, energetic',
            createdAt: Date.now() - 86400000
          },
          {
            id: 'v2',
            name: 'å¾®ç¬‘',
            content: 'smiling, happy expression, cheerful, joyful',
            createdAt: Date.now() - 172800000
          },
          {
            id: 'v3',
            name: 'å¾®é£',
            content: 'gentle breeze, wind effect, flowing movement, natural',
            createdAt: Date.now() - 259200000
          },
          {
            id: 'v4',
            name: 'é˜³å…‰',
            content: 'sunlight, bright lighting, warm atmosphere, golden hour',
            createdAt: Date.now() - 345600000
          },
          {
            id: 'v5',
            name: 'è‰åœ°',
            content: 'grass field, green landscape, natural environment, outdoor',
            createdAt: Date.now() - 432000000
          },
          {
            id: 'v6',
            name: 'æ…¢åŠ¨ä½œ',
            content: 'slow motion, cinematic effect, dramatic timing, smooth',
            createdAt: Date.now() - 518400000
          }
        ]
        // ä»é»˜è®¤è§†é¢‘æç¤ºè¯æ›´æ–°æ ‡ç­¾æ˜ å°„
        updateVideoTagMappingFromCommonPrompts(videoCommonPrompts.value.map(prompt => ({
          title: prompt.name,
          content: prompt.content
        })))
      }
    } catch (localError) {
      console.error('ä»æœ¬åœ°ç¼“å­˜åŠ è½½å¤±è´¥:', localError)
      videoCommonPrompts.value = []
    }
  }
}

// å¤„ç†å¸¸ç”¨æç¤ºè¯æ›´æ–°
const handleCommonPromptsUpdated = (updatedPrompts) => {
  // è®¾ç½®åˆ é™¤æ›´æ–°æ ‡å¿—
  isUpdatingFromDelete.value = true
  
  // æ›´æ–°å¸¸ç”¨æç¤ºè¯åˆ—è¡¨
  commonPrompts.value = updatedPrompts
  
  // æ¸…ç†å·²åˆ é™¤æç¤ºè¯çš„é€‰ä¸­çŠ¶æ€
  const currentPromptIds = new Set(updatedPrompts.map(p => p.id))
  const selectedIdsToRemove = []
  
  selectedCommonPromptIds.value.forEach(id => {
    if (!currentPromptIds.has(id)) {
      selectedIdsToRemove.push(id)
    }
  })
  
  // ç§»é™¤å·²åˆ é™¤æç¤ºè¯çš„é€‰ä¸­çŠ¶æ€
  selectedIdsToRemove.forEach(id => {
    selectedCommonPromptIds.value.delete(id)
  })
  
  // æ¸…ç†æ ‡ç­¾æ•°ç»„ä¸­å·²åˆ é™¤çš„å¸¸ç”¨æç¤ºè¯
  const currentPromptNames = new Set(updatedPrompts.map(p => p.name))
  const originalTags = [...promptTags.value] // ä¿å­˜åŸå§‹æ ‡ç­¾æ•°ç»„
  
  promptTags.value = promptTags.value.filter(tag => {
    // ä¿ç•™éå¸¸ç”¨æç¤ºè¯æ ‡ç­¾ï¼Œæˆ–è€…ä»ç„¶å­˜åœ¨çš„å¸¸ç”¨æç¤ºè¯æ ‡ç­¾
    const isCommonPrompt = originalTags.some(t => t === tag) && commonPrompts.value.some(p => p.name === tag)
    return !isCommonPrompt || currentPromptNames.has(tag)
  })
  
  // æ‰‹åŠ¨åŒæ­¥é€‰ä¸­çŠ¶æ€ï¼Œé¿å…watchç›‘å¬å™¨çš„å¹²æ‰°
  syncSelectedStateFromTags()
  
  // é‡ç½®åˆ é™¤æ›´æ–°æ ‡å¿—
  isUpdatingFromDelete.value = false
}

// å¤„ç†è§†é¢‘å¸¸ç”¨æç¤ºè¯æ›´æ–°
const handleVideoCommonPromptsUpdated = (updatedPrompts) => {
  // æ›´æ–°è§†é¢‘å¸¸ç”¨æç¤ºè¯åˆ—è¡¨
  videoCommonPrompts.value = updatedPrompts
  
  // æ¸…ç†å·²åˆ é™¤æç¤ºè¯çš„é€‰ä¸­çŠ¶æ€
  const currentPromptIds = new Set(updatedPrompts.map(p => p.id))
  const selectedIdsToRemove = []
  
  selectedVideoPromptIds.value.forEach(id => {
    if (!currentPromptIds.has(id)) {
      selectedIdsToRemove.push(id)
    }
  })
  
  // ç§»é™¤å·²åˆ é™¤æç¤ºè¯çš„é€‰ä¸­çŠ¶æ€
  selectedIdsToRemove.forEach(id => {
    selectedVideoPromptIds.value.delete(id)
  })
  
  // æ¸…ç†æ ‡ç­¾æ•°ç»„ä¸­å·²åˆ é™¤çš„è§†é¢‘å¸¸ç”¨æç¤ºè¯
  const currentPromptNames = new Set(updatedPrompts.map(p => p.name))
  
  videoPromptTags.value = videoPromptTags.value.filter(tag => {
    // ä¿ç•™éå¸¸ç”¨æç¤ºè¯æ ‡ç­¾ï¼Œæˆ–è€…ä»ç„¶å­˜åœ¨çš„å¸¸ç”¨æç¤ºè¯æ ‡ç­¾
    return !videoCommonPrompts.value.some(p => p.name === tag) || currentPromptNames.has(tag)
  })
  
  // é‡æ–°åŠ è½½è§†é¢‘å¸¸ç”¨æç¤ºè¯åˆ—è¡¨
  loadVideoCommonPrompts()
}

// å¼¹çª—ç›¸å…³æ–¹æ³•
const closeImageModal = () => {
  showImageModal.value = false
}

// æ‰“å¼€è§†é¢‘é¢„è§ˆ
const openVideoPreview = (video) => {
  currentPreviewVideo.value = {
    url: video.url || '',
    duration: video.duration || '',
    resolution: video.resolution || '',
    ratio: video.ratio || ''
  }
  showVideoModal.value = true
}

// å…³é—­è§†é¢‘é¢„è§ˆ
const closeVideoModal = () => {
  showVideoModal.value = false
  // æ¸…ç©ºå½“å‰é¢„è§ˆè§†é¢‘
  currentPreviewVideo.value = {
    url: '',
    duration: '',
    resolution: '',
    ratio: ''
  }
}

const prevImage = () => {
  if (currentImageIndex.value > 0 && currentBatchImages.value.length > 0) {
    currentImageIndex.value--
    currentPreviewImage.value = currentBatchImages.value[currentImageIndex.value].url
    currentPreviewTitle.value = `ç”Ÿæˆçš„å›¾ç‰‡ ${currentImageIndex.value + 1}`
    console.log('[å¤§å›¾ç¿»é¡µ] ä¸Šä¸€å¼ :', currentImageIndex.value + 1, '/', currentBatchImages.value.length)
    // é‡ç½®ç¼©æ”¾å’Œæ—‹è½¬
    imageScale.value = 1
    imageRotation.value = 0
    imagePosition.value = { x: 0, y: 0 }
  }
}

const nextImage = () => {
  if (currentImageIndex.value < currentBatchImages.value.length - 1 && currentBatchImages.value.length > 0) {
    currentImageIndex.value++
    currentPreviewImage.value = currentBatchImages.value[currentImageIndex.value].url
    currentPreviewTitle.value = `ç”Ÿæˆçš„å›¾ç‰‡ ${currentImageIndex.value + 1}`
    console.log('[å¤§å›¾ç¿»é¡µ] ä¸‹ä¸€å¼ :', currentImageIndex.value + 1, '/', currentBatchImages.value.length)
    // é‡ç½®ç¼©æ”¾å’Œæ—‹è½¬
    imageScale.value = 1
    imageRotation.value = 0
    imagePosition.value = { x: 0, y: 0 }
  }
}

const zoomIn = () => {
  imageScale.value = Math.min(imageScale.value * 1.2, 5)
}

const zoomOut = () => {
  imageScale.value = Math.max(imageScale.value / 1.2, 0.1)
}

const resetZoom = () => {
  imageScale.value = 1
  imageRotation.value = 0
  imagePosition.value = { x: 0, y: 0 }
}

const rotateLeft = () => {
  imageRotation.value -= 90
}

const rotateRight = () => {
  imageRotation.value += 90
}

const handleImageWheel = (event) => {
  event.preventDefault()
  if (event.deltaY < 0) {
    zoomIn()
  } else {
    zoomOut()
  }
}

const startDrag = (event) => {
  isDragging.value = true
  dragStart.value = { x: event.clientX, y: event.clientY }
}

const handleDrag = (event) => {
  if (!isDragging.value) return
  
  const deltaX = event.clientX - dragStart.value.x
  const deltaY = event.clientY - dragStart.value.y
  
  imagePosition.value.x += deltaX
  imagePosition.value.y += deltaY
  
  dragStart.value = { x: event.clientX, y: event.clientY }
}

const endDrag = () => {
  isDragging.value = false
}

const downloadCurrentImage = async () => {
  const image = currentBatchImages.value[currentImageIndex.value]
  if (image) {
    try {
      // ä¼˜å…ˆä½¿ç”¨åŸç”Ÿé“¾æ¥ï¼ˆFALé“¾æ¥ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨OSSé“¾æ¥
      const downloadUrl = image.originalUrl || image.url
      
      console.log(`ä¸‹è½½å½“å‰å›¾ç‰‡: ${downloadUrl}`)
      
      // æ ¹æ®URLç±»å‹é€‰æ‹©ä¸‹è½½æ–¹å¼ï¼Œé¿å…CORSé—®é¢˜
      let response
      if (needsProxyDownload(downloadUrl)) {
        // ä½¿ç”¨ä»£ç†APIä¸‹è½½ï¼Œé¿å…CORSé—®é¢˜
        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(downloadUrl)}`
        console.log(`[å¤§å›¾ä¸‹è½½] ä½¿ç”¨ä»£ç†: ${proxyUrl}`)
        response = await fetch(proxyUrl, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
      } else {
        // ç›´æ¥ä¸‹è½½æœ¬åœ°å›¾ç‰‡
        console.log(`[å¤§å›¾ä¸‹è½½] ç›´æ¥ä¸‹è½½: ${downloadUrl}`)
        response = await fetch(downloadUrl)
      }
      
      if (!response.ok) {
        throw new Error('è·å–å›¾ç‰‡å¤±è´¥')
      }
      
      const blob = await response.blob()
      const blobUrl = URL.createObjectURL(blob)
      
      const link = document.createElement('a')
      link.href = blobUrl
      link.download = `generated-image-${currentImageIndex.value + 1}-${Date.now()}.png`
      link.target = '_self'
      
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      
      URL.revokeObjectURL(blobUrl)
      
      ElMessage.success('ä¸‹è½½æˆåŠŸ')
    } catch (error) {
      console.error('ä¸‹è½½å¤±è´¥:', error)
      ElMessage.error('ä¸‹è½½å¤±è´¥')
    }
  }
}

// ä¿å­˜å½“å‰å›¾ç‰‡ä¸ºæç¤ºè¯
const saveCurrentImageAsPrompt = async () => {
  const image = currentBatchImages.value[currentImageIndex.value]
  if (!image) {
    ElMessage.warning('æ— æ³•è·å–å½“å‰å›¾ç‰‡ä¿¡æ¯')
    return
  }
  
  // æŸ¥æ‰¾å›¾ç‰‡æ‰€å±çš„æ‰¹æ¬¡ï¼Œè·å–æç¤ºè¯
  let batchPrompt = ''
  if (currentViewingBatchId.value) {
    const batch = generationBatches.value.find(b => b.id === currentViewingBatchId.value)
    batchPrompt = batch?.prompt || ''
  }
  
  // å¦‚æœæ‰¾ä¸åˆ°æ‰¹æ¬¡æç¤ºè¯ï¼Œå°è¯•ä½¿ç”¨å…¨å±€prompt
  if (!batchPrompt && prompt.value) {
    batchPrompt = prompt.value
  }
  
  // æ„é€ å›¾ç‰‡æ•°æ®
  const imageData = {
    src: image.url,
    prompt: batchPrompt,
    title: currentPreviewTitle.value || `ç”Ÿæˆçš„å›¾ç‰‡ ${currentImageIndex.value + 1}`
  }
  
  console.log('[ä¿å­˜æç¤ºè¯] å›¾ç‰‡æ•°æ®:', imageData)
  
  // è°ƒç”¨å·²æœ‰çš„æ·»åŠ åˆ°æç¤ºè¯å‡½æ•°
  await handleAddToPrompts(imageData)
}

// è®¤è¯ç›¸å…³æ–¹æ³•
const checkAuthStatus = () => {
  const token = localStorage.getItem('token')
  const user = localStorage.getItem('user')
  
  console.log('æ£€æŸ¥è®¤è¯çŠ¶æ€:', {
    token: token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
    user: user ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
    tokenLength: token ? token.length : 0
  })
  
  if (token && user) {
    try {
      currentUser.value = JSON.parse(user)
      isLoggedIn.value = true
      console.log('ç”¨æˆ·å·²ç™»å½•:', currentUser.value)
    } catch (error) {
      console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
      localStorage.removeItem('token')
      localStorage.removeItem('user')
    }
  } else {
    console.log('ç”¨æˆ·æœªç™»å½•')
  }
}

const handleLoginSuccess = async (user) => {
  currentUser.value = user
  isLoggedIn.value = true
  // ç™»å½•æˆåŠŸåè·å–å¸¸ç”¨å‚è€ƒå›¾å’Œæç¤ºè¯
  fetchCommonReferenceImages()
  loadCommonPrompts()
  loadVideoCommonPrompts() // åŠ è½½è§†é¢‘å¸¸ç”¨æç¤ºè¯
  loadUserPrompts() // åŠ è½½ç”¨æˆ·æç¤ºè¯
  
  // æ£€æµ‹å¹¶ä¸Šä¼ localStorageä¸­çš„æç¤ºè¯
  await checkAndUploadLocalStoragePrompts()
}

const handleLogout = async () => {
  try {
    await ElMessageBox.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', 'æç¤º', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    
    // è°ƒç”¨æœåŠ¡ç«¯é€€å‡ºç™»å½•æ¥å£
    try {
      const token = localStorage.getItem('token')
      if (token) {
        await fetch('/api/auth/logout', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
      }
    } catch (error) {
      console.error('è°ƒç”¨é€€å‡ºç™»å½•æ¥å£å¤±è´¥:', error)
      // å³ä½¿æœåŠ¡ç«¯è°ƒç”¨å¤±è´¥ï¼Œä¹Ÿè¦æ¸…é™¤æœ¬åœ°ç¼“å­˜
    }
    
    // ä½¿ç”¨å·¥å…·å‡½æ•°æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç¼“å­˜
    const clearSuccess = clearAllUserCache()
    
    // é‡ç½®çŠ¶æ€
    isLoggedIn.value = false
    currentUser.value = null
    
    // æ¸…ç©ºåº”ç”¨æ•°æ®
    generatedImages.value = []
    uploadedImages.value = []
    uploadedFiles.value = []
    prompt.value = ''
    promptTags.value = []
    userPrompts.value = []
    commonPrompts.value = []
    selectedCommonPromptIds.value.clear()
    
    if (clearSuccess) {
      ElMessage.success('å·²é€€å‡ºç™»å½•ï¼Œæ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤')
    } else {
      ElMessage.warning('å·²é€€å‡ºç™»å½•ï¼Œä½†éƒ¨åˆ†ç¼“å­˜æ¸…é™¤å¤±è´¥')
    }
  } catch (error) {
    // ç”¨æˆ·å–æ¶ˆé€€å‡º
  }
}

// åŠ è½½ç”¨æˆ·æç¤ºè¯
const loadUserPrompts = async () => {
  try {
    userPromptsLoading.value = true
    
    const token = localStorage.getItem('token')
    if (!token) {
      userPrompts.value = []
      return
    }
    
    // ä»æœåŠ¡å™¨APIåŠ è½½æç¤ºè¯
    const response = await fetch('/api/prompts', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    
    if (response.ok) {
      const result = await response.json()
      if (result.success) {
        // è½¬æ¢æœåŠ¡å™¨æ•°æ®æ ¼å¼ä¸ºå‰ç«¯æ ¼å¼
        userPrompts.value = result.data.map(prompt => ({
          id: prompt.id.toString(),
          title: prompt.title,
          content: prompt.content,
          // ä¿®å¤ï¼šå°é¢ä½¿ç”¨ç”Ÿæˆç»“æœå›¾ï¼Œä½†ä¿å­˜çš„å‚è€ƒå›¾é“¾æ¥ä¿æŒä¸å˜
          referenceImage: prompt.cover_image_url || prompt.oss_url || prompt.reference_image_url || null,
          // ä¿å­˜å‚è€ƒå›¾é“¾æ¥ç”¨äºç‚¹å‡»å¡ç‰‡æ—¶åŠ è½½
          referenceImageUrl: prompt.reference_image_url || null,
          createdAt: new Date(prompt.created_at).getTime(),
          updatedAt: new Date(prompt.updated_at).getTime(),
          // æ·»åŠ ç¼ºå¤±çš„å…³é”®å­—æ®µ
          tags: prompt.tags,
          manual_input: prompt.manual_input,
          selected_common_prompts: prompt.selected_common_prompts,
          selected_reference_images: prompt.selected_reference_images,
          generation_mode: prompt.generation_mode,
          image_size: prompt.image_size,
          generate_quantity: prompt.generate_quantity
        }))
        
        // åŒæ—¶æ›´æ–°localStorageä½œä¸ºç¼“å­˜
        localStorage.setItem('promptManager', JSON.stringify(userPrompts.value))
      } else {
        throw new Error(result.message || 'åŠ è½½æç¤ºè¯å¤±è´¥')
      }
    } else if (response.status === 401) {
      // è®¤è¯å¤±è´¥ï¼Œæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•
      clearAllUserCache()
      isLoggedIn.value = false
      currentUser.value = null
      ElMessage.error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
    } else {
      throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥')
    }
  } catch (error) {
    console.error('åŠ è½½ç”¨æˆ·æç¤ºè¯å¤±è´¥:', error)
    
    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½ä½œä¸ºå¤‡ç”¨
    try {
    const savedPrompts = localStorage.getItem('promptManager')
    if (savedPrompts) {
      userPrompts.value = JSON.parse(savedPrompts)
        ElMessage.warning('å·²ä»æœ¬åœ°ç¼“å­˜åŠ è½½æç¤ºè¯')
    } else {
      userPrompts.value = []
    }
    } catch (localError) {
      console.error('ä»æœ¬åœ°ç¼“å­˜åŠ è½½å¤±è´¥:', localError)
    userPrompts.value = []
    }
  } finally {
    userPromptsLoading.value = false
  }
}

// æ£€æµ‹å¹¶ä¸Šä¼ localStorageä¸­çš„æç¤ºè¯
const checkAndUploadLocalStoragePrompts = async () => {
  try {
    const token = localStorage.getItem('token')
    if (!token) {
      return
    }

    // æ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰æç¤ºè¯æ•°æ®
    const promptCardsData = localStorage.getItem('promptManager')
    const commonPromptsData = localStorage.getItem('commonPrompts')
    
    let promptCards = []
    let commonPrompts = []
    
    // è§£ææç¤ºè¯å¡ç‰‡æ•°æ®
    if (promptCardsData) {
      try {
        const parsed = JSON.parse(promptCardsData)
        if (Array.isArray(parsed) && parsed.length > 0) {
          promptCards = parsed
        }
      } catch (error) {
        console.error('è§£ææç¤ºè¯å¡ç‰‡æ•°æ®å¤±è´¥:', error)
      }
    }
    
    // è§£æå¸¸ç”¨æç¤ºè¯æ•°æ®
    if (commonPromptsData) {
      try {
        const parsed = JSON.parse(commonPromptsData)
        if (Array.isArray(parsed) && parsed.length > 0) {
          commonPrompts = parsed
        }
      } catch (error) {
        console.error('è§£æå¸¸ç”¨æç¤ºè¯æ•°æ®å¤±è´¥:', error)
      }
    }
    
    // å¦‚æœæ²¡æœ‰æ•°æ®éœ€è¦ä¸Šä¼ ï¼Œç›´æ¥è¿”å›
    if (promptCards.length === 0 && commonPrompts.length === 0) {
      return
    }
    
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    const confirmResult = await ElMessageBox.confirm(
      `æ£€æµ‹åˆ°æ‚¨æœ‰ ${promptCards.length} ä¸ªæç¤ºè¯å¡ç‰‡å’Œ ${commonPrompts.length} ä¸ªå¸¸ç”¨æç¤ºè¯å­˜å‚¨åœ¨æœ¬åœ°ï¼Œæ˜¯å¦è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Ÿ`,
      'ä¸Šä¼ æœ¬åœ°æç¤ºè¯',
      {
        confirmButtonText: 'ä¸Šä¼ ',
        cancelButtonText: 'ç¨å',
        type: 'info',
        distinguishCancelAndClose: true
      }
    ).catch(() => {
      // ç”¨æˆ·å–æ¶ˆæˆ–å…³é—­å¯¹è¯æ¡†
      return false
    })
    
    if (!confirmResult) {
      return
    }
    
    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
    const loadingInstance = ElLoading.service({
      lock: true,
      text: 'æ­£åœ¨ä¸Šä¼ æç¤ºè¯...',
      background: 'rgba(0, 0, 0, 0.7)'
    })
    
    try {
      // è°ƒç”¨æ‰¹é‡ä¸Šä¼ API
      const response = await fetch('/api/prompts/batch-upload', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          promptCards,
          commonPrompts
        })
      })
      
      if (!response.ok) {
        throw new Error('ä¸Šä¼ å¤±è´¥')
      }
      
      const result = await response.json()
      
      if (result.success) {
        const { promptCards: promptCardsResult, commonPrompts: commonPromptsResult } = result.data
        const totalSuccess = promptCardsResult.success + commonPromptsResult.success
        const totalFailed = promptCardsResult.failed + commonPromptsResult.failed
        
        if (totalSuccess > 0) {
          ElMessage.success(`æˆåŠŸä¸Šä¼  ${totalSuccess} ä¸ªæç¤ºè¯åˆ°æœåŠ¡å™¨`)
          
          // é‡æ–°åŠ è½½æœåŠ¡å™¨ä¸Šçš„æç¤ºè¯
          await loadUserPrompts()
          await loadCommonPrompts()
          
          // å¯é€‰ï¼šæ¸…é™¤localStorageä¸­çš„æç¤ºè¯æ•°æ®ï¼ˆé¿å…é‡å¤ä¸Šä¼ ï¼‰
          if (totalFailed === 0) {
            const clearResult = await ElMessageBox.confirm(
              'æ‰€æœ‰æç¤ºè¯å·²æˆåŠŸä¸Šä¼ ï¼Œæ˜¯å¦æ¸…é™¤æœ¬åœ°ç¼“å­˜ï¼Ÿ',
              'æ¸…é™¤æœ¬åœ°ç¼“å­˜',
              {
                confirmButtonText: 'æ¸…é™¤',
                cancelButtonText: 'ä¿ç•™',
                type: 'success'
              }
            ).catch(() => false)
            
            if (clearResult) {
              localStorage.removeItem('promptManager')
              localStorage.removeItem('commonPrompts')
              ElMessage.success('æœ¬åœ°ç¼“å­˜å·²æ¸…é™¤')
            }
          }
        }
        
        if (totalFailed > 0) {
          const errors = [...promptCardsResult.errors, ...commonPromptsResult.errors]
          ElMessage.warning(`${totalFailed} ä¸ªæç¤ºè¯ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤å†…å®¹`)
          console.warn('ä¸Šä¼ å¤±è´¥çš„æç¤ºè¯:', errors)
        }
      } else {
        throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥')
      }
    } catch (error) {
      console.error('ä¸Šä¼ æç¤ºè¯å¤±è´¥:', error)
      ElMessage.error(`ä¸Šä¼ å¤±è´¥: ${error.message}`)
    } finally {
      loadingInstance.close()
    }
    
  } catch (error) {
    console.error('æ£€æµ‹localStorageæç¤ºè¯å¤±è´¥:', error)
  }
}

// åŒæ­¥é€‰ä¸­çŠ¶æ€ä»æ ‡ç­¾æ•°ç»„
const syncSelectedStateFromTags = () => {
  // æ¸…ç©ºå½“å‰é€‰ä¸­çŠ¶æ€
  selectedCommonPromptIds.value.clear()
  
  // æ£€æŸ¥å“ªäº›å¸¸ç”¨æç¤ºè¯åœ¨æ ‡ç­¾ä¸­
  commonPrompts.value.forEach(promptItem => {
    if (promptTags.value.includes(promptItem.name)) {
      selectedCommonPromptIds.value.add(promptItem.id)
    }
  })
}

// ç›‘å¬æç¤ºè¯æ ‡ç­¾å˜åŒ–ï¼ŒåŒæ­¥æ›´æ–°é€‰ä¸­çŠ¶æ€
watch(promptTags, (newTags) => {
  // åªæœ‰åœ¨éåˆ é™¤æ“ä½œæ—¶æ‰è‡ªåŠ¨åŒæ­¥
  // åˆ é™¤æ“ä½œä¼šé€šè¿‡ handleCommonPromptsUpdated æ‰‹åŠ¨åŒæ­¥
  if (!isUpdatingFromDelete.value) {
    syncSelectedStateFromTags()
  }
})

// ç›‘å¬ç”Ÿæˆæ¨¡å¼å˜åŒ–ï¼Œé‡ç½®ç›¸åº”çš„æç¤ºè¯çŠ¶æ€
watch(generationMode, (newMode) => {
  if (newMode === 'image-to-video') {
    // åˆ‡æ¢åˆ°AIè§†é¢‘æ¨¡å¼æ—¶ï¼Œç¡®ä¿è§†é¢‘æç¤ºè¯å·²åŠ è½½
    if (videoCommonPrompts.value.length === 0) {
      loadVideoCommonPrompts()
    }
  }
})

// ç»„ä»¶æŒ‚è½½æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
onMounted(() => {
  checkAuthStatus()
  fetchAvailableModels() // è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
  fetchVideoModels() // è·å–è§†é¢‘æ¨¡å‹åˆ—è¡¨
  if (isLoggedIn.value) {
  fetchCommonReferenceImages()
  loadCommonPrompts()
  loadVideoCommonPrompts() // åŠ è½½è§†é¢‘å¸¸ç”¨æç¤ºè¯
    loadUserPrompts()
  }
})
</script>

<style>
/* å…¨å±€é‡ç½®ï¼Œç¡®ä¿å¼€æ”¾å¼å¸ƒå±€ - ä½¿ç”¨éscopedæ ·å¼è¦†ç›–æ‰€æœ‰é»˜è®¤æ ·å¼ */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100% !important;
  width: 100% !important;
  margin: 0 !important;
  padding: 0 !important;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
  background: #f5f7fa !important;
  overflow-x: hidden !important;
}

#app {
  height: 100vh !important;
  width: 100vw !important;
  margin: 0 !important;
  padding: 0 !important;
}
</style>

<style scoped>


.main-layout {
  display: flex;
  height: 100vh;
  width: 100vw;
  margin: 0;
  padding: 0;
  background: #f8fafc;
  overflow: hidden;
  position: fixed;
  top: 0;
  left: 0;
  gap: 16px;
}

/* å·¦ä¾§é¢æ¿ï¼šTABåˆ‡æ¢ + ç”¨æˆ·è´¦æˆ·ç³»ç»Ÿ */
.left-panel {
  width: 350px;
  height: calc(100vh - 32px);
  margin: 16px 0 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 0;
  flex-shrink: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  border: 1px solid #e2e8f0;
  overflow: hidden;
}

/* TABåˆ‡æ¢åŒºåŸŸ */
.tab-section {
  background: white;
  border-radius: 12px 12px 0 0;
  box-shadow: none;
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  position: relative;
}

/* Tabå¤´éƒ¨å®¹å™¨ */
.tab-header {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 16px 16px 0 16px;
}

/* Tabç®¡ç†æŒ‰é’® */
.prompts-manage-header {
  padding: 0 16px 6px 16px;
  border-bottom: 1px solid rgba(226, 232, 240, 0.6);
  margin-bottom: 4px;
}

.prompts-manage-btn {
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 12px;
  height: 28px;
  width: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
  font-weight: 500;
}

.prompts-manage-btn:hover {
  background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.left-tabs {
  height: 100%;
  display: flex;
  flex-direction: column;
  flex: 1;
}

.left-tabs .el-tabs__header {
  margin: 0 24px 0 24px;
  padding-bottom: 12px;
  background: transparent;
  border-bottom: 1px solid #e2e8f0;
}

.left-tabs .el-tabs__content {
  flex: 1;
  padding: 0;
  overflow: hidden;
}

.left-tabs .el-tab-pane {
  height: 100%;
  overflow: hidden;
}

.left-tabs .el-tabs__nav-wrap::after {
  display: none;
}

.left-tabs .el-tabs__item {
  font-size: 14px;
  font-weight: 600;
  color: #64748b;
  padding: 0 28px;
  height: 40px;
  line-height: 40px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.left-tabs .el-tabs__item.is-active {
  color: #667eea;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.left-tabs .el-tabs__item:hover {
  color: #667eea;
  background: rgba(102, 126, 234, 0.1);
}

.tab-content {
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  padding: 0 12px 12px 12px;
}

/* æç¤ºè¯å¡ç‰‡å®¹å™¨ */
/* æç¤ºè¯ç€‘å¸ƒæµå®¹å™¨ */
.prompts-waterfall-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 8px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  align-content: start;
  grid-auto-rows: min-content;
  max-height: calc(100vh - 200px);
  scrollbar-width: thin;
  scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

.prompts-waterfall-container::-webkit-scrollbar {
  width: 6px;
}

.prompts-waterfall-container::-webkit-scrollbar-track {
  background: transparent;
}

.prompts-waterfall-container::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 3px;
}

.prompts-waterfall-container::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 0, 0, 0.3);
}

/* åŠ è½½çŠ¶æ€æ ·å¼ */
.loading-prompts {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 200px;
}

/* ç€‘å¸ƒæµæç¤ºè¯å¡ç‰‡æ ·å¼ */
.prompt-card-waterfall {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 8px;
  padding: 0;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid rgba(226, 232, 240, 0.8);
  display: flex;
  flex-direction: column;
  aspect-ratio: 3/4;
  width: 100%;
  min-height: 150px;
  max-height: 200px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  overflow: hidden;
}

.prompt-card-waterfall:hover {
  background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
  border-color: #667eea;
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
}

.card-image-waterfall {
  width: 100%;
  height: 85%;
  border-radius: 0;
  overflow: hidden;
  margin-bottom: 0;
  background: linear-gradient(135deg, #f5f5f5 0%, #e8f2ff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  position: relative;
}

.card-image-waterfall img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 0;
}

.no-image-waterfall {
  color: #94a3b8;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
}

.card-content-waterfall {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 4px;
}

.card-title-waterfall {
  font-size: 11px;
  font-weight: 600;
  color: #334155;
  margin: 0 0 2px 0;
  line-height: 1.2;
  text-align: center;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
}



.card-content {
  margin-bottom: 8px;
}

.card-title {
  font-size: 13px;
  font-weight: 600;
  color: #333;
  margin: 0 0 4px 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-text {
  font-size: 11px;
  color: #666;
  margin: 0;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.card-actions {
  display: flex;
  gap: 4px;
}

.card-actions .el-button {
  flex: 1;
  font-size: 11px;
  padding: 4px 8px;
  height: auto;
}

/* ç©ºçŠ¶æ€ */
.empty-prompts {
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.empty-prompts .el-icon {
  color: #ccc;
  margin-bottom: 12px;
}

.empty-prompts p {
  margin: 0 0 16px 0;
  font-size: 14px;
}

/* æ·»åŠ æç¤ºè¯åŒºåŸŸ */
.add-prompt-section {
  padding: 16px;
  border-top: 1px solid #f0f0f0;
  background: #fafafa;
}

.add-prompt-btn {
  width: 100%;
  height: 36px;
  font-size: 13px;
}

/* ç”¨æˆ·è´¦æˆ·å¡ç‰‡ï¼ˆåº•éƒ¨ï¼Œæ— é—´è·ï¼‰ */
.user-account-card {
  background: white;
  border-radius: 0 0 12px 12px;
  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
  padding: 12px 20px;
  height: 60px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  border-top: 1px solid #e2e8f0;
  position: relative;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 0;
}

.user-avatar {
  flex-shrink: 0;
}

.user-details {
  flex: 1;
  min-width: 0;
}

.username {
  font-size: 13px;
  font-weight: 600;
  color: #333;
  margin-bottom: 1px;
}

.user-status {
  font-size: 11px;
  color: #52c41a;
}

.user-actions {
  display: flex;
  justify-content: flex-end;
}

.more-btn {
  padding: 4px;
  color: #666;
}

.more-btn:hover {
  color: #333;
}

.control-panel {
  width: 450px;
  height: calc(100vh - 32px);
  margin: 16px 0;
  background: white;
  padding: 12px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  border: 1px solid #e2e8f0;
  overflow-y: auto;
  flex-shrink: 0;
}

.result-panel {
  flex: 1;
  height: calc(100vh - 32px);
  margin: 16px 16px 16px 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  border: 1px solid #e2e8f0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.result-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #e2e8f0;
  background: white;
  flex-shrink: 0;
  border-radius: 12px 12px 0 0;
}

.result-header h2 {
  margin: 0;
  color: #334155;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}


.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.auto-download-switch {
  display: flex;
  align-items: center;
}

.auto-download-switch .el-switch {
  --el-switch-on-color: #67c23a;
  --el-switch-off-color: #dcdfe6;
}

.auto-download-switch .el-switch__label {
  font-size: 12px;
  color: #606266;
}

.result-content {
  flex: 1;
  padding: 8px 12px;
  display: flex;
  align-items: flex-start;
  overflow-y: auto;
}

/* ç”Ÿæˆè¿›åº¦åŒºåŸŸ */
.generating-result {
  flex: 1;
  display: flex;
  flex-direction: column;
  width: 100%;
}

.generating-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid #e4e7ed;
}

.generating-header h3 {
  margin: 0;
  color: #303133;
  font-size: 18px;
  font-weight: 600;
}

.progress-text {
  color: #409EFF;
  font-weight: 600;
  font-size: 14px;
}

/* ä»»åŠ¡ç½‘æ ¼ */
.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 240px)); /* ä¸results-gridä¿æŒä¸€è‡´ */
  gap: 12px;
  flex: 1;
  margin-top: 8px;
}

/* ä»»åŠ¡å¡ç‰‡ */
.task-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  border: 2px solid transparent;
  height: 200px; /* ä¸results-gridä¿æŒä¸€è‡´ */
  display: flex;
  align-items: center;
  justify-content: center;
}

.task-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.task-pending {
  border-color: #e4e7ed;
}

.task-processing {
  border-color: #409EFF;
  animation: pulse 2s infinite;
}

.task-completed {
  border-color: #67c23a;
}

.task-failed {
  border-color: #f56c6c;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(64, 158, 255, 0.4);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(64, 158, 255, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(64, 158, 255, 0);
  }
}

.task-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: 12px;
}

.task-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.pending-icon {
  color: #909399;
}

.processing-icon {
  color: #409EFF;
  animation: spin 1s linear infinite;
}

.completed-icon {
  color: #67c23a;
}

.failed-icon {
  color: #f56c6c;
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.task-info h4 {
  margin: 0 0 4px 0;
  color: #303133;
  font-size: 16px;
  font-weight: 600;
}

.task-info p {
  margin: 0;
  color: #606266;
  font-size: 14px;
}

/* é”™è¯¯ä¿¡æ¯æ ·å¼ - å°å­—ä¸”ä¸è¶…å‡ºå®¹å™¨ */
.task-info p.error-message {
  font-size: 12px;
  color: #f56c6c;
  word-wrap: break-word;
  word-break: break-word;
  overflow-wrap: break-word;
  max-width: 100%;
  line-height: 1.4;
}

.task-progress {
  width: 100%;
  margin-top: 8px;
}

/* ä»»åŠ¡çŠ¶æ€æ¦‚è§ˆ */
.task-summary {
  width: 100%;
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.summary-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #e4e7ed;
}

.summary-header h3 {
  margin: 0;
  color: #303133;
  font-size: 18px;
  font-weight: 600;
}

.summary-text {
  color: #67c23a;
  font-weight: 600;
  font-size: 14px;
}

.summary-tasks {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.summary-task {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 8px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.summary-task.task-pending {
  border-color: #e4e7ed;
  background: #f8f9fa;
}

.summary-task.task-processing {
  border-color: #409EFF;
  background: #f0f9ff;
}

.summary-task.task-completed {
  border-color: #67c23a;
  background: #f0f9f0;
}

.summary-task.task-failed {
  border-color: #f56c6c;
  background: #fef0f0;
}

.summary-task-icon {
  font-size: 16px;
}

.summary-task-text {
  font-size: 14px;
  font-weight: 500;
  color: #303133;
}

.history-section {
  margin-bottom: 24px;
}

.history-btn {
  width: 100%;
  height: 44px;
  font-size: 16px;
  font-weight: 500;
  border-radius: 8px;
}

.mode-section {
  margin-bottom: 24px;
  padding: 16px;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.mode-section h3 {
  margin: 0 0 12px 0;
  font-size: 15px;
  font-weight: 600;
  color: #334155;
  display: flex;
  align-items: center;
  gap: 8px;
}


/* å…¨å±€Tabåˆ‡æ¢æ ·å¼ */
.global-mode-tabs {
  width: 100%;
  margin-bottom: 1px;
}

.global-mode-tabs .el-tabs__header {
  margin: 0;
  padding-bottom: 0;
  background: transparent;
  border-bottom: 1px solid #e2e8f0;
}

.global-mode-tabs .el-tabs__nav-wrap {
  padding: 0;
}

.global-mode-tabs .el-tabs__nav-wrap::after {
  display: none;
}

.global-mode-tabs .el-tabs__nav {
  display: flex;
  width: 100%;
  background: transparent;
}

.global-mode-tabs .el-tabs__item {
  flex: 1;
  font-size: 15px;
  font-weight: 500;
  color: #64748b;
  padding: 0 20px;
  height: 44px;
  line-height: 44px;
  transition: all 0.3s ease;
  text-align: center;
  background: transparent;
  border: none;
  position: relative;
}

.global-mode-tabs .el-tabs__item.is-active {
  color: #3b82f6;
  background: transparent;
}

.global-mode-tabs .el-tabs__item.is-active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60%;
  height: 3px;
  background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
  border-radius: 2px;
}

.global-mode-tabs .el-tabs__item:hover:not(.is-active) {
  color: #3b82f6;
  background: rgba(59, 130, 246, 0.05);
}

.global-mode-tabs .el-tabs__content {
  display: none;
}

.prompt-section {
  margin-bottom: 8px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
}

.prompt-header {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  margin-bottom: 8px;
}



.prompt-manager-btn {
  border-radius: 6px;
  font-size: 12px;
  padding: 6px 12px;
}

/* å¤šè¡Œæ ‡ç­¾è¾“å…¥ç»„ä»¶æ ·å¼ */
.prompt-input-tag {
  width: 100%;
  margin-bottom: 16px;
}

.prompt-input-tag :deep(.tags-container) {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border: 1px solid #e4e7ed;
  transition: all 0.3s ease;
}

.prompt-input-tag :deep(.tags-container:hover) {
  border-color: #c0c4cc;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.prompt-input-tag :deep(.tags-container.is-focused) {
  border-color: #409eff;
  box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
}

.prompt-input-tag :deep(.tag-item) {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
  font-weight: 500;
  margin: 0;
  max-width: 200px;
  word-break: break-all;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.prompt-input-tag :deep(.tag-item:hover) {
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.prompt-input-tag :deep(.tag-item .el-tag__close) {
  color: white;
  font-size: 12px;
}

.prompt-input-tag :deep(.tag-item .el-tag__close:hover) {
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
}

.prompt-input-tag :deep(.textarea-input .el-textarea__inner) {
  background: transparent;
  border: none;
  font-size: 14px;
  line-height: 1.5;
  color: #606266;
}

.prompt-input-tag :deep(.textarea-input .el-textarea__inner::placeholder) {
  color: #a8abb2;
  font-style: italic;
}

.prompt-input-tag :deep(.input-hint) {
  color: #909399;
  font-size: 12px;
}

.common-prompts {
  margin-top: 12px;
}

.common-prompts-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.common-prompts-label {
  font-size: 12px;
  color: #666;
  font-weight: 500;
}

.manage-prompts-btn {
  font-size: 11px;
  padding: 2px 6px;
  height: auto;
}

.common-prompts-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.common-prompts-buttons .el-button {
  font-size: 12px;
  padding: 4px 8px;
  height: auto;
  margin: 0;
  transition: all 0.3s ease;
}

.common-prompts-buttons .el-button.selected-prompt {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  border-color: #3b82f6;
  color: white;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  transform: translateY(-1px);
}

.common-prompts-buttons .el-button.selected-prompt:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
  border-color: #2563eb;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.image-upload-section {
  margin-bottom: 16px;
  padding: 16px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.image-upload-section h3 {
  margin: 0 0 12px 0;
  color: #334155;
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}


.image-upload-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.image-upload-header h3 {
  margin: 0;
  color: #334155;
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}


.reference-manager-btn {
  font-size: 12px;
}

.upload-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.image-uploader {
  width: 100%;
  display: flex;
  justify-content: center;
}

.upload-placeholder-square {
  width: 80px;
  height: 80px;
  border: 2px dashed #d9d9d9;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #fafafa;
}

.upload-placeholder-square:hover {
  border-color: #409eff;
  background: #f0f9ff;
  transform: translateY(-2px);
}

.upload-icon {
  font-size: 24px;
  color: #c0c4cc;
}

.upload-text-container {
  text-align: center;
}

.upload-text {
  font-size: 14px;
  color: #606266;
  margin-bottom: 4px;
}

.upload-hint {
  font-size: 12px;
  color: #909399;
}



.image-preview {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.image-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.image-preview:hover .image-overlay {
  opacity: 1;
}

/* å·²ä¸Šä¼ å›¾ç‰‡åŒºåŸŸ */
.uploaded-images {
  margin-top: 16px;
}

.images-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 14px;
  color: #333;
}

/* æ¨ªå‘æ’åˆ—çš„å›¾ç‰‡ç½‘æ ¼ */
.images-horizontal-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.image-item-small {
  position: relative;
  width: 50px;
  height: 50px;
  border-radius: 4px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  flex-shrink: 0;
}

.image-item-small img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-overlay-small {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.image-item-small:hover .image-overlay-small {
  opacity: 1;
}

.image-overlay-small .el-button {
  padding: 2px 6px;
  font-size: 10px;
  height: auto;
}


/* å¸¸ç”¨å‚è€ƒå›¾å›¾æ ‡åŒºåŸŸ */
.common-reference-icons {
  margin-top: 16px;
}

.icons-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 14px;
  color: #333;
  font-weight: 500;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* åˆ†ç±»æ ‡ç­¾æ ·å¼ */
.category-tabs {
  display: flex;
  gap: 6px;
}

.category-tab {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: #f5f7fa;
  border: 1px solid #e4e7ed;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 12px;
}

.category-tab:hover {
  background: #ecf5ff;
  border-color: #b3d8ff;
}

.category-tab.active {
  background: #409eff;
  border-color: #409eff;
  color: white;
}

.category-name {
  font-weight: 500;
}

.category-count {
  opacity: 0.8;
  font-size: 11px;
}


.collapse-btn {
  font-size: 12px;
  padding: 4px 8px;
  height: auto;
}

.icons-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 6px;
  transition: all 0.3s ease;
}

.icons-grid.collapsed {
  max-height: 92px; /* 2è¡Œçš„é«˜åº¦ */
  overflow: hidden;
}

.reference-icon {
  width: 40px;
  height: 40px;
  border-radius: 4px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 2px solid transparent;
}

.reference-icon:hover {
  border-color: #409eff;
  transform: scale(1.05);
}

.reference-icon img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.settings-section {
  margin-bottom: 8px;
  padding: 12px;
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  border-radius: 6px;
  border: 1px solid rgba(226, 232, 240, 0.5);
  display: flex;
  gap: 8px;
}

.settings-section.compact-section {
  padding: 8px;
  margin-bottom: 6px;
}

.setting-item {
  flex: 1;
}

.setting-item h3 {
  margin: 0 0 10px 0;
  color: #334155;
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}


.setting-select {
  width: 100%;
}

.setting-select .el-select__wrapper {
  border-radius: 8px;
  height: 40px;
}

/* ä¸Šä¸‹ä¸¤åˆ—å¸ƒå±€æ ·å¼ */
.settings-section.vertical-layout {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.settings-section.vertical-layout .setting-item {
  width: 100%;
}

/* æ ‡ç­¾é€‰æ‹©å™¨æ ·å¼ - å‚ç…§åŸå‹å›¾ç®€çº¦è®¾è®¡ */
.tag-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}

.tag-option {
  padding: 6px 12px;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  background: #ffffff;
  color: #64748b;
  font-size: 13px;
  font-weight: 400;
  cursor: pointer;
  transition: all 0.15s ease;
  user-select: none;
  text-align: center;
  min-width: 32px;
}

.tag-option:hover {
  border-color: #667eea;
  color: #667eea;
  background: #f8faff;
}

.tag-option.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: #667eea;
  color: #ffffff;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

/* ==================== æ¯”ä¾‹é€‰æ‹©å™¨æ ·å¼ ==================== */
.ratio-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 6px;
}

.ratio-option {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  border: 1.5px solid #e2e8f0;
  border-radius: 6px;
  background: #ffffff;
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
  min-width: 45px;
}

.ratio-option:hover {
  border-color: #667eea;
  background: #f8faff;
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
}

.ratio-option.active {
  border-color: #667eea;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  transform: translateY(-2px);
}

.ratio-option.active .ratio-box {
  border-color: #ffffff;
  background: rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
}

.ratio-option.active .ratio-text {
  color: #ffffff;
  font-weight: 600;
}

.ratio-box {
  border: 2px solid #94a3b8;
  background: transparent;
  transition: all 0.2s ease;
}

.ratio-text {
  font-size: 10px;
  color: #64748b;
  font-weight: 500;
  transition: all 0.2s ease;
  white-space: nowrap;
  line-height: 1;
}

/* ä¸åŒæ¯”ä¾‹çš„çº¿æ¡†å°ºå¯¸ - å¢åŠ 2px */
.ratio-box.ratio-1-1 {
  width: 14px;
  height: 14px;
  border-radius: 2px;
}

.ratio-box.ratio-16-9 {
  width: 18px;
  height: 11px;
  border-radius: 2px;
}

.ratio-box.ratio-9-16 {
  width: 11px;
  height: 18px;
  border-radius: 2px;
}

.ratio-box.ratio-4-3 {
  width: 16px;
  height: 12px;
  border-radius: 2px;
}

.ratio-box.ratio-3-4 {
  width: 12px;
  height: 16px;
  border-radius: 2px;
}

.ratio-box.ratio-3-2 {
  width: 17px;
  height: 12px;
  border-radius: 2px;
}

.ratio-box.ratio-2-3 {
  width: 12px;
  height: 17px;
  border-radius: 2px;
}

.ratio-box.ratio-21-9 {
  width: 20px;
  height: 10px;
  border-radius: 2px;
}

.ratio-box.ratio-9-21 {
  width: 10px;
  height: 20px;
  border-radius: 2px;
}

.ratio-box.ratio-4-5 {
  width: 14px;
  height: 17px;
  border-radius: 2px;
}

.ratio-box.ratio-5-4 {
  width: 17px;
  height: 14px;
  border-radius: 2px;
}

.action-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 8px;
  padding: 8px;
  background: #f8fafc;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
}

.concurrent-tip {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  margin-top: 12px;
  background: #e0f2fe;
  border-radius: 8px;
  border: 1px solid #7dd3fc;
  font-size: 13px;
  color: #0369a1;
}

.concurrent-tip .el-icon {
  font-size: 16px;
  flex-shrink: 0;
}

/* ç¡®ä¿æŒ‰é’®å®Œå…¨å¯¹é½ */
.action-buttons .el-button {
  margin: 0;
  padding: 0;
  border: none;
  box-sizing: border-box;
}

.generate-btn {
  width: 100%;
  height: 48px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

.generate-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
}

.reset-btn {
  width: 100%;
  height: 48px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.empty-result {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 400px;
  width: 100%;
  padding: 40px 20px;
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  max-width: 300px;
}

.empty-icon-container {
  position: relative;
  margin-bottom: 24px;
}

.empty-icon {
  font-size: 80px;
  color: #e0e0e0;
  z-index: 2;
  position: relative;
}

.empty-decoration {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 120px;
  height: 120px;
}

.decoration-circle {
  position: absolute;
  border-radius: 50%;
  opacity: 0.1;
  animation: float 3s ease-in-out infinite;
}

.circle-1 {
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #409EFF, #67C23A);
  top: 0;
  left: 0;
  animation-delay: 0s;
}

.circle-2 {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #E6A23C, #F56C6C);
  top: 20px;
  right: 0;
  animation-delay: 1s;
}

.circle-3 {
  width: 30px;
  height: 30px;
  background: linear-gradient(135deg, #909399, #C0C4CC);
  bottom: 0;
  left: 20px;
  animation-delay: 2s;
}

.empty-title {
  font-size: 24px;
  font-weight: 600;
  color: #606266;
  margin: 0 0 12px 0;
}

.empty-description {
  font-size: 14px;
  color: #909399;
  margin: 0;
  line-height: 1.5;
}

@keyframes float {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-10px);
  }
}

@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.images-result {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.images-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
  padding: 12px;
  flex: 1;
  overflow-y: auto;
  align-content: start;
}


.images-actions {
  text-align: center;
  padding-top: 16px;
  border-top: 1px solid #f0f0f0;
}

.images-actions .el-button {
  border-radius: 8px;
  font-weight: 500;
  padding: 12px 24px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1400px) {
  .left-panel {
    width: 320px;
  }
  
  .control-panel {
    width: 420px;
  }
}

@media (max-width: 1200px) {
  .main-layout {
    flex-direction: column;
    min-height: auto;
    gap: 0;
  }
  
  .left-panel {
    width: 100%;
    min-height: auto;
    flex-direction: row;
    gap: 0;
    border-right: none;
    border-bottom: 1px solid #e2e8f0;
    margin: 0;
    border-radius: 0;
  }
  
  .tab-section {
    flex: 1;
    border-radius: 0;
    height: 300px;
  }
  
  .user-account-card {
    width: 280px;
    flex-shrink: 0;
    border-radius: 0;
    height: 300px;
    border-top: none;
    border-left: 1px solid #e2e8f0;
  }
  
  .control-panel {
    width: 100%;
    height: auto;
    max-height: 500px;
    margin: 0;
    border-radius: 0;
  }
  
  .result-panel {
    height: 400px;
    margin: 0;
    border-radius: 0;
  }
  
  .images-grid {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
  }
}

@media (max-width: 768px) {
  .main-layout {
    min-height: 100vh;
    gap: 0;
  }
  
  .left-panel {
    flex-direction: column;
    gap: 0;
    min-height: auto;
    border-bottom: 1px solid #e2e8f0;
    margin: 0;
    border-radius: 0;
  }
  
  .tab-section {
    border-radius: 0;
    height: 250px;
  }
  
  .user-account-card {
    width: 100%;
    border-radius: 0;
    height: 60px;
    border-top: 1px solid #e2e8f0;
    border-left: none;
  }
  
  .control-panel {
    padding: 16px;
    height: auto;
    max-height: 400px;
    margin: 0;
    border-radius: 0;
  }
  
  /* ç§»åŠ¨ç«¯å…¨å±€Tabæ ·å¼ä¼˜åŒ– */
  .global-mode-tabs {
    margin-bottom: 16px;
  }
  
  .global-mode-tabs .el-tabs__item {
    font-size: 14px;
    padding: 0 16px;
    height: 40px;
    line-height: 40px;
  }
  
  /* ç§»åŠ¨ç«¯å¸¸ç”¨æç¤ºè¯æŒ‰é’®ä¼˜åŒ– */
  .common-prompts-buttons {
    gap: 6px;
  }
  
  .common-prompts-buttons .el-button {
    font-size: 11px;
    padding: 3px 6px;
  }
  
  .common-prompts-buttons .el-button.selected-prompt {
    transform: none;
    box-shadow: 0 1px 4px rgba(59, 130, 246, 0.3);
  }
  
  .common-prompts-buttons .el-button.selected-prompt:hover {
    transform: none;
    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
  }
  
  .result-header {
    padding: 12px 16px;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .result-header h2 {
    font-size: 18px;
  }
  
  .header-actions {
    width: 100%;
    justify-content: center;
  }
  
  .result-content {
    padding: 16px;
  }
  
  .images-grid {
    grid-template-columns: 1fr;
    gap: 12px;
    padding: 12px;
  }
  
  .upload-placeholder-square,
  .image-preview {
    width: 80px;
    height: 80px;
  }
}

/* æ»šåŠ¨æ¡æ ·å¼ */
.control-panel::-webkit-scrollbar {
  width: 6px;
}

.control-panel::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.control-panel::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.control-panel::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* å›¾ç‰‡é¢„è§ˆå¼¹çª—æ ·å¼ */
.image-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(5px);
}

.image-modal-content {
  position: relative;
  width: 90%;
  height: 90%;
  max-width: 1200px;
  max-height: 800px;
  display: flex;
  flex-direction: column;
  background: #1a1a1a;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.close-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 40px;
  height: 40px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 18px;
  cursor: pointer;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

.image-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
  background: #000;
}

.preview-image {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  cursor: grab;
  transition: transform 0.1s ease;
  user-select: none;
}

.preview-image:active {
  cursor: grabbing;
}

.image-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  background: rgba(0, 0, 0, 0.8);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
}

.nav-controls {
  display: flex;
  align-items: center;
  gap: 16px;
}

.nav-btn {
  width: 36px;
  height: 36px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 16px;
}

.nav-btn:hover:not(:disabled) {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

.nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.image-counter {
  color: white;
  font-size: 14px;
  font-weight: 500;
  min-width: 60px;
  text-align: center;
}

.zoom-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.control-btn {
  width: 32px;
  height: 32px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 14px;
}

.control-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

.download-btn {
  width: 36px;
  height: 36px;
  background: rgba(64, 158, 255, 0.8);
  border: none;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 16px;
}

.download-btn:hover {
  background: rgba(64, 158, 255, 1);
  transform: scale(1.1);
}

.save-prompt-btn {
  padding: 10px 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.save-prompt-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.save-prompt-btn .el-icon {
  font-size: 16px;
}

/* è§†é¢‘é¢„è§ˆå¼¹çª—æ ·å¼ */
.video-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(5px);
}

.video-modal-content {
  position: relative;
  width: 90%;
  max-width: 1200px;
  display: flex;
  flex-direction: column;
  background: #1a1a1a;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  padding: 20px;
}

.video-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 16px;
}

.preview-video {
  width: 100%;
  max-height: 70vh;
  object-fit: contain;
}

.video-modal-info {
  display: flex;
  gap: 20px;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  margin-bottom: 16px;
}

.video-modal-info .info-row {
  color: #e0e0e0;
  font-size: 14px;
}

.video-modal-info .info-row strong {
  color: #fff;
  margin-right: 8px;
}

.download-btn-video {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 20px;
  background: rgba(64, 158, 255, 0.8);
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.download-btn-video:hover {
  background: rgba(64, 158, 255, 1);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(64, 158, 255, 0.4);
}

/* å¼ºåˆ¶éšè—å‚è€ƒå›¾ç®¡ç†å¼¹çª—çš„header */
.el-dialog .el-dialog__header {
  display: none !important;
}

.el-dialog .el-dialog__body {
  padding: 0 !important;
  overflow: hidden !important;
  height: calc(80vh - 80px) !important; /* å¢åŠ å†…å®¹åŒºåŸŸé«˜åº¦åˆ°90vh */
  max-height: calc(60vh - 60px) !important; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
  margin-top: -20px !important; /* å‘ä¸Šç§»åŠ¨å†…å®¹åŒºåŸŸ */
}

/* ç¡®ä¿å¼¹çª—æœ¬èº«ä¸æ»šåŠ¨ */
.el-dialog {
  overflow: hidden !important;
  height: 80vh !important;
  max-height: 80vh !important;
}

.el-dialog__wrapper {
  overflow: hidden !important;
}

/* ç¡®ä¿å¼¹çª—å†…å®¹åŒºåŸŸä¸æ»šåŠ¨ */
.el-dialog .el-dialog__body {
  overflow: hidden !important;
}

/* ç¡®ä¿å¼¹çª—å®¹å™¨ä¸æ»šåŠ¨ */
.el-dialog .el-dialog__container {
  overflow: hidden !important;
}

/* ç¡®ä¿å¼¹çª—çš„æ‰€æœ‰å­å…ƒç´ éƒ½ä¸ä¼šå¯¼è‡´æ»šåŠ¨ */
.el-dialog * {
  box-sizing: border-box;
}

/* ç‰¹åˆ«ç¡®ä¿å¼¹çª—å†…å®¹ä¸ä¼šæº¢å‡º */
.el-dialog .el-dialog__body > * {
  max-height: 100%;
  overflow: hidden;
}

/* å½“å¼¹çª—æ‰“å¼€æ—¶ï¼Œé˜²æ­¢é¡µé¢æ»šåŠ¨ */
body.el-popup-parent--hidden {
  overflow: hidden !important;
}

/* é˜²æ­¢ el-overlay å’Œ el-modal-dialog å¯¼è‡´é¡µé¢æ»šåŠ¨ */
.el-overlay {
  overflow: hidden !important;
}

.el-modal-dialog {
  overflow: hidden !important;
}

.el-modal-dialog .el-dialog__wrapper {
  overflow: hidden !important;
}

.el-modal-dialog .el-dialog__container {
  overflow: hidden !important;
}

.el-modal-dialog .el-dialog__body {
  overflow: hidden !important;
}

/* å¼ºåˆ¶æ¶ˆé™¤æ‰€æœ‰å¼¹çª—çš„æ»šåŠ¨æ¡ */
.el-dialog,
.el-dialog__wrapper,
.el-dialog__container,
.el-dialog__body,
.el-overlay,
.el-modal-dialog,
.el-modal-dialog .el-dialog__wrapper,
.el-modal-dialog .el-dialog__container,
.el-modal-dialog .el-dialog__body {
  overflow: hidden !important;
  scrollbar-width: none !important; /* Firefox */
  -ms-overflow-style: none !important; /* IE and Edge */
}

/* éšè— Webkit æµè§ˆå™¨çš„æ»šåŠ¨æ¡ */
.el-dialog::-webkit-scrollbar,
.el-dialog__wrapper::-webkit-scrollbar,
.el-dialog__container::-webkit-scrollbar,
.el-dialog__body::-webkit-scrollbar,
.el-overlay::-webkit-scrollbar,
.el-modal-dialog::-webkit-scrollbar,
.el-modal-dialog .el-dialog__wrapper::-webkit-scrollbar,
.el-modal-dialog .el-dialog__container::-webkit-scrollbar,
.el-modal-dialog .el-dialog__body::-webkit-scrollbar {
  display: none !important;
  width: 0 !important;
  height: 0 !important;
}

/* ç¡®ä¿å¼¹çª—å†…å®¹ä¸ä¼šè¶…å‡ºè¾¹ç•Œ */
.el-dialog .el-dialog__body,
.el-modal-dialog .el-dialog__body {
  max-height: calc(80vh - 120px) !important;
  overflow: hidden !important;
}

/* å¼ºåˆ¶è®¾ç½®å¼¹çª—å°ºå¯¸ï¼Œé˜²æ­¢å†…å®¹æº¢å‡º */
.el-dialog {
  max-height: 80vh !important;
  height: auto !important;
  overflow: hidden !important;
}

.el-dialog__wrapper {
  max-height: 80vh !important;
  overflow: hidden !important;
}

.el-dialog__container {
  max-height: 80vh !important;
  overflow: hidden !important;
}

/* ç¡®ä¿å¼¹çª—å†…å®¹åŒºåŸŸæœ‰å›ºå®šé«˜åº¦ */
.el-dialog__body {
  max-height: calc(80vh - 120px) !important;
  overflow: hidden !important;
  padding: 0 !important;
}

/* å¼ºåˆ¶æ¶ˆé™¤æ‰€æœ‰å¯èƒ½çš„æ»šåŠ¨æ¡ - æ›´å…¨é¢çš„è¦†ç›– */
*[class*="el-dialog"],
*[class*="el-overlay"],
*[class*="el-modal"] {
  overflow: hidden !important;
  scrollbar-width: none !important;
  -ms-overflow-style: none !important;
}

*[class*="el-dialog"]::-webkit-scrollbar,
*[class*="el-overlay"]::-webkit-scrollbar,
*[class*="el-modal"]::-webkit-scrollbar {
  display: none !important;
  width: 0 !important;
  height: 0 !important;
}

/* ç‰¹åˆ«é’ˆå¯¹å¼¹çª—çš„æ ¹å…ƒç´  */
.el-dialog__wrapper,
.el-overlay,
.el-modal__wrapper {
  overflow: hidden !important;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
}

html {
  overflow-x: hidden;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .image-modal-content {
    width: 95%;
    height: 95%;
  }
  
  .image-controls {
    padding: 12px 16px;
    flex-direction: column;
    gap: 12px;
  }
  
  .nav-controls,
  .zoom-controls {
    gap: 8px;
  }
  
  .nav-btn,
  .control-btn,
  .download-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
  
  .image-counter {
    font-size: 12px;
  }
}

/* æ¨¡å‹é€‰æ‹©å™¨æ ·å¼ */
.model-selector {
  width: 100%;
}

.model-option {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.model-name {
  font-weight: 500;
  color: #303133;
}

.default-tag {
  background: #409eff;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  align-self: flex-start;
}

.model-description {
  font-size: 12px;
  color: #909399;
  line-height: 1.4;
}

/* æ¨¡å‹é€‰æ‹©å™¨ä¸‹æ‹‰æ¡†æ ·å¼ä¼˜åŒ– */
:deep(.el-select-dropdown__item) {
  padding: 8px 12px;
}

:deep(.el-select-dropdown__item:hover) {
  background-color: #f5f7fa;
}

:deep(.el-select-dropdown__item.selected) {
  background-color: #ecf5ff;
  color: #409eff;
}

/* è§†é¢‘ç”ŸæˆåŒºåŸŸæ ·å¼ */
.video-input-section {
  margin-top: 20px;
}

.video-result-container {
  height: 100%;
}

.reference-images-section {
  margin-top: 10px;
}

/* é¦–å°¾å¸§å¹¶æ’å¸ƒå±€ */
.frame-upload-container {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
}

.frame-upload-item {
  flex: 1;
  min-width: 0;
}

.frame-label {
  display: flex;
  align-items: center;
  margin-bottom: 6px;
  font-weight: 500;
  color: #333;
  font-size: 13px;
}

.frame-hint {
  margin-left: 4px;
  font-size: 11px;
  color: #999;
  font-weight: normal;
}

/* é¦–å°¾å¸§ä¸Šä¼ åŒºåŸŸæ ·å¼ */
.frame-upload {
  width: 100%;
}

.frame-upload .el-upload-dragger {
  width: 100%;
  height: 80px;
  border: 2px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s;
}

.frame-upload .el-upload-dragger:hover {
  border-color: #409eff;
}

.frame-upload-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 8px;
}

.frame-upload-icon {
  font-size: 20px;
  color: #c0c4cc;
  margin-bottom: 4px;
}

.frame-upload-text {
  text-align: center;
}

.frame-upload-text p {
  margin: 0;
  font-size: 12px;
  color: #606266;
  line-height: 1.2;
}

.frame-upload-hint {
  font-size: 10px !important;
  color: #909399 !important;
}

/* ä¿ç•™åŸæœ‰çš„referenceæ ·å¼ä»¥å…¼å®¹å…¶ä»–éƒ¨åˆ† */
.reference-upload-item {
  margin-bottom: 20px;
}

.reference-label {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  font-weight: 500;
  color: #333;
}

.reference-hint {
  margin-left: 4px;
  font-size: 12px;
  color: #999;
  font-weight: normal;
}

.upload-area {
  text-align: center;
  padding: 30px 20px;
  border: 2px dashed #d9d9d9;
  border-radius: 6px;
  background-color: #fafafa;
  transition: border-color 0.3s;
}

.upload-area:hover {
  border-color: #409eff;
}

.upload-icon {
  font-size: 36px;
  color: #c0c4cc;
  margin-bottom: 12px;
}

.upload-text p {
  margin: 0;
  color: #666;
}

.upload-hint {
  font-size: 12px;
  color: #999;
  margin-top: 4px;
}

.upload-instructions {
  margin-top: 16px;
}

.instruction-list {
  margin: 0;
  padding-left: 16px;
  font-size: 13px;
  line-height: 1.6;
}

.instruction-list li {
  margin-bottom: 4px;
  color: #666;
}

/* æ–°å¢çš„è§†é¢‘ç›¸å…³æ ·å¼ */
/* ç´§å‡‘ä¸Šä¼ å¸ƒå±€ */
.upload-compact-grid {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.upload-compact-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex: 1;
  min-width: 180px;
}

.compact-label {
  font-size: 13px;
  font-weight: 600;
  color: #606266;
}

.compact-preview-box {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  background: #f5f7fa;
  border-radius: 4px;
  border: 1px solid #dcdfe6;
  height: 32px;
}

.compact-thumb {
  width: 24px;
  height: 24px;
  object-fit: cover;
  border-radius: 3px;
  flex-shrink: 0;
}

.compact-filename {
  flex: 1;
  font-size: 13px;
  color: #409eff;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.compact-uploader {
  height: 32px;
}

.compact-uploader .el-button {
  width: 100%;
  height: 100%;
  padding: 4px 12px;
}

/* ç´§å‡‘å‚æ•°è¡Œå¸ƒå±€ */
.params-compact-row {
  display: flex;
  gap: 8px;
}

.param-compact-col {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.param-compact-col label {
  font-size: 13px;
  font-weight: 600;
  color: #606266;
}

.param-compact-col .el-select {
  width: 100%;
}

.param-hint-inline {
  font-size: 11px;
  color: #909399;
  margin-top: 2px;
  line-height: 1.4;
}

/* æŠ˜å é«˜çº§é€‰é¡¹æ ·å¼ */
.compact-section {
  margin: 8px 0;
}

.advanced-collapse {
  border: none;
  background: transparent;
}

.advanced-collapse .el-collapse-item__header {
  background: transparent;
  border: none;
  padding: 0;
  height: auto;
  line-height: normal;
}

.advanced-collapse .el-collapse-item__wrap {
  border: none;
  background: transparent;
}

.advanced-collapse .el-collapse-item__content {
  padding: 8px 0 0 0;
}

.collapse-title {
  margin: 0;
  font-size: 15px;
  font-weight: 600;
  color: #303133;
}

.advanced-options-compact {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 6px;
}

.option-item-compact {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.option-item-compact label {
  font-size: 13px;
  font-weight: 600;
  color: #606266;
}

.option-checkboxes {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}

.option-checkboxes .el-checkbox {
  margin: 0;
}

/* ç´§å‡‘å‚è€ƒå›¾ç®¡ç†æ ·å¼ */
.reference-compact-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.reference-actions-row {
  display: flex;
  gap: 6px;
  align-items: center;
}

.uploaded-images-compact {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 8px;
  border: 1px solid #e2e8f0;
}

.compact-images-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 13px;
}

.image-count {
  color: #606266;
  font-weight: 500;
}

.compact-images-grid {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
}

.compact-image-item {
  position: relative;
  width: 40px;
  height: 40px;
  border-radius: 4px;
  overflow: hidden;
  border: 1px solid #dcdfe6;
}

.compact-image-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.remove-btn {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 16px;
  height: 16px;
  min-height: 16px;
  padding: 0;
  font-size: 10px;
}

.more-images-indicator {
  width: 40px;
  height: 40px;
  background: #f0f2f5;
  border: 1px dashed #d9d9d9;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #909399;
  font-weight: 500;
}

/* è¶…ç´§å‡‘è§†é¢‘ä¸Šä¼ æ ·å¼ */
.video-upload-ultra-compact {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.video-upload-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 120px;
}

.ultra-compact-label {
  font-size: 12px;
  font-weight: 600;
  color: #606266;
  margin: 0;
}

.ultra-compact-preview {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 8px;
  background: #f5f7fa;
  border-radius: 4px;
  border: 1px solid #dcdfe6;
  height: 36px;
}

.ultra-thumb {
  width: 24px;
  height: 24px;
  object-fit: cover;
  border-radius: 3px;
  flex-shrink: 0;
}

.ultra-compact-uploader {
  height: 36px;
}

.ultra-compact-uploader .el-button {
  width: 100%;
  height: 100%;
  font-size: 12px;
}

/* å›¾ç”Ÿå›¾ç´§å‡‘ä¸Šä¼ æ ·å¼ */
.image-upload-header-inline {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.image-upload-header-inline h3 {
  margin: 0;
  font-size: 15px;
  font-weight: 600;
  color: #303133;
}

.reference-upload-compact {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 1px;
}

.uploaded-compact-display {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: #f5f7fa;
  border-radius: 4px;
  border: 1px solid #dcdfe6;
}

.upload-count {
  font-size: 13px;
  color: #606266;
  font-weight: 500;
}

.uploaded-thumbnails-compact {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}

.thumbnail-item-compact {
  position: relative;
  width: 60px;
  height: 60px;
  border-radius: 6px;
  overflow: visible;
  border: 2px solid #dcdfe6;
  transition: all 0.3s ease;
}

.thumbnail-item-compact::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 4px;
  overflow: hidden;
  z-index: 1;
}

.thumbnail-item-compact:hover {
  border-color: #409eff;
  transform: scale(1.05);
}

/* æ‹–æ‹½çŠ¶æ€æ ·å¼ */
.thumbnail-item-compact.dragging {
  opacity: 0.5;
  cursor: move;
}

.thumbnail-item-compact.drag-over {
  border: 2px dashed #409eff;
  background-color: rgba(64, 158, 255, 0.1);
  box-shadow: 0 0 10px rgba(64, 158, 255, 0.3);
}

.thumbnail-item-compact.drag-over::after {
  content: '';
  position: absolute;
  top: -4px;
  left: -4px;
  right: -4px;
  bottom: -4px;
  border: 2px dashed #409eff;
  border-radius: 8px;
  animation: pulse 0.8s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.thumbnail-item-compact img {
  cursor: pointer;
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 4px;
  position: relative;
  z-index: 2;
}

.remove-thumb-btn {
  position: absolute;
  top: -10px;
  right: -10px;
  width: 22px;
  height: 22px;
  min-height: 22px;
  padding: 0;
  font-size: 12px;
  z-index: 10;
  background: #f56c6c;
  border-color: #f56c6c;
  box-shadow: 0 2px 8px rgba(245, 108, 108, 0.4);
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: auto;
}

.remove-thumb-btn:hover {
  background: #f78989;
  border-color: #f78989;
  transform: scale(1.1);
}

.thumbnail-item-compact:hover .remove-thumb-btn {
  opacity: 1;
}

/* å†…è”å¸¸ç”¨å‚è€ƒå›¾æ ·å¼ */
.common-reference-icons-inline {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e2e8f0;
}

.icons-header-inline {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.icons-header-inline > span {
  font-size: 14px;
  font-weight: 600;
  color: #606266;
}

.header-actions-inline {
  display: flex;
  align-items: center;
  gap: 12px;
}

.category-tabs-inline {
  display: flex;
  gap: 8px;
}

.category-tab-inline {
  padding: 4px 10px;
  background: #f5f7fa;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 12px;
}

.category-tab-inline:hover {
  background: #e6e8eb;
}

.category-tab-inline.active {
  background: #409eff;
  color: white;
}

.category-name {
  font-weight: 500;
}

.category-count {
  opacity: 0.7;
  margin-left: 4px;
}

.icons-grid-inline {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
  gap: 8px;
  max-height: 200px;
  overflow-y: auto;
  transition: max-height 0.3s ease;
}

.icons-grid-inline.collapsed {
  max-height: 120px;
}

.reference-icon-inline {
  width: 50px;
  height: 50px;
  border-radius: 6px;
  overflow: hidden;
  cursor: grab;
  border: 2px solid #e2e8f0;
  transition: all 0.3s ease;
}

.reference-icon-inline:active {
  cursor: grabbing;
}

.reference-icon-inline:hover {
  border-color: #409eff;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
}

.reference-icon-inline img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* å¸¸ç”¨å‚è€ƒå›¾åŠ è½½åŠ¨ç”» */
.reference-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  gap: 12px;
  color: #909399;
  font-size: 14px;
}

.reference-loading .el-icon {
  color: #409eff;
}

.upload-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.upload-item {
  display: flex;
  flex-direction: column;
}

.upload-label {
  margin-bottom: 8px;
  color: #303133;
  font-weight: 600;
  font-size: 14px;
}

.image-uploader {
  width: 100%;
}

.image-preview {
  position: relative;
  width: 100%;
  height: 200px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px dashed #d9d9d9;
}

.image-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  opacity: 0;
  transition: opacity 0.3s;
}

.image-preview:hover .image-overlay {
  opacity: 1;
}

.upload-placeholder {
  width: 100%;
  height: 200px;
  border: 2px dashed #d9d9d9;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #909399;
  transition: border-color 0.3s;
}

.upload-placeholder:hover {
  border-color: #409eff;
}

.upload-icon {
  font-size: 32px;
  margin-bottom: 12px;
}

.upload-text {
  font-size: 14px;
  margin-bottom: 4px;
}

.upload-hint {
  font-size: 12px;
  color: #c0c4cc;
}

.params-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.param-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.param-item label {
  color: #303133;
  font-weight: 600;
  font-size: 14px;
}

.param-select,
.param-input {
  width: 100%;
}

.advanced-options {
  margin-top: 20px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
}

.options-grid {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.option-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
}

.option-item.full-width {
  flex-direction: column;
  grid-column: 1 / -1; /* å æ®æ•´è¡Œ */
}

.option-item.full-width label {
  font-weight: 500;
  margin-bottom: 8px;
  color: #333;
}

.option-item.full-width .el-input,
.option-item.full-width .el-select {
  width: 100%;
}

.option-item .el-checkbox {
  margin-top: 2px;
}

.option-desc {
  color: #6c757d;
  font-size: 14px;
  line-height: 1.4;
  flex: 1;
}

@media (max-width: 768px) {
  .upload-grid {
    grid-template-columns: 1fr;
  }
  
  .params-grid {
    grid-template-columns: 1fr;
  }
}

/* è§†é¢‘å¡ç‰‡æ ·å¼ */
.video-card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
}

.video-card:hover {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
}

.video-player {
  width: 100%;
  height: auto;
  display: block;
  background: #000;
}

.video-info {
  padding: 15px;
  background: #f8f9fa;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  border-top: 1px solid #e9ecef;
}

.video-info .info-item {
  font-size: 13px;
  color: #495057;
  line-height: 1.5;
}

.video-info .info-item strong {
  color: #212529;
  margin-right: 4px;
}

.video-actions {
  padding: 15px;
  display: flex;
  justify-content: center;
  gap: 10px;
  border-top: 1px solid #e9ecef;
}

.video-actions .el-button {
  flex: 1;
  max-width: 200px;
}

/* ==================== æ‰¹æ¬¡ç³»ç»Ÿæ ·å¼ ==================== */
.result-content {
  max-height: calc(100vh - 100px); /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œå‡å°‘åº•éƒ¨ç©ºç™½ */
  overflow-y: auto; /* å¯ç”¨å‚ç›´æ»šåŠ¨ */
  padding-right: 10px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºé—´ */
}

/* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
.result-content::-webkit-scrollbar {
  width: 8px;
}

.result-content::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.result-content::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
  transition: background 0.3s ease;
}

.result-content::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.batches-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 0;
  width: 100%;
}

.batch-card {
  background: white;
  border-radius: 8px;
  padding: 12px 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border: 1px solid #e8eaed;
  transition: all 0.3s ease;
}

.batch-card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  transform: translateY(-2px);
}

.batch-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid #f0f2f5;
}

.batch-info {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  flex: 1;
}

.batch-type {
  font-weight: 600;
  color: #409eff;
  font-size: 15px;
  padding: 4px 12px;
  background: #ecf5ff;
  border-radius: 6px;
  flex-shrink: 0;
}

.batch-time {
  color: #909399;
  font-size: 13px;
  padding: 4px 8px;
  background: #f5f7fa;
  border-radius: 4px;
}

.batch-prompt {
  color: #606266;
  font-size: 13px;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 400px;
}

/* æ‰¹æ¬¡æ¨¡å‹æ ‡ç­¾ - ç´§è·Ÿåœ¨ batch-type åé¢ */
.batch-model-tag {
  padding: 4px 10px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  flex-shrink: 0;
}

.status-pending {
  background: #f4f4f5;
  color: #909399;
}

.status-processing {
  background: #ecf5ff;
  color: #409eff;
  animation: pulse 2s ease-in-out infinite;
}

.status-completed {
  background: #f0f9ff;
  color: #67c23a;
}

.status-partial {
  background: #fdf6ec;
  color: #e6a23c;
}

.status-failed {
  background: #fef0f0;
  color: #f56c6c;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 240px));
  gap: 12px;
  margin-top: 8px;
}

.results-grid .video-card,
.results-grid .main-card,
.tasks-grid .main-card {
  width: 100%;
  height: 200px;
}

/* ç¼©ç•¥å›¾æ¨¡å¼ï¼šresults-gridå†…çš„è§†é¢‘å¡ç‰‡ */
.results-grid .video-card-thumbnail {
  cursor: pointer;
  position: relative;
}

.results-grid .video-card-thumbnail .video-player {
  height: 100%;
  object-fit: cover;
  pointer-events: none;
}

.results-grid .video-card-thumbnail .video-info,
.results-grid .video-card-thumbnail .video-actions {
  display: none;
}

/* æ·»åŠ è§†é¢‘æ’­æ”¾å›¾æ ‡è¦†ç›–å±‚ */
.results-grid .video-card-thumbnail::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 60px;
  height: 60px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.results-grid .video-card-thumbnail::before {
  content: 'â–¶';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-45%, -50%);
  color: white;
  font-size: 26px;
  z-index: 1;
  pointer-events: none;
}
</style>



